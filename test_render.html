<!DOCTYPE html>
<html lang="zh-HK" data-bs-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ML å€‹è‚¡åˆ†æ â€” StockLab</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    :root {
      --bs-body-bg: #0d1117;
      --bs-body-color: #c9d1d9;
      --accent: #00d4ff;
      --accent2: #58a6ff;
      --success: #3fb950;
      --warning: #d29922;
      --danger: #f85149;
    }
    body { background: var(--bs-body-bg); color: var(--bs-body-color); font-size: 14px; }
    .navbar-brand { color: var(--accent) !important; font-weight: 700; letter-spacing: 1px; }
    .nav-link { color: #8b949e !important; transition: color .2s; }
    .nav-link:hover, .nav-link.active { color: var(--accent) !important; }
    .card { background: #161b22; border: 1px solid #30363d; border-radius: 8px; }
    .card-header { background: #1c2128; border-bottom: 1px solid #30363d; font-weight: 600; }
    .table { --bs-table-bg: transparent; --bs-table-color: #c9d1d9;
             --bs-table-striped-bg: #1a2030; --bs-table-hover-bg: #253060; }
    .table th { color: var(--accent); border-color: #30363d; font-size: 12px; text-transform: uppercase; }
    .table td { border-color: #21262d; vertical-align: middle; }
    .badge-A { background: #1b6e2e; color: #3fb950; }
    .badge-B { background: #4a3800; color: #e3b341; }
    .badge-C { background: #1a3060; color: #58a6ff; }
    .score-high { color: #3fb950; font-weight: 700; }
    .score-mid  { color: #e3b341; font-weight: 600; }
    .score-low  { color: #f85149; }
    .regime-bull  { background: #0a2e1a; border-left: 4px solid #3fb950; }
    .regime-trans { background: #2e2500; border-left: 4px solid #e3b341; }
    .regime-bear  { background: #2e0a0a; border-left: 4px solid #f85149; }
    .regime-bottom{ background: #0a1a2e; border-left: 4px solid #58a6ff; }
    .spinner-glow { animation: glow 1.2s ease-in-out infinite alternate; }
    @keyframes glow { from { opacity: .5; } to { opacity: 1; } }
    .metric-card { background: #161b22; border: 1px solid #30363d;
                   border-radius: 8px; padding: 16px; text-align: center; }
    .metric-val  { font-size: 28px; font-weight: 700; color: var(--accent); }
    .metric-lbl  { font-size: 11px; color: #8b949e; text-transform: uppercase; margin-top: 2px; }
    pre.result-pre { background: #0d1117; border: 1px solid #30363d;
                     border-radius: 6px; padding: 14px; font-size: 12px;
                     color: #c9d1d9; max-height: 500px; overflow-y: auto; }
    .tag-vcp { background: #004d40; color: #64ffda; border-radius: 4px;
               padding: 2px 7px; font-size: 11px; white-space: nowrap; }
    .btn-accent { background: var(--accent); color: #000; border: none; font-weight: 600; }
    .btn-accent:hover { background: #00b8d9; color: #000; }
    #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 9999; }
    .toast-msg { background: #1c2128; border: 1px solid #30363d; color: #c9d1d9;
                 border-radius: 6px; padding: 12px 18px; margin-top: 8px;
                 box-shadow: 0 4px 12px rgba(0,0,0,.5); animation: fadein .3s; }
    .toast-msg.ok   { border-left: 4px solid #3fb950; }
    .toast-msg.err  { border-left: 4px solid #f85149; }
    @keyframes fadein { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: none; } }
    .sidebar-sticky { position: sticky; top: 68px; }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: #0d1117; }
    ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 3px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- TradingView Lightweight Charts â€” professional K-line candlestick rendering -->
  <script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
  
<!-- Fallback styles for CSS CDN failure - Ensure visibility -->
<style>
  /* â•â•â•â• Critical: Make content visible even if Bootstrap fails â•â•â•â• */
  html, body {
    background: #0d1117 !important;
    color: #c9d1d9 !important;
    margin: 0 !important;
    padding: 0 !important;
    width: 100% !important;
    min-height: 100vh !important;
  }
  
  /* Navbar styling */
  nav, .navbar {
    display: block !important;
    background: #161b22 !important;
    border-bottom: 1px solid #30363d !important;
    width: 100% !important;
    padding: 0.5rem 1rem !important;
  }
  
  /* Main content must be visible */
  .container-fluid {
    display: block !important;
    width: 100% !important;
    padding: 1rem !important;
    margin: 0 !important;
    background: #0d1117 !important;
    color: #c9d1d9 !important;
  }
  
  /* Row and col */
  .row {
    display: block !important;
    width: 100% !important;
    margin: 1rem 0 !important;
  }
  
  .col-12, .col-6, .col-md-2, .col-md-3 {
    display: block !important;
    width: 100% !important;
    margin-bottom: 1rem !important;
  }
  
  /* Form elements */
  input, textarea, select, button {
    background: #0d1117 !important;
    color: #c9d1d9 !important;
    border: 1px solid #30363d !important;
    padding: 0.5rem !important;
    margin: 0.25rem 0 !important;
    display: inline-block !important;
  }
  
  button {
    cursor: pointer !important;
    background: #238636 !important;
    color: white !important;
  }
  
  /* Text must be visible */
  h1, h2, h3, h4, h5, h6, p {
    color: #c9d1d9 !important;
  }
  
  /* Cards */
  .card {
    display: block !important;
    background: #161b22 !important;
    border: 1px solid #30363d !important;
    margin: 1rem 0 !important;
    padding: 0.5rem !important;
  }
</style>

<style>
  .star-val { font-size: 2rem; font-weight: 700; }
  .star-5  { color: #3fb950; }
  .star-4  { color: #3fb950; }
  .star-3  { color: #e3b341; }
  .star-low { color: #f85149; }
  .dim-bar-wrap { background: #21262d; border-radius: 4px; height: 8px; overflow: hidden; }
  .dim-bar { height: 8px; border-radius: 4px; transition: width .6s ease; }
  .veto-alert { background: #3a0a0a; border: 1px solid #f85149; border-radius: 8px; padding: 12px 16px; }
  .trade-plan-card { background: #0d1117; border: 1px solid #30363d; border-radius: 8px; padding: 16px; }
  .stop-phase { border-left: 3px solid; padding: 10px 14px; margin-bottom: 8px; border-radius: 0 6px 6px 0; }
  .stop-phase-1 { border-color: #f85149; background: #1a0a0a; }
  .stop-phase-2 { border-color: #e3b341; background: #1a1000; }
  .stop-phase-3 { border-color: #3fb950; background: #0a1a0a; }
  .profit-step { border-left: 3px solid #58a6ff; background: #0a0e1a;
                 padding: 10px 14px; margin-bottom: 8px; border-radius: 0 6px 6px 0; }
  .badge-pb   { background: #0e4429; color: #3fb950; }
  .badge-br   { background: #1a3060; color: #58a6ff; }
  .badge-bo   { background: #4a3800; color: #e3b341; }
  .badge-ep   { background: #3a0060; color: #d49fff; }
  .badge-chg  { background: #003040; color: #00d4ff; }
  .badge-para { background: #3a0a0a; color: #f85149; }
  .badge-uk   { background: #1c2128; color: #8b949e; }
  #dailyChartContainer, #weeklyChartContainer { background: #0d1117; border-radius: 6px; overflow: hidden; }
  .chart-legend { display: flex; flex-wrap: wrap; gap: 12px; padding: 6px 10px; font-size: 11px; color: #8b949e; }
  .chart-legend span { display: flex; align-items: center; gap: 4px; }
  .chart-range-btn { font-size: 11px; padding: 2px 8px; }
  .chart-tab-active { border-bottom: 2px solid #3fb950 !important; color: #3fb950 !important; }
  /* Indicator toggles */
  .ind-toggle { cursor: pointer; user-select: none; border-radius: 4px; padding: 1px 4px; transition: opacity .2s; }
  .ind-toggle:hover { background: #21262d; }
  .ind-toggle.toggled-off { opacity: 0.35; text-decoration: line-through; }
  /* Commentary */
  .cmt-pass  { border-left: 3px solid #3fb950; background:#0a1a0a; padding:8px 12px; border-radius:0 6px 6px 0; margin-bottom:8px; font-size:13px; }
  .cmt-warn  { border-left: 3px solid #e3b341; background:#1a1000; padding:8px 12px; border-radius:0 6px 6px 0; margin-bottom:8px; font-size:13px; }
  .cmt-fail  { border-left: 3px solid #f85149; background:#1a0a0a; padding:8px 12px; border-radius:0 6px 6px 0; margin-bottom:8px; font-size:13px; }
  .cmt-info  { border-left: 3px solid #58a6ff; background:#0a0e1a; padding:8px 12px; border-radius:0 6px 6px 0; margin-bottom:8px; font-size:13px; }
  .cmt-label { font-weight:700; margin-right:6px; }
  /* Watch mode styles */
  .mode-btn { font-size:13px; padding:10px 20px; border: none; border-radius:6px; cursor:pointer; background:#21262d; color:#8b949e; transition:all .2s; font-weight:600; }
  .mode-btn:hover { background:#30363d; }
  .mode-btn.active { background:#3fb950; color:#0d1117; }
  .mode-btn-group { display:flex; gap:8px; margin-bottom:20px; }
  .market-status { display:flex; align-items:center; gap:8px; padding:8px 12px; border-radius:6px; font-size:12px; font-weight:600; }
  .market-status.premarket { background:#3a3000; color:#e3b341; }
  .market-status.open { background:#0a3a0a; color:#3fb950; }
  .market-status.afterhours { background:#0a2a3a; color:#58a6ff; }
  .market-status.closed { background:#1c2128; color:#8b949e; }
  .live-pulse { display:inline-block; width:8px; height:8px; border-radius:50%; background:#3fb950; animation:pulse 1.5s infinite; }
  @keyframes pulse { 0%, 100% { opacity:1; } 50% { opacity:0.4; } }
  #intradayChartContainer { background:#0d1117; border-radius:6px; overflow:hidden; }
  .intraday-legend { display:flex; flex-wrap:wrap; gap:10px; padding:8px 12px; font-size:11px; color:#8b949e; border-bottom:1px solid #21262d; }
  .intraday-btn-group { display:flex; gap:4px; margin-bottom:12px; }
  .intraday-btn { font-size:11px; padding:6px 12px; border:1px solid #30363d; background:#0d1117; color:#8b949e; border-radius:4px; cursor:pointer; transition:all .2s; }
  .intraday-btn.active { background:#3fb950; color:#0d1117; border-color:#3fb950; }
  .watch-status-row { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; flex-wrap:wrap; gap:12px; }
  .watch-countdown { font-size:12px; color:#8b949e; font-weight:600; }
  .premarket-warning { background:#3a2a0a; border:1px solid #e3b341; border-radius:6px; padding:12px; margin-bottom:12px; color:#e3b341; font-size:12px; }
  .closed-notice { background:#1a0a0a; border:1px solid #f85149; border-radius:6px; padding:16px; text-align:center; color:#f85149; font-size:13px; }
</style>


</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark sticky-top" style="background:#161b22;border-bottom:1px solid #30363d">
  <div class="container-fluid">
    <a class="navbar-brand" href="/"><i class="bi bi-graph-up-arrow me-2"></i>SEPA&nbsp;Lab</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="nav">
      <ul class="navbar-nav me-auto gap-1">
        <li class="nav-item"><a class="nav-link " href="/"><i class="bi bi-speedometer2 me-1"></i>Dashboard</a></li>
        <li class="nav-item"><a class="nav-link " href="/combined"><i class="bi bi-lightning-fill me-1" style="color:#00d4ff"></i>Combined Scan çµ„åˆæƒæ</a></li>
        <!-- â”€â”€ SEPA dropdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle "
             href="#" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="bi bi-funnel me-1"></i>SEPA
          </a>
          <ul class="dropdown-menu dropdown-menu-dark" style="background:#161b22;border-color:#30363d">
            <li><h6 class="dropdown-header" style="color:#8b949e;font-size:10px">MINERVINI SEPA</h6></li>
            <li><a class="dropdown-item " href="/scan">
              <i class="bi bi-funnel me-2"></i>Scan æƒæ</a></li>
            <li><a class="dropdown-item " href="/analyze">
              <i class="bi bi-search me-2"></i>Analyze åˆ†æ</a></li>
            <li><a class="dropdown-item " href="/watchlist">
              <i class="bi bi-bookmark-star me-2"></i>Watchlist è§€å¯Ÿåå–®</a></li>
            <li><a class="dropdown-item " href="/positions">
              <i class="bi bi-briefcase me-2"></i>Positions æŒå€‰</a></li>
            <li><a class="dropdown-item " href="/market">
              <i class="bi bi-bar-chart-line me-2"></i>Market å¸‚å ´ç’°å¢ƒ</a></li>
            <li><a class="dropdown-item " href="/vcp">
              <i class="bi bi-activity me-2"></i>VCP æ³¢å‹•æ”¶ç¸®</a></li>
            <li><a class="dropdown-item " href="/backtest">
              <i class="bi bi-clock-history me-2"></i>Backtest å›æ¸¬</a></li>
            <li><hr class="dropdown-divider" style="border-color:#30363d"></li>
            <li><a class="dropdown-item " href="/guide">
              <i class="bi bi-book me-2"></i>SEPA æ•™å­¸ Guide</a></li>
          </ul>
        </li>
        <!-- â”€â”€ Qullamaggie dropdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle "
             href="#" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="bi bi-lightning-charge me-1" style="color:#e3b341"></i>QM
          </a>
          <ul class="dropdown-menu dropdown-menu-dark" style="background:#161b22;border-color:#30363d">
            <li><h6 class="dropdown-header" style="color:#8b949e;font-size:10px">QULLAMAGGIE çªç ´æ³¢æ®µ</h6></li>
            <li><a class="dropdown-item " href="/qm/scan">
              <i class="bi bi-lightning-charge me-2" style="color:#e3b341"></i>QM Scan æƒæ</a></li>
            <li><a class="dropdown-item " href="/qm/analyze">
              <i class="bi bi-search me-2"></i>QM Analyze åˆ†æ</a></li>
            <li><hr class="dropdown-divider" style="border-color:#30363d"></li>
            <li><a class="dropdown-item " href="/qm/guide">
              <i class="bi bi-book me-2"></i>QM æ•™å­¸ Guide</a></li>
          </ul>
        </li>
        <!-- â”€â”€ Martin Luk dropdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle active"
             href="#" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="bi bi-graph-up-arrow me-1" style="color:#3fb950"></i>ML
          </a>
          <ul class="dropdown-menu dropdown-menu-dark" style="background:#161b22;border-color:#30363d">
            <li><h6 class="dropdown-header" style="color:#8b949e;font-size:10px">MARTIN LUK å›èª¿æ³¢æ®µ</h6></li>
            <li><a class="dropdown-item " href="/ml/scan">
              <i class="bi bi-graph-up-arrow me-2" style="color:#3fb950"></i>ML Scan æƒæ</a></li>
            <li><a class="dropdown-item text-info" href="/ml/analyze">
              <i class="bi bi-search me-2"></i>ML Analyze åˆ†æ</a></li>
            <li><hr class="dropdown-divider" style="border-color:#30363d"></li>
            <li><a class="dropdown-item " href="/ml/guide">
              <i class="bi bi-book me-2"></i>ML æ•™å­¸ Guide</a></li>
          </ul>
        </li>
      </ul>
      <ul class="navbar-nav gap-1">
        <li class="nav-item"><a class="nav-link" href="/latest-report" target="_blank"><i class="bi bi-file-earmark-text me-1"></i>Report</a></li>
      </ul>
    </div>
  </div>
</nav>

<div class="container-fluid py-3 px-4">
  
<!-- Search bar -->
<div class="row g-3 mb-4">
  <div class="col-12">
    <div class="d-flex gap-2 align-items-center">
      <h4 class="mb-0">
        <i class="bi bi-graph-up-arrow me-2" style="color:#3fb950"></i>
        ML å€‹è‚¡åˆ†æ <span style="color:#8b949e;font-size:13px">Martin Luk Pullback Analysis</span>
      </h4>
      <div class="input-group ms-auto" style="max-width:300px">
        <input type="text" class="form-control form-control-sm"
               id="tickerInput" placeholder="è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿâ€¦  e.g. AAPL"
               value="False" style="background:#0d1117;color:#c9d1d9;border-color:#30363d"
               onkeydown="if(event.key==='Enter') analyzeStock()">
        <button class="btn btn-sm" onclick="analyzeStock()"
                style="background:#238636;color:#fff;border:1px solid #2ea043">
          <i class="bi bi-search me-1"></i>åˆ†æ Analyze
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Loading -->
<div id="loadingArea" class="text-center py-5 d-none">
  <div class="spinner-border mb-3" style="color:#3fb950" role="status"></div>
  <div class="text-secondary">æ­£åœ¨åˆ†æä¸­â€¦ Analyzingâ€¦</div>
</div>

<!-- Empty state -->
<div id="emptyState" class="">
  <div class="text-center py-5 text-secondary">
    <i class="bi bi-graph-up-arrow" style="font-size:3rem;opacity:0.3;color:#3fb950"></i>
    <div class="mt-3">è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿä¸¦é»æ“Šã€Œåˆ†æã€</div>
    <div style="font-size:12px;margin-top:4px">Enter a ticker and click Analyze</div>
  </div>
</div>

<!-- Results -->
<div id="resultArea" class="d-none">

  <!-- Mode Selection -->
  <div class="mode-btn-group mb-4">
    <button class="mode-btn active" onclick="switchMlMode('review')">ğŸ” è¤‡ç›¤æ¨¡å¼ Review</button>
    <button class="mode-btn" onclick="switchMlMode('watch')">ğŸ“¡ ç›¯ç›¤æ¨¡å¼ Watch Market</button>
  </div>

  <!-- Review Panel (è¤‡ç›¤) -->
  <div id="reviewPanel">

  <!-- Row 1: Star + Setup + Dims -->
  <div class="row g-3 mb-3">
    <!-- Star rating -->
    <div class="col-12 col-md-3">
      <div class="card h-100 text-center">
        <div class="card-header"><i class="bi bi-star-fill me-1" style="color:#3fb950"></i>ML æ˜Ÿç´šè©•åˆ†</div>
        <div class="card-body d-flex flex-column align-items-center justify-content-center py-4">
          <div class="star-val" id="starDisplay">â€”</div>
          <div id="starStars" style="font-size:1.4rem;margin:8px 0"></div>
          <div id="vetoDisplay" class="d-none veto-alert w-100 text-center mt-2">
            <i class="bi bi-x-octagon-fill me-1"></i>VETO å¦æ±º
            <div id="vetoReason" style="font-size:11px;margin-top:4px"></div>
          </div>
          <div id="recDisplay" class="mt-3 badge fs-6" style="background:#1c2128;color:#8b949e"></div>
        </div>
      </div>
    </div>

    <!-- 7-dim scores -->
    <div class="col-12 col-md-5">
      <div class="card h-100">
        <div class="card-header">
          <i class="bi bi-bar-chart-steps me-1"></i>ä¸ƒç¶­è©•åˆ† 7-Dimension Scores
        </div>
        <div class="card-body" id="dimScoresArea">
          <div class="text-secondary text-center">â€”</div>
        </div>
      </div>
    </div>

    <!-- Quick info -->
    <div class="col-12 col-md-4">
      <div class="card h-100">
        <div class="card-header"><i class="bi bi-info-circle me-1"></i>åŸºæœ¬è³‡æ–™</div>
        <div class="card-body" id="infoArea">
          <div class="text-secondary text-center">â€”</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Row 2: Trade Plan -->
  <div class="row g-3 mb-3">
    <div class="col-12">
      <div class="card">
        <div class="card-header"><i class="bi bi-clipboard-data me-1" style="color:#3fb950"></i>äº¤æ˜“è¨ˆåŠƒ Trade Plan</div>
        <div class="card-body" id="tradePlanArea">
          <div class="text-secondary text-center">â€”</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Row 3: Daily Chart -->
  <div class="row g-3 mb-3">
    <div class="col-12">
      <div class="card">
        <div class="card-header d-flex align-items-center justify-content-between flex-wrap gap-2">
          <div>
            <i class="bi bi-graph-up me-1" style="color:#3fb950"></i>æ—¥ç·šåœ– Daily Chart
            <span style="font-size:11px;color:#8b949e">&nbsp;â€” EMA 9/21/50/150 + Anchored VWAP</span>
          </div>
          <div id="dailyRangeBtns" class="btn-group btn-group-sm">
            <button class="btn btn-outline-secondary chart-range-btn active" onclick="setDailyRange(63,this)">3M</button>
            <button class="btn btn-outline-secondary chart-range-btn" onclick="setDailyRange(126,this)">6M</button>
            <button class="btn btn-outline-secondary chart-range-btn" onclick="setDailyRange(252,this)">1Y</button>
            <button class="btn btn-outline-secondary chart-range-btn" onclick="setDailyRange(504,this)">2Y</button>
          </div>
        </div>
        <div class="card-body p-0">
          <!-- EMA legend â€” each item is a clickable toggle -->
          <div class="chart-legend" style="border-bottom:1px solid #21262d" title="é»æ“ŠæŒ‡æ¨™åç¨±å¯åˆ‡æ›é¡¯ç¤º / Click indicator name to toggle">
            <span class="ind-toggle" id="ml-lg-ema9"  onclick="toggleMlDailySeries('ema9',this)"><span style="display:inline-block;width:14px;height:2px;background:#00d4ff;vertical-align:middle"></span>&nbsp;EMA 9</span>
            <span class="ind-toggle" id="ml-lg-ema21" onclick="toggleMlDailySeries('ema21',this)"><span style="display:inline-block;width:14px;height:2px;background:#3fb950;vertical-align:middle"></span>&nbsp;EMA 21</span>
            <span class="ind-toggle" id="ml-lg-ema50" onclick="toggleMlDailySeries('ema50',this)"><span style="display:inline-block;width:14px;height:2px;background:#e3b341;vertical-align:middle"></span>&nbsp;EMA 50</span>
            <span class="ind-toggle" id="ml-lg-ema150" onclick="toggleMlDailySeries('ema150',this)"><span style="display:inline-block;width:14px;height:2px;background:#f85149;vertical-align:middle"></span>&nbsp;EMA 150</span>
            <span class="ind-toggle" id="ml-lg-avwap_high" onclick="toggleMlDailySeries('avwap_high',this)"><span style="display:inline-block;width:14px;height:1px;background:#d49fff;border-top:1px dashed #d49fff;vertical-align:middle"></span>&nbsp;AVWAP ä¾›çµ¦</span>
            <span class="ind-toggle" id="ml-lg-avwap_low" onclick="toggleMlDailySeries('avwap_low',this)"><span style="display:inline-block;width:14px;height:1px;background:#58a6ff;border-top:1px dashed #58a6ff;vertical-align:middle"></span>&nbsp;AVWAP æ”¯æ’</span>
            <span id="ml-avwap-anchor-info" style="font-size:10px;color:#6e7681;margin-left:4px"></span>
          </div>
          <div id="dailyChartContainer" style="height:420px">
            <div class="text-center py-5 text-secondary">
              <div class="spinner-border spinner-border-sm" style="color:#3fb950"></div>
              <div class="mt-2" style="font-size:12px">è¼‰å…¥åœ–è¡¨ Loading chartâ€¦</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Row 4: Weekly Chart -->
  <div class="row g-3 mb-3">
    <div class="col-12">
      <div class="card">
        <div class="card-header d-flex align-items-center justify-content-between flex-wrap gap-2">
          <div>
            <i class="bi bi-calendar-week me-1" style="color:#3fb950"></i>å‘¨ç·šåœ– Weekly Chart
            <span style="font-size:11px;color:#8b949e">&nbsp;â€” Martin Luk: ã€ŒWeekly è®“ Daily çš„æ··äº‚è®Šå¾—æ¸…æ™°ã€</span>
          </div>
          <div id="weeklyRangeBtns" class="btn-group btn-group-sm">
            <button class="btn btn-outline-secondary chart-range-btn" onclick="setWeeklyRange(52,this)">1Y</button>
            <button class="btn btn-outline-secondary chart-range-btn active" onclick="setWeeklyRange(104,this)">2Y</button>
            <button class="btn btn-outline-secondary chart-range-btn" onclick="setWeeklyRange(156,this)">3Y</button>
          </div>
        </div>
        <div class="card-body p-0">
          <div class="chart-legend" style="border-bottom:1px solid #21262d" title="é»æ“ŠæŒ‡æ¨™åç¨±å¯åˆ‡æ›é¡¯ç¤º">
            <span class="ind-toggle" id="ml-wk-lg-ema9w"  onclick="toggleMlWklySeries('ema9w',this)"><span style="display:inline-block;width:14px;height:2px;background:#00d4ff;vertical-align:middle"></span>&nbsp;W-EMA 9</span>
            <span class="ind-toggle" id="ml-wk-lg-ema21w" onclick="toggleMlWklySeries('ema21w',this)"><span style="display:inline-block;width:14px;height:2px;background:#3fb950;vertical-align:middle"></span>&nbsp;W-EMA 21</span>
            <span class="ind-toggle" id="ml-wk-lg-ema50w" onclick="toggleMlWklySeries('ema50w',this)"><span style="display:inline-block;width:14px;height:2px;background:#e3b341;vertical-align:middle"></span>&nbsp;W-EMA 50</span>
          </div>
          <div id="weeklyChartContainer" style="height:350px">
            <div class="text-center py-5 text-secondary">
              <div class="spinner-border spinner-border-sm" style="color:#3fb950"></div>
              <div class="mt-2" style="font-size:12px">è¼‰å…¥å‘¨ç·šåœ– Loading weekly chartâ€¦</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Row 5: Stop system -->
  <div class="row g-3 mb-3">
    <div class="col-12">
      <div class="card">
        <div class="card-header"><i class="bi bi-shield-exclamation me-1 text-danger"></i>ä¸‰éšæ®µæ­¢æç³»çµ± 3-Phase Stop System</div>
        <div class="card-body">
          <div class="stop-phase stop-phase-1">
            <strong>Phase 1 (Day 1)ï¼š</strong>æ­¢æ = ç•¶æ—¥æœ€ä½é» (LOD) ä¸‹æ–¹ 0.3%
            <div style="font-size:12px;color:#8b949e;margin-top:4px">Martin ç”¨æœ€ç·Šçš„æ­¢æï¼Œå› ç‚ºé€²å ´åœ¨å·²çŸ¥æ”¯æ’é»</div>
          </div>
          <div class="stop-phase stop-phase-2">
            <strong>Phase 2 (Day 2)ï¼š</strong>æ­¢æç§»è‡³æˆæœ¬åƒ¹ (breakeven)
            <div style="font-size:12px;color:#8b949e;margin-top:4px">å¿«é€Ÿè„«é›¢é¢¨éšªï¼Œè®“äº¤æ˜“è®Šæˆé›¶é¢¨éšª</div>
          </div>
          <div class="stop-phase stop-phase-3">
            <strong>Phase 3 (Day 3+)ï¼š</strong>è¿½è¹¤æ­¢æ = 9 EMA
            <div style="font-size:12px;color:#8b949e;margin-top:4px">æ”¶ç›¤è·Œç©¿ 9 EMA â†’ å‡ºå ´æ‰€æœ‰å‰©é¤˜æŒå€‰</div>
          </div>
          <div class="profit-step mt-3">
            <strong>éƒ¨åˆ†äº†çµï¼š</strong>3R å‡º 15% â†’ 5R å†å‡º 15% â†’ å‰©é¤˜ 70% è¿½è¹¤ 9 EMA
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Row 6: Martin Luk Commentary -->
  <div class="row g-3 mb-3">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <i class="bi bi-chat-quote me-1" style="color:#3fb950"></i>
          Martin Luk åˆ†æè©•èª
          <span style="font-size:11px;color:#8b949e">&nbsp;â€” ç‚ºä»€éº¼é€šé/ä¸é€šéç¯©é¸ï¼Œä»¥åŠå…¥å ´æ³¨æ„äº‹é …</span>
        </div>
        <div class="card-body" id="mlCommentaryArea">
          <div class="text-secondary text-center">â€”</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Row 7: Scan vs Analyze notice -->
  <div class="row g-3 mb-2" id="scanNoticeRow">
    <div class="col-12">
      <div class="alert alert-dark mb-0" style="font-size:12px;border-color:#30363d;background:#0d1117">
        <i class="bi bi-info-circle me-1" style="color:#58a6ff"></i>
        <strong>æƒæ vs å€‹è‚¡åˆ†æçš„å·®ç•°ï¼š</strong>
        æƒæï¼ˆScanï¼‰ä½¿ç”¨ç°¡åŒ–ç¯©é¸ï¼ˆADR + æˆäº¤é¡ï¼‰ï¼Œé€Ÿåº¦å¿«ä½†ä¸è¨ˆç®—ä¸ƒç¶­è©•åˆ†ã€‚
        å€‹è‚¡åˆ†æï¼ˆAnalyzeï¼‰æœƒé€²è¡Œå®Œæ•´è¨ˆç®—ï¼ŒåŒ…æ‹¬æ­¢æè·é›¢ã€EMAæ’åˆ—ã€æˆäº¤é‡æ¨¡å¼ç­‰ï¼Œ
        å› æ­¤éƒ¨åˆ†é€šéæƒæçš„è‚¡ç¥¨ï¼Œåœ¨å€‹è‚¡åˆ†æä¸­å¯èƒ½å¾—åˆ°è¼ƒä½è©•åˆ†æˆ– PASS å»ºè­° â€” <em>é€™æ˜¯æ­£å¸¸è¡Œç‚º</em>ã€‚
      </div>
    </div>
  </div>

  <!-- Watch Panel (ç›¯ç›¤) -->
  <div id="watchPanel" class="d-none">

    <!-- Status + Countdown -->
    <div class="watch-status-row">
      <div>
        <h5 class="mb-1"><span id="watchTicker" style="color:#3fb950">â€”</span> <span id="watchPrice" style="font-size:18px">â€”</span></h5>
        <div class="market-status" id="marketStatusBadge">
          <span class="live-pulse"></span>
          <span id="marketStatusLabel">å¸‚å ´ç‹€æ…‹</span>
        </div>
      </div>
      <div class="watch-countdown">
        <div>ä¸‹æ¬¡åˆ·æ–°</div>
        <div id="watchCountdown" style="font-size:14px; color:#3fb950">5:00</div>
      </div>
    </div>

    <!-- Premarket warning (é¡¯ç¤ºæ–¼ç›¤å‰) -->
    <div id="premktWarning" class="premarket-warning d-none">
      <i class="bi bi-info-circle me-1"></i>
      <strong>ç›¤å‰æ™‚æ®µ</strong> â€” æ•¸æ“šåŒ…å«ç¾æ± 4:00 - 9:30 é å¸‚äº¤æ˜“ã€‚ç›¤ä¸­çš„åœ–è¡¨è¡Œç‚ºå¯èƒ½èˆ‡ç›¤å‰ä¸åŒã€‚
    </div>

    <!-- Closed notice (é¡¯ç¤ºæ–¼ä¼‘å¸‚) -->
    <div id="closedNotice" class="closed-notice d-none">
      <i class="bi bi-x-circle me-1"></i>
      <strong>ç¾è‚¡ç¾å·²ä¼‘å¸‚</strong> â€” åˆ‡æ›è‡³<button class="btn btn-link p-0" style="color:#3fb950" onclick="switchMlMode('review')">è¤‡ç›¤æ¨¡å¼</button>æŸ¥çœ‹å®Œæ•´åˆ†æã€‚
    </div>

    <!-- Intraday Chart Selection -->
    <div class="intraday-btn-group">
      <button class="intraday-btn active" onclick="loadIntradayChart(document.getElementById('watchTicker').textContent, '5m')">5åˆ†é˜</button>
      <button class="intraday-btn" onclick="loadIntradayChart(document.getElementById('watchTicker').textContent, '15m')">15åˆ†é˜</button>
      <button class="intraday-btn" onclick="loadIntradayChart(document.getElementById('watchTicker').textContent, '1h')">1å°æ™‚</button>
    </div>

    <!-- Intraday Chart -->
    <div class="card mb-3">
      <div class="card-body p-0">
        <div class="intraday-legend">
          <span><span style="display:inline-block;width:14px;height:2px;background:#00d4ff"></span>&nbsp;EMA 9</span>
          <span><span style="display:inline-block;width:14px;height:2px;background:#3fb950"></span>&nbsp;EMA 21</span>
          <span><span style="display:inline-block;width:14px;height:2px;background:#ff9500"></span>&nbsp;Intraday VWAP</span>
          <span><span style="display:inline-block;width:14px;height:2px;background:#e3b341;border-top:1px dashed #e3b341"></span>&nbsp;ORH</span>
          <span><span style="display:inline-block;width:14px;height:2px;background:#f85149;border-top:1px dashed #f85149"></span>&nbsp;LOD</span>
          <span style="margin-left:auto; font-size:10px; color:#6e7681">ğŸ“ ç°è‰² = ç›¤å‰ Pre-Market</span>
        </div>
        <div id="intradayChartContainer" style="height:450px">
          <div class="text-center py-5 text-secondary">
            <div class="spinner-border spinner-border-sm" style="color:#3fb950"></div>
            <div class="mt-2" style="font-size:12px">è¼‰å…¥ç›¤ä¸­åœ–è¡¨â€¦</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Premarket Plan -->
    <div class="card mb-3" id="premktPlanCard">
      <div class="card-header">
        <i class="bi bi-clipboard-check me-1" style="color:#e3b341"></i>ç›¤å‰è¨ˆåŠƒ Premarket Plan
      </div>
      <div class="card-body" id="premktPlanArea">
        <div class="text-secondary text-center">â€”</div>
      </div>
    </div>

    <!-- Intraday Commentary -->
    <div class="card mb-3">
      <div class="card-header">
        <i class="bi bi-chat-dots me-1" style="color:#58a6ff"></i>æ—¥å…§äº¤æ˜“å»ºè­° Intraday Signals
        <span style="font-size:11px; color:#8b949e">&nbsp;(5åˆ†é˜è‡ªå‹•æ›´æ–°)</span>
      </div>
      <div class="card-body" id="intradayCommentaryArea">
        <div class="text-secondary text-center">â€”</div>
      </div>
    </div>

  </div>

</div>

</div>

<div id="toast-container"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// â”€â”€ Global settings for toast behavior â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TOAST_PERSIST_ALL = true; // Set to true to make all toasts persistent (don't auto-close)
const TOAST_SHOW_TIMESTAMP = true; // Set to true to show timestamp on all toasts
const TOAST_AUTO_CLOSE_MS = 0; // 0 = never auto-close; set to ms if you want auto-close (e.g., 4000)

// â”€â”€ Unified toast helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// All toasts now support persistent mode with timestamp by default
function toast(msg, ok=true, persist=null) {
  // Use global setting if persist not explicitly specified
  const isPersistent = persist !== null ? persist : TOAST_PERSIST_ALL;
  
  const el = document.createElement('div');
  el.className = 'toast-msg ' + (ok ? 'ok' : 'err');
  
  // Format timestamp
  let timestampHtml = '';
  if (TOAST_SHOW_TIMESTAMP) {
    const now = new Date();
    const timeStr = now.toLocaleString('zh-HK', { 
      hour:'2-digit', minute:'2-digit', second:'2-digit'
    });
    timestampHtml = '<small style="color:#8b949e; margin-top:4px; display:block; opacity:0.8;">æ™‚é–“: ' + timeStr + '</small>';
  }
  
  el.style.cssText = 'display:flex; align-items:flex-start; gap:8px; max-width:420px; padding:12px 16px;';
  
  const body = document.createElement('span');
  body.style.flex = '1';
  body.innerHTML = msg + timestampHtml;
  
  const btn = document.createElement('button');
  btn.innerHTML = '&times;';
  btn.style.cssText = 'background:none; border:none; color:#8b949e; font-size:1.2rem; cursor:pointer; padding:0; line-height:1; flex-shrink:0; margin-top:2px';
  btn.onclick = () => el.remove();
  btn.title = 'é—œé–‰é€šçŸ¥ (Close)';
  
  el.appendChild(body);
  el.appendChild(btn);
  document.getElementById('toast-container').appendChild(el);
  
  // Auto-close only if TOAST_AUTO_CLOSE_MS > 0 AND not persistent
  if (TOAST_AUTO_CLOSE_MS > 0 && !isPersistent) {
    setTimeout(() => { if (el.parentNode) el.remove(); }, TOAST_AUTO_CLOSE_MS);
  }
}

// â”€â”€ Alias for backward compatibility â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toastCompletion(msg, ok=true) {
  // Always persistent with explicit completion-style message
  toast(msg, ok, true);
}

// â”€â”€ Generic job poller â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function pollJob(statusUrl, onDone, onError, intervalMs=2500) {
  const id = setInterval(async () => {
    const r = await fetch(statusUrl).then(x => x.json()).catch(() => ({status:'error',error:'network'}));
    if (r.status === 'done') { clearInterval(id); onDone(r.result); }
    else if (r.status === 'error') { clearInterval(id); onError(r.error || 'Unknown error'); }
  }, intervalMs);
}

// â”€â”€ Score colour helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function scoreClass(v) {
  if (v >= 75) return 'score-high';
  if (v >= 55) return 'score-mid';
  return 'score-low';
}

// â”€â”€ Format number helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmt2(v) { return (v == null) ? 'â€”' : Number(v).toFixed(2); }
function fmtPct(v) { return (v == null) ? 'â€”' : Number(v).toFixed(1) + '%'; }
function fmtInt(v) { return (v == null) ? 'â€”' : Math.round(Number(v)); }
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el =>
    new bootstrap.Tooltip(el, { placement: 'top' })
  );
  const prefill = 'False';
  if (prefill) analyzeStock();
});

async function analyzeStock() {
  const ticker = document.getElementById('tickerInput').value.trim().toUpperCase();
  if (!ticker) return;

  document.getElementById('loadingArea').classList.remove('d-none');
  document.getElementById('emptyState').classList.add('d-none');
  document.getElementById('resultArea').classList.add('d-none');

  try {
    const resp = await fetch('/api/ml/analyze', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ ticker })
    });
    const data = await resp.json();

    if (!data.ok) {
      toast('åˆ†æå¤±æ•—ï¼š' + (data.error || ''), false);
      document.getElementById('loadingArea').classList.add('d-none');
      document.getElementById('emptyState').classList.remove('d-none');
      return;
    }

    renderAnalysis(data.result);
    document.getElementById('loadingArea').classList.add('d-none');
    document.getElementById('resultArea').classList.remove('d-none');
  } catch(e) {
    toast('åˆ†æå¤±æ•—ï¼š' + e, false);
    document.getElementById('loadingArea').classList.add('d-none');
    document.getElementById('emptyState').classList.remove('d-none');
  }
}

function renderAnalysis(r) {
  // Star rating
  const stars = parseFloat(r.capped_stars || 0);
  const starClass = stars >= 4.5 ? 'star-5' : stars >= 4 ? 'star-4' : stars >= 3 ? 'star-3' : 'star-low';
  document.getElementById('starDisplay').className = 'star-val ' + starClass;
  document.getElementById('starDisplay').textContent = stars.toFixed(1) + ' â˜…';
  const fullStars = Math.floor(stars);
  const half = (stars - fullStars) >= 0.5;
  let ss = '';
  for (let i = 0; i < fullStars; i++) ss += 'â­';
  if (half) ss += 'Â½';
  document.getElementById('starStars').textContent = ss;

  // Veto
  if (r.veto) {
    document.getElementById('vetoDisplay').classList.remove('d-none');
    document.getElementById('vetoReason').textContent =
      r.veto === 'RISK' ? 'æ­¢æè·é›¢éå¤§ > 2.5%' : 'ç†Šå¸‚å¦æ±º â€” ä¸‹é™è¶¨å‹¢';
  } else {
    document.getElementById('vetoDisplay').classList.add('d-none');
  }

  // Recommendation
  const rec = r.recommendation || '';
  const recZh = r.recommendation_zh || '';
  const recColors = {
    'STRONG BUY': '#3fb950', 'BUY': '#3fb950',
    'WATCH': '#e3b341', 'WEAK': '#8b949e', 'PASS': '#f85149'
  };
  const recEl = document.getElementById('recDisplay');
  recEl.textContent = `${rec} â€” ${recZh}`;
  recEl.style.background = recColors[rec] || '#1c2128';
  recEl.style.color = rec === 'PASS' ? '#fff' : '#0d1117';

  // 7-dim scores
  const dims = r.dim_scores || {};
  const dimLabels = {
    A: 'EMAçµæ§‹', B: 'å›èª¿å“è³ª', C: 'AVWAPåŒ¯åˆ',
    D: 'æˆäº¤é‡', E: 'é¢¨éšªå›å ±', F: 'ç›¸å°å¼·åº¦', G: 'å¸‚å ´ç’°å¢ƒ'
  };
  let dimHtml = '';
  for (const [key, label] of Object.entries(dimLabels)) {
    const d = dims[key] || {};
    const sc = parseFloat(d.score || 0);
    const pct = Math.max(0, Math.min(100, (sc + 2) / 4 * 100));
    const color = sc > 0 ? '#3fb950' : sc < 0 ? '#f85149' : '#8b949e';
    dimHtml += `
      <div class="d-flex align-items-center mb-2">
        <span style="width:100px;font-size:12px;color:#8b949e">${key}: ${label}</span>
        <div class="dim-bar-wrap flex-grow-1 mx-2">
          <div class="dim-bar" style="width:${pct}%;background:${color}"></div>
        </div>
        <span style="width:45px;text-align:right;font-size:13px;color:${color}">${sc >= 0 ? '+' : ''}${sc.toFixed(1)}</span>
      </div>`;
  }
  document.getElementById('dimScoresArea').innerHTML = dimHtml;

  // Quick info
  const setup = r.setup_type || {};
  const setupCode = (setup.primary_setup || 'UNKNOWN').toUpperCase();
  const setupBadge = setupBadgeHtml(setupCode);
  document.getElementById('infoArea').innerHTML = `
    <table class="table table-sm mb-0" style="font-size:13px">
      <tr><td class="text-secondary">è‚¡ç¥¨</td><td class="fw-bold" style="color:#3fb950">${r.ticker}</td></tr>
      <tr><td class="text-secondary">æ”¶ç›¤åƒ¹</td><td>$${(r.close || 0).toFixed(2)}</td></tr>
      <tr><td class="text-secondary">ADR (14æ—¥)</td><td>${(r.adr || 0).toFixed(1)}%</td></tr>
      <tr><td class="text-secondary">æ—¥æˆäº¤é¡</td><td>$${(r.dollar_volume_m || 0).toFixed(1)}M</td></tr>
      <tr><td class="text-secondary">3M å‹•é‡</td><td>${fmtMom(r.mom_3m)}</td></tr>
      <tr><td class="text-secondary">6M å‹•é‡</td><td>${fmtMom(r.mom_6m)}</td></tr>
      <tr><td class="text-secondary">å½¢æ…‹é¡å‹</td><td>${setupBadge} (ä¿¡å¿ƒ ${((setup.confidence || 0) * 100).toFixed(0)}%)</td></tr>
    </table>`;

  // Trade plan
  const tp = r.trade_plan || {};
  if (tp.action === 'BUY') {
    document.getElementById('tradePlanArea').innerHTML = `
      <div class="row g-3">
        <div class="col-12 mb-2">
          <code style="font-size:13px;color:#3fb950">${tp.formula || ''}</code>
        </div>
        <div class="col-6 col-md-2">
          <div class="trade-plan-card text-center">
            <div style="font-size:11px;color:#8b949e">é€²å ´ Entry</div>
            <div class="fw-bold" style="font-size:18px">$${(tp.entry || 0).toFixed(2)}</div>
          </div>
        </div>
        <div class="col-6 col-md-2">
          <div class="trade-plan-card text-center">
            <div style="font-size:11px;color:#f85149">æ­¢æ Stop</div>
            <div class="fw-bold text-danger" style="font-size:18px">$${(tp.stop || 0).toFixed(2)}</div>
            <div style="font-size:11px;color:#8b949e">${(tp.stop_pct || 0).toFixed(1)}%</div>
          </div>
        </div>
        <div class="col-6 col-md-2">
          <div class="trade-plan-card text-center">
            <div style="font-size:11px;color:#8b949e">è‚¡æ•¸ Shares</div>
            <div class="fw-bold" style="font-size:18px">${tp.shares || 0}</div>
          </div>
        </div>
        <div class="col-6 col-md-2">
          <div class="trade-plan-card text-center">
            <div style="font-size:11px;color:#8b949e">å€‰ä½é‡‘é¡</div>
            <div class="fw-bold" style="font-size:18px">$${(tp.position_value || 0).toLocaleString()}</div>
            <div style="font-size:11px;color:#8b949e">${(tp.position_pct || 0).toFixed(1)}%</div>
          </div>
        </div>
        <div class="col-6 col-md-2">
          <div class="trade-plan-card text-center">
            <div style="font-size:11px;color:#3fb950">3R ç›®æ¨™</div>
            <div class="fw-bold text-success" style="font-size:18px">${tp.target_1_price ? '$' + tp.target_1_price.toFixed(2) : 'â€”'}</div>
          </div>
        </div>
        <div class="col-6 col-md-2">
          <div class="trade-plan-card text-center">
            <div style="font-size:11px;color:#3fb950">5R ç›®æ¨™</div>
            <div class="fw-bold text-success" style="font-size:18px">${tp.target_2_price ? '$' + tp.target_2_price.toFixed(2) : 'â€”'}</div>
          </div>
        </div>
      </div>
      <div class="mt-2" style="font-size:12px;color:#8b949e">
        <i class="bi bi-shield me-1"></i>é¢¨éšªé‡‘é¡ï¼š$${(tp.risk_dollars || 0).toFixed(0)} (${(tp.risk_pct_of_account || 0).toFixed(2)}%)
        &nbsp;|&nbsp; ${tp.trail_label || ''}
      </div>`;
  } else {
    document.getElementById('tradePlanArea').innerHTML =
      '<div class="text-center text-secondary py-3"><i class="bi bi-x-circle me-1"></i>ä¸ç¬¦åˆäº¤æ˜“æ¢ä»¶ â€” ' +
      (tp.action || 'PASS') + '</div>';
  }

  // Store trade plan price levels for chart price lines
  const ticker = r.ticker || '';
  document.body.setAttribute('data-ml-entry', String(tp.entry || ''));
  document.body.setAttribute('data-ml-stop',  String(tp.stop || ''));
  document.body.setAttribute('data-ml-3r',    String(tp.target_1_price || ''));
  document.body.setAttribute('data-ml-5r',    String(tp.target_2_price || ''));

  // Load charts (non-blocking)
  _mlCurrentTicker = ticker;
  _mlWatchTicker = ticker;  // Store for watch mode
  loadDailyChart(ticker);
  loadWeeklyChart(ticker);
  renderMlCommentary(r);
  
  // Initialize watch mode with premarket plan if daily analysis available
  if (ticker && r) {
    renderPremktPlan(r);  // Populate premarket plan with daily analysis
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * Martin Luk Commentary â€” explain why pass/fail + what to watch
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderMlCommentary(r) {
  const el = document.getElementById('mlCommentaryArea');
  if (!el) return;

  const dims = r.dim_scores || {};
  const setup = r.setup_type || {};
  const tp = r.trade_plan || {};
  const setupCode = (setup.primary_setup || 'UNKNOWN').toUpperCase();
  const setupConf = ((setup.confidence || 0) * 100).toFixed(0);
  const stars = parseFloat(r.capped_stars || 0);
  let html = '';

  // â”€â”€ Section 1: Why pass/fail â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  html += '<div class="mb-3"><strong style="font-size:13px;color:#3fb950"><i class="bi bi-check2-circle me-1"></i>ç¯©é¸çµæœåˆ†æ</strong></div>';

  const passItems = [], warnItems = [], failItems = [];

  // Dim A: EMA Structure
  const a = dims.A || {}; const aD = a.detail || {};
  const aCls = a.score > 0 ? 'pass' : a.score < -0.5 ? 'fail' : 'warn';
  const aMsg = aD.stacking || 'â€”';
  const aRise = aD.rising || '';
  const aSlope = aD.slope || '';
  (aCls==='pass' ? passItems : aCls==='fail' ? failItems : warnItems).push(
    `<strong>A EMA\u6392\u5217</strong>\uff1a${aMsg}${aRise ? ' | ' + aRise : ''}${aSlope ? ' | ' + aSlope : ''}`
  );

  // Dim B: Pullback
  const b = dims.B || {}; const bD = b.detail || {};
  const bPb = bD.quality || 'â€”';
  const bExt = bD.extended || '';
  const bDepth = bD.depth || '';
  const bCls = b.score >= 0.5 ? 'pass' : b.score <= -0.8 ? 'fail' : 'warn';
  (bCls==='pass' ? passItems : bCls==='fail' ? failItems : warnItems).push(
    `<strong>B \u56de\u8abf\u54c1\u8cea</strong>\uff1a${bPb}${bDepth ? ' | ' + bDepth : ''}${bExt ? ' | ' + bExt : ''}`
  );

  // Dim C: AVWAP
  const c = dims.C || {}; const cD = c.detail || {};
  const cStatus = cD.avwap_status || 'â€”';
  const cProx = cD.support_proximity || '';
  const cCls = c.score > 0.5 ? 'pass' : c.score < -0.2 ? 'fail' : 'warn';
  (cCls==='pass' ? passItems : cCls==='fail' ? failItems : warnItems).push(
    `<strong>C AVWAP\u532f\u5408</strong>\uff1a${cStatus}${cProx ? ' | <em>' + cProx + '</em>' : ''}`
  );

  // Dim D: Volume
  const d = dims.D || {}; const dD = d.detail || {};
  const dDry = dD.dry_up || 'â€”';
  const dSurge = dD.surge || '';
  const dCls = d.score >= 0.5 ? 'pass' : d.score < 0 ? 'warn' : 'warn';
  (dCls==='pass' ? passItems : warnItems).push(
    `<strong>D \u6210\u4ea4\u91cf\u6a21\u5f0f</strong>\uff1a${dDry}${dSurge ? ' | ' + dSurge : ''}`
  );

  // Dim E: Risk
  const e = dims.E || {}; const eD = e.detail || {};
  const eStop = eD.stop || 'â€”';
  const eRR = eD.rr_3r_target || '';
  const eCls = e.is_veto ? 'fail' : e.score > 0 ? 'pass' : 'warn';
  (eCls==='pass' ? passItems : eCls==='fail' ? failItems : warnItems).push(
    `<strong>E \u98a8\u96aa\u56de\u5831</strong>\uff1a${eStop}${eRR ? ' | ' + eRR : ''}`
  );

  // Dim F: RS
  const f = dims.F || {}; const fD = f.detail || {};
  const fRS = fD.rs || 'â€”';
  const fCls = f.score > 0 ? 'pass' : f.score < -0.3 ? 'fail' : 'warn';
  (fCls==='pass' ? passItems : fCls==='fail' ? failItems : warnItems).push(
    `<strong>F \u76f8\u5c0d\u5f37\u5ea6</strong>\uff1a${fRS}`
  );

  // Dim G: Market
  const g = dims.G || {}; const gD = g.detail || {};
  const gStatus = gD.regime || gD.status || (g.score >= 0 ? '\u5e02\u5834\u6709\u5229' : '\u5e02\u5834\u4e0d\u5229');
  const gCls = g.score >= 0 ? 'pass' : 'fail';
  (gCls==='pass' ? passItems : failItems).push(
    `<strong>G \u5e02\u5834\u74b0\u5883</strong>\uff1a${gStatus}`
  );

  // Render pass/warn/fail lists
  passItems.forEach(t => { html += `<div class="cmt-pass">\u2705 ${t}</div>`; });
  warnItems.forEach(t => { html += `<div class="cmt-warn">\u26a0\ufe0f ${t}</div>`; });
  failItems.forEach(t => { html += `<div class="cmt-fail">\u274c ${t}</div>`; });

  // â”€â”€ Section 2: Setup interpretation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  html += '<div class="mt-3 mb-2"><strong style="font-size:13px;color:#58a6ff"><i class="bi bi-diagram-3 me-1"></i>\u5f62\u614b\u89e3\u8b80</strong></div>';
  const setupDesc = {
    'PB_EMA':    `EMA\u56de\u8abf\u8cb7\u5165 \u2014 \u80a1\u50f9\u56de\u8abf\u81f3 21/50 EMA \u4e14\u6709\u6210\u4ea4\u91cf\u840e\u7e2e\u8a0a\u865f\u3002\u9019\u662f Martin \u6700\u559c\u6b61\u7684\u5165\u5834\u6a21\u5f0f\uff0c\u98a8\u96aa\u6700\u4f4e\u3002`,
    'BR_RETEST': `\u7a81\u7834\u56de\u6e2c \u2014 \u80a1\u50f9\u4e4b\u524d\u7a81\u7834\u5f37\u963b\u529b\u5f8c\u56de\u6e2c\u8a72\u5340\u57df\uff0c\u73fe\u5728\u8a72\u5340\u57df\u63d0\u4f9b\u652f\u6490\u3002\u5165\u5834\u81f3\u56de\u6e2c\u4f4e\u9ede\u4e0a\u65b9\u3002`,
    'BREAKOUT':  `\u7a81\u7834\u5f35 \u2014 \u80a1\u50f9\u77e5\u7a81\u7834\u5386\u53f2\u9ad8\u9ede\u6216\u91cd\u8981\u5340\u57df\u3002Martin \u8b66\u793a\u4e0d\u8981\u8ffd\u9ad8\uff0c\u6700\u597d\u5728\u7a81\u7834\u7b2c\u4e00\u6b65\u5165\u5834\u3002`,
    'EP':        `\u8df3\u7a7a\u7f3a\u53e3 (EP) \u2014 \u8ca1\u5831/\u5927\u6d88\u606f\u5f15\u767c\u7684\u9593\u7a7a\u4f4e\u958b\uff0c\u6210\u4ea4\u91cf\u7206\u767c\u3002\u9019\u662f\u9ad8\u98a8\u96aa\u9ad8\u56de\u5831\u7684\u8a2d\u7f6e\uff0c\u9700\u8981\u7dbf\u5bc6\u7684\u6b62\u640d\u7ba1\u7406\u3002`,
    'CHAR_CHG':  `\u8d70\u52e2\u8f49\u8b8a (Character Change) \u2014 \u80a1\u50f9\u5f9e\u512a\u5f31\u8a66\u8f49\u70ba\u5f37\u52e2\u3002\u8a72\u5f62\u614b\u8868\u793a\u5927\u8cc7\u91d1\u958b\u59cb\u7a4d\u7d2f\u3002`,
    'PARABOLIC': `\u62cb\u7269\u7dda\u4e0a\u6f32 \u2014 \u80a1\u50f9\u7d93\u6b77\u6025\u5021\u5347\uff0c\u9ad8\u98a8\u96aa\u5165\u5834\u3002Martin \u901a\u5e38\u6703\u7b49\u5f85\u56de\u8abf\u5f8c\u518d\u518d\u5165\u5834\u3002`,
  };
  const sdesc = setupDesc[setupCode] || `\u672a\u8b58\u5225\u5f62\u614b (${setupCode})\u3002`;
  html += `<div class="cmt-info"><strong>${setupCode}</strong>\uff08\u4fe1\u5fc3\u5ea6 ${setupConf}%\uff09\uff1a${sdesc}</div>`;

  // â”€â”€ Section 3: What Martin would watch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  html += '<div class="mt-3 mb-2"><strong style="font-size:13px;color:#e3b341"><i class="bi bi-eye me-1"></i>Martin \u5165\u5834\u6ce8\u610f\u4e8b\u9805</strong></div>';
  const watchPoints = [];

  // Based on setup type
  if (setupCode === 'PB_EMA' || setupCode === 'BR_RETEST') {
    watchPoints.push('\u78ba\u8a8d\u56de\u8abf\u65e5\u6210\u4ea4\u91cf<strong>\u8457\u5be6\u840e\u7e2e</strong>\uff0c\u7d55\u5c0d\u4e0d\u8981\u5728\u9ad8\u6210\u4ea4\u91cf\u56de\u8abf\u65e5\u5165\u5834');
    watchPoints.push('\u5f85\u80a1\u50f9<strong>\u53cd\u5f48\u81f3 21 EMA \u4e0a\u65b9</strong>\u4e14\u6613\u65e5\u6536\u9234\u8207\u4e0a\u65e5\u6536\u9234\u76f8\u8fd1\u6216\u9ad8\u65bc\u4e0a\u65e5\u6642\u624d\u5165\u5834');
  }
  if (setupCode === 'EP') {
    watchPoints.push('\u8df3\u7a7a\u7f3a\u53e3\u5165\u5834\uff1a\u5728<strong>\u958b\u5e02\u524d 30 \u5206\u9418</strong>\u6c7a\u5b9a\u662f\u5426\u5165\u5834\uff0c\u907f\u514d\u5728\u958b\u5e02\u5377\u52d5\u671f\u9032\u5165');
    watchPoints.push('\u786e\u8a8d\u7f3a\u53e3\u5f8c\u80a1\u50f9<strong>\u4e0d\u56de\u586b\u7f3a\u53e3</strong>\uff0c\u5982\u56de\u586b\u5247\u8a8d\u8f38\u51fa\u5834');
  }

  // Based on dim scores
  if ((aD.stacking || '').includes('\u5b8c\u7f8e')) {
    watchPoints.push('EMA \u5b8c\u7f8e\u6392\u5217\u2014\u8a72\u80a1\u7b26\u5408 Martin \u7684\u6838\u5fc3\u7be9\u9078\u689d\u4ef6\uff0c\u8da8\u52e2\u4e2d\u56de\u8abf\u901a\u5e38\u5c31\u662f\u6700\u597d\u7684\u5165\u5834\u6a5f\u6703');
  }
  if (cD.support_proximity) {
    watchPoints.push(`\u80a1\u50f9\u63a5\u8fd1\u652f\u6490 AVWAP \u2014 <em>${cD.support_proximity}</em>\uff0c\u76e3\u632f\u7b49\u5019\u78ba\u8a8d\u652f\u6490\u4f5c\u7528`);
  }
  if ((bD.extended || '').includes('\u904e\u5ea6')) {
    watchPoints.push('\u26a0\ufe0f \u80a1\u50f9\u904e\u5ea6\u5ef6\u4f38\uff0cMartin \u4e0d\u6703\u8ffd\u9ad8\uff0c\u7b49\u5f85<strong>\u6b63\u5e38\u7684\u56de\u8abf\u78ba\u8a8d\u652f\u6490</strong>\u524d\u518d\u8003\u616e\u5165\u5834');
  }
  if (e.is_veto) {
    watchPoints.push('\u274c \u6b62\u640d\u5927\u65bc 2.5%\uff0cMartin \u4e0d\u4f1a\u9032\u5165\u6b64\u8001\uff0c\u7b49\u5f85\u80a1\u50f9\u7d50\u69cb\u6539\u5584\uff08\u66f4\u7dca\u5bc6\u7684\u79fb\u52d5\u6a21\u5f0f\uff09');
  }

  // General watchpoints
  watchPoints.push('\u91cd\u8981\u652f\u6490\u4f4d\uff1aEMA9 (\u6700\u77ed\u671f\u653f\u7b56)\u3001EMA21 (\u4e2d\u671f\u8da8\u52e2)\u3001\u652f\u6490 AVWAP \u4e09\u5c64\u652f\u6490\u5171\u5c45\u70ba\u7406\u683c\u5165\u5834\u6dfb');
  watchPoints.push('\u5165\u5834\u5f8c\u7b2c 1 \u5929\uff1a\u786e\u8a8d<strong>\u6536\u9234\u9ad8\u65bc\u958b\u9234</strong>\uff0c\u5426\u5247\u5373\u65e5\u51fa\u5834 (Martin \u4e0d\u6301\u6709\u8f38\u5bb6)');
  if (stars >= 4.0) {
    watchPoints.push('\u2605 \u8a55\u5206 ' + stars.toFixed(1) + '\u2605\uff0c\u78ba\u8a8d\u50c5\u7136\u6709\u6548 \u2014 Martin \u6703\u7528\u6b64\u5206\u6578\u51b3\u5b9a\u5009\u4f4d\u5927\u5c0f\uff1a' + stars.toFixed(1) + '\u2605 = ' + (stars >= 4.5 ? '15-25' : '10-15') + '% \u8cc7\u91d1\u914d\u7f6e');
  }

  watchPoints.forEach(p => { html += `<div class="cmt-info" style="border-left-color:#e3b341;background:#1a1000">\ud83d\udc40 ${p}</div>`; });

  el.innerHTML = html;
}

function setupBadgeHtml(code) {
  const map = {
    'PB_EMA':   ['badge-pb',  'PB_EMA',  'EMAå›èª¿è²·å…¥'],
    'BR_RETEST':['badge-br',  'BR_RETEST','çªç ´å›æ¸¬'],
    'BREAKOUT': ['badge-bo',  'BREAKOUT', 'çªç ´'],
    'EP':       ['badge-ep',  'EP',       'è·³ç©ºç¼ºå£'],
    'CHAR_CHG': ['badge-chg', 'CHAR_CHG', 'èµ°å‹¢è½‰è®Š'],
    'PARABOLIC':['badge-para','PARA',     'æ‹‹ç‰©ç·š'],
  };
  const info = map[code] || ['badge-uk', code || '?', 'æœªåˆ†é¡'];
  return `<span class="badge ${info[0]}">${info[1]}</span>`;
}

function fmtMom(v) {
  if (v == null) return 'â€”';
  const n = parseFloat(v);
  const cls = n >= 0 ? 'text-success' : 'text-danger';
  return `<span class="${cls}">${n >= 0 ? '+' : ''}${n.toFixed(1)}%</span>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * LightweightCharts â€” Daily & Weekly for Martin Luk methodology
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let _mlDailyChart = null, _mlWeeklyChart = null;
let _mlDailyCandleSeries = null;
let _mlDailyData = null, _mlWeeklyData = null;
let _mlCurrentTicker = null;
let _mlDailySeriesMap = {};   // key â†’ LWC series
let _mlWklySeriesMap  = {};   // key â†’ LWC series
let _mlDailySeriesVisible = {};  // key â†’ bool
let _mlWklySeriesVisible  = {};  // key â†’ bool

/* ---------- helpers ---------- */
function _destroyMlChart(which) {
  if (which === 'daily' && _mlDailyChart) {
    try { _mlDailyChart.remove(); } catch(e) {}
    _mlDailyChart = null; _mlDailyCandleSeries = null; _mlDailyData = null;
    _mlDailySeriesMap = {}; _mlDailySeriesVisible = {};
  }
  if (which === 'weekly' && _mlWeeklyChart) {
    try { _mlWeeklyChart.remove(); } catch(e) {}
    _mlWeeklyChart = null; _mlWeeklyData = null;
    _mlWklySeriesMap = {}; _mlWklySeriesVisible = {};
  }
}

/* ---------- Daily Chart ---------- */
async function loadDailyChart(ticker) {
  const container = document.getElementById('dailyChartContainer');
  if (!container) return;
  container.innerHTML = '<div class="text-center py-5 text-secondary"><div class="spinner-border spinner-border-sm" style="color:#3fb950"></div><div class="mt-2" style="font-size:12px">è¼‰å…¥åœ–è¡¨â€¦</div></div>';
  _destroyMlChart('daily');

  try {
    const resp = await fetch(`/api/chart/enriched/${ticker}?days=504`);
    if (!resp.ok) throw new Error('API ' + resp.status);
    const data = await resp.json();
    if (!data.ok || !data.candles || !data.candles.length) throw new Error(data.error || 'No data');
    _mlDailyData = data;

    container.innerHTML = '';
    const LWC = LightweightCharts;
    _mlDailyChart = LWC.createChart(container, {
      width: container.clientWidth || window.innerWidth - 40,
      height: 420,
      layout: { background: { color: '#0d1117' }, textColor: '#8b949e' },
      grid: { vertLines: { color: '#21262d' }, horzLines: { color: '#21262d' } },
      crosshair: { mode: LWC.CrosshairMode.Normal },
      rightPriceScale: { borderColor: '#30363d' },
      timeScale: { borderColor: '#30363d', timeVisible: true, secondsVisible: false },
      handleScroll: true, handleScale: true,
    });

    // Candlestick
    _mlDailyCandleSeries = _mlDailyChart.addCandlestickSeries({
      upColor: '#3fb950', downColor: '#f85149',
      borderUpColor: '#3fb950', borderDownColor: '#f85149',
      wickUpColor: '#3fb950', wickDownColor: '#f85149',
    });
    _mlDailyCandleSeries.setData(data.candles);

    // Volume (lower 18%)
    if (data.volume && data.volume.length) {
      const volS = _mlDailyChart.addHistogramSeries({
        priceFormat: { type: 'volume' }, priceScaleId: 'vol',
      });
      _mlDailyChart.priceScale('vol').applyOptions({
        scaleMargins: { top: 0.82, bottom: 0 },
        drawTicks: false, borderVisible: false,
      });
      volS.setData(data.volume);
    }

    // EMA overlays (Martin Luk uses EMA, not SMA)
    const emaSeriesCfg = [
      { key: 'ema9',   color: '#00d4ff', title: 'EMA 9' },
      { key: 'ema21',  color: '#3fb950', title: 'EMA 21' },
      { key: 'ema50',  color: '#e3b341', title: 'EMA 50' },
      { key: 'ema150', color: '#f85149', title: 'EMA 150' },
    ];
    emaSeriesCfg.forEach(({ key, color, title }) => {
      if (data[key] && data[key].length) {
        const s = _mlDailyChart.addLineSeries({
          color, lineWidth: 1.5, title,
          priceLineVisible: false, lastValueVisible: false,
        });
        s.setData(data[key]);
        _mlDailySeriesMap[key] = s;
        _mlDailySeriesVisible[key] = true;
      }
    });

    // AVWAP from swing high (ä¾›çµ¦/resistance) â€” dashed orange-ish purple
    if (data.avwap_high && data.avwap_high.length) {
      const s = _mlDailyChart.addLineSeries({
        color: '#d49fff', lineWidth: 1.5, lineStyle: 2,
        title: 'AVWAP ä¾›çµ¦',
        priceLineVisible: false, lastValueVisible: false,
      });
      s.setData(data.avwap_high);
      _mlDailySeriesMap['avwap_high'] = s;
      _mlDailySeriesVisible['avwap_high'] = true;
    }
    // AVWAP from swing low (æ”¯æ’/support) â€” dashed blue
    if (data.avwap_low && data.avwap_low.length) {
      const s = _mlDailyChart.addLineSeries({
        color: '#58a6ff', lineWidth: 1.5, lineStyle: 2,
        title: 'AVWAP æ”¯æ’',
        priceLineVisible: false, lastValueVisible: false,
      });
      s.setData(data.avwap_low);
      _mlDailySeriesMap['avwap_low'] = s;
      _mlDailySeriesVisible['avwap_low'] = true;
    }

    // Trade plan price lines
    const entry = parseFloat(document.body.getAttribute('data-ml-entry'));
    const stop  = parseFloat(document.body.getAttribute('data-ml-stop'));
    const t3r   = parseFloat(document.body.getAttribute('data-ml-3r'));
    const t5r   = parseFloat(document.body.getAttribute('data-ml-5r'));

    if (entry && !isNaN(entry)) {
      _mlDailyCandleSeries.createPriceLine({
        price: entry, color: '#3fb950', lineWidth: 2, lineStyle: 2,
        axisLabelVisible: true, title: `Entry $${entry.toFixed(2)}`,
      });
    }
    if (stop && !isNaN(stop)) {
      _mlDailyCandleSeries.createPriceLine({
        price: stop, color: '#f85149', lineWidth: 2, lineStyle: 2,
        axisLabelVisible: true, title: `Stop $${stop.toFixed(2)}`,
      });
    }
    if (t3r && !isNaN(t3r)) {
      _mlDailyCandleSeries.createPriceLine({
        price: t3r, color: '#58a6ff', lineWidth: 1, lineStyle: 2,
        axisLabelVisible: true, title: `3R $${t3r.toFixed(2)}`,
      });
    }
    if (t5r && !isNaN(t5r)) {
      _mlDailyCandleSeries.createPriceLine({
        price: t5r, color: '#00d4ff', lineWidth: 1, lineStyle: 2,
        axisLabelVisible: true, title: `5R $${t5r.toFixed(2)}`,
      });
    }

    _mlDailyChart.timeScale().fitContent();
    // Default to 3M so AVWAP lines are visible (they start from recent swing points)
    setTimeout(() => {
      if (_mlDailyData && _mlDailyData.candles) {
        setDailyRange(63, document.querySelector('#dailyRangeBtns .active'));
      }
    }, 50);

    // Show AVWAP anchor dates in legend
    const anchorInfo = document.getElementById('ml-avwap-anchor-info');
    if (anchorInfo) {
      const ah = data.avwap_high_anchor, al = data.avwap_low_anchor;
      let parts = [];
      if (ah && ah.date) parts.push(`ä¾›çµ¦éŒ¨: ${ah.date}`);
      if (al && al.date) parts.push(`æ”¯æ’éŒ¨: ${al.date}`);
      anchorInfo.textContent = parts.length ? `â‘  AVWAP éŒ¨é» â€” ${parts.join(' | ')}` : '';
    }

    // Responsive resize
    new ResizeObserver(() => {
      const w = container.clientWidth || window.innerWidth - 40;
      if (_mlDailyChart) _mlDailyChart.applyOptions({ width: w });
    }).observe(container);

  } catch(e) {
    console.error('loadDailyChart error:', e);
    container.innerHTML = `<div class="text-secondary text-center py-4">
      <i class="bi bi-graph-up" style="font-size:2rem;opacity:0.3"></i>
      <div class="mt-2" style="font-size:12px">æ—¥ç·šåœ–è¼‰å…¥å¤±æ•— Daily chart unavailable</div>
      <div class="mt-1" style="font-size:10px;opacity:0.7">${e.message || ''}</div>
    </div>`;
  }
}

/* ---------- Weekly Chart ---------- */
async function loadWeeklyChart(ticker) {
  const container = document.getElementById('weeklyChartContainer');
  if (!container) return;
  container.innerHTML = '<div class="text-center py-5 text-secondary"><div class="spinner-border spinner-border-sm" style="color:#3fb950"></div><div class="mt-2" style="font-size:12px">è¼‰å…¥å‘¨ç·šåœ–â€¦</div></div>';
  _destroyMlChart('weekly');

  try {
    const resp = await fetch(`/api/chart/weekly/${ticker}`);
    if (!resp.ok) throw new Error('API ' + resp.status);
    const data = await resp.json();
    if (!data.ok || !data.candles || !data.candles.length) throw new Error(data.error || 'No data');
    _mlWeeklyData = data;

    container.innerHTML = '';
    const LWC = LightweightCharts;
    _mlWeeklyChart = LWC.createChart(container, {
      width: container.clientWidth || window.innerWidth - 40,
      height: 350,
      layout: { background: { color: '#0d1117' }, textColor: '#8b949e' },
      grid: { vertLines: { color: '#21262d' }, horzLines: { color: '#21262d' } },
      crosshair: { mode: LWC.CrosshairMode.Normal },
      rightPriceScale: { borderColor: '#30363d' },
      timeScale: { borderColor: '#30363d', timeVisible: false },
      handleScroll: true, handleScale: true,
    });

    // Candlestick
    const wCandles = _mlWeeklyChart.addCandlestickSeries({
      upColor: '#3fb950', downColor: '#f85149',
      borderUpColor: '#3fb950', borderDownColor: '#f85149',
      wickUpColor: '#3fb950', wickDownColor: '#f85149',
    });
    wCandles.setData(data.candles);

    // Volume
    if (data.volume && data.volume.length) {
      const wVol = _mlWeeklyChart.addHistogramSeries({
        priceFormat: { type: 'volume' }, priceScaleId: 'vol',
      });
      _mlWeeklyChart.priceScale('vol').applyOptions({
        scaleMargins: { top: 0.82, bottom: 0 },
        drawTicks: false, borderVisible: false,
      });
      wVol.setData(data.volume);
    }

    // Weekly EMA overlays
    const wmaSeriesCfg = [
      { key: 'ema9w',  color: '#00d4ff', title: 'W-EMA 9'  },
      { key: 'ema21w', color: '#3fb950', title: 'W-EMA 21' },
      { key: 'ema50w', color: '#e3b341', title: 'W-EMA 50' },
    ];
    wmaSeriesCfg.forEach(({ key, color, title }) => {
      if (data[key] && data[key].length) {
        const s = _mlWeeklyChart.addLineSeries({
          color, lineWidth: 1.5, title,
          priceLineVisible: false, lastValueVisible: false,
        });
        s.setData(data[key]);
        _mlWklySeriesMap[key] = s;
        _mlWklySeriesVisible[key] = true;
      }
    });

    _mlWeeklyChart.timeScale().fitContent();

    new ResizeObserver(() => {
      const w = container.clientWidth || window.innerWidth - 40;
      if (_mlWeeklyChart) _mlWeeklyChart.applyOptions({ width: w });
    }).observe(container);

  } catch(e) {
    console.error('loadWeeklyChart error:', e);
    container.innerHTML = `<div class="text-secondary text-center py-4">
      <i class="bi bi-calendar-week" style="font-size:2rem;opacity:0.3"></i>
      <div class="mt-2" style="font-size:12px">å‘¨ç·šåœ–è¼‰å…¥å¤±æ•— Weekly chart unavailable</div>
      <div class="mt-1" style="font-size:10px;opacity:0.7">${e.message || ''}</div>
    </div>`;
  }
}

/* ---------- Range controls ---------- */
function setDailyRange(days, btn) {
  if (!_mlDailyChart || !_mlDailyData) return;
  const candles = _mlDailyData.candles;
  if (!candles.length) return;
  const from = candles[Math.max(0, candles.length - days)].time;
  _mlDailyChart.timeScale().setVisibleRange({ from, to: candles[candles.length - 1].time });
  document.querySelectorAll('#dailyRangeBtns .chart-range-btn').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
}

function setWeeklyRange(weeks, btn) {
  if (!_mlWeeklyChart || !_mlWeeklyData) return;
  const candles = _mlWeeklyData.candles;
  if (!candles.length) return;
  const from = candles[Math.max(0, candles.length - weeks)].time;
  _mlWeeklyChart.timeScale().setVisibleRange({ from, to: candles[candles.length - 1].time });
  document.querySelectorAll('#weeklyRangeBtns .chart-range-btn').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
}

/* ---------- Indicator toggles ---------- */
function toggleMlDailySeries(key, legendEl) {
  const s = _mlDailySeriesMap[key];
  if (!s) return;
  _mlDailySeriesVisible[key] = !_mlDailySeriesVisible[key];
  s.applyOptions({ visible: _mlDailySeriesVisible[key] });
  if (legendEl) legendEl.classList.toggle('toggled-off', !_mlDailySeriesVisible[key]);
}

function toggleMlWklySeries(key, legendEl) {
  const s = _mlWklySeriesMap[key];
  if (!s) return;
  _mlWklySeriesVisible[key] = !_mlWklySeriesVisible[key];
  s.applyOptions({ visible: _mlWklySeriesVisible[key] });
  if (legendEl) legendEl.classList.toggle('toggled-off', !_mlWklySeriesVisible[key]);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * WATCH MODE â€” ç›¯ç›¤æ¨¡å¼ (Intraday Live Trading)
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let _mlWatchTicker = null;
let _mlWatchCurrentInterval = '5m';
let _mlWatchChart = null;
let _mlWatchData = null;
let _mlWatchInterval = null;
let _mlCountdownInterval = null;
let _mlCountdownRemaining = 300; // 5 minutes

function getMarketStatus() {
  // Determine market status: using Intl.DateTimeFormat to get NY time
  const formatter = new Intl.DateTimeFormat('en-US', {
    timeZone: 'America/New_York',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit',
    hour12: false
  });
  const parts = formatter.formatToParts(new Date());
  let h = parseInt(parts.find(p => p.type === 'hour').value);
  let m = parseInt(parts.find(p => p.type === 'minute').value);
  
  if ((h < 4) || (h >= 20)) {
    return { status: 'closed', label: 'ç¾è‚¡æœªé–‹ç›¤', color: '#1c2128' };
  } else if (h < 9 || (h === 9 && m < 30)) {
    return { status: 'premarket', label: 'ç›¤å‰ Pre-Market', color: '#e3b341' };
  } else if (h < 16) {
    return { status: 'open', label: 'ç›¤ä¸­ Open', color: '#3fb950' };
  } else {
    return { status: 'afterhours', label: 'ç›¤å¾Œ After-Hours', color: '#58a6ff' };
  }
}

function switchMlMode(mode) {
  const reviewPanel = document.getElementById('reviewPanel');
  const watchPanel = document.getElementById('watchPanel');
  const modeBtns = document.querySelectorAll('.mode-btn');
  
  if (mode === 'review') {
    reviewPanel.classList.remove('d-none');
    watchPanel.classList.add('d-none');
    modeBtns[0].classList.add('active');
    modeBtns[1].classList.remove('active');
    if (_mlWatchInterval) clearInterval(_mlWatchInterval);
    if (_mlCountdownInterval) clearInterval(_mlCountdownInterval);
  } else {
    reviewPanel.classList.add('d-none');
    watchPanel.classList.remove('d-none');
    modeBtns[0].classList.remove('active');
    modeBtns[1].classList.add('active');
    // Initialize watch mode if we have a ticker
    const ticker = document.getElementById('tickerInput').value.trim().toUpperCase();
    if (ticker) {
      initWatchMode(ticker);
    }
  }
}

function initWatchMode(ticker) {
  _mlWatchTicker = ticker;
  document.getElementById('watchTicker').textContent = ticker;
  
  // Update market status
  updateMarketStatus();
  
  // Load intraday chart
  loadIntradayChart(ticker, '5m');
  
  // Start auto-refresh every 5 minutes
  if (_mlWatchInterval) clearInterval(_mlWatchInterval);
  _mlWatchInterval = setInterval(() => refreshWatchMode(ticker), 300000);
  
  // Start countdown timer
  startCountdownTimer();
}

function updateMarketStatus() {
  const status = getMarketStatus();
  const badge = document.getElementById('marketStatusBadge');
  const label = document.getElementById('marketStatusLabel');
  const premktWarning = document.getElementById('premktWarning');
  const closedNotice = document.getElementById('closedNotice');
  const premktPlanCard = document.getElementById('premktPlanCard');
  
  badge.className = 'market-status ' + status.status;
  label.textContent = status.label;
  
  if (status.status === 'premarket') {
    premktWarning.classList.remove('d-none');
    premktPlanCard.classList.remove('d-none');
    closedNotice.classList.add('d-none');
  } else if (status.status === 'closed') {
    closedNotice.classList.remove('d-none');
    premktWarning.classList.add('d-none');
    premktPlanCard.classList.add('d-none');
  } else {
    premktWarning.classList.add('d-none');
    closedNotice.classList.add('d-none');
    premktPlanCard.classList.remove('d-none');
  }
}

function startCountdownTimer() {
  _mlCountdownRemaining = 300;
  if (_mlCountdownInterval) clearInterval(_mlCountdownInterval);
  _mlCountdownInterval = setInterval(() => {
    _mlCountdownRemaining--;
    const mins = Math.floor(_mlCountdownRemaining / 60);
    const secs = _mlCountdownRemaining % 60;
    document.getElementById('watchCountdown').textContent = 
      mins + ':' + (secs < 10 ? '0' : '') + secs;
    if (_mlCountdownRemaining <= 0) {
      clearInterval(_mlCountdownInterval);
    }
  }, 1000);
}

async function loadIntradayChart(ticker, interval) {
  const container = document.getElementById('intradayChartContainer');
  if (!container) return;
  
  // Update active button based on interval parameter (not event.target)
  document.querySelectorAll('.intraday-btn').forEach((btn) => {
    btn.classList.remove('active');
    // Find button with matching text content
    const btnText = btn.textContent.trim();
    const shouldBeActive = 
      (interval === '5m' && btnText.includes('5åˆ†')) ||
      (interval === '15m' && btnText.includes('15åˆ†')) ||
      (interval === '1h' && btnText.includes('1å°æ™‚'));
    if (shouldBeActive) btn.classList.add('active');
  });
  
  _mlWatchCurrentInterval = interval;
  container.innerHTML = '<div class=\"text-center py-5 text-secondary\"><div class=\"spinner-border spinner-border-sm\" style=\"color:#3fb950\"></div><div class=\"mt-2\" style=\"font-size:12px\">è¼‰å…¥' + (interval==='5m' ? '5åˆ†' : interval==='15m' ? '15åˆ†' : '1å°æ™‚') + 'åœ–è¡¨â€¦</div></div>';
  
  if (_mlWatchChart) {
    try { _mlWatchChart.remove(); } catch(e) {}
    _mlWatchChart = null;
  }
  
  try {
    const resp = await fetch('/api/chart/intraday/' + ticker + '?interval=' + interval);
    if (!resp.ok) throw new Error('API ' + resp.status);
    
    const data = await resp.json();
    if (!data.ok) throw new Error(data.error || 'No data');
    
    _mlWatchData = data;
    container.innerHTML = '';
    
    const LWC = LightweightCharts;
    _mlWatchChart = LWC.createChart(container, {
      width: container.clientWidth || window.innerWidth - 40,
      height: 450,
      layout: { background: { color: '#0d1117' }, textColor: '#8b949e' },
      grid: { vertLines: { color: '#21262d' }, horzLines: { color: '#21262d' } },
      crosshair: { mode: LWC.CrosshairMode.Normal },
      rightPriceScale: { borderColor: '#30363d' },
      timeScale: { borderColor: '#30363d', timeVisible: true, secondsVisible: false },
      handleScroll: true, handleScale: true,
    });
    
    // Candlestick (separate colors for premarket)
    const candleSeries = _mlWatchChart.addCandlestickSeries({
      upColor: '#3fb950', downColor: '#f85149',
      borderUpColor: '#3fb950', borderDownColor: '#f85149',
      wickUpColor: '#3fb950', wickDownColor: '#f85149',
    });
    
    // Split candles into premarket (gray transparent) and market (normal)
    const candles = [];
    (data.candles || []).forEach(c => {
      const candle = {
        time: c.time, open: c.open, high: c.high, low: c.low, close: c.close
      };
      if (c.is_premarket) {
        candle.color = '#3fb95033';
        candle.borderColor = '#3fb95033';
        candle.wickColor = '#3fb95033';
      }
      candles.push(candle);
    });
    candleSeries.setData(candles);
    
    // Volume
    if (data.volume && data.volume.length) {
      const volSeries = _mlWatchChart.addHistogramSeries({
        priceFormat: { type: 'volume' },
        priceScaleId: 'vol',
      });
      _mlWatchChart.priceScale('vol').applyOptions({
        scaleMargins: { top: 0.82, bottom: 0 },
        drawTicks: false, borderVisible: false,
      });
      volSeries.setData(data.volume);
    }
    
    // EMA 9 & 21
    if (data.ema9 && data.ema9.length) {
      _mlWatchChart.addLineSeries({
        color: '#00d4ff', lineWidth: 1.5, title: 'EMA 9',
        priceLineVisible: false, lastValueVisible: false,
      }).setData(data.ema9);
    }
    if (data.ema21 && data.ema21.length) {
      _mlWatchChart.addLineSeries({
        color: '#3fb950', lineWidth: 1.5, title: 'EMA 21',
        priceLineVisible: false, lastValueVisible: false,
      }).setData(data.ema21);
    }
    
    // Intraday VWAP
    if (data.vwap && data.vwap.length) {
      _mlWatchChart.addLineSeries({
        color: '#ff9500', lineWidth: 1.5, title: 'Intraday VWAP',
        priceLineVisible: false, lastValueVisible: false,
      }).setData(data.vwap);
    }
    
    // Price lines: ORH (yellow dashed), LOD (red dashed)
    if (data.orh && data.orh > 0) {
      candleSeries.createPriceLine({
        price: data.orh, color: '#e3b341', lineWidth: 1, lineStyle: 2,
        axisLabelVisible: true, title: 'ORH $' + data.orh.toFixed(2),
      });
    }
    if (data.lod && data.lod > 0) {
      candleSeries.createPriceLine({
        price: data.lod, color: '#f85149', lineWidth: 1, lineStyle: 2,
        axisLabelVisible: true, title: 'LOD $' + data.lod.toFixed(2),
      });
    }
    
    _mlWatchChart.timeScale().fitContent();
    
    // Update intraday commentary
    renderIntradayCommentary(data.signals, getMarketStatus());
    
    // Update premarket plan if available
    renderPremktPlan(data);
    
    // Update current price
    if (data.candles && data.candles.length > 0) {
      const lastCandle = data.candles[data.candles.length - 1];
      document.getElementById('watchPrice').textContent = '$' + lastCandle.close.toFixed(2);
    }
    
    // Responsive resize
    try {
      new ResizeObserver(() => {
        const w = container.clientWidth || window.innerWidth - 40;
        if (_mlWatchChart) _mlWatchChart.applyOptions({ width: w });
      }).observe(container);
    } catch(e) {
      // ResizeObserver not essential, ignore error
    }
    
  } catch(e) {
    console.error('loadIntradayChart:', e);
    container.innerHTML = '<div class=\"text-secondary text-center py-4\"><i class=\"bi bi-graph-up\" style=\"font-size:2rem;opacity:0.3\"></i><div class=\"mt-2\" style=\"font-size:12px\">åœ–è¡¨è¼‰å…¥å¤±æ•—</div><div style=\"font-size:10px;opacity:0.7\">' + (e.message || '') + '</div></div>';
  }
}

function renderPremktPlan(data) {
  const el = document.getElementById('premktPlanArea');
  if (!el) return;
  
  // Handle both daily analysis data and intraday API response
  let html = '';
  
  // Try to pull from daily analysis (from renderAnalysis)
  if (data.trade_plan && data.dim_scores) {
    const tp = data.trade_plan;
    const dims = data.dim_scores;
    const dimA = dims.A || {};
    const dimAdetail = dimA.detail || {};
    
    const ema21Level = dimAdetail.ema21_level || 'â€”';
    const avrngLevel = dimAdetail.avwap_support || 'â€”';
    
    html += '<div style=\"margin-bottom:12px\"><strong>ç›¤å‰è¨ˆåŠƒï¼š</strong></div>';
    html += '<div class=\"row g-2 mb-2\">';
    html += '<div class=\"col-6 col-md-3\"><div style=\"background:#1a0a0a;border:1px solid #30363d;border-radius:6px;padding:8px;text-align:center\">';
    html += '<div style=\"font-size:11px;color:#8b949e\">Entry</div>';
    html += '<div style=\"font-weight:bold;color:#3fb950\">$' + (tp.entry || 0).toFixed(2) + '</div></div></div>';
    html += '<div class=\"col-6 col-md-3\"><div style=\"background:#1a0a0a;border:1px solid #30363d;border-radius:6px;padding:8px;text-align:center\">';
    html += '<div style=\"font-size:11px;color:#8b949e\">EMA 21</div>';
    html += '<div style=\"font-weight:bold;color:#3fb950\">' + (typeof ema21Level === 'number' ? '$' + ema21Level.toFixed(2) : ema21Level) + '</div></div></div>';
    html += '<div class=\"col-6 col-md-3\"><div style=\"background:#1a0a0a;border:1px solid #30363d;border-radius:6px;padding:8px;text-align:center\">';
    html += '<div style=\"font-size:11px;color:#8b949e\">AVWAP æ”¯æ’</div>';
    html += '<div style=\"font-weight:bold;color:#ff9500\">' + (typeof avrngLevel === 'number' ? '$' + avrngLevel.toFixed(2) : avrngLevel) + '</div></div></div>';
    html += '<div class=\"col-6 col-md-3\"><div style=\"background:#1a0a0a;border:1px solid #30363d;border-radius:6px;padding:8px;text-align:center\">';
    html += '<div style=\"font-size:11px;color:#8b949e\">æ­¢æ</div>';
    html += '<div style=\"font-weight:bold;color:#f85149\">$' + (tp.stop || 0).toFixed(2) + '</div></div></div>';
    html += '</div>';
    html += '<div style=\"font-size:12px;color:#8b949e;line-height:1.6;margin-top:8px\">';
    html += '<div>ğŸ“‹ <strong>ä»Šæ—¥äº¤æ˜“è¨ˆåŠƒï¼š</strong></div>';
    html += '<div>â€¢ åœ¨ EMA 21 åŠ AVWAP æ‰¾æ”¯æ’ä½ï¼Œé¿å…åœ¨é«˜ä½è¿½é«˜</div>';
    html += '<div>â€¢ ç›£è¦–ç›¤å‰æˆäº¤ï¼Œç¢ºèªä»Šæ—¥æ–¹å‘ä¿¡å¿ƒ</div>';
    html += '<div>â€¢ é€²å ´å‰å†æ¬¡é©—è­‰ Opening Range çš„çªç ´æ©Ÿæœƒ</div>';
    html += '</div>';
  }
  // Or try intraday API response (from loadIntradayChart)
  else if (data.orh && data.lod) {
    const orh = data.orh || 0, orl = data.orl || 0;
    const lod = data.lod || 0;
    
    html += '<div style=\"margin-bottom:12px\"><strong>Opening Range (å‰15åˆ†)ï¼š</strong></div>';
    html += '<div class=\"row g-2 mb-2\">';
    html += '<div class=\"col-6 col-md-3\"><div style=\"background:#1a0a0a;border:1px solid #30363d;border-radius:6px;padding:8px;text-align:center\"><div style=\"font-size:11px;color:#8b949e\">ORH</div><div style=\"font-weight:bold;color:#e3b341\">$' + orh.toFixed(2) + '</div></div></div>';
    html += '<div class=\"col-6 col-md-3\"><div style=\"background:#1a0a0a;border:1px solid #30363d;border-radius:6px;padding:8px;text-align:center\"><div style=\"font-size:11px;color:#8b949e\">ORL</div><div style=\"font-weight:bold;color:#e3b341\">$' + orl.toFixed(2) + '</div></div></div>';
    html += '<div class=\"col-6 col-md-3\"><div style=\"background:#1a0a0a;border:1px solid #30363d;border-radius:6px;padding:8px;text-align:center\"><div style=\"font-size:11px;color:#8b949e\">LOD</div><div style=\"font-weight:bold;color:#f85149\">$' + lod.toFixed(2) + '</div></div></div>';
    html += '</div>';
    html += '<div style=\"font-size:12px;color:#8b949e;line-height:1.6;margin-top:8px\">';
    html += '<div>ğŸ“‹ <strong>ç›¤å‰è¨ˆåŠƒï¼š</strong></div>';
    html += '<div>â€¢ ç›¤å‰ç¢ºèª EMA 21 ä½æ°´ä½ï¼ˆæ”¯æ’ï¼‰</div>';
    html += '<div>â€¢ ç­‰å¾… Opening Range å®Œæ•´ï¼Œç›¡é‡ä¸è¿½é«˜</div>';
    html += '<div>â€¢ ç›£è¦–ä¸‹ä¸€æ ¹ Candle Breakout çš„çªç ´æ©Ÿæœƒ</div>';
    html += '</div>';
  } else {
    html += '<div class=\"text-secondary\">â€”</div>';
  }
  
  el.innerHTML = html;
}

function renderIntradayCommentary(signals, status) {
  const el = document.getElementById('intradayCommentaryArea');
  if (!el) return;
  
  let html = '';
  const advice = signals.setup_advice || 'no_data';
  
  if (status.status === 'closed') {
    html += '<div class=\"cmt-info\" style=\"border-color:#f85149;background:#1a0a0a\"><i class=\"bi bi-x-circle me-1\" style=\"color:#f85149\"></i><strong>ç¾è‚¡ç¾å·²æ”¶ç›¤</strong> â€” åˆ‡æ›è‡³<button class=\"btn btn-link p-0\" style=\"color:#3fb950\" onclick=\"switchMlMode(\\'review\\')\">è¤‡ç›¤æ¨¡å¼</button>æŸ¥çœ‹å®Œæ•´åˆ†æ</div>';
  } else if (status.status === 'premarket') {
    html += '<div class=\"cmt-warn\"><i class=\"bi bi-clock me-1\"></i><strong>ç›¤å‰æ™‚æ®µ</strong> â€” è‚¡ç¥¨æœªé–‹ç›¤ï¼Œæ•¸æ“šè¡Œç‚ºä¸ä»£è¡¨ç›¤ä¸­è¡¨ç¾</div>';
  } else {
    // Market is open
    const chasePct = signals.chase_pct || 0;
    const emai9Diff = signals.ema9_diff || 0;
    const ema21Diff = signals.ema21_diff || 0;
    
    if (advice === 'avoid_chase') {
      html += '<div class=\"cmt-fail\"><i class=\"bi bi-exclamation-triangle me-1\"></i><strong>â›” ç¦æ­¢è¿½é«˜</strong> â€” è· LOD å·² ' + chasePct.toFixed(1) + '%ï¼ŒMartin è¦å‰‡ï¼š>3% ä¸é€²å ´</div>';
    } else if (advice === 'mid_entry_breakout') {
      html += '<div class=\"cmt-pass\"><i class=\"bi bi-lightning me-1\"></i><strong>âœ“ 5åˆ†é˜çªç ´é€²å ´æ©Ÿæœƒ</strong> â€” è‚¡ç¥¨å¾æ”¯æ’åå½ˆï¼Œç›£è¦– 5 åˆ†é˜å‰ä¸€æ ¹æŸ±çš„çªç ´</div>';
    } else if (advice === 'early_entry_watch') {
      html += '<div class=\"cmt-warn\"><i class=\"bi bi-hourglass-split me-1\"></i><strong>â³ Opening Range å»ºç«‹ä¸­</strong> â€” ç­‰å¾…é¦– 15 åˆ†é˜å®Œæˆï¼Œé¿å…å‰ 15 åˆ†é˜è¿½å…¥</div>';
    } else {
      html += '<div class=\"cmt-info\"><i class=\"bi bi-info-circle me-1\"></i><strong>ç›£è¦–ä¸­â€¦</strong> â€” EMA 9 vs 21 æ’åˆ—ã€VWAP æ”¯æ’ç¢ºèª</div>';
    }
    
    // Additional signals
    if (emai9Diff > 0 && ema21Diff > 0) {
      html += '<div class=\"cmt-pass\" style=\"border-left-color:#3fb950;background:#0a1a0a\"><i class=\"bi bi-check me-1\"></i>è‚¡åƒ¹åœ¨ EMA 9 å’Œ 21 ä¸Šæ–¹ âœ“</div>';
    } else if (emai9Diff < 0) {
      html += '<div class=\"cmt-fail\"><i class=\"bi bi-dash me-1\"></i>âš ï¸ è‚¡åƒ¹è·Œç©¿ EMA 9 â€” è¬¹æ…é€²å ´</div>';
    }
    
    if (signals.flush_recovery) {
      html += '<div class=\"cmt-pass\" style=\"border-left-color:#3fb950;background:#0a1a0a\"><i class=\"bi bi-arrow-up me-1\"></i>V å½¢åå½ˆä¿¡è™Ÿ âœ“ â€” è‚¡ç¥¨å¾æ”¯æ’å¿«é€Ÿæ¢å¾©</div>';
    }
  }
  
  el.innerHTML = html || '<div class=\"text-secondary\">â€”</div>';
}

function refreshWatchMode(ticker) {
  // Fetch latest intraday data and update chart
  loadIntradayChart(ticker, _mlWatchCurrentInterval);
  startCountdownTimer();
}

// â”€â”€ Fallback diagnostic logging â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded', () => {
  // Log page state for debugging
  const tickerInput = document.getElementById('tickerInput');
  const emptyState = document.getElementById('emptyState');
  const resultArea = document.getElementById('resultArea');
  
  console.log('[ML Analyze] Page loaded:');
  console.log('  - tickerInput found:', !!tickerInput);
  console.log('  - emptyState visible:', emptyState && !emptyState.classList.contains('d-none'));
  console.log('  - resultArea hidden:', resultArea && resultArea.classList.contains('d-none'));
  console.log('  - Bootstrap CSS loaded:', !!window.bootstrap);
  console.log('  - LightweightCharts loaded:', typeof LightweightCharts !== 'undefined');
}, { once: true });

</script>

<noscript>
<div style="background: #2e1010; color: #ffcccc; padding: 20px; margin: 20px; border: 2px solid #ff6666; border-radius: 8px; text-align: center;">
  <strong>âš ï¸ JavaScript å·²ç¦ç”¨</strong><br>
  ML å€‹è‚¡åˆ†æéœ€è¦å•Ÿç”¨ JavaScript æ‰èƒ½æ­£å¸¸å·¥ä½œã€‚<br>
  è«‹åœ¨ç€è¦½å™¨è¨­ç½®ä¸­å•Ÿç”¨ JavaScriptã€‚
</noscript>


</body>
</html>