{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h4 class="mb-0"><i class="bi bi-speedometer2 me-2" style="color:var(--accent)"></i>Dashboard</h4>
  <span class="text-muted small">{{ today }}</span>
</div>

<!-- Metric cards -->
<div class="row g-3 mb-4">
  <div class="col-6 col-md-3">
    <div class="metric-card">
      <div class="metric-val">{{ positions|length }}</div>
      <div class="metric-lbl">Open Positions</div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="metric-card">
      <div class="metric-val" style="color:#3fb950">{{ wl_counts.A }}</div>
      <div class="metric-lbl">Grade-A Watchlist</div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="metric-card">
      <div class="metric-val" style="color:#e3b341">{{ wl_counts.B }}</div>
      <div class="metric-lbl">Grade-B Watchlist</div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="metric-card">
      <div class="metric-val">${{ "{:,.0f}".format(account_size) }}</div>
      <div class="metric-lbl">Account Size</div>
    </div>
  </div>
</div>

<div class="row g-3">
  <!-- Open Positions -->
  <div class="col-12 col-lg-7">
    <div class="card h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-briefcase me-2"></i>Open Positions</span>
        <a href="/positions" class="btn btn-sm btn-outline-secondary">Manage</a>
      </div>
      <div class="card-body p-0">
        {% if positions %}
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead><tr>
              <th>Ticker</th><th>Entry</th><th>Stop</th><th>Target</th>
              <th>R:R</th><th>Shares</th><th>Risk $</th>
            </tr></thead>
            <tbody>
            {% for t, p in positions.items() %}
            <tr>
              <td><strong><a href="/analyze?ticker={{ t }}" class="text-decoration-none" style="color:var(--accent)">{{ t }}</a></strong></td>
              <td>${{ "%.2f"|format(p.buy_price) }}</td>
              <td class="text-danger">${{ "%.2f"|format(p.stop_loss) }}</td>
              <td class="text-success">${{ "%.2f"|format(p.target) }}</td>
              <td>{{ "%.1f"|format(p.rr) }}:1</td>
              <td>{{ "{:,}".format(p.shares) }}</td>
              <td>${{ "{:,.0f}".format(p.risk_dollar) }}</td>
            </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="p-4 text-center text-muted">
          <i class="bi bi-inbox fs-2 d-block mb-2"></i>No open positions.
          <a href="/positions" class="d-block mt-2">Add a position â†’</a>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Grade-A Watchlist preview -->
  <div class="col-12 col-lg-5">
    <div class="card h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-bookmark-star me-2"></i>Grade A Watchlist</span>
        <a href="/watchlist" class="btn btn-sm btn-outline-secondary">All</a>
      </div>
      <div class="card-body p-0">
        {% if wl.A %}
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead><tr><th>Ticker</th><th>RS</th><th>VCP</th><th>Pivot</th></tr></thead>
            <tbody>
            {% for t, d in wl.A.items() %}
            <tr>
              <td><strong><a href="/analyze?ticker={{ t }}" class="text-decoration-none" style="color:var(--accent)">{{ t }}</a></strong></td>
              <td>{{ d.rs_rank|int if d.rs_rank else 'â€”' }}</td>
              <td>{% if d.vcp_grade in ['A','B'] %}<span class="tag-vcp">{{ d.vcp_grade }}</span>{% else %}{{ d.vcp_grade or 'â€”' }}{% endif %}</td>
              <td>{% if d.pivot_price %}${{ "%.2f"|format(d.pivot_price) }}{% else %}â€”{% endif %}</td>
            </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="p-4 text-center text-muted">
          <i class="bi bi-star fs-2 d-block mb-2"></i>No Grade-A stocks yet.
          <a href="/watchlist" class="d-block mt-2">Add to watchlist â†’</a>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Quick actions -->
<div class="row g-3 mt-1">
  <div class="col-12">
    <div class="card">
      <div class="card-header"><i class="bi bi-lightning me-2"></i>Quick Actions</div>
      <div class="card-body d-flex flex-wrap gap-2">
        <a href="/scan" class="btn btn-accent"><i class="bi bi-funnel me-1"></i>Run SEPA Scan</a>
        <a href="/market" class="btn btn-outline-info"><i class="bi bi-bar-chart-line me-1"></i>Market Check</a>
        <a href="/analyze" class="btn btn-outline-secondary"><i class="bi bi-search me-1"></i>Analyze Stock</a>
        <a href="/vcp" class="btn btn-outline-secondary"><i class="bi bi-activity me-1"></i>VCP Check</a>
        <button class="btn btn-outline-warning" onclick="generateReport()">
          <i class="bi bi-file-earmark-text me-1"></i>Generate Report
        </button>
        <button class="btn btn-outline-danger" onclick="restartServer()" title="Restart Flask server to apply code changes">
          <i class="bi bi-arrow-clockwise me-1"></i>Restart Server
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
async function generateReport() {
  toast('Generating reportâ€¦');
  const r = await fetch('/api/report/generate', {method:'POST'}).then(x=>x.json());
  pollJob(`/api/report/generate`, () => {
    toast('Report ready!'); 
  }, e => toast('Error: ' + e, false));
}

async function restartServer() {
  if (!confirm('ðŸ”„ Restart the Flask server? Any ongoing operations will be interrupted. This is needed to apply code changes.\n\nThe server will be back online in ~2 seconds.')) return;
  
  const btn = event.target.closest('button');
  btn.disabled = true;
  btn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Restartingâ€¦';
  
  try {
    const r = await fetch('/api/admin/restart', {method: 'POST'}).then(x => x.json());
    if (r.ok) {
      toast('Server restartingâ€¦ page will reconnect automatically', true);
      // Poll for server to come back
      let tries = 0;
      const checkServer = setInterval(() => {
        fetch('/').then(() => {
          clearInterval(checkServer);
          toast('âœ… Server restarted and ready!', true);
          setTimeout(() => location.reload(), 500);
        }).catch(() => {
          tries++;
          if (tries > 30) { // Timeout after 30s
            clearInterval(checkServer);
            toast('Server did not respond in time. Please refresh manually.', false);
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-arrow-clockwise me-1"></i>Restart Server';
          }
        });
      }, 500);
    } else {
      toast('Failed to restart: ' + r.error, false);
      btn.disabled = false;
      btn.innerHTML = '<i class="bi bi-arrow-clockwise me-1"></i>Restart Server';
    }
  } catch (e) {
    toast('Error: ' + e.message, false);
    btn.disabled = false;
    btn.innerHTML = '<i class="bi bi-arrow-clockwise me-1"></i>Restart Server';
  }
}
</script>
{% endblock %}
