{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h4 class="mb-0"><i class="bi bi-speedometer2 me-2" style="color:var(--accent)"></i>Dashboard</h4>
  <span class="text-muted small">{{ today }}</span>
</div>

<!-- Metric cards -->
<div class="row g-3 mb-4">
  <div class="col-6 col-md-3">
    <div class="metric-card">
      <div class="metric-val">{{ positions|length }}</div>
      <div class="metric-lbl">Open Positions</div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="metric-card">
      <div class="metric-val" style="color:#3fb950">{{ wl_counts.A }}</div>
      <div class="metric-lbl">Grade-A Watchlist</div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="metric-card">
      <div class="metric-val" style="color:#e3b341">{{ wl_counts.B }}</div>
      <div class="metric-lbl">Grade-B Watchlist</div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="metric-card">
      <div class="metric-val">${{ "{:,.0f}".format(account_size) }}</div>
      <div class="metric-lbl">Account Size</div>
    </div>
  </div>
</div>

<div class="row g-3">
  <!-- Open Positions -->
  <div class="col-12 col-lg-7">
    <div class="card h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-briefcase me-2"></i>Open Positions</span>
        <a href="/positions" class="btn btn-sm btn-outline-secondary">Manage</a>
      </div>
      <div class="card-body p-0">
        {% if positions %}
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead><tr>
              <th>Ticker</th><th>Entry</th><th>Stop</th><th>Target</th>
              <th>R:R</th><th>Shares</th><th>Risk $</th>
            </tr></thead>
            <tbody>
            {% for t, p in positions.items() %}
            <tr>
              <td><strong><a href="/analyze?ticker={{ t }}" class="text-decoration-none" style="color:var(--accent)">{{ t }}</a></strong></td>
              <td>${{ "%.2f"|format(p.buy_price) }}</td>
              <td class="text-danger">${{ "%.2f"|format(p.stop_loss) }}</td>
              <td class="text-success">${{ "%.2f"|format(p.target) }}</td>
              <td>{{ "%.1f"|format(p.rr) }}:1</td>
              <td>{{ "{:,}".format(p.shares) }}</td>
              <td>${{ "{:,.0f}".format(p.risk_dollar) }}</td>
            </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="p-4 text-center text-muted">
          <i class="bi bi-inbox fs-2 d-block mb-2"></i>No open positions.
          <a href="/positions" class="d-block mt-2">Add a position â†’</a>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Grade-A Watchlist preview -->
  <div class="col-12 col-lg-5">
    <div class="card h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-bookmark-star me-2"></i>Grade A Watchlist</span>
        <a href="/watchlist" class="btn btn-sm btn-outline-secondary">All</a>
      </div>
      <div class="card-body p-0">
        {% if wl.A %}
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead><tr><th>Ticker</th><th>RS</th><th>VCP</th><th>Pivot</th></tr></thead>
            <tbody>
            {% for t, d in wl.A.items() %}
            <tr>
              <td><strong><a href="/analyze?ticker={{ t }}" class="text-decoration-none" style="color:var(--accent)">{{ t }}</a></strong></td>
              <td>{{ d.rs_rank|int if d.rs_rank else 'â€”' }}</td>
              <td>{% if d.vcp_grade in ['A','B'] %}<span class="tag-vcp">{{ d.vcp_grade }}</span>{% else %}{{ d.vcp_grade or 'â€”' }}{% endif %}</td>
              <td>{% if d.pivot_price %}${{ "%.2f"|format(d.pivot_price) }}{% else %}â€”{% endif %}</td>
            </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="p-4 text-center text-muted">
          <i class="bi bi-star fs-2 d-block mb-2"></i>No Grade-A stocks yet.
          <a href="/watchlist" class="d-block mt-2">Add to watchlist â†’</a>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Combined Scan Highlights -->
<div class="row g-3 mt-1">
  <div class="col-12">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>
          <i class="bi bi-layers me-2" style="color:var(--accent)"></i>ä¸Šæ¬¡ Combined æƒææ‘˜è¦
          <span id="combinedRegimeBadge" class="badge ms-2" style="font-size:10px;display:none"></span>
        </span>
        <div class="d-flex align-items-center gap-2">
          <span id="combinedLastTs" class="text-muted" style="font-size:11px"></span>
          <a href="/combined" class="btn btn-sm btn-accent"><i class="bi bi-play-fill me-1"></i>ç«‹å³æƒæ</a>
        </div>
      </div>
      <!-- Stats mini-row -->
      <div id="combinedStatsRow" style="display:none" class="border-bottom px-3 py-2 d-flex flex-wrap gap-4">
        <span class="small text-muted">SEPA é€šé: <strong id="combinedSepaCount" class="text-info">â€”</strong></span>
        <span class="small text-muted">QM é€šé: <strong id="combinedQmCount" style="color:#e3b341">â€”</strong></span>
        <span class="small text-muted" id="combinedTimingInfo"></span>
      </div>
      <div class="card-body p-0">
        <div id="combinedHighlightLoading" class="p-3 text-center text-muted small">
          <div class="spinner-border spinner-border-sm text-secondary"></div>
        </div>
        <div id="combinedHighlightContent" style="display:none">
          <div class="row g-0">
            <!-- SEPA Top 5 -->
            <div class="col-12 col-lg-6" style="border-right:1px solid rgba(255,255,255,.08)">
              <div class="px-3 pt-2 pb-1 border-bottom d-flex align-items-center gap-2">
                <i class="bi bi-funnel" style="color:var(--accent)"></i>
                <span class="small fw-bold text-muted">SEPA Top 5</span>
              </div>
              <table class="table table-hover mb-0" style="font-size:13px">
                <thead><tr>
                  <th style="width:26px">#</th>
                  <th>Ticker</th>
                  <th>Score</th>
                  <th>RS</th>
                  <th>VCP</th>
                </tr></thead>
                <tbody id="combinedSepaBody"></tbody>
              </table>
            </div>
            <!-- QM Top 5 -->
            <div class="col-12 col-lg-6">
              <div class="px-3 pt-2 pb-1 border-bottom d-flex align-items-center gap-2">
                <i class="bi bi-lightning-charge" style="color:#e3b341"></i>
                <span class="small fw-bold text-muted">QM Top 5</span>
              </div>
              <table class="table table-hover mb-0" style="font-size:13px">
                <thead><tr>
                  <th style="width:26px">#</th>
                  <th>Ticker</th>
                  <th>Stars</th>
                  <th>ADR%</th>
                  <th>Setup</th>
                </tr></thead>
                <tbody id="combinedQmBody"></tbody>
              </table>
            </div>
          </div>
          <div class="px-3 pb-2 pt-1 text-end border-top">
            <a href="/combined" class="text-secondary small">æŸ¥çœ‹ / é‡æ–°åŸ·è¡Œ Combined æƒæ â†’</a>
          </div>
        </div>
        <div id="combinedHighlightEmpty" style="display:none" class="p-4 text-center text-muted">
          <i class="bi bi-layers d-block mb-2 fs-3"></i>
          å°šç„¡ Combined æƒæè¨˜éŒ„ã€‚<br>
          <a href="/combined" class="mt-2 d-inline-block">ç«‹å³åŸ·è¡Œ Combined æƒæ â†’</a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Quick actions -->
<div class="row g-3 mt-1">
  <div class="col-12">
    <div class="card">
      <div class="card-header"><i class="bi bi-lightning me-2"></i>Quick Actions</div>
      <div class="card-body d-flex flex-wrap gap-2">
        <a href="/combined" class="btn btn-accent"><i class="bi bi-layers me-1"></i>Combined Scan</a>
        <a href="/market" class="btn btn-outline-info"><i class="bi bi-bar-chart-line me-1"></i>Market Check</a>
        <a href="/analyze" class="btn btn-outline-secondary"><i class="bi bi-search me-1"></i>Analyze Stock</a>
        <a href="/vcp" class="btn btn-outline-secondary"><i class="bi bi-activity me-1"></i>VCP Scanner</a>
        <a href="/watchlist" class="btn btn-outline-secondary"><i class="bi bi-bookmark-star me-1"></i>Watchlist</a>
        <button class="btn btn-outline-warning" onclick="generateReport()">
          <i class="bi bi-file-earmark-text me-1"></i>Generate Report
        </button>
        <button class="btn btn-sm btn-outline-danger" onclick="restartServer()" title="é‡å•Ÿ Flask ä¼ºæœå™¨ä»¥å¥—ç”¨ç¨‹å¼ç¢¼æ›´æ”¹">
          <i class="bi bi-arrow-clockwise me-1"></i>Restart Server
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
/* â”€â”€ Combined scan highlights â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function loadCombinedHighlights() {
  try {
    const r = await fetch('/api/combined/scan/last').then(x => x.json());
    document.getElementById('combinedHighlightLoading').style.display = 'none';

    const sepaRows = (r.sepa_rows || []).slice(0, 5);
    const qmRows   = (r.qm_rows   || []).slice(0, 5);

    if (!r.saved_at && !sepaRows.length && !qmRows.length) {
      document.getElementById('combinedHighlightEmpty').style.display = 'block';
      return;
    }

    // â”€â”€ Header: timestamp + regime badge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (r.saved_at) {
      document.getElementById('combinedLastTs').textContent =
        r.saved_at.slice(0, 16).replace('T', ' ');
    }
    const m = r.market_env || {};
    if (m.regime) {
      const badge = document.getElementById('combinedRegimeBadge');
      const rc = m.regime === 'CONFIRMED_UPTREND'       ? ['bg-success',  m.regime]
               : m.regime === 'UPTREND_UNDER_PRESSURE'  ? ['bg-warning text-dark', m.regime]
               : m.regime === 'MARKET_IN_CORRECTION'    ? ['bg-orange',   m.regime]
               : ['bg-danger', m.regime];
      badge.className = `badge ms-2 ${rc[0]}`;
      badge.textContent = rc[1].replace(/_/g, ' ');
      badge.style.display = '';
    }

    // â”€â”€ Stats row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById('combinedSepaCount').textContent = r.sepa_count ?? sepaRows.length;
    document.getElementById('combinedQmCount').textContent   = r.qm_count   ?? qmRows.length;
    const t = r.timing || {};
    if (t.total_secs) {
      document.getElementById('combinedTimingInfo').textContent =
        `æƒæç”¨æ™‚: ${Number(t.total_secs).toFixed(0)}s`;
    }
    document.getElementById('combinedStatsRow').style.display = '';

    // â”€â”€ SEPA rows â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (sepaRows.length) {
      document.getElementById('combinedSepaBody').innerHTML = sepaRows.map((s, i) => {
        const score = s.total_score != null ? Number(s.total_score).toFixed(1) : 'â€”';
        const sCls  = s.total_score >= 75 ? 'score-high' : s.total_score >= 55 ? 'score-mid' : 'score-low';
        const rs    = s.rs_rank != null ? Number(s.rs_rank).toFixed(0) : 'â€”';
        const vcp   = s.vcp_grade && s.vcp_grade !== 'D'
          ? `<span class="tag-vcp" style="font-size:10px">VCP ${s.vcp_grade}</span>` : 'â€”';
        return `<tr onclick="window.location='/analyze?ticker=${s.ticker}'" style="cursor:pointer">
          <td class="text-muted small">${i+1}</td>
          <td><a href="/analyze?ticker=${s.ticker}" class="fw-bold" style="color:var(--accent)">${s.ticker}</a>
            <div class="text-muted" style="font-size:10px">${s.sector||''}</div></td>
          <td class="${sCls} fw-bold">${score}</td>
          <td class="text-muted small">${rs}</td>
          <td>${vcp}</td>
        </tr>`;
      }).join('');
    } else {
      document.getElementById('combinedSepaBody').innerHTML =
        '<tr><td colspan="5" class="text-muted text-center small py-3">ç„¡ SEPA çµæœ</td></tr>';
    }

    // â”€â”€ QM rows â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const setupLabel = {'HTF':'HTF','EP':'EP','LADDER':'LADDER','SURF_50':'SURF50',
                        'SURF_20':'SURF20','SURF_10':'SURF10','RPL':'RPL','FLAG':'FLAG'};
    if (qmRows.length) {
      document.getElementById('combinedQmBody').innerHTML = qmRows.map((q, i) => {
        const star  = parseFloat(q.qm_star != null ? q.qm_star : (q.stars || 0));
        const sClr  = star >= 5 ? '#3fb950' : star >= 4 ? '#e3b341' : '#8b949e';
        const stars = 'â˜…'.repeat(Math.floor(star)) + (star - Math.floor(star) >= 0.5 ? 'Â½' : '');
        const adr   = q.adr != null ? Number(q.adr).toFixed(1) + '%' : 'â€”';
        const slbl  = setupLabel[q.setup_type] || q.setup_type || 'â€”';
        return `<tr onclick="window.location='/qm/analyze?ticker=${q.ticker}'" style="cursor:pointer">
          <td class="text-muted small">${i+1}</td>
          <td><a href="/qm/analyze?ticker=${q.ticker}" class="fw-bold" style="color:#e3b341">${q.ticker}</a></td>
          <td class="fw-bold" style="color:${sClr}">${stars} <small>(${star.toFixed(1)})</small></td>
          <td class="text-muted small">${adr}</td>
          <td><span class="badge bg-secondary" style="font-size:10px">${slbl}</span></td>
        </tr>`;
      }).join('');
    } else {
      document.getElementById('combinedQmBody').innerHTML =
        '<tr><td colspan="5" class="text-muted text-center small py-3">ç„¡ QM çµæœ</td></tr>';
    }

    document.getElementById('combinedHighlightContent').style.display = 'block';
  } catch(e) {
    document.getElementById('combinedHighlightLoading').style.display = 'none';
    document.getElementById('combinedHighlightEmpty').style.display = 'block';
  }
}

window.addEventListener('DOMContentLoaded', () => {
  setTimeout(() => loadCombinedHighlights(), 50);
});

async function generateReport() {
  toast('Generating reportâ€¦');
  const r = await fetch('/api/report/generate', {method:'POST'}).then(x=>x.json());
  pollJob(`/api/report/generate`, () => {
    toastCompletion('âœ… å ±å‘Šå·²ç”Ÿæˆå®Œæˆ'); 
  }, e => toast('Error: ' + e, false));
}

async function restartServer() {
  if (!confirm('ğŸ”„ Restart the Flask server? Any ongoing operations will be interrupted. This is needed to apply code changes.\n\nThe server will be back online in ~3 seconds.')) return;
  
  const btn = event.target.closest('button');
  btn.disabled = true;
  btn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Restartingâ€¦';
  
  try {
    const r = await fetch('/api/admin/restart', {method: 'POST'}).then(x => x.json()).catch(e => ({ok: false, error: e.message}));
    if (r.ok) {
      toast('Server shutting down and restartingâ€¦', true);
      // Wait 2.5s for old process to fully exit and new one to start
      await new Promise(resolve => setTimeout(resolve, 2500));
      
      // Poll for server to come back (max 30 tries = 15 seconds)
      let tries = 0;
      const max_tries = 30;
      const checkServer = setInterval(async () => {
        try {
          const health = await fetch('/', {method: 'GET', signal: AbortSignal.timeout(2000)});
          if (health.ok) {
            clearInterval(checkServer);
            toastCompletion('âœ… æœå‹™å™¨å·²é‡å•Ÿä¸¦å°±ç·’', true);
            setTimeout(() => location.reload(), 1500);
            return;
          }
        } catch (e) {
          // Still connecting...
        }
        
        tries++;
        if (tries >= max_tries) {
          clearInterval(checkServer);
          toast('âš ï¸ Server did not respond after 15s. Click to refresh manually.', false);
          btn.disabled = false;
          btn.innerHTML = '<i class="bi bi-arrow-clockwise me-1"></i>Restart Server';
        }
      }, 500);
    } else {
      toast('Failed to restart: ' + (r.error || 'Unknown error'), false);
      btn.disabled = false;
      btn.innerHTML = '<i class="bi bi-arrow-clockwise me-1"></i>Restart Server';
    }
  } catch (e) {
    toast('Error: ' + e.message, false);
    btn.disabled = false;
    btn.innerHTML = '<i class="bi bi-arrow-clockwise me-1"></i>Restart Server';
  }
}
</script>
{% endblock %}
