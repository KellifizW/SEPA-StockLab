{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h4 class="mb-0"><i class="bi bi-speedometer2 me-2" style="color:var(--accent)"></i>Dashboard</h4>
  <span class="text-muted small">{{ today }}</span>
</div>

<!-- Metric cards -->
<div class="row g-3 mb-4">
  <div class="col-6 col-md-3">
    <div class="metric-card">
      <div class="metric-val">{{ positions|length }}</div>
      <div class="metric-lbl">Open Positions</div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="metric-card">
      <div class="metric-val" style="color:#3fb950">{{ wl_counts.A }}</div>
      <div class="metric-lbl">Grade-A Watchlist</div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="metric-card">
      <div class="metric-val" style="color:#e3b341">{{ wl_counts.B }}</div>
      <div class="metric-lbl">Grade-B Watchlist</div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="metric-card">
      <div class="metric-val">${{ "{:,.0f}".format(account_size) }}</div>
      <div class="metric-lbl">Account Size</div>
    </div>
  </div>
</div>

<div class="row g-3">
  <!-- Open Positions -->
  <div class="col-12 col-lg-7">
    <div class="card h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-briefcase me-2"></i>Open Positions</span>
        <a href="/positions" class="btn btn-sm btn-outline-secondary">Manage</a>
      </div>
      <div class="card-body p-0">
        {% if positions %}
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead><tr>
              <th>Ticker</th><th>Entry</th><th>Stop</th><th>Target</th>
              <th>R:R</th><th>Shares</th><th>Risk $</th>
            </tr></thead>
            <tbody>
            {% for t, p in positions.items() %}
            <tr>
              <td><strong><a href="/analyze?ticker={{ t }}" class="text-decoration-none" style="color:var(--accent)">{{ t }}</a></strong></td>
              <td>${{ "%.2f"|format(p.buy_price) }}</td>
              <td class="text-danger">${{ "%.2f"|format(p.stop_loss) }}</td>
              <td class="text-success">${{ "%.2f"|format(p.target) }}</td>
              <td>{{ "%.1f"|format(p.rr) }}:1</td>
              <td>{{ "{:,}".format(p.shares) }}</td>
              <td>${{ "{:,.0f}".format(p.risk_dollar) }}</td>
            </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="p-4 text-center text-muted">
          <i class="bi bi-inbox fs-2 d-block mb-2"></i>No open positions.
          <a href="/positions" class="d-block mt-2">Add a position ‚Üí</a>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Grade-A Watchlist preview -->
  <div class="col-12 col-lg-5">
    <div class="card h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-bookmark-star me-2"></i>Grade A Watchlist</span>
        <a href="/watchlist" class="btn btn-sm btn-outline-secondary">All</a>
      </div>
      <div class="card-body p-0">
        {% if wl.A %}
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead><tr><th>Ticker</th><th>RS</th><th>VCP</th><th>Pivot</th></tr></thead>
            <tbody>
            {% for t, d in wl.A.items() %}
            <tr>
              <td><strong><a href="/analyze?ticker={{ t }}" class="text-decoration-none" style="color:var(--accent)">{{ t }}</a></strong></td>
              <td>{{ d.rs_rank|int if d.rs_rank else '‚Äî' }}</td>
              <td>{% if d.vcp_grade in ['A','B'] %}<span class="tag-vcp">{{ d.vcp_grade }}</span>{% else %}{{ d.vcp_grade or '‚Äî' }}{% endif %}</td>
              <td>{% if d.pivot_price %}${{ "%.2f"|format(d.pivot_price) }}{% else %}‚Äî{% endif %}</td>
            </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="p-4 text-center text-muted">
          <i class="bi bi-star fs-2 d-block mb-2"></i>No Grade-A stocks yet.
          <a href="/watchlist" class="d-block mt-2">Add to watchlist ‚Üí</a>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Persistent Signals -->
<div class="row g-3 mt-1">
  <div class="col-12">
    <div class="card">
      <div class="card-header"><i class="bi bi-arrow-repeat me-2"></i>Persistent Signals (Last 30 days, ‚â•3 appearances)</div>
      <div class="card-body p-0">
        <div id="persistentLoading" class="p-4 text-center text-muted">
          <div class="spinner-border spinner-border-sm text-info"></div>
          <div class="small mt-2">Loading signals‚Ä¶</div>
        </div>
        <div id="persistentTable" style="display:none">
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead><tr>
                <th>Ticker</th><th>Appearances</th><th>Avg Score</th><th>Max Score</th><th>Best VCP</th><th>Last Seen</th>
              </tr></thead>
              <tbody id="persistentBody"></tbody>
            </table>
          </div>
        </div>
        <div id="persistentEmpty" style="display:none" class="p-4 text-center text-muted">
          <i class="bi bi-inbox fs-2 d-block mb-2"></i>
          No persistent signals yet. Run a few scans first.
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Quick actions -->
<div class="row g-3 mt-1">
  <div class="col-12">
    <div class="card">
      <div class="card-header"><i class="bi bi-lightning me-2"></i>Quick Actions</div>
      <div class="card-body d-flex flex-wrap gap-2">
        <a href="/scan" class="btn btn-accent"><i class="bi bi-funnel me-1"></i>Run SEPA Scan</a>
        <a href="/market" class="btn btn-outline-info"><i class="bi bi-bar-chart-line me-1"></i>Market Check</a>
        <a href="/analyze" class="btn btn-outline-secondary"><i class="bi bi-search me-1"></i>Analyze Stock</a>
        <a href="/vcp" class="btn btn-outline-secondary"><i class="bi bi-activity me-1"></i>VCP Check</a>
        <button class="btn btn-outline-warning" onclick="generateReport()">
          <i class="bi bi-file-earmark-text me-1"></i>Generate Report
        </button>
        <button class="btn btn-outline-danger" onclick="restartServer()" title="Restart Flask server to apply code changes">
          <i class="bi bi-arrow-clockwise me-1"></i>Restart Server
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
async function loadPersistentSignals() {
  try {
    document.getElementById('persistentLoading').style.display = 'block';
    document.getElementById('persistentTable').style.display = 'none';
    document.getElementById('persistentEmpty').style.display = 'none';

    const r = await fetch('/api/db/watchlist-history').then(x => x.json());
    const rows = r.rows || [];

    if (!rows.length) {
      document.getElementById('persistentLoading').style.display = 'none';
      document.getElementById('persistentEmpty').style.display = 'block';
      return;
    }

    const html = rows.map(row => `<tr onclick="window.location='/analyze?ticker=${row.ticker}'" style="cursor:pointer">
      <td><strong style="color:var(--accent)">${row.ticker}</strong></td>
      <td>${Math.round(row.appearances)}</td>
      <td>${Number(row.avg_score||0).toFixed(1)}</td>
      <td><span class="score-high">${Number(row.max_score||0).toFixed(1)}</span></td>
      <td><span class="tag-vcp">${row.best_vcp||'‚Äî'}</span></td>
      <td class="text-muted small">${row.last_seen}</td>
    </tr>`).join('');

    document.getElementById('persistentBody').innerHTML = html;
    document.getElementById('persistentLoading').style.display = 'none';
    document.getElementById('persistentTable').style.display = 'block';
  } catch (e) {
    console.error('Error loading persistent signals:', e);
    document.getElementById('persistentLoading').style.display = 'none';
    document.getElementById('persistentEmpty').style.display = 'block';
  }
}

window.addEventListener('DOMContentLoaded', () => {
  // Load persistent signals asynchronously after page render
  // Don't block page display - give DOM time to render first
  setTimeout(() => loadPersistentSignals(), 50);
});

async function generateReport() {
  toast('Generating report‚Ä¶');
  const r = await fetch('/api/report/generate', {method:'POST'}).then(x=>x.json());
  pollJob(`/api/report/generate`, () => {
    toast('Report ready!'); 
  }, e => toast('Error: ' + e, false));
}

async function restartServer() {
  if (!confirm('üîÑ Restart the Flask server? Any ongoing operations will be interrupted. This is needed to apply code changes.\n\nThe server will be back online in ~3 seconds.')) return;
  
  const btn = event.target.closest('button');
  btn.disabled = true;
  btn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Restarting‚Ä¶';
  
  try {
    const r = await fetch('/api/admin/restart', {method: 'POST'}).then(x => x.json()).catch(e => ({ok: false, error: e.message}));
    if (r.ok) {
      toast('Server shutting down and restarting‚Ä¶', true);
      // Wait 2.5s for old process to fully exit and new one to start
      await new Promise(resolve => setTimeout(resolve, 2500));
      
      // Poll for server to come back (max 30 tries = 15 seconds)
      let tries = 0;
      const max_tries = 30;
      const checkServer = setInterval(async () => {
        try {
          const health = await fetch('/', {method: 'GET', signal: AbortSignal.timeout(2000)});
          if (health.ok) {
            clearInterval(checkServer);
            toast('‚úÖ Server restarted and ready!', true);
            setTimeout(() => location.reload(), 800);
            return;
          }
        } catch (e) {
          // Still connecting...
        }
        
        tries++;
        if (tries >= max_tries) {
          clearInterval(checkServer);
          toast('‚ö†Ô∏è Server did not respond after 15s. Click to refresh manually.', false);
          btn.disabled = false;
          btn.innerHTML = '<i class="bi bi-arrow-clockwise me-1"></i>Restart Server';
        }
      }, 500);
    } else {
      toast('Failed to restart: ' + (r.error || 'Unknown error'), false);
      btn.disabled = false;
      btn.innerHTML = '<i class="bi bi-arrow-clockwise me-1"></i>Restart Server';
    }
  } catch (e) {
    toast('Error: ' + e.message, false);
    btn.disabled = false;
    btn.innerHTML = '<i class="bi bi-arrow-clockwise me-1"></i>Restart Server';
  }
}
</script>
{% endblock %}
