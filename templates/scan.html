{% extends "base.html" %}
{% block title %}SEPA Scan{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h4 class="mb-0"><i class="bi bi-funnel me-2" style="color:var(--accent)"></i>SEPA 3-Stage Screen</h4>
  <div class="d-flex align-items-center gap-3">
    <span id="tradingDateBadge" class="badge bg-dark border border-secondary small" title="US trading date being scanned"></span>
    <span id="clockHK" class="badge bg-dark border border-secondary small" title="Hong Kong Time (UTC+8)"></span>
    <span id="clockUS" class="badge bg-dark border border-secondary small" title="US Eastern Time"></span>
    <span id="lastScanBadge" class="badge bg-secondary d-none"></span>
  </div>
</div>

<!-- Controls row -->
<div class="row g-3 mb-3">
  <div class="col-12 col-md-8">
    <div class="card">
      <div class="card-body">
        <p class="text-muted small mb-3">
          <strong>Stage 1</strong> â€” NASDAQ FTP / Finviz coarse filter (USA listed stocks, price/volume/EPS/ROE)&emsp;
          <strong>Stage 2</strong> â€” Minervini TT1-TT10 exact validation (batch download + parallel)&emsp;
          <strong>Stage 3</strong> â€” 5-pillar SEPA scoring + VCP detection (parallel)
        </p>
        <!-- Stage 1 Source selector -->
        <div class="d-flex align-items-center gap-2 mb-3 flex-wrap">
          <label class="text-muted small mb-0" for="sepaStage1Source">Stage 1 ä¾†æº / Source:</label>
          <select class="form-select form-select-sm w-auto" id="sepaStage1Source" onchange="onSepaSourceChange()">
            <option value="nasdaq_ftp" selected>NASDAQ FTP (æ¨è–¦ / Recommended)</option>
            <option value="finviz">Finviz</option>
          </select>
          <div id="sepaNote_nasdaq_ftp" class="text-muted small">
            <i class="bi bi-info-circle me-1"></i>å…è²»éœæ…‹æª”æ¡ˆï¼Œç´„ 2-4 åˆ†é˜ï¼Œåƒ…ä¸Šå¸‚è‚¡ç¥¨ã€‚
            Free static file, ~2-4 min, listed stocks only.
          </div>
          <div id="sepaNote_finviz" class="text-muted small d-none">
            <i class="bi bi-info-circle me-1"></i>finvizfinance ç¯©é¸ï¼Œç´„ 10-15 åˆ†é˜ï¼ŒOTC è‚¡ç¥¨å·²è‡ªå‹•éæ¿¾ã€‚
            finvizfinance filter, ~10-15 min, OTC stocks auto-removed.
          </div>
        </div>
        <div class="d-flex gap-2 align-items-center flex-wrap">
          <button class="btn btn-accent px-4" id="btnScan" onclick="startScan()">
            <i class="bi bi-play-fill me-1"></i>Run Scan
          </button>
          <button class="btn btn-outline-danger px-3 d-none" id="btnStop" onclick="stopScan()">
            <i class="bi bi-stop-fill me-1"></i>Stop
          </button>
          <div class="form-check ms-2">
            <input class="form-check-input" type="checkbox" id="chkRefresh">
            <label class="form-check-label text-muted small" for="chkRefresh">
              Force refresh RS rankings <span class="text-warning">(ignore daily cache)</span>
            </label>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-12 col-md-4">
    <div class="card h-100">
      <div class="card-body py-2">
        <div id="scanStatus" class="text-muted small mb-1">Ready. Previous results shown below (if any).</div>
        <div id="scanMeta" class="text-muted small"></div>
      </div>
    </div>
  </div>
</div>

<!-- â”€â”€ Speed & Cache Info Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="cacheInfoPanel" class="card mb-3" style="background:#0d1b2a; border-color:#1c2f42;">
  <div class="card-body py-2">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <i class="bi bi-lightning-charge me-1" style="color:var(--accent)"></i>
        <span class="small fw-semibold" style="color:var(--accent)">Speed &amp; Cache Status</span>
      </div>
      <button class="btn btn-sm btn-outline-secondary py-0 px-2" onclick="loadCacheInfo()" title="Refresh cache info">
        <i class="bi bi-arrow-clockwise"></i>
      </button>
    </div>
    <div id="cacheInfoBody" class="mt-2">
      <div class="row g-2 small">
        <div class="col-md-3">
          <span class="text-muted">RS Rankings:</span>
          <span id="cacheRS" class="ms-1 badge bg-secondary">checking...</span>
        </div>
        <div class="col-md-3">
          <span class="text-muted">Price Cache:</span>
          <span id="cachePrice" class="ms-1 badge bg-secondary">checking...</span>
        </div>
        <div class="col-md-3">
          <span class="text-muted">Fundamentals:</span>
          <span id="cacheFundamentals" class="ms-1 badge bg-secondary">checking...</span>
        </div>
        <div class="col-md-3">
          <span class="text-muted">Est. Speed:</span>
          <span id="cacheEstimate" class="ms-1 badge bg-secondary">checking...</span>
        </div>
      </div>
      <div id="cacheHints" class="mt-2 small text-muted"></div>
    </div>
  </div>
</div>

<!-- â”€â”€ API Rate Limits Info Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="card mb-3" style="background:#0d1b2a; border-color:#2d3f52; border-left: 3px solid var(--accent);">
  <div class="card-body py-2">
    <button class="btn btn-sm btn-link p-0 text-start w-100" onclick="toggleRateLimitInfo()" style="text-decoration:none;">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <i class="bi bi-exclamation-circle me-1" style="color:var(--accent)"></i>
          <span class="small fw-semibold" style="color:var(--accent)">API Rate Limits &amp; Best Practices</span>
        </div>
        <i class="bi bi-chevron-down" id="rateLimitToggle" style="color:#8b949e;"></i>
      </div>
    </button>
    <div id="rateLimitInfo" class="mt-2 small text-muted d-none" style="background:#0a0f18; border-radius:4px; padding:10px;">
      <div class="mb-3">
        <strong style="color:#c9d1d9;">ğŸ“Š yfinance (Yahoo Finance)</strong>
        <div class="ms-2 small">
          <div>- æ­·å²åƒ¹æ ¼èˆ‡åŸºæœ¬é¢æ•¸æ“š</div>
          <div>- <strong style="color:#f85149;">é€Ÿç‡é™åˆ¶</strong>: æ¯å°æ™‚é™åˆ¶ï¼ˆä¸å…¬é–‹ï¼‰ï¼ŒIPå¯èƒ½è¢«æš«æ™‚é™åˆ¶</div>
          <div>- <strong style="color:#3fb950;">å°ç­–</strong>: æ‰¹æ¬¡é–“éš” 0.5-1.5 ç§’ã€ä¸¦è¡Œå·¥ä½œè€…å—é™ã€æ¯æ—¥å¿«å–</div>
        </div>
      </div>
      <div class="mb-3">
        <strong style="color:#c9d1d9;">ğŸ” finvizfinance (Finviz)</strong>
        <div class="ms-2 small">
          <div>- è‚¡ç¥¨ç¯©é¸å™¨ã€ç”¢æ¥­æ’åã€å¿«é€Ÿå¿«ç…§</div>
          <div>- <strong style="color:#f85149;">é€Ÿç‡é™åˆ¶</strong>: åçˆ¬èŸ²æ©Ÿåˆ¶ï¼Œéœ€è¦ 1.2+ ç§’é–“éš”</div>
          <div>- <strong style="color:#3fb950;">å°ç­–</strong>: 1.2 ç§’ polite delayã€4 å°æ™‚ in-memory å¿«å–</div>
        </div>
      </div>
      <div class="mb-2">
        <strong style="color:#c9d1d9;">ğŸ’¡ ä½¿ç”¨å»ºè­°</strong>
        <div class="ms-2 small">
          <div>âœ… <span style="color:#3fb950;">æ¯æ—¥å¤šæ¬¡æƒæ</span>: åŒæ—¥é‡è¤‡æƒæåˆ©ç”¨å¿«å–ï¼Œ<strong>~2-5 åˆ†é˜</strong></div>
          <div>âœ… <span style="color:#3fb950;">é¦–æ—¥æƒæ</span>: é æœŸ 7-12 åˆ†é˜ï¼ˆä¾ç¯©é¸çµæœæ•¸é‡ï¼‰</div>
          <div>âš ï¸ <span style="color:#d29922;">é¿å…åŒæ™‚å¤šå€‹æƒæ</span>: é€£çºŒæƒæ OKï¼Œä¸¦è¡Œæƒæå¯èƒ½è§¸ç™¼é™åˆ¶</div>
          <div>âŒ <span style="color:#f85149;">å¦‚æ”¶åˆ° HTTP 429</span>: ç³»çµ±è‡ªå‹•é™é€Ÿã€ç¨å€™å¾Œé‡è©¦</div>
          <div>â€” <span style="color:#8b949e;">æƒæçµæœåŒæ—¥å¿«å–ï¼Œåˆå¾Œå†æƒæé€šå¸¸ä¸å¿…é‡æ–°ä¸‹è¼‰</span></div>
        </div>
      </div>
    </div>
  </div>
</div>


<!-- â”€â”€ Progress panel (visible while scanning) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="scanLoading" class="card mb-3 d-none">
  <div class="card-body">
    <div class="d-flex justify-content-between mb-2 small">
      <span id="step1" class="step-label text-muted">â‘  RS Rankings</span>
      <span id="step2" class="step-label text-muted">â‘¡ Coarse Filter</span>
      <span id="step3" class="step-label text-muted">â‘¢ Batch DL + TT</span>
      <span id="step4" class="step-label text-muted">â‘£ SEPA Scoring</span>
      <span id="step5" class="step-label text-muted">âœ… Done</span>
    </div>
    <div class="progress mb-2" style="height:12px; border-radius:6px; background:#1c2333;">
      <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated"
           role="progressbar" style="width:2%; background:linear-gradient(90deg,var(--accent),var(--accent2))"></div>
    </div>
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <span id="progressStage" class="fw-semibold" style="color:var(--accent)">Initialisingâ€¦</span>
        <span id="progressMsg" class="text-muted ms-2 small"></span>
      </div>
      <div id="progressTicker" class="badge px-2 py-1"
           style="background:var(--accent2); font-size:0.8rem; min-width:60px"></div>
    </div>
    <!-- Live scoring log (per-ticker details scroll area) -->
    <div id="liveLogWrap" class="mt-2 d-none" style="max-height:120px; overflow-y:auto; background:#0a0f18; border-radius:4px; padding:6px 10px; font-family:monospace; font-size:0.75rem; color:#8b949e;">
      <div id="liveLog"></div>
    </div>
  </div>
</div>

<!-- â”€â”€ Results table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<!-- Log file bar -->
<div id="scanLogBar" class="mb-2 d-none">
  <div class="card" style="background:#0d1520; border-color:#1e2d3d;">
    <div class="card-body py-2 d-flex align-items-center gap-2 small">
      <i class="bi bi-journal-text" style="color:var(--accent)"></i>
      <span class="text-muted">Log file:</span>
      <code id="scanLogPath" style="color:#58a6ff; font-size:0.8rem;"></code>
    </div>
  </div>
</div>
<div id="resultsSection" class="d-none">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <span id="resultCount" class="text-muted small"></span>
    <div class="d-flex gap-2 align-items-center">      <div class="form-check form-switch ms-2">
        <input class="form-check-input" type="checkbox" id="chkShowAll" onchange="toggleShowAll()">
        <label class="form-check-label text-muted small" for="chkShowAll">
          é¡¯ç¤ºå…¨éƒ¨åˆ†æè‚¡ç¥¨ <span id="allScoredCount" class="badge bg-secondary ms-1 d-none"></span>
        </label>
      </div>      <button class="btn btn-sm btn-outline-info" onclick="toggleFilterPanel()" title="Advanced filters">
        <i class="bi bi-funnel me-1"></i><span id="filterBadge" class="badge bg-info ms-1 d-none">0</span>
      </button>
      <input class="form-control form-control-sm" style="width:170px" id="filterInput"
             placeholder="Search ticker / sectorâ€¦" oninput="filterTable()">
    </div>
  </div>

  <!-- â”€â”€ Collapsible Filter Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div id="filterPanel" class="card mb-3 d-none" style="background:#0d1b2a; border-color:#1c2f42;">
    <div class="card-body p-3">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h6 class="mb-0">Advanced Filters</h6>
        <button class="btn btn-sm btn-outline-secondary" onclick="resetFilters()">
          <i class="bi bi-arrow-clockwise me-1"></i>Reset
        </button>
      </div>

      <div class="row g-3">
        <!-- SEPA Score -->
        <div class="col-md-4">
          <label class="form-label small mb-1">SEPA Score</label>
          <div class="d-flex gap-2 align-items-center">
            <input type="number" class="form-control form-control-sm" id="sepaMin" min="0" max="100"
                   placeholder="Min" oninput="filterTable()" style="width:60px;">
            <span class="text-muted" style="font-size:0.8rem;">â€”</span>
            <input type="number" class="form-control form-control-sm" id="sepaMax" min="0" max="100"
                   placeholder="Max" oninput="filterTable()" style="width:60px;">
          </div>
        </div>

        <!-- Trend Score -->
        <div class="col-md-4">
          <label class="form-label small mb-1">Trend (0-100)</label>
          <div class="d-flex gap-2 align-items-center">
            <input type="number" class="form-control form-control-sm" id="trendMin" min="0" max="100"
                   placeholder="Min" oninput="filterTable()" style="width:60px;">
            <span class="text-muted" style="font-size:0.8rem;">â€”</span>
            <input type="number" class="form-control form-control-sm" id="trendMax" min="0" max="100"
                   placeholder="Max" oninput="filterTable()" style="width:60px;">
          </div>
        </div>

        <!-- Fundamental Score -->
        <div class="col-md-4">
          <label class="form-label small mb-1">Fundamentals (0-100)</label>
          <div class="d-flex gap-2 align-items-center">
            <input type="number" class="form-control form-control-sm" id="fundMin" min="0" max="100"
                   placeholder="Min" oninput="filterTable()" style="width:60px;">
            <span class="text-muted" style="font-size:0.8rem;">â€”</span>
            <input type="number" class="form-control form-control-sm" id="fundMax" min="0" max="100"
                   placeholder="Max" oninput="filterTable()" style="width:60px;">
          </div>
        </div>

        <!-- RS Rank -->
        <div class="col-md-4">
          <label class="form-label small mb-1">RS Rank (0-99)</label>
          <div class="d-flex gap-2 align-items-center">
            <input type="number" class="form-control form-control-sm" id="rsMin" min="0" max="99"
                   placeholder="Min" oninput="filterTable()" style="width:60px;">
            <span class="text-muted" style="font-size:0.8rem;">â€”</span>
            <input type="number" class="form-control form-control-sm" id="rsMax" min="0" max="99"
                   placeholder="Max" oninput="filterTable()" style="width:60px;">
          </div>
        </div>

        <!-- Price -->
        <div class="col-md-4">
          <label class="form-label small mb-1">Price ($)</label>
          <div class="d-flex gap-2 align-items-center">
            <input type="number" class="form-control form-control-sm" id="priceMin" min="0" step="0.01"
                   placeholder="Min" oninput="filterTable()" style="width:60px;">
            <span class="text-muted" style="font-size:0.8rem;">â€”</span>
            <input type="number" class="form-control form-control-sm" id="priceMax" min="0" step="0.01"
                   placeholder="Max" oninput="filterTable()" style="width:60px;">
          </div>
        </div>

        <!-- Pivot ($) -->
        <div class="col-md-4">
          <label class="form-label small mb-1">Pivot ($)</label>
          <div class="d-flex gap-2 align-items-center">
            <input type="number" class="form-control form-control-sm" id="pivotMin" min="0" step="0.01"
                   placeholder="Min" oninput="filterTable()" style="width:60px;">
            <span class="text-muted" style="font-size:0.8rem;">â€”</span>
            <input type="number" class="form-control form-control-sm" id="pivotMax" min="0" step="0.01"
                   placeholder="Max" oninput="filterTable()" style="width:60px;">
          </div>
        </div>

        <!-- VCP Grade -->
        <div class="col-md-4">
          <label class="form-label small mb-1">VCP Grade</label>
          <div class="btn-group btn-group-sm w-100" role="group">
            <input type="checkbox" class="btn-check" id="vcpA" value="A" onchange="filterTable()">
            <label class="btn btn-outline-info btn-sm" for="vcpA">A</label>
            <input type="checkbox" class="btn-check" id="vcpB" value="B" onchange="filterTable()">
            <label class="btn btn-outline-info btn-sm" for="vcpB">B</label>
            <input type="checkbox" class="btn-check" id="vcpC" value="C" onchange="filterTable()">
            <label class="btn btn-outline-info btn-sm" for="vcpC">C</label>
            <input type="checkbox" class="btn-check" id="vcpNone" value="None" onchange="filterTable()">
            <label class="btn btn-outline-info btn-sm" for="vcpNone">None</label>
          </div>
        </div>

        <!-- Trend Template -->
        <div class="col-md-4">
          <label class="form-label small mb-1">Trend Template (TT)</label>
          <div class="btn-group btn-group-sm w-100" role="group">
            <input type="checkbox" class="btn-check" id="ttPass" value="pass" onchange="filterTable()" checked>
            <label class="btn btn-outline-success btn-sm" for="ttPass">Pass</label>
            <input type="checkbox" class="btn-check" id="ttFail" value="fail" onchange="filterTable()">
            <label class="btn btn-outline-danger btn-sm" for="ttFail">Fail</label>
          </div>
        </div>

        <!-- Sector (multi-select) -->
        <div class="col-md-4">
          <label class="form-label small mb-1">Sector</label>
          <select class="form-select form-select-sm" id="sectorFilter" multiple onchange="filterTable()"
                  style="min-height:36px; font-size:0.875rem;">
          </select>
          <small class="text-muted d-block mt-1">Hold Ctrl to select multiple</small>
        </div>
      </div>
    </div>
  </div>

  <!-- æƒææ‘˜è¦åœ– Scan Summary Charts -->
  <div id="scanSummaryCharts" class="row g-3 mb-3" style="display:none">
    <div class="col-12 col-md-6">
      <div class="card">
        <div class="card-header small"><i class="bi bi-pie-chart me-2"></i>Sector åˆ†ä½ˆ Distribution</div>
        <div class="card-body" style="position:relative;height:200px">
          <canvas id="sectorDonutChart"></canvas>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-6">
      <div class="card">
        <div class="card-header small"><i class="bi bi-bar-chart me-2"></i>SEPA Score åˆ†ä½ˆ Distribution</div>
        <div class="card-body" style="position:relative;height:200px">
          <canvas id="scoreHistChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center py-2">
      <span class="small text-muted">æƒæçµæœè¡¨æ ¼ Scan Results Table</span>
      <button class="btn btn-sm btn-outline-secondary" onclick="exportCSV()" title="ä¸‹è¼‰ç›®å‰é¡¯ç¤ºçµæœç‚º CSV">
        <i class="bi bi-download me-1"></i>ä¸‹è¼‰ CSV
      </button>
    </div>
    <div class="table-responsive">
      <table class="table table-hover mb-0 align-middle" id="scanTable">
        <thead>
          <tr>
            <th>#</th>
            <th>Ticker</th>
            <th title="Weighted SEPA total">SEPA Score</th>
            <th title="Trend pillar (0-100)">Trend</th>
            <th title="Fundamentals pillar (0-100)">Fund.</th>
            <th title="IBD-style RS percentile rank">RS</th>
            <th>VCP</th>
            <th>Pivot</th>
            <th>Price</th>
            <th title="Passes Trend Template">TT</th>
            <th>Sector</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="scanBody"></tbody>
      </table>
    </div>
  </div>
</div>

<style>
.step-label { transition: color .3s; }
.step-label.active { color: var(--accent) !important; font-weight: 600; }
.step-label.done   { color: #3fb950 !important; }

/* Below-threshold rows â€” dimmed appearance */
.row-below-threshold { opacity: 0.5; }
.row-below-threshold:hover { opacity: 0.75; }
</style>
{% endblock %}

{% block extra_js %}
<script>
let _scanData      = [];   // passed quality gate
let _allScoredData = [];   // ALL scored stocks (including below threshold)
let _currentJid    = null;
let _showAll       = false; // toggle state
const SCAN_CACHE_VERSION = 'scan-cache-v2';

/* --- Page load: restore last scan (delayed to avoid blocking) -------- */
window.addEventListener('DOMContentLoaded', () => {
  const cachedVer  = sessionStorage.getItem('sepa_scan_cache_ver');
  const cached     = sessionStorage.getItem('sepa_scan_data');
  const cachedMeta = sessionStorage.getItem('sepa_scan_meta');
  if (cached && cachedVer === SCAN_CACHE_VERSION) {
    try {
      const parsed = JSON.parse(cached);
      // Support both old format (array) and new format ({rows, all_scored})
      if (Array.isArray(parsed)) {
        _scanData = parsed;
        _allScoredData = [];
      } else {
        _scanData = parsed.rows || [];
        _allScoredData = parsed.all_scored || [];
      }
      if (_scanData.length) {
        setTimeout(() => {
          renderScanTable(_getDisplayData());
          populateSectorFilter(_allScoredData.length ? _allScoredData : _scanData);
          updateAllScoredBadge();
          showBadge(cachedMeta || `${_scanData.length} stocks (cached)`);
        }, 50);
        return;
      }
    } catch(e) {}
  }
  // Delay loading server data to avoid blocking page render
  // Use timeout signal to abort if server is slow
  setTimeout(() => {
    const ctrl = new AbortController();
    const timer = setTimeout(() => ctrl.abort(), 3000);
    fetch('/api/scan/last?include_all=1', {signal: ctrl.signal})
      .then(r => r.json())
      .then(d => {
        clearTimeout(timer);
        if (d.rows && d.rows.length) {
          _scanData = d.rows;
          _allScoredData = d.all_scored || [];
          setTimeout(() => {
            renderScanTable(_getDisplayData());
            populateSectorFilter(_allScoredData.length ? _allScoredData : _scanData);
            updateAllScoredBadge();
            const ts = d.saved_at ? new Date(d.saved_at).toLocaleString() : '';
            showBadge(`Last scan: ${ts} (${d.count} stocks passed, ${d.all_scored_count || d.count} scored)`);
          }, 50);
        }
      })
      .catch(() => { clearTimeout(timer); });
  }, 300);
});

function showBadge(txt) {
  const el = document.getElementById('lastScanBadge');
  el.textContent = txt; el.classList.remove('d-none');
}

/* â”€â”€â”€ Start scan â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function onSepaSourceChange() {
  const src = document.getElementById('sepaStage1Source').value;
  ['nasdaq_ftp', 'finviz'].forEach(s => {
    const el = document.getElementById('sepaNote_' + s);
    if (el) el.classList.toggle('d-none', s !== src);
  });
}

async function startScan() {
  const refreshRs    = document.getElementById('chkRefresh').checked;
  const stage1Source = document.getElementById('sepaStage1Source').value;
  document.getElementById('btnScan').disabled = true;
  document.getElementById('btnStop').classList.remove('d-none');
  document.getElementById('btnStop').disabled = false;
  document.getElementById('scanLoading').classList.remove('d-none');
  document.getElementById('scanStatus').textContent = 'Scan in progressâ€¦';
  // Reset live log
  _lastLogTicker = '';
  document.getElementById('liveLog').innerHTML = '';
  document.getElementById('liveLogWrap').classList.add('d-none');
  setStep(0);

  let r;
  try {
    r = await fetch('/api/scan/run', {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({refresh_rs: refreshRs, stage1_source: stage1Source})
    }).then(x => x.json());
  } catch(e) { onScanError(e.message); return; }

  _currentJid = r.job_id;
  scanPoll(`/api/scan/status/${_currentJid}`);
}

function scanPoll(url) {
  fetch(url).then(r => r.json()).then(job => {
    if      (job.status === 'done')      onScanDone(job.result || [], job.log_file || '');
    else if (job.status === 'error')     onScanError(job.error || 'Unknown error');
    else if (job.status === 'not_found') onScanError('Job not found');
    else {
      renderProgress(job.progress || {});
      setTimeout(() => scanPoll(url), 2000);
    }
  }).catch(() => setTimeout(() => scanPoll(url), 3000));
}

let _lastLogTicker = '';

function renderProgress(p) {
  const pct = p.pct || 0;
  document.getElementById('progressBar').style.width    = Math.max(pct, 2) + '%';
  document.getElementById('progressStage').textContent  = p.stage  || 'â€¦';
  document.getElementById('progressMsg').textContent    = p.msg    || '';
  document.getElementById('progressTicker').textContent = p.ticker || '';

  // Live log for per-ticker scoring (Stage 3 & Stage 2)
  const liveLogWrap = document.getElementById('liveLogWrap');
  const liveLog     = document.getElementById('liveLog');
  if (p.ticker && p.ticker !== _lastLogTicker) {
    _lastLogTicker = p.ticker;
    liveLogWrap.classList.remove('d-none');
    const ts = new Date().toLocaleTimeString();
    const line = document.createElement('div');
    line.innerHTML = `<span style="color:#58a6ff">${ts}</span> <span style="color:#d2a8ff">${p.ticker}</span> <span style="color:#8b949e">${p.msg || ''}</span>`;
    liveLog.appendChild(line);
    // Keep max 50 lines
    while (liveLog.children.length > 50) liveLog.removeChild(liveLog.firstChild);
    liveLogWrap.scrollTop = liveLogWrap.scrollHeight;
  }

  // Step highlight
  const s = (p.stage || '').toLowerCase();
  clearSteps();
  if      (pct <= 5)                           setStep(0);
  else if (s.includes('rs')   || pct <= 14)   setStep(1);
  else if (s.includes('coarse') || pct <= 33) setStep(2);
  else if (s.includes('trend') || pct <= 66)  setStep(3);
  else if (pct < 100)                          setStep(4);
  else                                         setStep(5);
}

function clearSteps() {
  for (let i = 1; i <= 5; i++) {
    const el = document.getElementById('step' + i);
    el.classList.remove('active', 'done');
  }
}
function setStep(n) {
  for (let i = 1; i < n; i++)
    document.getElementById('step' + i).classList.add('done');
  if (n >= 1 && n <= 5)
    document.getElementById('step' + n).classList.add('active');
}

function onScanDone(rows, logFile) {
  _scanData = rows;
  document.getElementById('scanLoading').classList.add('d-none');
  document.getElementById('btnScan').disabled = false;
  document.getElementById('btnStop').classList.add('d-none');
  setStep(5);
  
  const ts   = new Date().toLocaleString();
  const meta = `Last scan: ${ts} (${_scanData.length} stocks)`;
  
  // Fetch all scored data (in background, non-blocking)
  fetch('/api/scan/last?include_all=1')
    .then(r => r.json())
    .then(d => {
      _allScoredData = d.all_scored || [];
      updateAllScoredBadge();
      populateSectorFilter(_allScoredData.length ? _allScoredData : _scanData);
      // Update session cache with all_scored
      try {
        sessionStorage.setItem('sepa_scan_cache_ver', SCAN_CACHE_VERSION);
        sessionStorage.setItem('sepa_scan_data', JSON.stringify({
          rows: _scanData, all_scored: _allScoredData
        }));
      } catch(e) {}
    })
    .catch(() => {});
  
  // Delay rendering to avoid blocking
  setTimeout(() => {
    renderScanTable(_getDisplayData());
    populateSectorFilter(_scanData);
    showBadge(meta);
  }, 50);
  
  try {
    sessionStorage.setItem('sepa_scan_cache_ver', SCAN_CACHE_VERSION);
    sessionStorage.setItem('sepa_scan_data', JSON.stringify({
      rows: _scanData, all_scored: _allScoredData
    }));
    sessionStorage.setItem('sepa_scan_meta', meta);
  } catch(e) {}

  // æŒä¹…å®Œæˆé€šçŸ¥ï¼ˆä¸è‡ªå‹•é—œé–‰ï¼‰
  const logHint = logFile ? `<br><small class="text-muted">æ—¥èªŒ: ${logFile}</small>` : '';
  toastCompletion(
    `âœ… æƒæå®Œæˆ â€” æ‰¾åˆ° ${_scanData.length} æª”è‚¡ç¥¨${logHint}`,
    true
  );

  // Show persistent log bar
  if (logFile) {
    document.getElementById('scanLogPath').textContent = logFile;
    document.getElementById('scanLogBar').classList.remove('d-none');
  }

  // Refresh cache info after scan completes
  loadCacheInfo();
}

function populateSectorFilter(data) {
  const select = document.getElementById('sectorFilter');
  const sectors = [...new Set(data.map(r => r.sector).filter(s => s))].sort();
  select.innerHTML = '';
  sectors.forEach(sector => {
    const opt = document.createElement('option');
    opt.value = sector;
    opt.textContent = sector;
    select.appendChild(opt);
  });
}

/* â”€â”€ Show-all toggle helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function _getDisplayData() {
  if (_showAll && _allScoredData.length) {
    // Mark which ones passed the quality gate
    const passedSet = new Set(_scanData.map(r => r.ticker));
    return _allScoredData.map(r => ({...r, _passed: passedSet.has(r.ticker)}));
  }
  return _scanData.map(r => ({...r, _passed: true}));
}

function toggleShowAll() {
  _showAll = document.getElementById('chkShowAll').checked;
  if (_showAll && !_allScoredData.length) {
    // Need to fetch all_scored from server
    document.getElementById('chkShowAll').disabled = true;
    fetch('/api/scan/last?include_all=1')
      .then(r => r.json())
      .then(d => {
        _allScoredData = d.all_scored || [];
        updateAllScoredBadge();
        renderScanTable(_getDisplayData());
        populateSectorFilter(_allScoredData.length ? _allScoredData : _scanData);
        document.getElementById('chkShowAll').disabled = false;
      })
      .catch(() => { document.getElementById('chkShowAll').disabled = false; });
    return;
  }
  renderScanTable(_getDisplayData());
  populateSectorFilter(_showAll && _allScoredData.length ? _allScoredData : _scanData);
}

function updateAllScoredBadge() {
  const badge = document.getElementById('allScoredCount');
  if (_allScoredData.length) {
    badge.textContent = _allScoredData.length;
    badge.classList.remove('d-none');
  }
}

function onScanError(err) {
  document.getElementById('scanLoading').classList.add('d-none');
  document.getElementById('btnScan').disabled = false;
  document.getElementById('btnStop').classList.add('d-none');
  document.getElementById('scanStatus').innerHTML =
    `<span class="text-danger"><i class="bi bi-exclamation-triangle me-1"></i>Error: ${err}</span>`;
  toast('Scan error: ' + err, false);
}

/* â”€â”€â”€ Stop scan â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function stopScan() {
  if (!_currentJid) return;
  document.getElementById('btnStop').disabled = true;
  document.getElementById('progressStage').textContent = 'Cancellingâ€¦';
  await fetch(`/api/scan/cancel/${_currentJid}`, {method: 'POST'}).catch(() => {});
  toast('Stop signal sent â€” finishing current tickerâ€¦', true);
}

/* â”€â”€â”€ Render results table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderScanTable(data) {
  const body = document.getElementById('scanBody');
  body.innerHTML = '';
  if (!data.length) {
    body.innerHTML =
      '<tr><td colspan="12" class="text-center text-muted py-4">' +
      'No stocks passed all SEPA filters. ' +
      'Try refreshing RS rankings or wait for better market breadth.</td></tr>';
  } else {
    // Use DocumentFragment to avoid O(nÂ²) DOM operations
    const fragment = document.createDocumentFragment();
    let passedCount = 0;
    data.forEach((r, i) => {
      const passed = r._passed !== false;  // default to passed if not set
      if (passed) passedCount++;
      const total  = r.total_score != null ? Number(r.total_score).toFixed(1) : 'â€”';
      const tCls   = r.total_score >= 75 ? 'score-high' : r.total_score >= 55 ? 'score-mid' : 'score-low';
      const trend  = r.trend_score        != null ? Number(r.trend_score).toFixed(0)        : 'â€”';
      const fund   = r.fundamental_score  != null ? Number(r.fundamental_score).toFixed(0)  : 'â€”';
      const rs     = r.rs_rank            != null ? Number(r.rs_rank).toFixed(0)             : 'â€”';
      const vcpGrd = r.vcp_grade && r.vcp_grade !== 'D'
                     ? `<span class="tag-vcp">VCP ${r.vcp_grade}</span>` : 'â€”';
      const pivotVal = r.pivot != null ? r.pivot : (r.pivot_price != null ? r.pivot_price : null);
      const pivot  = pivotVal != null ? `$${Number(pivotVal).toFixed(2)}` : 'â€”';
      const price  = r.close != null ? `$${Number(r.close).toFixed(2)}`
                   : r.price != null ? `$${Number(r.price).toFixed(2)}` : 'â€”';
      const ttOk   = (r.tt_score != null && r.tt_score >= 8) || r.tt_pass === true;
      const ttIcon = ttOk
        ? '<i class="bi bi-check-circle-fill text-success"></i>'
        : '<i class="bi bi-x-circle text-danger"></i>';
      const ttScoreLabel = r.tt_score != null ? `${Number(r.tt_score).toFixed(0)}/10` : (ttOk ? 'Pass' : 'Fail');
      const tt9 = r.tt_checks && typeof r.tt_checks === 'object' ? r.tt_checks.TT9 : null;
      const tt10 = r.tt_checks && typeof r.tt_checks === 'object' ? r.tt_checks.TT10 : null;
      const ttExtras = [
        tt9 === true ? 'RSâœ“' : (tt9 === false ? 'RSâœ—' : ''),
        tt10 === true ? 'Secâœ“' : (tt10 === false ? 'Secâœ—' : '')
      ].filter(Boolean).join(' ');
      const ttHtml = `
        <div class="d-flex flex-column align-items-center" title="Trend Template score and optional TT9/TT10 details">
          <span>${ttIcon} <span class="small ms-1">${ttScoreLabel}</span></span>
          ${ttExtras ? `<small class="text-muted" style="font-size:.65rem">${ttExtras}</small>` : ''}
        </div>
      `;

      const row = document.createElement('tr');
      if (!passed) row.classList.add('row-below-threshold');
      row.setAttribute('data-ticker', r.ticker);
      row.innerHTML = `
        <td class="text-muted small">${i + 1}</td>
        <td>
          <a href="/analyze?ticker=${r.ticker}" class="fw-bold text-decoration-none"
             style="color:${passed ? 'var(--accent)' : '#6e7681'}">${r.ticker}</a>
          ${!passed ? '<span class="badge bg-dark text-muted ms-1" style="font-size:.55rem">æœªé€šé</span>' : ''}
          <div class="text-muted" style="font-size:.7rem">${r.company || ''}</div>
        </td>
        <td class="${passed ? tCls : 'text-muted'} fw-bold">${total}</td>
        <td class="text-muted small">${trend}</td>
        <td class="text-muted small">${fund}</td>
        <td class="text-muted">${rs}</td>
        <td>${vcpGrd}</td>
        <td class="small">${pivot}</td>
        <td class="small">${price}</td>
        <td class="text-center">${ttHtml}</td>
        <td class="text-muted small">${r.sector || 'â€”'}</td>
        <td>
          <button class="btn btn-sm btn-outline-info py-0 px-2" title="Add to Watchlist"
                  onclick="addToWatchlist('${r.ticker}')">
            <i class="bi bi-bookmark-plus"></i>
          </button>
          <a href="/vcp?ticker=${r.ticker}"
             class="btn btn-sm btn-outline-secondary py-0 px-2 ms-1" title="VCP chart">
            <i class="bi bi-activity"></i>
          </a>
        </td>
      `;
      fragment.appendChild(row);
    });
    body.appendChild(fragment);
  }
  const totalShown = data.length;
  const passedOnly = data.filter(r => r._passed !== false).length;
  const statusText = _showAll
    ? `Showing ${totalShown} stocks (${passedOnly} passed, ${totalShown - passedOnly} below threshold)`
    : `Showing ${totalShown} stock${totalShown !== 1 ? 's' : ''}`;
  document.getElementById('scanStatus').textContent = statusText;
  document.getElementById('resultCount').textContent = statusText;
  document.getElementById('resultsSection').classList.remove('d-none');
  // Render summary charts (sector + score distribution) for passed stocks only
  renderScanCharts(data.filter(r => r._passed !== false));
}

/* â”€â”€â”€ Scan summary charts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderScanCharts(passedData) {
  const summary = document.getElementById('scanSummaryCharts');
  if (!summary || !passedData || !passedData.length) {
    if (summary) summary.style.display = 'none';
    return;
  }
  summary.style.display = '';

  // â”€â”€ Sector distribution donut â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const sectorCount = {};
  passedData.forEach(r => {
    const s = r.sector || 'Other';
    sectorCount[s] = (sectorCount[s] || 0) + 1;
  });
  const sectorLabels = Object.keys(sectorCount).sort((a,b) => sectorCount[b] - sectorCount[a]);
  const sectorVals   = sectorLabels.map(s => sectorCount[s]);
  const palette = ['#00d4ff','#58a6ff','#3fb950','#e3b341','#f85149','#c084fc','#f97316','#a3e635','#38bdf8','#fb7185','#34d399'];

  const donutEl = document.getElementById('sectorDonutChart');
  if (donutEl) {
    if (donutEl._chart) donutEl._chart.destroy();
    donutEl._chart = new Chart(donutEl, {
      type: 'doughnut',
      data: {
        labels: sectorLabels,
        datasets: [{ data: sectorVals, backgroundColor: palette, borderWidth: 0 }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: {
          legend: { position: 'right', labels: { color: '#c9d1d9', usePointStyle: true, boxWidth: 10, font: { size: 10 } } }
        },
      },
    });
  }

  // â”€â”€ SEPA Score histogram â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const bins = ['0-20','20-40','40-60','60-70','70-80','80-90','90-100'];
  const binCounts = new Array(7).fill(0);
  passedData.forEach(r => {
    const s = r.total_score != null ? Number(r.total_score) : 0;
    if      (s < 20) binCounts[0]++;
    else if (s < 40) binCounts[1]++;
    else if (s < 60) binCounts[2]++;
    else if (s < 70) binCounts[3]++;
    else if (s < 80) binCounts[4]++;
    else if (s < 90) binCounts[5]++;
    else             binCounts[6]++;
  });
  const binColors = bins.map((_, i) => i <= 2 ? '#f85149' : i <= 3 ? '#e3b341' : '#3fb950');

  const histEl = document.getElementById('scoreHistChart');
  if (histEl) {
    if (histEl._chart) histEl._chart.destroy();
    histEl._chart = new Chart(histEl, {
      type: 'bar',
      data: {
        labels: bins,
        datasets: [{ label: 'Stocks', data: binCounts, backgroundColor: binColors, borderWidth: 0 }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { grid: { color: '#21262d' }, ticks: { color: '#8b949e', font: { size: 10 } } },
          y: { grid: { color: '#21262d' }, ticks: { color: '#8b949e' }, beginAtZero: true },
        },
      },
    });
  }
}

function filterTable() {
  const displayData = _getDisplayData();
  if (!displayData.length) return;

  // Get filter values
  const searchText = document.getElementById('filterInput').value.toLowerCase();
  const sepaMin = parseFloat(document.getElementById('sepaMin').value) || 0;
  const sepaMax = parseFloat(document.getElementById('sepaMax').value) || Infinity;
  const trendMin = parseFloat(document.getElementById('trendMin').value) || 0;
  const trendMax = parseFloat(document.getElementById('trendMax').value) || Infinity;
  const fundMin = parseFloat(document.getElementById('fundMin').value) || 0;
  const fundMax = parseFloat(document.getElementById('fundMax').value) || Infinity;
  const rsMin = parseFloat(document.getElementById('rsMin').value) || 0;
  const rsMax = parseFloat(document.getElementById('rsMax').value) || Infinity;
  const priceMin = parseFloat(document.getElementById('priceMin').value) || 0;
  const priceMax = parseFloat(document.getElementById('priceMax').value) || Infinity;
  const pivotMin = parseFloat(document.getElementById('pivotMin').value) || 0;
  const pivotMax = parseFloat(document.getElementById('pivotMax').value) || Infinity;

  const vcpGrades = new Set();
  if (document.getElementById('vcpA').checked) vcpGrades.add('A');
  if (document.getElementById('vcpB').checked) vcpGrades.add('B');
  if (document.getElementById('vcpC').checked) vcpGrades.add('C');
  if (document.getElementById('vcpNone').checked) vcpGrades.add('None');

  const ttFilters = new Set();
  if (document.getElementById('ttPass').checked) ttFilters.add('pass');
  if (document.getElementById('ttFail').checked) ttFilters.add('fail');

  const sectorSelect = document.getElementById('sectorFilter');
  const selectedSectors = new Set(Array.from(sectorSelect.selectedOptions).map(o => o.value));

  // Apply filters
  const filtered = displayData.filter(r => {
    // Text search
    if (searchText && !((r.ticker || '').toLowerCase().includes(searchText) ||
                        (r.sector || '').toLowerCase().includes(searchText) ||
                        (r.company || '').toLowerCase().includes(searchText))) {
      return false;
    }

    // SEPA Score
    const sepa = r.total_score != null ? parseFloat(r.total_score) : 0;
    if (sepa < sepaMin || sepa > sepaMax) return false;

    // Trend
    const trend = r.trend_score != null ? parseFloat(r.trend_score) : 0;
    if (trend < trendMin || trend > trendMax) return false;

    // Fundamentals
    const fund = r.fundamental_score != null ? parseFloat(r.fundamental_score) : 0;
    if (fund < fundMin || fund > fundMax) return false;

    // RS Rank
    const rs = r.rs_rank != null ? parseFloat(r.rs_rank) : 0;
    if (rs < rsMin || rs > rsMax) return false;

    // Price
    const price = r.close != null ? parseFloat(r.close) : (r.price != null ? parseFloat(r.price) : 0);
    if (price < priceMin || price > priceMax) return false;

    // Pivot
    const pivotVal = r.pivot != null ? r.pivot : (r.pivot_price != null ? r.pivot_price : null);
    const pivot = pivotVal != null ? parseFloat(pivotVal) : 0;
    if (pivot < pivotMin || pivot > pivotMax) return false;

    // VCP Grade
    if (vcpGrades.size > 0) {
      const grade = r.vcp_grade && r.vcp_grade !== 'D' ? r.vcp_grade : 'None';
      if (!vcpGrades.has(grade)) return false;
    }

    // TT Status
    if (ttFilters.size > 0) {
      const ttOk = (r.tt_score != null && r.tt_score >= 8) || r.tt_pass === true;
      const ttStatus = ttOk ? 'pass' : 'fail';
      if (!ttFilters.has(ttStatus)) return false;
    }

    // Sector
    if (selectedSectors.size > 0 && !selectedSectors.has(r.sector)) {
      return false;
    }

    return true;
  });

  // Render filtered table
  renderScanTable(filtered);
  updateFilterBadge();
}

function toggleFilterPanel() {
  const panel = document.getElementById('filterPanel');
  panel.classList.toggle('d-none');
}

function resetFilters() {
  // Reset all filter inputs
  document.getElementById('sepaMin').value = '';
  document.getElementById('sepaMax').value = '';
  document.getElementById('trendMin').value = '';
  document.getElementById('trendMax').value = '';
  document.getElementById('fundMin').value = '';
  document.getElementById('fundMax').value = '';
  document.getElementById('rsMin').value = '';
  document.getElementById('rsMax').value = '';
  document.getElementById('priceMin').value = '';
  document.getElementById('priceMax').value = '';
  document.getElementById('pivotMin').value = '';
  document.getElementById('pivotMax').value = '';
  document.getElementById('filterInput').value = '';

  // Reset checkboxes
  document.getElementById('vcpA').checked = false;
  document.getElementById('vcpB').checked = false;
  document.getElementById('vcpC').checked = false;
  document.getElementById('vcpNone').checked = false;
  document.getElementById('ttPass').checked = true;
  document.getElementById('ttFail').checked = false;

  // Reset sector select
  document.getElementById('sectorFilter').selectedIndex = -1;

  filterTable();
}

function updateFilterBadge() {
  const badge = document.getElementById('filterBadge');
  const sepaMin = document.getElementById('sepaMin').value;
  const sepaMax = document.getElementById('sepaMax').value;
  const trendMin = document.getElementById('trendMin').value;
  const trendMax = document.getElementById('trendMax').value;
  const fundMin = document.getElementById('fundMin').value;
  const fundMax = document.getElementById('fundMax').value;
  const rsMin = document.getElementById('rsMin').value;
  const rsMax = document.getElementById('rsMax').value;
  const priceMin = document.getElementById('priceMin').value;
  const priceMax = document.getElementById('priceMax').value;
  const pivotMin = document.getElementById('pivotMin').value;
  const pivotMax = document.getElementById('pivotMax').value;
  const searchText = document.getElementById('filterInput').value;
  const vcpCount = [
    document.getElementById('vcpA').checked,
    document.getElementById('vcpB').checked,
    document.getElementById('vcpC').checked,
    document.getElementById('vcpNone').checked
  ].filter(x => x).length;
  const ttPass = document.getElementById('ttPass').checked;
  const ttFail = document.getElementById('ttFail').checked;
  const sectorCount = document.getElementById('sectorFilter').selectedOptions.length;

  let count = 0;
  if (sepaMin) count++; if (sepaMax) count++;
  if (trendMin) count++; if (trendMax) count++;
  if (fundMin) count++; if (fundMax) count++;
  if (rsMin) count++; if (rsMax) count++;
  if (priceMin) count++; if (priceMax) count++;
  if (pivotMin) count++; if (pivotMax) count++;
  if (searchText) count++;
  if (vcpCount > 0 && vcpCount < 4) count++;
  if ((ttPass && !ttFail) || (!ttPass && ttFail)) count++;
  if (sectorCount > 0) count++;

  if (count > 0) {
    badge.textContent = count;
    badge.classList.remove('d-none');
  } else {
    badge.classList.add('d-none');
  }
}

async function addToWatchlist(ticker) {
  const r = await fetch('/api/watchlist/add', {
    method: 'POST', headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ticker})
  }).then(x => x.json());
  pollJob(`/api/watchlist/add/status/${r.job_id}`,
    ()  => toast(`${ticker} added to watchlist`),
    err => toast(`Error: ${err}`, false)
  );
}

function exportCSV() {
  const exportData = _getDisplayData();
  if (!exportData.length) return;
  const flat = exportData.map(r => {
    const out = {};
    for (const [k, v] of Object.entries(r))
      if (v === null || typeof v !== 'object') out[k] = v;
    // Add passed/failed column
    out['quality_gate'] = r._passed !== false ? 'PASS' : 'BELOW';
    // Remove internal _passed flag
    delete out['_passed'];
    return out;
  });
  const keys = Object.keys(flat[0]);
  const rows = [keys.join(','),
    ...flat.map(r => keys.map(k => `"${r[k] ?? ''}"`).join(','))];
  const blob = new Blob([rows.join('\n')], {type: 'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `sepa_scan_${new Date().toISOString().slice(0, 10)}.csv`;
  a.click();
}

/* â”€â”€â”€ Cache info loader â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function loadCacheInfo() {
  fetch('/api/scan/cache-info')
    .then(r => r.json())
    .then(d => {
      if (!d.ok) {
        document.getElementById('cacheHints').innerHTML =
          `<div class="text-warning small">Cache check failed: ${d.error || 'unknown'}</div>`;
        ['cacheRS','cachePrice','cacheFundamentals','cacheEstimate'].forEach(id => {
          const el = document.getElementById(id);
          el.textContent = 'N/A'; el.className = 'ms-1 badge bg-secondary';
        });
        return;
      }
      const info = d.cache;

      // RS Rankings
      const rsEl = document.getElementById('cacheRS');
      if (info.rs_cached) {
        rsEl.textContent = `âœ“ cached (${info.rs_count} tickers)`;
        rsEl.className = 'ms-1 badge bg-success';
      } else {
        rsEl.textContent = 'âœ— needs rebuild (~5 min)';
        rsEl.className = 'ms-1 badge bg-warning text-dark';
      }

      // Price cache
      const priceEl = document.getElementById('cachePrice');
      priceEl.textContent = `${info.price_cached_today} today`;
      priceEl.className = info.price_cached_today > 50 ? 'ms-1 badge bg-success' : 'ms-1 badge bg-info';

      // Fundamentals cache
      const fundEl = document.getElementById('cacheFundamentals');
      fundEl.textContent = `${info.fund_cached_today} today`;
      fundEl.className = info.fund_cached_today > 10 ? 'ms-1 badge bg-success' : 'ms-1 badge bg-info';

      // Speed estimate
      const estEl = document.getElementById('cacheEstimate');
      if (info.rs_cached && info.price_cached_today > 100) {
        estEl.textContent = '~2-5 min (cached)';
        estEl.className = 'ms-1 badge bg-success';
      } else if (info.rs_cached) {
        estEl.textContent = '~5-12 min';
        estEl.className = 'ms-1 badge bg-info';
      } else {
        estEl.textContent = '~10-20 min (first run)';
        estEl.className = 'ms-1 badge bg-warning text-dark';
      }

      // Hints
      const hintsEl = document.getElementById('cacheHints');
      let hints = [];
      if (!info.rs_cached)
        hints.push('ğŸ’¡ é¦–æ¬¡æƒæéœ€å»ºç«‹ RS æ’åå¿«å–ï¼ˆ~200 æª”è‚¡ç¥¨ï¼‰ï¼Œç´„ 5 åˆ†é˜');
      if (info.price_cached_today > 100)
        hints.push('âš¡ å·²å¿«å– ' + info.price_cached_today + ' æª”è‚¡åƒ¹è³‡æ–™ï¼ŒStage 2 å°‡å¿«é€Ÿå®Œæˆ (&lt;2 åˆ†é˜)');
      if (info.fund_cached_today > 0)
        hints.push('ğŸ“Š å·²å¿«å– ' + info.fund_cached_today + ' æª”åŸºæœ¬é¢è³‡æ–™ï¼Œé¿å…é‡è¤‡ API èª¿ç”¨');
      if (info.finviz_cached)
        hints.push('ğŸ”„ Finviz ç¯©é¸çµæœå¿«å–ä¸­ï¼ˆ' + info.finviz_ttl_hours + ' å°æ™‚ TTLï¼Œé¿å…åçˆ¬èŸ²é™åˆ¶ï¼‰');
      if (hints.length === 0)
        hints.push('ğŸ’¡ æœ€ä½³å¯¦è¸: æƒæå®Œæˆå¾ŒåŒæ—¥å†æ¬¡æƒæï¼Œåˆ©ç”¨å¿«å–ç¸®çŸ­æ™‚é–“è‡³ 2-5 åˆ†é˜');
      hints.push('â„¹ï¸ è©³ç´° API é™åˆ¶è¨Šæ¯ï¼Œè«‹é»æ“Šä¸Šæ–¹ã€ŒAPI Rate Limits &amp; Best Practicesã€');

      hintsEl.innerHTML = hints.map(h => `<div>${h}</div>`).join('');
    })
    .catch(() => {
      document.getElementById('cacheHints').innerHTML =
        '<div class="text-muted">Unable to load cache info</div>';
    });
}

// Load cache info on page load
setTimeout(loadCacheInfo, 500);

/* â”€â”€â”€ Trading date display â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function updateTradingDate() {
  // Compute last US trading date (approx: skip weekends)
  const now = new Date();
  const usEast = new Date(now.toLocaleString('en-US', {timeZone: 'America/New_York'}));
  let d = new Date(usEast);
  // If before 9:30 AM ET or weekend, use previous trading day
  if (d.getHours() < 9 || (d.getHours() === 9 && d.getMinutes() < 30)) {
    d.setDate(d.getDate() - 1);
  }
  while (d.getDay() === 0 || d.getDay() === 6) {
    d.setDate(d.getDate() - 1);
  }
  const yyyy = d.getFullYear();
  const mm   = String(d.getMonth() + 1).padStart(2, '0');
  const dd   = String(d.getDate()).padStart(2, '0');
  const dayName = d.toLocaleDateString('en-US', {weekday: 'short', timeZone: 'America/New_York'});
  document.getElementById('tradingDateBadge').innerHTML =
    `<i class="bi bi-calendar3 me-1"></i>Trading Date: ${yyyy}-${mm}-${dd} (${dayName})`;
}

/* â”€â”€â”€ Live HK & US clocks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function updateClocks() {
  const now = new Date();
  // Hong Kong time (UTC+8)
  const hkStr = now.toLocaleTimeString('en-GB', {
    timeZone: 'Asia/Hong_Kong', hour: '2-digit', minute: '2-digit', second: '2-digit'
  });
  // US Eastern time
  const usStr = now.toLocaleTimeString('en-GB', {
    timeZone: 'America/New_York', hour: '2-digit', minute: '2-digit', second: '2-digit'
  });
  // Market status
  const usNow = new Date(now.toLocaleString('en-US', {timeZone: 'America/New_York'}));
  const h = usNow.getHours(), m = usNow.getMinutes(), day = usNow.getDay();
  let mktStatus = '';
  if (day >= 1 && day <= 5) {
    const mins = h * 60 + m;
    if (mins >= 570 && mins < 960) mktStatus = ' ğŸŸ¢';      // 9:30-16:00
    else if (mins >= 240 && mins < 570) mktStatus = ' ğŸŸ¡';  // 4:00-9:30 pre-market
    else if (mins >= 960 && mins < 1200) mktStatus = ' ğŸŸ¡'; // 16:00-20:00 after-hours
    else mktStatus = ' ğŸ”´';
  } else {
    mktStatus = ' ğŸ”´';
  }
  document.getElementById('clockHK').innerHTML =
    `<i class="bi bi-clock me-1"></i>HK ${hkStr}`;
  document.getElementById('clockUS').innerHTML =
    `<i class="bi bi-clock me-1"></i>US ${usStr}${mktStatus}`;
}

updateTradingDate();
updateClocks();
setInterval(updateClocks, 1000);

/* â”€â”€â”€ Toggle rate limit info â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function toggleRateLimitInfo() {
  const info = document.getElementById('rateLimitInfo');
  const toggle = document.getElementById('rateLimitToggle');
  info.classList.toggle('d-none');
  toggle.style.transform = info.classList.contains('d-none') ? 'rotate(0deg)' : 'rotate(180deg)';
  toggle.style.transition = 'transform 0.2s';
}
</script>
{% endblock %}
