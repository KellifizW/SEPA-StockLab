{% extends "base.html" %}
{% block title %}QM 掃描 Scan{% endblock %}

{% block extra_head %}
<style>
  .star-5p  { color: #3fb950; font-weight: 700; }
  .star-5   { color: #3fb950; }
  .star-4   { color: #e3b341; }
  .star-3   { color: #8b949e; }
  .star-low { color: #f85149; }
  .badge-htf  { background: #1b6e2e; color: #3fb950; }
  .badge-ep   { background: #4a3800; color: #e3b341; }
  .badge-lad  { background: #1a3060; color: #58a6ff; }
  .badge-surf { background: #003040; color: #00d4ff; }
  .badge-rpl  { background: #3a0060; color: #d49fff; }
  .badge-flag { background: #301020; color: #ff8fa3; }
  .badge-uk   { background: #1c2128; color: #8b949e; }
  .qm-row:hover { background: #1a2030 !important; cursor: pointer; }
  .progress-stage { font-size: 12px; color: #8b949e; margin-top: 4px; }
  .filter-bar { background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 16px; }
  .veto-badge { background: #3a0a0a; color: #f85149; font-size: 10px;
                border-radius: 3px; padding: 1px 5px; }
</style>
{% endblock %}

{% block content %}
<div class="d-flex align-items-center mb-3 gap-3">
  <h4 class="mb-0"><i class="bi bi-lightning-charge-fill me-2" style="color:#e3b341"></i>
    Qullamaggie 突破波段掃描 <span style="color:#8b949e;font-size:13px">Breakout Swing Scanner</span>
  </h4>
  <span class="badge bg-secondary ms-auto">每日收盤後使用 • Use after market close</span>
</div>

<!-- Controls row -->
<div class="row g-3 mb-4">
  <div class="col-12">
    <div class="filter-bar">
      <div class="row g-3 align-items-end">
        <div class="col-auto">
          <label class="form-label text-secondary" style="font-size:12px">最低星級 Min Stars</label>
          <select id="minStar" class="form-select form-select-sm" style="width:110px;background:#0d1117;color:#c9d1d9;border-color:#30363d">
            <option value="3">★★★ 3+</option>
            <option value="3.5">★★★½ 3.5+</option>
            <option value="4" selected>★★★★ 4+</option>
            <option value="4.5">★★★★½ 4.5+</option>
            <option value="5">★★★★★ 5+</option>
          </select>
        </div>
        <div class="col-auto">
          <label class="form-label text-secondary" style="font-size:12px">顯示數量 Top N</label>
          <select id="topN" class="form-select form-select-sm" style="width:100px;background:#0d1117;color:#c9d1d9;border-color:#30363d">
            <option value="25">25</option>
            <option value="50" selected>50</option>
            <option value="100">100</option>
          </select>
        </div>
        <div class="col-auto">
          <label class="form-label text-secondary" style="font-size:12px">股票來源 Stage 1 Source</label>
          <select id="stage1Source" class="form-select form-select-sm" style="width:155px;background:#0d1117;color:#c9d1d9;border-color:#30363d" title="選擇第一階段篩選來源 Choose Stage 1 data source" onchange="onSourceChange(this.value)">
            <option value="nasdaq_ftp" selected>NASDAQ FTP (快速 Fast)</option>
            <option value="finviz">Finviz (慢 Slow ~15m)</option>
          </select>
          <!-- Per-source limitation notes -->
          <div id="srcNote_nasdaq_ftp" class="mt-1" style="font-size:11px;color:#8b949e;max-width:360px">
            <i class="bi bi-check-circle me-1" style="color:#3fb950"></i>
            <strong style="color:#c9d1d9">推薦 Recommended</strong> —
            涵蓋最完整的 NASDAQ/NYSE/AMEX 官方掛牌股票，OTC 場外股票自動排除。<br>
            <span style="color:#6e7681">Covers more listed stocks than Finviz (~24 vs ~22 in testing). OTC stocks are automatically excluded by design.</span>
          </div>
          <div id="srcNote_finviz" class="mt-1 d-none" style="font-size:11px;color:#8b949e;max-width:360px">
            <i class="bi bi-exclamation-triangle me-1" style="color:#e3b341"></i>
            掃描速度慢（約 10–15 分鐘）。OTC 場外股票已自動過濾。<br>
            注意：Finviz 自身的掛牌股票覆蓋率比 NASDAQ FTP 少約 2 隻，結果不一定更多。<br>
            <span style="color:#6e7681">Slow (~10–15 min). OTC stocks auto-removed. Finviz's listed-stock coverage is slightly less complete than NASDAQ FTP — expect ~22 results vs ~24 from NASDAQ FTP.</span>
          </div>

        </div>
        <div class="col-auto">
          <button class="btn btn-accent px-4" id="btnScan" onclick="startScan()">
            <i class="bi bi-lightning-charge me-1"></i>開始掃描 Run Scan
          </button>
          <button class="btn btn-outline-secondary btn-sm ms-2 d-none" id="btnCancel" onclick="cancelScan()">
            <i class="bi bi-stop-circle me-1"></i>取消 Cancel
          </button>
        </div>
        <div class="col-auto">
          <button class="btn btn-outline-secondary btn-sm" onclick="loadLast()">
            <i class="bi bi-clock-history me-1"></i>上次結果 Load Last
          </button>
        </div>
        <div class="col ms-auto text-end">
          <small class="text-secondary">
            <i class="bi bi-info-circle me-1"></i>
            掃描篩選條件：6個月漲幅≥150%，3個月≥50%，1個月≥25%，ADR>5%，日均成交額>$500萬
          </small>
        </div>
      </div>

      <!-- Progress bar (hidden by default) -->
      <div id="progressArea" class="mt-3 d-none">
        <div class="progress" style="height:6px;background:#21262d">
          <div id="progressBar" class="progress-bar" style="background:var(--accent);width:0%;transition:width .4s"></div>
        </div>
        <div class="progress-stage" id="progressStage">準備中…</div>
        
        <!-- Diagnostics panel (toggle-able) -->
        <div class="mt-3">
          <a href="#" onclick="toggleDiagnostics(event)" class="text-secondary" style="font-size:12px">
            <i class="bi bi-chevron-right" id="diagToggleIcon"></i> 詳細診斷日誌 Detailed Diagnostics
          </a>
          <div id="diagnosticsPanel" class="mt-2 p-3 bg-black rounded" style="display:none;border:1px solid #30363d;max-height:300px;overflow-y:auto">
            <small class="text-monospace text-secondary" id="diagnosticsContent">
              Loading diagnostics…
            </small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Summary row -->
<div class="row g-3 mb-3" id="summaryRow" style="display:none!important">
  <div class="col-6 col-md-3">
    <div class="metric-card">
      <div class="metric-val" id="metPassCount">—</div>
      <div class="metric-lbl">通過股票 Passed</div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="metric-card">
      <div class="metric-val" id="met5Star" style="color:#3fb950">—</div>
      <div class="metric-lbl">5★ 以上</div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="metric-card">
      <div class="metric-val" id="metAvgStar" style="color:#e3b341">—</div>
      <div class="metric-lbl">平均星級 Avg Stars</div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="metric-card">
      <div class="metric-val" id="metScanTime" style="color:#8b949e">—</div>
      <div class="metric-lbl">掃描時間 Scan Time</div>
    </div>
  </div>
</div>

<!-- Results table -->
<div class="card">
  <div class="card-header d-flex align-items-center gap-2">
    <i class="bi bi-table me-1"></i>掃描結果 Results
    <span id="resultCount" class="badge bg-secondary ms-auto">—</span>
    <button class="btn btn-outline-secondary btn-sm" onclick="exportCSV()" id="btnExport" disabled>
      <i class="bi bi-download me-1"></i>匯出 CSV
    </button>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0" id="resultTable">
        <thead>
          <tr>
            <th style="width:40px">#</th>
            <th>
              股票 Ticker
              <i class="bi bi-info-circle text-secondary ms-1" data-bs-toggle="tooltip"
                 title="點擊股票代號可進入 QM 個股分析頁面"></i>
            </th>
            <th>
              ⭐ 星級 Stars
              <i class="bi bi-info-circle text-secondary ms-1" data-bs-toggle="tooltip"
                 title="Qullamaggie 6維評分系統：動力（Momentum）、ADR、整固（Consolidation）、均線（MA）、股票類型（Type）、市場環境（Market）。5★以上為最優質設置，ADR<5%或熊市將觸發否決（VETO）。"></i>
            </th>
            <th>
              ADR%
              <i class="bi bi-info-circle text-secondary ms-1" data-bs-toggle="tooltip"
                 title="平均日波動幅 (Average Daily Range)：收盤前14日的高低差平均值除以收盤價。Qullamaggie 要求 ADR>5%，這確保股票有足夠波動性以提供交易機會。ADR<5% 將直接否決整個設置。"></i>
            </th>
            <th>
              日均成交額 $Vol
              <i class="bi bi-info-circle text-secondary ms-1" data-bs-toggle="tooltip"
                 title="20日平均成交金額（美元）。Qullamaggie 要求最低 $500萬，確保流動性充足，可以全倉進出而不影響股價。"></i>
            </th>
            <th>
              1M%
              <i class="bi bi-info-circle text-secondary ms-1" data-bs-toggle="tooltip"
                 title="過去1個月（約21個交易日）的價格漲幅百分比。Qullamaggie 最低要求：≥25%。這是捕捉「已在移動」的強勢股的核心篩選指標。"></i>
            </th>
            <th>
              3M%
              <i class="bi bi-info-circle text-secondary ms-1" data-bs-toggle="tooltip"
                 title="過去3個月（約63個交易日）的價格漲幅。最低要求：≥50%。配合6個月指標一起驗證中長期動力。"></i>
            </th>
            <th>
              6M%
              <i class="bi bi-info-circle text-secondary ms-1" data-bs-toggle="tooltip"
                 title="過去6個月（約126個交易日）的價格漲幅。最低要求：≥150%。Qullamaggie 的核心篩選：尋找在6個月內翻倍以上的超強動力股票。"></i>
            </th>
            <th>
              形態類型 Setup
              <i class="bi bi-info-circle text-secondary ms-1" data-bs-toggle="tooltip"
                 title="Qullamaggie 7種突破形態：HTF（高緊旗形）、EP（事件驅動突破）、LADDER（階梯式上升）、SURF_50（50均線衝浪）、RPL（拋物線修正）、FLAG（旗形整固）。HTF和EP為最高質量設置。"></i>
            </th>
            <th>
              均線 MA
              <i class="bi bi-info-circle text-secondary ms-1" data-bs-toggle="tooltip"
                 title="股價與均線的關係。10 = 在10日均線上方衝浪；20 = 在20日均線上方衝浪；50 = 在50日均線上方衝浪。Qullamaggie 的「衝浪盤買家」（Surfing Disc Buyer）策略的核心。"></i>
            </th>
            <th>
              較高低點 HL
              <i class="bi bi-info-circle text-secondary ms-1" data-bs-toggle="tooltip"
                 title="Higher Lows：在波段整固過程中，每次回調的低點都比前一次更高。這是強勢股在盤整時的典型特徵，表示賣壓逐漸減少，機構在吸籌。"></i>
            </th>
            <th>
              波動收緊 Tight
              <i class="bi bi-info-circle text-secondary ms-1" data-bs-toggle="tooltip"
                 title="Tightness：近期20天的價格波動範圍相對比歷史更緊縮，顯示股票進入整固阶段，預示可能發生突破。VCP（波動收縮形態）的關鍵特徵。"></i>
            </th>
          </tr>
        </thead>
        <tbody id="resultBody">
          <tr><td colspan="12" class="text-center text-secondary py-5">
            <i class="bi bi-lightning-charge" style="font-size:2rem;opacity:0.3"></i>
            <div class="mt-2">點擊「開始掃描」以篩選 Qullamaggie 高質量突破設置</div>
            <div style="font-size:12px;margin-top:4px">Click "Run Scan" to filter for high-quality Qullamaggie breakout setups</div>
          </td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Info footer -->
<div class="mt-3 p-3" style="background:#161b22;border:1px solid #30363d;border-radius:8px;font-size:12px;color:#8b949e">
  <i class="bi bi-lightbulb me-1 text-warning"></i>
  <strong>Qullamaggie 掃描說明：</strong>
  此掃描器基於 Kristjan Kullamägi（@Qullamaggie）的突破波段交易法則。
  系統篩選具有強勁動力（6個月漲幅≥150%）、高ADR（>5%）、
  以及出現整固形態（較高低點或緊縮波動）的股票。
  星級評分由 A（動力）至 F（市場環境）共六個維度構成，
  ADR低於5%或熊市環境將觸發否決（VETO），評分清零。
  <span class="ms-2 text-info">建議持倉風險：5★以上可投入15-25%資金，4★投10-15%，3★不超過10%。</span>
</div>
{% endblock %}

{% block extra_js %}
<script>
let _jobId = null;
let _pollInterval = null;
let _scanStartTime = null;
let _lastRows = [];

// Enable tooltips
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el =>
    new bootstrap.Tooltip(el, { placement: 'top' })
  );
  loadLast();
});

function onSourceChange(val) {
  ['nasdaq_ftp', 'finviz'].forEach(src => {
    const el = document.getElementById('srcNote_' + src);
    if (el) el.classList.toggle('d-none', src !== val);
  });
}

async function startScan() {
  const minStar = parseFloat(document.getElementById('minStar').value);
  const topN    = parseInt(document.getElementById('topN').value);
  const stage1Source = document.getElementById('stage1Source').value;

  document.getElementById('btnScan').disabled = true;
  document.getElementById('btnCancel').classList.remove('d-none');
  document.getElementById('progressArea').classList.remove('d-none');
  document.getElementById('progressBar').style.width = '0%';
  document.getElementById('progressStage').textContent = '啟動掃描… Starting…';
  document.getElementById('btnExport').disabled = true;
  _scanStartTime = Date.now();

  try {
    const resp = await fetch('/api/qm/scan/run', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ min_star: minStar, top_n: topN, stage1_source: stage1Source })
    });
    const data = await resp.json();
    _jobId = data.job_id;
    pollProgress();
  } catch(e) {
    toast('掃描請求失敗：' + e, false);
    resetScanUI();
  }
}

function cancelScan() {
  if (_jobId) {
    fetch('/api/qm/scan/cancel/' + _jobId, { method: 'POST' });
    toast('已發送取消請求 Cancel request sent');
    resetScanUI();
  }
}

function pollProgress() {
  _pollInterval = setInterval(async () => {
    try {
      // Poll status endpoint to check if done
      const r = await fetch('/api/qm/scan/status/' + _jobId).then(x => x.json());

      // Update progress bar via progress endpoint
      const p = await fetch('/api/qm/scan/progress').then(x => x.json()).catch(() => null);
      if (p) {
        document.getElementById('progressBar').style.width = (p.pct || 0) + '%';
        let stageText = p.stage || '';
        if (p.ticker) stageText += ' — ' + p.ticker;
        if (p.msg) stageText += ': ' + p.msg;
        document.getElementById('progressStage').textContent = stageText;
      }

      // Fetch and display diagnostics if still running
      if (r.status !== 'done' && r.status !== 'error') {
        try {
          const logs = await fetch('/api/qm/scan/logs/' + _jobId)
            .then(x => x.json())
            .catch(() => null);
          if (logs && logs.ok) {
            const diag = logs.stage1_diagnostics || [];
            if (diag.length > 0) {
              const diagHtml = diag.map(line => 
                `<div>${escapeHtml(line)}</div>`
              ).join('');
              document.getElementById('diagnosticsContent').innerHTML = diagHtml;
            }
          }
        } catch(e) {
          // Silently ignore log fetch errors during polling
        }
      }

      if (r.status === 'done') {
        clearInterval(_pollInterval);
        const elapsed = ((Date.now() - _scanStartTime) / 1000).toFixed(0);
        renderResults(r.result || []);
        document.getElementById('progressBar').style.width = '100%';
        document.getElementById('progressStage').textContent = `掃描完成 (${elapsed}秒)`;
        resetScanUI(true);
        toastCompletion(`✓ QM 掃描完成！找到 ${(r.result||[]).length} 個高質量設置`, true);
      } else if (r.status === 'error') {
        clearInterval(_pollInterval);
        toast('掃描錯誤：' + (r.error || ''), false);
        resetScanUI();
      }
    } catch(e) {
      // Network blip — keep polling
    }
  }, 2000);
}

function resetScanUI(done=false) {
  document.getElementById('btnScan').disabled = false;
  document.getElementById('btnCancel').classList.add('d-none');
  if (!done) document.getElementById('progressArea').classList.add('d-none');
  _jobId = null;
}

function toggleDiagnostics(e) {
  e.preventDefault();
  const panel = document.getElementById('diagnosticsPanel');
  const icon = document.getElementById('diagToggleIcon');
  const isVisible = panel.style.display !== 'none';
  panel.style.display = isVisible ? 'none' : 'block';
  icon.className = isVisible ? 'bi bi-chevron-right' : 'bi bi-chevron-down';
}

function escapeHtml(text) {
  const map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  };
  return text.replace(/[&<>"']/g, m => map[m]);
}

async function loadLast() {
  try {
    const data = await fetch('/api/qm/scan/last').then(r => r.json());
    if (data.rows && data.rows.length > 0) {
      renderResults(data.rows);
      toast(`已載入上次掃描結果（${data.rows.length} 個設置）`, true);
    }
  } catch(e) {}
}

function renderResults(rows) {
  _lastRows = rows;
  const tbody = document.getElementById('resultBody');
  if (!rows || rows.length === 0) {
    tbody.innerHTML = '<tr><td colspan="12" class="text-center text-secondary py-4">未找到符合條件的股票。嘗試降低最低星級門檻。</td></tr>';
    document.getElementById('resultCount').textContent = '0';
    return;
  }

  // Update metrics
  const stars5p = rows.filter(r => (r.qm_star || r.stars || 0) >= 5).length;
  const avgStar = (rows.reduce((s, r) => s + (r.qm_star || r.stars || 0), 0) / rows.length).toFixed(1);
  document.getElementById('metPassCount').textContent = rows.length;
  document.getElementById('met5Star').textContent = stars5p;
  document.getElementById('metAvgStar').textContent = avgStar + '★';
  document.getElementById('metScanTime').textContent = new Date().toLocaleTimeString('zh-HK');
  document.getElementById('summaryRow').style.display = '';
  document.getElementById('resultCount').textContent = rows.length;
  document.getElementById('btnExport').disabled = false;

  tbody.innerHTML = rows.map((r, i) => {
    const star = parseFloat(r.qm_star ?? r.stars ?? 0);
    const starClass = star >= 5 ? 'star-5p' : star >= 4.5 ? 'star-5' : star >= 4 ? 'star-4' : star >= 3 ? 'star-3' : 'star-low';
    const starStr = renderStars(star);
    const setup = (r.setup_type || '').toUpperCase();
    const setupBadge = setupBadgeHtml(setup);
    const surf = r.surfing_ma ? `<span class="badge" style="background:#003040;color:#00d4ff">${r.surfing_ma}MA</span>` : '<span class="text-secondary">—</span>';
    const hl = r.has_higher_lows ? '<i class="bi bi-check-circle-fill text-success"></i>' : '<span class="text-secondary">—</span>';
    const tight = r.is_tight ? '<i class="bi bi-arrows-collapse text-info"></i>' : '<span class="text-secondary">—</span>';
    const vetoHtml = r.veto ? `<br><span class="veto-badge">VETO:${r.veto}</span>` : '';
    const adr = r.adr != null ? parseFloat(r.adr).toFixed(1) + '%' : '—';
    const adrClass = r.adr && r.adr < 5 ? 'text-danger' : '';
    const dvol = r.dollar_volume_m != null ? '$' + parseFloat(r.dollar_volume_m).toFixed(1) + 'M' : '—';
    const m1 = r.mom_1m != null ? fmtMom(r.mom_1m) : '—';
    const m3 = r.mom_3m != null ? fmtMom(r.mom_3m) : '—';
    const m6 = r.mom_6m != null ? fmtMom(r.mom_6m) : '—';

    return `<tr class="qm-row" onclick="window.location='/qm/analyze?ticker=${r.ticker}'">
      <td class="text-secondary">${i+1}</td>
      <td><a href="/qm/analyze?ticker=${r.ticker}" class="fw-bold" style="color:var(--accent2)" onclick="event.stopPropagation()">
        ${r.ticker}</a>${vetoHtml}
      </td>
      <td class="${starClass}">${starStr}</td>
      <td class="${adrClass}">${adr}</td>
      <td>${dvol}</td>
      <td>${m1}</td>
      <td>${m3}</td>
      <td class="fw-bold">${m6}</td>
      <td>${setupBadge}</td>
      <td>${surf}</td>
      <td>${hl}</td>
      <td>${tight}</td>
    </tr>`;
  }).join('');
}

function renderStars(val) {
  const full = Math.floor(val);
  const half = (val - full) >= 0.5;
  let s = '';
  for (let i = 0; i < full; i++) s += '★';
  if (half) s += '½';
  return s + ` <small>(${val.toFixed(1)})</small>`;
}

function setupBadgeHtml(code) {
  const map = {
    'HTF':   ['badge-htf',  'HTF', '高緊旗形 High Tight Flag'],
    'EP':    ['badge-ep',   'EP',  '事件突破 Episodic Pivot'],
    'LADDER':['badge-lad',  'LADDER', '階梯突破 Staircase'],
    'SURF_50':['badge-surf','SURF', '50MA衝浪 Surf 50SMA'],
    'RPL':   ['badge-rpl',  'RPL', '拋物反彈 Reverse Parabolic'],
    'FLAG':  ['badge-flag', 'FLAG', '旗形整固 Flag/Base'],
  };
  const info = map[code] || ['badge-uk', code || '?', '未分類'];
  return `<span class="badge ${info[0]}" data-bs-toggle="tooltip" title="${info[2]}">${info[1]}</span>`;
}

function fmtMom(v) {
  const n = parseFloat(v);
  const cls = n >= 50 ? 'text-success fw-bold' : n >= 0 ? 'text-success' : 'text-danger';
  return `<span class="${cls}">${n >= 0 ? '+' : ''}${n.toFixed(1)}%</span>`;
}

function exportCSV() {
  if (!_lastRows.length) return;
  const keys = ['ticker','qm_star','setup_type','adr','dollar_volume_m','mom_1m','mom_3m','mom_6m','surfing_ma','has_higher_lows','is_tight','recommendation'];
  let csv = keys.join(',') + '\n';
  csv += _lastRows.map(r => keys.map(k => r[k] ?? '').join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `qm_scan_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
}
</script>
{% endblock %}
