{% extends "base.html" %}
{% block title %}VCP Analysis{% endblock %}
{% block content %}
<h4 class="mb-3"><i class="bi bi-activity me-2" style="color:var(--accent)"></i>VCP â€” Volatility Contraction Pattern</h4>

<div class="card mb-3">
  <div class="card-body">
    <div class="row g-2 align-items-end">
      <div class="col-auto">
        <label class="form-label text-muted small">Ticker Symbol</label>
        <input class="form-control" id="tickerInput" value="{{ prefill }}"
               placeholder="e.g. NVDA" style="width:110px;text-transform:uppercase"
               oninput="this.value=this.value.toUpperCase()"
               onkeydown="if(event.key==='Enter')runVcp()">
      </div>
      <div class="col-auto">
        <button class="btn btn-accent" id="btnVcp" onclick="runVcp()">
          <i class="bi bi-play-fill me-1"></i>Analyse VCP
        </button>
      </div>
    </div>
    <div class="mt-2 text-muted small">
      VCP (Volatility Contraction Pattern) â€” Minervini's proprietary entry setup.
      Uses 2 years of price history + ATR + Bollinger Bands + Volume analysis.
    </div>
    <div class="mt-2 small text-muted">
      <div><strong>è¼”åŠ©èªªæ˜ Helper</strong></div>
      <div>â€¢ <strong>ATR æ”¶ç¸® ATR Contracting</strong>ï¼šä»£è¡¨æ—¥å…§çœŸå¯¦æ³¢å‹•å¹…åº¦é€æ­¥ä¸‹é™ï¼Œå¸¸è¦‹æ–¼åŸºåº•å¾Œæ®µï¼Œè¡¨ç¤ºæ‹‹å£“æ¸›å¼±èˆ‡é¢¨éšªå¯æ§ã€‚</div>
      <div>â€¢ <strong>å¸ƒæ—å¸¶æ”¶ç¸® BB Contracting</strong>ï¼šBand Width è®Šçª„å±¬æ–¼æ³¢å‹•å£“ç¸®ï¼ˆVolatility Squeezeï¼‰ï¼Œé€šå¸¸æ˜¯çªç ´å‰èƒ½é‡ç´¯ç©è¨Šè™Ÿã€‚</div>
      <div>â€¢ <strong>é‡èƒ½ä¹¾æ¶¸ Volume Dry-up</strong>ï¼šæ¥è¿‘ pivot æ™‚æˆäº¤é‡ä½æ–¼å‡é‡ï¼Œä»£è¡¨ä¾›çµ¦æ¸›å°‘ï¼›è‹¥å¾ŒçºŒæ”¾é‡çªç ´ï¼Œè¨Šè™Ÿæ›´å¯é ã€‚</div>
    </div>
  </div>
</div>

<div id="loading" class="text-center py-5 d-none">
  <div class="spinner-border text-info spinner-glow" style="width:3rem;height:3rem"></div>
  <div class="mt-3 text-muted">Downloading 2-year history and running VCP detectionâ€¦</div>
</div>

<div id="errBox" class="alert alert-danger d-none"></div>

<div id="result" class="d-none">
  <!-- Banner -->
  <div class="card mb-3" id="vcpBanner">
    <div class="card-body d-flex align-items-center gap-4 flex-wrap">
      <div>
        <div class="text-muted small mb-1">VCP Grade</div>
        <div id="vcpGrade" class="fw-bold" style="font-size:2.5rem"></div>
      </div>
      <div>
        <div class="text-muted small mb-1">Score</div>
        <div id="vcpScore" class="fw-bold fs-2" style="color:var(--accent)"></div>
      </div>
      <div>
        <div class="text-muted small mb-1">Valid VCP</div>
        <div id="vcpValid" class="fw-bold fs-4"></div>
      </div>
      <div>
        <div class="text-muted small mb-1">
          Pivot Price
          <i class="bi bi-question-circle ms-1" style="cursor:help;color:#8b949e;font-size:0.8rem"
            data-bs-toggle="tooltip" data-bs-placement="top"
            title="Pivot çªç ´é»ï¼šVCP å½¢æ…‹çš„ç†æƒ³å…¥å ´åƒ¹ä½ã€‚å³æœ€å¾Œä¸€æ¬¡æ”¶ç¸®çµæŸå¾Œï¼Œå½¢æ…‹é ‚éƒ¨çš„é˜»åŠ›ä½ã€‚ç•¶è‚¡åƒ¹æ”¾é‡çªç ´æ­¤æ°´å¹³ï¼Œå³ç‚º Minervini SEPA æ¨™æº–é€²å ´ä¿¡è™Ÿã€‚è‚¡åƒ¹é€²å…¥çªç ´é»ä¸Šæ–¹ 5% å†…å±¬æ–¼åˆæ ¼è¿½è³¼å€é–“ï¼ˆBuy Zoneï¼‰ã€‚åœ–è¡¨ä¸­ä»¥é’è‰²è™›ç·šæ¨™ç¤ºã€‚"></i>
        </div>
        <div id="vcpPivot" class="fw-bold fs-4" style="color:#64ffda"></div>
      </div>
      <div>
        <div class="text-muted small mb-1">Current Price</div>
        <div id="vcpCurrent" class="fw-bold fs-4"></div>
      </div>
    </div>
  </div>

  <div class="row g-3">
    <!-- Base Metrics -->
    <div class="col-12 col-md-6">
      <div class="card">
        <div class="card-header">Base Metrics</div>
        <div class="card-body">
          <div class="row g-2" id="baseMetrics"></div>
        </div>
      </div>
    </div>

    <!-- Signal Checks -->
    <div class="col-12 col-md-3">
      <div class="card h-100">
        <div class="card-header">Signal Checklist</div>
        <ul class="list-group list-group-flush" id="signals"></ul>
      </div>
    </div>

    <!-- Contractions -->
    <div class="col-12 col-md-3">
      <div class="card h-100">
        <div class="card-header">Contraction Sequence</div>
        <div class="card-body" id="contractions"></div>
      </div>
    </div>

    <!-- Notes + Action -->
    <div class="col-12">
      <div class="card">
        <div class="card-header">Analysis Notes</div>
        <div class="card-body" id="vcpNotes">
          <div class="mb-3" id="notesList"></div>
          <button id="btnAddWatchlist" class="btn btn-outline-success me-2" onclick="addToWatchlist()">
            <i class="bi bi-bookmark-plus me-1"></i>Add to Watchlist
          </button>
          <a id="btnAnalyze" href="#" class="btn btn-outline-info">
            <i class="bi bi-search me-1"></i>Full SEPA Analysis
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- VCP Kç·šæŠ€è¡“åˆ†æåœ– Technical Chart -->
  <div class="row g-3 mt-3">
    <div class="col-12" id="vcpChartSection" style="display:none">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
          <span><i class="bi bi-bar-chart-line me-2"></i>VCP K ç·šåœ– Technical Chart</span>
          <div class="d-flex align-items-center gap-3 flex-wrap">
            <div class="d-flex gap-2 small" style="color:#8b949e">
              <span><span style="display:inline-block;width:12px;height:2px;background:#58a6ff;vertical-align:middle"></span> SMA50</span>
              <span><span style="display:inline-block;width:12px;height:2px;background:#f85149;vertical-align:middle"></span> SMA200</span>
              <span><span style="display:inline-block;width:12px;height:1px;background:rgba(136,136,136,0.7);vertical-align:middle"></span> BB</span>
              <span style="color:#64ffda"><span style="display:inline-block;width:12px;height:2px;background:#64ffda;vertical-align:middle"></span> Pivot</span>
            </div>
            <div class="btn-group btn-group-sm" id="vcpRangeBtns">
              <button class="btn btn-outline-secondary" data-days="90"  onclick="setVcpRange(90,this)">3M</button>
              <button class="btn btn-outline-secondary" data-days="180" onclick="setVcpRange(180,this)">6M</button>
              <button class="btn btn-outline-secondary active" data-days="365" onclick="setVcpRange(365,this)">1Y</button>
            </div>
            <div class="btn-group btn-group-sm" id="vcpSubModeBtns">
              <button class="btn btn-outline-info active" onclick="setVcpSubMode('atr',this)">ATR</button>
              <button class="btn btn-outline-info" onclick="setVcpSubMode('bbw',this)">BB Width</button>
              <button class="btn btn-outline-info" onclick="setVcpSubMode('vr',this)">Vol Ratio</button>
            </div>
          </div>
        </div>
        <div class="card-body p-0" style="width:100%;overflow:hidden">
          <div id="vcpChartLoading" class="text-center py-3">
            <div class="spinner-border spinner-border-sm text-info"></div>
            <div class="text-muted small mt-2">è¼‰å…¥ K ç·šè³‡æ–™â€¦ Loading chart dataâ€¦</div>
          </div>
          <div id="vcpChartWrap" style="display:none;width:100%;overflow:hidden">
            <!-- Main chart: Candlestick + BB + SMA + Volume -->
            <div id="lwcVcpChart" style="height:350px;width:100%;overflow:hidden"></div>
            <!-- Volume label row -->
            <div style="background:#0d1117;padding:2px 14px;display:flex;align-items:center;gap:10px">
              <span class="small" style="color:#8b949e">Volume</span>
            </div>
            <div id="vcpSubHeader" style="background:#0d1117;padding:3px 14px;border-top:1px solid #21262d;border-bottom:1px solid #21262d;display:flex;align-items:center;gap:10px">
              <span class="small" style="color:#8b949e">ATR (14)</span>
              <span class="small fw-bold" id="vcpSubCurrentVal" style="color:#c9d1d9">â€”</span>
            </div>
            <div id="lwcVcpSubChart" style="height:110px;width:100%;overflow:hidden"></div>
          </div>
          <div id="vcpChartEmpty" style="display:none" class="text-center py-4 text-muted">
            <i class="bi bi-inbox fs-2 d-block mb-2"></i>No chart data available.
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let _currentTicker = '';
let _currentVcpResult = null;

async function runVcp() {
  const ticker = document.getElementById('tickerInput').value.trim().toUpperCase();
  if (!ticker) { toast('Enter a ticker', false); return; }
  _currentTicker = ticker;
  document.getElementById('btnVcp').disabled = true;
  document.getElementById('loading').classList.remove('d-none');
  document.getElementById('result').classList.add('d-none');
  document.getElementById('errBox').classList.add('d-none');

  const r = await fetch('/api/vcp', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ticker})
  }).then(x=>x.json());

  pollJob(`/api/vcp/status/${r.job_id}`,
    data => {
      document.getElementById('loading').classList.add('d-none');
      document.getElementById('btnVcp').disabled = false;
      renderVcp(ticker, data);
    },
    err => {
      document.getElementById('loading').classList.add('d-none');
      document.getElementById('btnVcp').disabled = false;
      document.getElementById('errBox').textContent = `Error: ${err}`;
      document.getElementById('errBox').classList.remove('d-none');
    }
  );
}

function renderVcp(ticker, d) {
  _currentVcpResult = d || null;
  const grade  = d.grade || 'D';
  const score  = d.vcp_score || 0;
  const valid  = d.is_valid_vcp;
  const pivot  = d.pivot_price;
  const curr   = d.current_price;
  const gradeClr = {A:'#3fb950',B:'#69f0ae',C:'#e3b341',D:'#f85149'}[grade]||'#f85149';

  document.getElementById('vcpGrade').textContent  = grade;
  document.getElementById('vcpGrade').style.color  = gradeClr;
  document.getElementById('vcpScore').textContent  = score + '/100';
  document.getElementById('vcpValid').innerHTML    = valid
    ? '<span class="text-success">âœ“ YES</span>' : '<span class="text-danger">âœ— NO</span>';
  document.getElementById('vcpPivot').textContent  = pivot ? `$${Number(pivot).toFixed(2)}` : 'â€”';
  document.getElementById('vcpCurrent').textContent= curr  ? `$${Number(curr).toFixed(2)}`  : 'â€”';

  // Highlight pivot zone if close to current
  if (pivot && curr && Math.abs((curr-pivot)/pivot)*100 < 3) {
    document.getElementById('vcpPivot').textContent += ' ğŸ”¥ In buy zone!';
  }

  // Base metrics
  document.getElementById('baseMetrics').innerHTML = [
    ['T-count (contractions)', d.t_count||0],
    ['Base width', `${d.base_weeks||0} weeks`],
    ['Base depth', fmtPct(d.base_depth_pct)],
    ['Vol ratio (recent/avg)', fmtPct(d.vol_ratio)],
  ].map(([lbl,val])=>`
    <div class="col-6"><div class="metric-card p-2">
      <div class="fw-bold fs-5">${val}</div>
      <div class="metric-lbl">${lbl}</div>
    </div></div>`).join('');

  // Signals
  document.getElementById('signals').innerHTML = [
    ['ATR Contracting',  d.atr_contracting],
    ['BB Contracting',   d.bb_contracting],
    ['Volume Dry-up',    d.vol_dry],
  ].map(([lbl,v])=>`
    <li class="list-group-item d-flex justify-content-between py-2" style="background:transparent;border-color:#21262d">
      <span class="small">${lbl}</span>
      ${v ? '<i class="bi bi-check-circle-fill text-success fs-5"></i>' : '<i class="bi bi-x-circle text-danger fs-5"></i>'}
    </li>`).join('');

  // Contractions
  const cs = d.contractions || [];
  document.getElementById('contractions').innerHTML = cs.length
    ? cs.map((c,i)=>`
      <div class="mb-2 small">
        <strong>Pivot ${i+1}:</strong> Range ${fmtPct(c.range_pct)}<br>
        <span class="text-muted">Vol ratio: ${fmtPct(c.vol_ratio)}</span>
        <div class="progress mt-1" style="height:4px">
          <div class="progress-bar bg-info" style="width:${Math.min(100,(c.range_pct||0)*2)}%"></div>
        </div>
      </div>`).join('')
    : '<span class="text-muted small">No contraction data.</span>';

  // Notes
  document.getElementById('notesList').innerHTML = (d.notes||[]).length
    ? (d.notes||[]).map(n=>`<div class="text-muted small">â€¢ ${n}</div>`).join('')
    : '<div class="text-muted small">No additional notes.</div>';

  document.getElementById('btnAnalyze').href = `/analyze?ticker=${ticker}`;
  document.getElementById('result').classList.remove('d-none');
  // Load VCP technical chart after result is rendered
  loadVcpChart(ticker, pivot ? Number(pivot) : null, d);
}

// â”€â”€ VCP Chart state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _vcpChart = null;
let _vcpData  = null;
let _vcpSubChart = null;
let _vcpSubMode = 'atr';

function _destroyVcpCharts() {
  if (_vcpChart) { try { _vcpChart.remove(); } catch(e) {} _vcpChart = null; }
  if (_vcpSubChart) { try { _vcpSubChart.remove(); } catch(e) {} _vcpSubChart = null; }
}

function setVcpSubMode(mode, btn) {
  _vcpSubMode = mode;
  document.querySelectorAll('#vcpSubModeBtns button').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  if (_vcpData && _vcpData.candles && _vcpData.candles.length) {
    const pivot = _currentVcpResult && _currentVcpResult.pivot_price ? Number(_currentVcpResult.pivot_price) : null;
    loadVcpChart(_currentTicker, pivot, _currentVcpResult);
  }
}

function setVcpRange(days, btn) {
  document.querySelectorAll('#vcpRangeBtns button').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  if (!_vcpChart || !_vcpData || !_vcpData.candles.length) return;
  const last = _vcpData.candles[_vcpData.candles.length - 1].time;
  const from = last - days * 86400;
  _vcpChart.timeScale().setVisibleRange({ from, to: last });
}

async function loadVcpChart(ticker, pivotPrice, vcpData) {
  const section = document.getElementById('vcpChartSection');
  const loadEl  = document.getElementById('vcpChartLoading');
  const wrapEl  = document.getElementById('vcpChartWrap');
  const emptyEl = document.getElementById('vcpChartEmpty');
  section.style.display = 'block';
  loadEl.style.display  = 'block';
  wrapEl.style.display  = 'none';
  emptyEl.style.display = 'none';
  _destroyVcpCharts();

  try {
    const res = await fetch(`/api/chart/enriched/${ticker}?days=504`).then(x => x.json());
    if (!res.ok || !res.candles || !res.candles.length) {
      loadEl.style.display  = 'none';
      emptyEl.style.display = 'block';
      return;
    }
    _vcpData = res;
    const LWC     = LightweightCharts;
    const chartDiv = document.getElementById('lwcVcpChart');
    const wrapDiv  = document.getElementById('vcpChartWrap');

    const baseOpts = {
      layout:    { background: { color: '#0d1117' }, textColor: '#8b949e' },
      grid:      { vertLines: { color: '#21262d' }, horzLines: { color: '#21262d' } },
      crosshair: { mode: LWC.CrosshairMode.Normal },
      rightPriceScale: { borderColor: '#30363d' },
      timeScale: { borderColor: '#30363d', timeVisible: true, secondsVisible: false },
      handleScroll: true, handleScale: true,
    };

    const containerWidth = wrapDiv.parentElement.clientWidth || window.innerWidth - 40;
    _vcpChart = LWC.createChart(chartDiv, { ...baseOpts, height: 350, width: containerWidth });

    // Candlestick
    const candleSeries = _vcpChart.addCandlestickSeries({
      upColor: '#3fb950', downColor: '#f85149',
      borderUpColor: '#3fb950', borderDownColor: '#f85149',
      wickUpColor: '#3fb950', wickDownColor: '#f85149',
    });
    candleSeries.setData(res.candles);

    // Volume histogram
    const volSeries = _vcpChart.addHistogramSeries({
      priceFormat: { type: 'volume' }, priceScaleId: 'vol',
    });
    _vcpChart.priceScale('vol').applyOptions({
      scaleMargins: { top: 0.82, bottom: 0 }, drawTicks: false, borderVisible: false,
    });
    volSeries.setData(res.volume);

    // Bollinger Bands: upper & lower dashed, midline dotted
    if (res.bbu && res.bbu.length)
      _vcpChart.addLineSeries({ color: 'rgba(136,136,136,0.5)', lineWidth: 1, lineStyle: 2,
        priceLineVisible: false, lastValueVisible: false }).setData(res.bbu);
    if (res.bbl && res.bbl.length)
      _vcpChart.addLineSeries({ color: 'rgba(136,136,136,0.5)', lineWidth: 1, lineStyle: 2,
        priceLineVisible: false, lastValueVisible: false }).setData(res.bbl);
    if (res.bbm && res.bbm.length)
      _vcpChart.addLineSeries({ color: 'rgba(136,136,136,0.25)', lineWidth: 1, lineStyle: 1,
        priceLineVisible: false, lastValueVisible: false }).setData(res.bbm);

    // SMA 50 (blue) + SMA 200 (red) â€” trend context
    if (res.sma50 && res.sma50.length)
      _vcpChart.addLineSeries({ color: 'rgba(88,166,255,0.7)', lineWidth: 1.5, title: 'SMA50',
        priceLineVisible: false, lastValueVisible: false }).setData(res.sma50);
    if (res.sma200 && res.sma200.length)
      _vcpChart.addLineSeries({ color: 'rgba(248,81,73,0.7)', lineWidth: 1.5, title: 'SMA200',
        priceLineVisible: false, lastValueVisible: false }).setData(res.sma200);

    // Pivot price â€” horizontal dashed teal line
    if (pivotPrice) {
      candleSeries.createPriceLine({
        price: pivotPrice,
        color: '#64ffda', lineWidth: 2, lineStyle: 2,
        axisLabelVisible: true,
        title: `Pivot $${pivotPrice.toFixed(2)}`,
      });
    }

    // VCP signal markers on the latest bar (ATR / BB / Volume)
    if (vcpData && res.candles && res.candles.length) {
      const lastTime = res.candles[res.candles.length - 1].time;
      const markers = [];
      const signalDefs = [
        { key: 'atr_contracting', label: 'ATR', passText: 'ATRâœ“', failText: 'ATRâœ—' },
        { key: 'bb_contracting',  label: 'BB',  passText: 'BBâœ“',  failText: 'BBâœ—' },
        { key: 'vol_dry',         label: 'VOL', passText: 'VOLâœ“', failText: 'VOLâœ—' },
      ];

      signalDefs.forEach((sig, idx) => {
        const passed = Boolean(vcpData[sig.key]);
        markers.push({
          time: lastTime,
          position: passed ? 'aboveBar' : 'belowBar',
          color: passed ? '#3fb950' : '#f85149',
          shape: passed ? 'circle' : 'square',
          text: passed ? sig.passText : sig.failText,
          size: 1 + idx,
        });
      });

      // Historical signal events (2/3 or 3/3) for learning + model validation
      if (res.vcp_signal_events && res.vcp_signal_events.length) {
        res.vcp_signal_events.forEach(ev => {
          const strong = Number(ev.signal_count || 0) >= 3;
          markers.push({
            time: ev.time,
            position: strong ? 'belowBar' : 'aboveBar',
            color: strong ? '#00d4ff' : '#e3b341',
            shape: strong ? 'arrowUp' : 'circle',
            text: strong ? 'VCP 3/3' : 'VCP 2/3',
          });
        });
      }

      if (typeof candleSeries.setMarkers === 'function') {
        candleSeries.setMarkers(markers);
      }
    }

    // Sub-chart (toggle): ATR / BB Width / Volume Ratio
    const subDiv = document.getElementById('lwcVcpSubChart');
    const subHead = document.getElementById('vcpSubHeader');
    const subValEl = document.getElementById('vcpSubCurrentVal');
    const subConfig = {
      atr: { key: 'atr14', title: 'ATR (14)', color: '#58a6ff', digits: 3 },
      bbw: { key: 'bb_width_pct', title: 'BB Width %', color: '#e3b341', digits: 2 },
      vr: { key: 'vol_ratio_50d', title: 'Vol Ratio vs 50D', color: '#3fb950', digits: 2 },
    }[_vcpSubMode] || { key: 'atr14', title: 'ATR (14)', color: '#58a6ff', digits: 3 };

    const subData = (res[subConfig.key] || []).filter(p => p && typeof p.value === 'number');
    if (subHead) subHead.querySelector('span.small').textContent = subConfig.title;

    _vcpSubChart = LWC.createChart(subDiv, {
      ...baseOpts,
      height: 110,
      width: containerWidth,
      timeScale: { ...baseOpts.timeScale, visible: false },
      rightPriceScale: { borderColor: '#30363d', scaleMargins: { top: 0.1, bottom: 0.1 } },
    });
    const subSeries = _vcpSubChart.addLineSeries({
      color: subConfig.color, lineWidth: 1.8,
      priceLineVisible: false, lastValueVisible: true,
    });
    if (subData.length) {
      subSeries.setData(subData);
      const lastV = subData[subData.length - 1].value;
      if (subValEl) {
        subValEl.textContent = Number(lastV).toFixed(subConfig.digits);
        subValEl.style.color = subConfig.color;
      }
    } else if (subValEl) {
      subValEl.textContent = 'â€”';
      subValEl.style.color = '#8b949e';
    }

    if (_vcpChart && _vcpSubChart) {
      let syncing = false;
      _vcpChart.timeScale().subscribeVisibleLogicalRangeChange(range => {
        if (syncing || !_vcpSubChart || !range) return;
        syncing = true; _vcpSubChart.timeScale().setVisibleLogicalRange(range); syncing = false;
      });
      _vcpSubChart.timeScale().subscribeVisibleLogicalRangeChange(range => {
        if (syncing || !_vcpChart || !range) return;
        syncing = true; _vcpChart.timeScale().setVisibleLogicalRange(range); syncing = false;
      });
    }

    // Responsive resize â€” observe parent card-body
    new ResizeObserver(() => {
      const w = wrapDiv.parentElement.clientWidth || window.innerWidth - 40;
      if (_vcpChart) _vcpChart.applyOptions({ width: w });
      if (_vcpSubChart) _vcpSubChart.applyOptions({ width: w });
    }).observe(wrapDiv.parentElement);

    // Default 1Y view
    setVcpRange(365, document.querySelector('#vcpRangeBtns button[data-days="365"]'));

    loadEl.style.display = 'none';
    wrapEl.style.display = 'block';

    // Render signal badges under chart for quick read
    let signalEl = document.getElementById('vcpSignalOverlay');
    if (!signalEl) {
      signalEl = document.createElement('div');
      signalEl.id = 'vcpSignalOverlay';
      signalEl.className = 'px-3 py-2 small';
      signalEl.style.background = '#0d1117';
      signalEl.style.borderTop = '1px solid #21262d';
      wrapEl.appendChild(signalEl);
    }
    const fmtSignal = (name, pass) => `
      <span class="badge ${pass ? 'text-bg-success' : 'text-bg-danger'} me-1">${name}: ${pass ? 'YES' : 'NO'}</span>
    `;
    signalEl.innerHTML = `
      <span class="text-muted me-2">Signal Overlay</span>
      ${fmtSignal('ATR Contracting', Boolean(vcpData && vcpData.atr_contracting))}
      ${fmtSignal('BB Contracting', Boolean(vcpData && vcpData.bb_contracting))}
      ${fmtSignal('Volume Dry-up', Boolean(vcpData && vcpData.vol_dry))}
      <span class="badge text-bg-info ms-1">æ­·å²äº‹ä»¶ Events: ${(res.vcp_signal_events||[]).length}</span>
    `;
  } catch(e) {
    console.error('loadVcpChart error:', e);
    loadEl.style.display  = 'none';
    emptyEl.style.display = 'block';
  }
}

async function addToWatchlist() {
  const r = await fetch('/api/watchlist/add', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ticker:_currentTicker})
  }).then(x=>x.json());
  const jid = r.job_id;
  pollJob(`/api/watchlist/add/status/${jid}`,
    () => toast(`${_currentTicker} added to watchlist`),
    e  => toast(`Error: ${e}`, false)
  );
}

window.addEventListener('DOMContentLoaded', () => {
  // Initialize Bootstrap tooltips
  new bootstrap.Tooltip(document.body, {selector: '[data-bs-toggle="tooltip"]'});
  const t = document.getElementById('tickerInput').value;
  if (t) runVcp();
});
</script>
{% endblock %}
