{% extends "base.html" %}
{% block title %}VCP Analysis{% endblock %}
{% block content %}
<h4 class="mb-3"><i class="bi bi-activity me-2" style="color:var(--accent)"></i>VCP â€” Volatility Contraction Pattern</h4>

<div class="card mb-3">
  <div class="card-body">
    <div class="row g-2 align-items-end">
      <div class="col-auto">
        <label class="form-label text-muted small">Ticker Symbol</label>
        <input class="form-control" id="tickerInput" value="{{ prefill }}"
               placeholder="e.g. NVDA" style="width:110px;text-transform:uppercase"
               oninput="this.value=this.value.toUpperCase()"
               onkeydown="if(event.key==='Enter')runVcp()">
      </div>
      <div class="col-auto">
        <button class="btn btn-accent" id="btnVcp" onclick="runVcp()">
          <i class="bi bi-play-fill me-1"></i>Analyse VCP
        </button>
      </div>
    </div>
    <div class="mt-2 text-muted small">
      VCP (Volatility Contraction Pattern) â€” Minervini's proprietary entry setup.
      Uses 2 years of price history + ATR + Bollinger Bands + Volume analysis.
    </div>
  </div>
</div>

<div id="loading" class="text-center py-5 d-none">
  <div class="spinner-border text-info spinner-glow" style="width:3rem;height:3rem"></div>
  <div class="mt-3 text-muted">Downloading 2-year history and running VCP detectionâ€¦</div>
</div>

<div id="errBox" class="alert alert-danger d-none"></div>

<div id="result" class="d-none">
  <!-- Banner -->
  <div class="card mb-3" id="vcpBanner">
    <div class="card-body d-flex align-items-center gap-4 flex-wrap">
      <div>
        <div class="text-muted small mb-1">VCP Grade</div>
        <div id="vcpGrade" class="fw-bold" style="font-size:2.5rem"></div>
      </div>
      <div>
        <div class="text-muted small mb-1">Score</div>
        <div id="vcpScore" class="fw-bold fs-2" style="color:var(--accent)"></div>
      </div>
      <div>
        <div class="text-muted small mb-1">Valid VCP</div>
        <div id="vcpValid" class="fw-bold fs-4"></div>
      </div>
      <div>
        <div class="text-muted small mb-1">Pivot Price</div>
        <div id="vcpPivot" class="fw-bold fs-4" style="color:#3fb950"></div>
      </div>
      <div>
        <div class="text-muted small mb-1">Current Price</div>
        <div id="vcpCurrent" class="fw-bold fs-4"></div>
      </div>
    </div>
  </div>

  <div class="row g-3">
    <!-- Base Metrics -->
    <div class="col-12 col-md-6">
      <div class="card">
        <div class="card-header">Base Metrics</div>
        <div class="card-body">
          <div class="row g-2" id="baseMetrics"></div>
        </div>
      </div>
    </div>

    <!-- Signal Checks -->
    <div class="col-12 col-md-3">
      <div class="card h-100">
        <div class="card-header">Signal Checklist</div>
        <ul class="list-group list-group-flush" id="signals"></ul>
      </div>
    </div>

    <!-- Contractions -->
    <div class="col-12 col-md-3">
      <div class="card h-100">
        <div class="card-header">Contraction Sequence</div>
        <div class="card-body" id="contractions"></div>
      </div>
    </div>

    <!-- Notes + Action -->
    <div class="col-12">
      <div class="card">
        <div class="card-header">Analysis Notes</div>
        <div class="card-body" id="vcpNotes">
          <div class="mb-3" id="notesList"></div>
          <button id="btnAddWatchlist" class="btn btn-outline-success me-2" onclick="addToWatchlist()">
            <i class="bi bi-bookmark-plus me-1"></i>Add to Watchlist
          </button>
          <a id="btnAnalyze" href="#" class="btn btn-outline-info">
            <i class="bi bi-search me-1"></i>Full SEPA Analysis
          </a>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let _currentTicker = '';

async function runVcp() {
  const ticker = document.getElementById('tickerInput').value.trim().toUpperCase();
  if (!ticker) { toast('Enter a ticker', false); return; }
  _currentTicker = ticker;
  document.getElementById('btnVcp').disabled = true;
  document.getElementById('loading').classList.remove('d-none');
  document.getElementById('result').classList.add('d-none');
  document.getElementById('errBox').classList.add('d-none');

  const r = await fetch('/api/vcp', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ticker})
  }).then(x=>x.json());

  pollJob(`/api/vcp/status/${r.job_id}`,
    data => {
      document.getElementById('loading').classList.add('d-none');
      document.getElementById('btnVcp').disabled = false;
      renderVcp(ticker, data);
    },
    err => {
      document.getElementById('loading').classList.add('d-none');
      document.getElementById('btnVcp').disabled = false;
      document.getElementById('errBox').textContent = `Error: ${err}`;
      document.getElementById('errBox').classList.remove('d-none');
    }
  );
}

function renderVcp(ticker, d) {
  const grade  = d.grade || 'D';
  const score  = d.vcp_score || 0;
  const valid  = d.is_valid_vcp;
  const pivot  = d.pivot_price;
  const curr   = d.current_price;
  const gradeClr = {A:'#3fb950',B:'#69f0ae',C:'#e3b341',D:'#f85149'}[grade]||'#f85149';

  document.getElementById('vcpGrade').textContent  = grade;
  document.getElementById('vcpGrade').style.color  = gradeClr;
  document.getElementById('vcpScore').textContent  = score + '/100';
  document.getElementById('vcpValid').innerHTML    = valid
    ? '<span class="text-success">âœ“ YES</span>' : '<span class="text-danger">âœ— NO</span>';
  document.getElementById('vcpPivot').textContent  = pivot ? `$${Number(pivot).toFixed(2)}` : 'â€”';
  document.getElementById('vcpCurrent').textContent= curr  ? `$${Number(curr).toFixed(2)}`  : 'â€”';

  // Highlight pivot zone if close to current
  if (pivot && curr && Math.abs((curr-pivot)/pivot)*100 < 3) {
    document.getElementById('vcpPivot').textContent += ' ðŸ”¥ In buy zone!';
  }

  // Base metrics
  document.getElementById('baseMetrics').innerHTML = [
    ['T-count (contractions)', d.t_count||0],
    ['Base width', `${d.base_weeks||0} weeks`],
    ['Base depth', fmtPct(d.base_depth_pct)],
    ['Vol ratio (recent/avg)', fmtPct(d.vol_ratio)],
  ].map(([lbl,val])=>`
    <div class="col-6"><div class="metric-card p-2">
      <div class="fw-bold fs-5">${val}</div>
      <div class="metric-lbl">${lbl}</div>
    </div></div>`).join('');

  // Signals
  document.getElementById('signals').innerHTML = [
    ['ATR Contracting',  d.atr_contracting],
    ['BB Contracting',   d.bb_contracting],
    ['Volume Dry-up',    d.vol_dry],
  ].map(([lbl,v])=>`
    <li class="list-group-item d-flex justify-content-between py-2" style="background:transparent;border-color:#21262d">
      <span class="small">${lbl}</span>
      ${v ? '<i class="bi bi-check-circle-fill text-success fs-5"></i>' : '<i class="bi bi-x-circle text-danger fs-5"></i>'}
    </li>`).join('');

  // Contractions
  const cs = d.contractions || [];
  document.getElementById('contractions').innerHTML = cs.length
    ? cs.map((c,i)=>`
      <div class="mb-2 small">
        <strong>Pivot ${i+1}:</strong> Range ${fmtPct(c.range_pct)}<br>
        <span class="text-muted">Vol ratio: ${fmtPct(c.vol_ratio)}</span>
        <div class="progress mt-1" style="height:4px">
          <div class="progress-bar bg-info" style="width:${Math.min(100,(c.range_pct||0)*2)}%"></div>
        </div>
      </div>`).join('')
    : '<span class="text-muted small">No contraction data.</span>';

  // Notes
  document.getElementById('notesList').innerHTML = (d.notes||[]).length
    ? (d.notes||[]).map(n=>`<div class="text-muted small">â€¢ ${n}</div>`).join('')
    : '<div class="text-muted small">No additional notes.</div>';

  document.getElementById('btnAnalyze').href = `/analyze?ticker=${ticker}`;
  document.getElementById('result').classList.remove('d-none');
}

async function addToWatchlist() {
  const r = await fetch('/api/watchlist/add', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ticker:_currentTicker})
  }).then(x=>x.json());
  const jid = r.job_id;
  pollJob(`/api/watchlist/add/status/${jid}`,
    () => toast(`${_currentTicker} added to watchlist`),
    e  => toast(`Error: ${e}`, false)
  );
}

window.addEventListener('DOMContentLoaded', () => {
  const t = document.getElementById('tickerInput').value;
  if (t) runVcp();
});
</script>
{% endblock %}
