{% extends "base.html" %}
{% block title %}Watchlist{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h4 class="mb-0"><i class="bi bi-bookmark-star me-2" style="color:var(--accent)"></i>Watchlist</h4>
  <div class="d-flex gap-2">
    <button class="btn btn-sm btn-outline-info" onclick="refreshWatchlist()">
      <i class="bi bi-arrow-repeat me-1"></i>Refresh All
    </button>
  </div>
</div>

<!-- Add form -->
<div class="card mb-3">
  <div class="card-body">
    <div class="row g-2 align-items-end">
      <div class="col-auto">
        <label class="form-label text-muted small">Add Ticker</label>
        <input class="form-control" id="addTicker" placeholder="e.g. NVDA" style="width:110px;text-transform:uppercase"
               oninput="this.value=this.value.toUpperCase()"
               onkeydown="if(event.key==='Enter')addStock()">
      </div>
      <div class="col-auto">
        <label class="form-label text-muted small">Grade (optional)</label>
        <select class="form-select" id="addGrade" style="width:100px">
          <option value="">Auto</option>
          <option>A</option><option>B</option><option>C</option>
        </select>
      </div>
      <div class="col-auto">
        <label class="form-label text-muted small">Note</label>
        <input class="form-control" id="addNote" placeholder="Optional note" style="width:180px">
      </div>
      <div class="col-auto">
        <button class="btn btn-accent" id="btnAdd" onclick="addStock()">
          <i class="bi bi-plus-circle me-1"></i>Add
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Loading overlay (used by async add / refresh) -->
<div id="wlLoading" class="text-center py-4 d-none">
  <div class="spinner-border text-info spinner-glow"></div>
  <div class="mt-2 text-muted small" id="wlLoadMsg">Working…</div>
</div>

<!-- Grade tabs — switching applies CSS filter instantly, no round-trip needed -->
<ul class="nav nav-tabs mb-0" id="wlTabs" style="border-color:#30363d">
  <li class="nav-item">
    <a class="nav-link active" href="#" onclick="setWlGrade('all',this)">
      All <span class="badge bg-secondary ms-1" id="cnt-all">{{ wl.get('A',{})|length + wl.get('B',{})|length + wl.get('C',{})|length }}</span>
    </a>
  </li>
  {% for g, colour in [('A','success'),('B','warning'),('C','info')] %}
  <li class="nav-item">
    <a class="nav-link" href="#" onclick="setWlGrade('{{ g }}',this)" style="color:var(--bs-body-color)">
      Grade {{ g }} <span class="badge bg-{{ colour }} ms-1" id="cnt-{{ g }}">{{ wl[g]|length }}</span>
    </a>
  </li>
  {% endfor %}
</ul>

<div class="card" style="border-top-left-radius:0">
  <div class="table-responsive">
    <table class="table table-hover mb-0" id="wlTable">
      <thead>
        <tr>
          <th>Grade</th><th>Ticker</th><th>RS Rank</th>
          <th>VCP</th><th>Pivot</th><th>Added</th><th>Note</th>
          <th>Actions</th>
        </tr>
      </thead>
      {# data-grade-filter drives the CSS-based row show/hide; htmx preserves this attribute on swap #}
      <tbody id="wlBody" data-grade-filter="all">
        {% include '_watchlist_rows.html' %}
      </tbody>
    </table>
  </div>
</div>

{% endblock %}
{% block extra_js %}
<script>
// ── Grade filter (CSS-driven, instant — no server round-trip) ─────────────────
function setWlGrade(g, el) {
  document.getElementById('wlBody').dataset.gradeFilter = g;
  document.querySelectorAll('#wlTabs .nav-link').forEach(a => a.classList.remove('active'));
  el.classList.add('active');
}

// ── Add stock (async background job) ─────────────────────────────────────────
// htmx handles promote/demote/remove; JS only needed for the polling flow here.
async function addStock() {
  const ticker = document.getElementById('addTicker').value.trim().toUpperCase();
  const grade  = document.getElementById('addGrade').value || null;
  const note   = document.getElementById('addNote').value;
  if (!ticker) { toast('Enter a ticker', false); return; }
  document.getElementById('btnAdd').disabled = true;
  document.getElementById('wlLoading').classList.remove('d-none');
  document.getElementById('wlLoadMsg').textContent = `Analyzing ${ticker}… (fetching data + VCP detection)`;

  const r = await fetch('/api/watchlist/add', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ticker, grade, note})
  }).then(x=>x.json());

  pollJob(`/api/watchlist/add/status/${r.job_id}`,
    () => {
      document.getElementById('btnAdd').disabled = false;
      document.getElementById('wlLoading').classList.add('d-none');
      document.getElementById('addTicker').value = '';
      // Refresh table via htmx — server returns rows + OOB badge updates
      htmx.ajax('GET', '/htmx/watchlist/body', {target: '#wlBody', swap: 'innerHTML'});
      toast(`✅ ${ticker} added to watchlist`);
    },
    err => {
      document.getElementById('btnAdd').disabled = false;
      document.getElementById('wlLoading').classList.add('d-none');
      toast(`❌ Failed: ${err}`, false);
    }
  );
}

// ── Refresh all (async background job) ────────────────────────────────────────
async function refreshWatchlist() {
  document.getElementById('wlLoading').classList.remove('d-none');
  document.getElementById('wlLoadMsg').textContent = 'Re-analyzing all watchlist stocks…';
  const r = await fetch('/api/watchlist/refresh', {method:'POST'}).then(x=>x.json());
  pollJob(`/api/watchlist/refresh/status/${r.job_id}`,
    () => {
      document.getElementById('wlLoading').classList.add('d-none');
      htmx.ajax('GET', '/htmx/watchlist/body', {target: '#wlBody', swap: 'innerHTML'});
      toastCompletion('✅ 觀察列表已重新分析完成', true);
    },
    err => {
      document.getElementById('wlLoading').classList.add('d-none');
      toast(`❌ Error: ${err}`, false);
    }
  );
}
</script>
{% endblock %}
