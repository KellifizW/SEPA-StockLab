{% extends "base.html" %}
{% block title %}Watchlist{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h4 class="mb-0"><i class="bi bi-bookmark-star me-2" style="color:var(--accent)"></i>Watchlist</h4>
  <div class="d-flex gap-2">
    <button class="btn btn-sm btn-outline-info" onclick="refreshWatchlist()">
      <i class="bi bi-arrow-repeat me-1"></i>Refresh All
    </button>
  </div>
</div>

<!-- Add form -->
<div class="card mb-3">
  <div class="card-body">
    <div class="row g-2 align-items-end">
      <div class="col-auto">
        <label class="form-label text-muted small">Add Ticker</label>
        <input class="form-control" id="addTicker" placeholder="e.g. NVDA" style="width:110px;text-transform:uppercase"
               oninput="this.value=this.value.toUpperCase()"
               onkeydown="if(event.key==='Enter')addStock()">
      </div>
      <div class="col-auto">
        <label class="form-label text-muted small">Grade (optional)</label>
        <select class="form-select" id="addGrade" style="width:100px">
          <option value="">Auto</option>
          <option>A</option><option>B</option><option>C</option>
        </select>
      </div>
      <div class="col-auto">
        <label class="form-label text-muted small">Note</label>
        <input class="form-control" id="addNote" placeholder="Optional note" style="width:180px">
      </div>
      <div class="col-auto">
        <button class="btn btn-accent" id="btnAdd" onclick="addStock()">
          <i class="bi bi-plus-circle me-1"></i>Add
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Loading overlay -->
<div id="wlLoading" class="text-center py-4 d-none">
  <div class="spinner-border text-info spinner-glow"></div>
  <div class="mt-2 text-muted small" id="wlLoadMsg">Working…</div>
</div>

<!-- Grade tabs -->
<ul class="nav nav-tabs mb-0" style="border-color:#30363d">
  <li class="nav-item">
    <a class="nav-link active" href="#" data-grade="all" onclick="showGrade('all',this)">
      All <span class="badge bg-secondary ms-1" id="cnt-all">0</span>
    </a>
  </li>
  {% for g,colour in [('A','success'),('B','warning'),('C','info')] %}
  <li class="nav-item">
    <a class="nav-link" href="#" data-grade="{{ g }}" onclick="showGrade('{{ g }}',this)" style="color:var(--bs-body-color)">
      Grade {{ g }} <span class="badge bg-{{ colour }} ms-1" id="cnt-{{g}}">{{ wl[g]|length }}</span>
    </a>
  </li>
  {% endfor %}
</ul>

<div class="card" style="border-top-left-radius:0">
  <div class="table-responsive">
    <table class="table table-hover mb-0" id="wlTable">
      <thead>
        <tr>
          <th>Grade</th><th>Ticker</th><th>RS Rank</th>
          <th>VCP</th><th>Pivot</th><th>Added</th><th>Note</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="wlBody"></tbody>
    </table>
  </div>
</div>

{% endblock %}
{% block extra_js %}
<script>
let _wl = {{ wl | tojson }};
let _currentGrade = 'all';

function renderWatchlist(wl) {
  _wl = wl;
  const body = document.getElementById('wlBody');
  body.innerHTML = '';
  let total = 0;
  ['A','B','C'].forEach(g => {
    const stocks = wl[g] || {};
    document.getElementById(`cnt-${g}`).textContent = Object.keys(stocks).length;
    if (_currentGrade !== 'all' && _currentGrade !== g) return;
    Object.entries(stocks).forEach(([ticker, d]) => {
      total++;
      const gradeClr = {A:'success',B:'warning',C:'info'}[g];
      const vcp = d.vcp_grade && ['A','B'].includes(d.vcp_grade)
        ? `<span class="tag-vcp">${d.vcp_grade}</span>` : (d.vcp_grade||'—');
      body.innerHTML += `<tr>
        <td><span class="badge bg-${gradeClr}">${g}</span></td>
        <td><a href="/analyze?ticker=${ticker}" class="fw-bold text-decoration-none" style="color:var(--accent)">${ticker}</a></td>
        <td>${d.rs_rank ? Math.round(d.rs_rank) : '—'}</td>
        <td>${vcp}</td>
        <td>${d.pivot_price ? `$${Number(d.pivot_price).toFixed(2)}` : '—'}</td>
        <td class="text-muted small">${d.added_date||'—'}</td>
        <td class="text-muted small">${d.note||''}</td>
        <td>
          <div class="btn-group btn-group-sm">
            <a href="/vcp?ticker=${ticker}" class="btn btn-outline-secondary" title="VCP"><i class="bi bi-activity"></i></a>
            <button class="btn btn-outline-success" onclick="promote('${ticker}')" title="Promote">↑</button>
            <button class="btn btn-outline-warning" onclick="demote('${ticker}')" title="Demote">↓</button>
            <button class="btn btn-outline-danger" onclick="removeStock('${ticker}')" title="Remove"><i class="bi bi-trash"></i></button>
          </div>
        </td>
      </tr>`;
    });
  });
  document.getElementById('cnt-all').textContent = Object.values(wl).reduce((s,v)=>s+Object.keys(v).length,0);
}

function showGrade(g, el) {
  _currentGrade = g;
  document.querySelectorAll('.nav-tabs .nav-link').forEach(a => a.classList.remove('active'));
  el.classList.add('active');
  renderWatchlist(_wl);
}

async function addStock() {
  const ticker = document.getElementById('addTicker').value.trim().toUpperCase();
  const grade  = document.getElementById('addGrade').value || null;
  const note   = document.getElementById('addNote').value;
  if (!ticker) { toast('Enter a ticker', false); return; }
  document.getElementById('btnAdd').disabled = true;
  document.getElementById('wlLoading').classList.remove('d-none');
  document.getElementById('wlLoadMsg').textContent = `Analyzing ${ticker}… (fetching data + VCP detection)`;

  const r = await fetch('/api/watchlist/add', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ticker, grade, note})
  }).then(x=>x.json());

  pollJob(`/api/watchlist/add/status/${r.job_id}`,
    (res) => {
      document.getElementById('btnAdd').disabled = false;
      document.getElementById('wlLoading').classList.add('d-none');
      document.getElementById('addTicker').value = '';
      renderWatchlist(res.watchlist);
      toast(`${ticker} added to watchlist`);
    },
    err => {
      document.getElementById('btnAdd').disabled = false;
      document.getElementById('wlLoading').classList.add('d-none');
      toast(`Failed: ${err}`, false);
    }
  );
}

async function removeStock(ticker) {
  if (!confirm(`Remove ${ticker} from watchlist?`)) return;
  const r = await fetch('/api/watchlist/remove', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ticker})
  }).then(x=>x.json());
  if (r.ok) { toast(`${ticker} removed`); renderWatchlist(r.watchlist); }
  else toast(`Error: ${r.error}`, false);
}

async function promote(ticker) {
  const r = await fetch('/api/watchlist/promote', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ticker})
  }).then(x=>x.json());
  if (r.ok) { toast(`${ticker} promoted`); renderWatchlist(r.watchlist); }
  else toast(`Error: ${r.error}`, false);
}

async function demote(ticker) {
  const r = await fetch('/api/watchlist/demote', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ticker})
  }).then(x=>x.json());
  if (r.ok) { toast(`${ticker} demoted`); renderWatchlist(r.watchlist); }
  else toast(`Error: ${r.error}`, false);
}

async function refreshWatchlist() {
  document.getElementById('wlLoading').classList.remove('d-none');
  document.getElementById('wlLoadMsg').textContent = 'Re-analyzing all watchlist stocks…';
  const r = await fetch('/api/watchlist/refresh', {method:'POST'}).then(x=>x.json());
  pollJob(`/api/watchlist/refresh/status/${r.job_id}`,
    res => {
      document.getElementById('wlLoading').classList.add('d-none');
      renderWatchlist(res.watchlist);
      toast('Watchlist refreshed');
    },
    err => {
      document.getElementById('wlLoading').classList.add('d-none');
      toast(`Error: ${err}`, false);
    }
  );
}

renderWatchlist(_wl);
</script>
{% endblock %}
