{% extends "base.html" %}
{% block title %}Market Environment{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h4 class="mb-0"><i class="bi bi-bar-chart-line me-2" style="color:var(--accent)"></i>Market Environment</h4>
  <button class="btn btn-accent" id="btnAssess" onclick="runAssess()">
    <i class="bi bi-play-fill me-1"></i>Assess Market
  </button>
</div>

<div class="row g-3 mb-3">
  <div class="col-12">
    <div class="card" style="background:#0d1520">
      <div class="card-body py-3 text-muted small">
        Analyses SPY, QQQ, IWM &amp; DIA â€” classifies market regime, counts distribution days,
        measures breadth (% stocks above SMA200), and maps to action parameters for position sizing &amp; aggressiveness.
      </div>
    </div>
  </div>
</div>

<div id="loading" class="d-none">
  <div class="card mb-3" style="background:#0d1520; border-color:#1e2d3d;">
    <div class="card-body">
      <div class="d-flex align-items-center gap-3 mb-3">
        <div class="spinner-border text-info spinner-glow" style="width:2rem;height:2rem"></div>
        <div>
          <div class="fw-bold" id="progressStage">Initialisingâ€¦</div>
          <div class="text-muted small" id="progressMsg"></div>
        </div>
        <div class="ms-auto text-end text-muted small" id="progressTimer">0s</div>
      </div>
      <!-- Progress bar -->
      <div class="progress mb-3" style="height:6px; background:#1c2f42;">
        <div id="progressBar" class="progress-bar" role="progressbar" style="width:0%; background:var(--accent); transition:width 0.3s;"></div>
      </div>
      <!-- Step checklist -->
      <div class="small" style="line-height:1.8;">
        <div id="mStep1" class="text-muted"><i class="bi bi-circle me-2"></i>â‘  ä¸‹è¼‰æŒ‡æ•¸è³‡æ–™ (SPY, QQQ, IWM, DIA)</div>
        <div id="mStep2" class="text-muted"><i class="bi bi-circle me-2"></i>â‘¡ åˆ†ææŒ‡æ•¸è¶¨å‹¢</div>
        <div id="mStep3" class="text-muted"><i class="bi bi-circle me-2"></i>â‘¢ è¨ˆç®— Distribution Days</div>
        <div id="mStep4" class="text-muted"><i class="bi bi-circle me-2"></i>â‘£ è¨ˆç®— Market Breadth (% above SMA200)</div>
        <div id="mStep5" class="text-muted"><i class="bi bi-circle me-2"></i>â‘¤ è¨ˆç®— New High / New Low æ¯”ç‡</div>
        <div id="mStep6" class="text-muted"><i class="bi bi-circle me-2"></i>â‘¥ å–å¾— Sector æ’å</div>
        <div id="mStep7" class="text-muted"><i class="bi bi-circle me-2"></i>â‘¦ åˆ†é¡ Regime & Action Matrix</div>
      </div>
    </div>
  </div>
</div>

<div id="result" class="d-none">

  <!-- Regime banner -->
  <div id="regimeBanner" class="card mb-3 p-3">
    <div class="d-flex align-items-center gap-3 flex-wrap">
      <div id="regimeEmoji" style="font-size:2.5rem"></div>
      <div>
        <div id="regimeName" class="fw-bold" style="font-size:1.4rem"></div>
        <div id="regimeDate" class="text-muted small"></div>
      </div>
      <div class="ms-auto text-end" id="actionNote" style="max-width:350px; font-size:0.85rem"></div>
    </div>
  </div>

  <!-- Index metrics -->
  <div class="row g-3 mb-3" id="indexCards"></div>

  <!-- Key indicators -->
  <div class="row g-3 mb-3">
    <div class="col-12 col-md-4">
      <div class="card">
        <div class="card-header">Distribution Days</div>
        <div class="card-body text-center">
          <div id="distDays" class="display-4 fw-bold"></div>
          <div class="text-muted small mt-1">SPY last 25 sessions &nbsp;(â‰¥5 = warning)</div>
          <div class="mt-2 text-muted small">QQQ: <span id="qqqDist"></span></div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="card">
        <div class="card-header">Market Breadth</div>
        <div class="card-body text-center">
          <div id="breadth" class="display-4 fw-bold"></div>
          <div class="text-muted small mt-1">% US stocks above SMA200</div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="card">
        <div class="card-header">New High / (NH+NL)</div>
        <div class="card-body text-center">
          <div id="nhNl" class="display-4 fw-bold"></div>
          <div class="text-muted small mt-1">52-week new highs ratio</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Action matrix + sector leaders -->
  <div class="row g-3">
    <div class="col-12 col-md-6">
      <div class="card">
        <div class="card-header"><i class="bi bi-sliders me-2"></i>Action Matrix
          <i class="bi bi-question-circle ms-2" style="cursor:help; color:#8b949e;" data-bs-toggle="tooltip" data-bs-placement="top" title="Action Matrix æ ¹æ“š Minervini çš„å¸‚å ´ç’°å¢ƒåˆ†é¡ï¼Œè‡ªå‹•å»ºè­°ä½ çš„æŒå€‰ä¸Šé™ã€è³‡é‡‘éƒ¨ç½²æ¯”ä¾‹å’Œæ­¢æç­–ç•¥ã€‚ç•¶å¸‚å ´è™•æ–¼ç‰›å¸‚ç¢ºèªæ™‚ï¼Œå¯å…¨åŠ›é€²æ”»ï¼›ç•¶å¸‚å ´èµ°å¼±æˆ–é€²å…¥ç†Šå¸‚ï¼Œç³»çµ±æœƒé™åˆ¶ä½ çš„éƒ¨ä½æ•¸å’Œè³‡é‡‘æ¯”ï¼Œä¸¦æ”¶ç·Šæ­¢æï¼Œä»¥ä¿è­·è³‡æœ¬ã€‚"></i>
        </div>
        <div class="card-body" id="actionMatrix"></div>
        <div class="card-footer bg-transparent border-top-0 pt-0">
          <details class="small text-muted">
            <summary style="cursor:pointer;">ä»€éº¼æ˜¯ Action Matrixï¼Ÿ</summary>
            <div class="mt-2" style="line-height:1.6;">
              Action Matrix æ ¹æ“š <strong>Mark Minervini</strong> çš„å¸‚å ´ç’°å¢ƒç†è«–ï¼ˆã€ŠTrade Like a Stock Market Wizardã€‹ç¬¬ 12-13 ç« ï¼‰ï¼Œ<br>
              ä¾æ“šç•¶å‰ Regimeï¼ˆå¸‚å ´éšæ®µï¼‰è‡ªå‹•è¼¸å‡ºä¸‰é …äº¤æ˜“åƒæ•¸ï¼š
              <ul class="mt-1 mb-1">
                <li><strong>Max Positions</strong> â€” åŒæ™‚æŒæœ‰çš„æœ€å¤§éƒ¨ä½æ•¸</li>
                <li><strong>Max Deployment</strong> â€” ç¸½è³‡é‡‘å¯æŠ•å…¥çš„æœ€å¤§æ¯”ä¾‹</li>
                <li><strong>Stop Mode</strong> â€” æ­¢æå¯¬é¬†åº¦ï¼ˆNORMAL â†’ TIGHT â†’ VERY_TIGHT â†’ EXITSï¼‰</li>
              </ul>
              <span style="color:#58a6ff;">BULL_CONFIRMED</span>ï¼šå…¨åŠ›é€²æ”»ï¼Œæœ€å¤š 8 å€‹éƒ¨ä½ã€100% è³‡é‡‘<br>
              <span style="color:#e3b341;">TRANSITION</span>ï¼šåƒ…é¸æœ€å„ª A ç´šæ¨™çš„ï¼Œ50% è³‡é‡‘ã€æ”¶ç·Šæ­¢æ<br>
              <span style="color:#f85149;">BEAR_CONFIRMED</span>ï¼šä¸é–‹æ–°å€‰ï¼Œä¿è­·è³‡æœ¬
            </div>
          </details>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-6">
      <div class="card">
        <div class="card-header"><i class="bi bi-building me-2"></i>Sector Performance</div>
        <div class="card-body" id="sectorBox"></div>
      </div>
    </div>
  </div>

  <!-- Log file path -->
  <div id="marketLogBar" class="mt-3 d-none">
    <div class="card" style="background:#0d1520; border-color:#1e2d3d;">
      <div class="card-body py-2 d-flex align-items-center gap-2 small">
        <i class="bi bi-journal-text" style="color:var(--accent)"></i>
        <span class="text-muted">Log file:</span>
        <code id="marketLogPath" style="color:#58a6ff; font-size:0.8rem;"></code>
      </div>
    </div>
  </div>
</div>
<script>
let _marketPollId = null;
let _marketStartTime = null;
let _marketTimerId = null;

function _updateTimer() {
  if (!_marketStartTime) return;
  const sec = Math.round((Date.now() - _marketStartTime) / 1000);
  const el = document.getElementById('progressTimer');
  if (el) el.textContent = sec < 60 ? `${sec}s` : `${Math.floor(sec/60)}m ${sec%60}s`;
}

function _updateProgress(p) {
  if (!p) return;
  const stage = p.stage || '';
  const pct = p.pct || 0;
  const msg = p.msg || '';
  const step = p.step || 0;

  document.getElementById('progressStage').textContent = stage;
  document.getElementById('progressMsg').textContent = msg;
  document.getElementById('progressBar').style.width = pct + '%';

  // Update step checklist
  for (let i = 1; i <= 7; i++) {
    const el = document.getElementById('mStep' + i);
    if (!el) continue;
    const label = el.textContent.replace(/^[âœ“âŸ³â—â—‹\s]+/, '');
    if (i < step) {
      // Completed
      el.className = 'text-success';
      el.innerHTML = `<i class="bi bi-check-circle-fill me-2"></i>${el.dataset.label || el.textContent.trim()}`;
    } else if (i === step) {
      // In progress
      el.className = '';
      el.style.color = '#58a6ff';
      el.innerHTML = `<span class="spinner-border spinner-border-sm me-2" style="width:0.8rem;height:0.8rem;"></span>${el.dataset.label || el.textContent.trim()}`;
    } else {
      // Not started
      el.className = 'text-muted';
      el.innerHTML = `<i class="bi bi-circle me-2"></i>${el.dataset.label || el.textContent.trim()}`;
    }
  }
}

async function runAssess() {
  document.getElementById('btnAssess').disabled = true;
  document.getElementById('loading').classList.remove('d-none');
  document.getElementById('result').classList.add('d-none');
  document.getElementById('marketLogBar').classList.add('d-none');

  // Save step labels on first run
  for (let i = 1; i <= 7; i++) {
    const el = document.getElementById('mStep' + i);
    if (el && !el.dataset.label) el.dataset.label = el.textContent.trim();
  }

  // Reset progress
  _updateProgress({stage: 'Initialisingâ€¦', pct: 0, msg: '', step: 0});
  _marketStartTime = Date.now();
  _marketTimerId = setInterval(_updateTimer, 500);

  const r = await fetch('/api/market/run', {method:'POST'}).then(x=>x.json());
  const statusUrl = `/api/market/status/${r.job_id}`;

  _marketPollId = setInterval(async () => {
    const job = await fetch(statusUrl).then(x=>x.json()).catch(()=>({status:'error',error:'network'}));

    // Update progress while pending
    if (job.status === 'pending' && job.progress) {
      _updateProgress(job.progress);
    }

    if (job.status === 'done') {
      clearInterval(_marketPollId);
      clearInterval(_marketTimerId);
      _updateProgress({stage: 'Complete', pct: 100, msg: `Regime: ${(job.result||{}).regime||'?'}`, step: 8});
      // Brief pause to show completion
      setTimeout(() => {
        document.getElementById('loading').classList.add('d-none');
        document.getElementById('btnAssess').disabled = false;
        renderMarket(job.result);
        if (job.log_file) {
          document.getElementById('marketLogPath').textContent = job.log_file;
          document.getElementById('marketLogBar').classList.remove('d-none');
        }
        toast(`âœ… å¸‚å ´è©•ä¼°å®Œæˆ â€” ${(job.result||{}).regime||'UNKNOWN'}`, true);
      }, 400);
    } else if (job.status === 'error') {
      clearInterval(_marketPollId);
      clearInterval(_marketTimerId);
      document.getElementById('loading').classList.add('d-none');
      document.getElementById('btnAssess').disabled = false;
      if (job.log_file) {
        document.getElementById('marketLogPath').textContent = job.log_file;
        document.getElementById('marketLogBar').classList.remove('d-none');
      }
      toast(`Error: ${job.error||'Unknown'}`, false);
    }
  }, 1500);
}

function renderMarket(d) {
  const emojis = {BULL_CONFIRMED:'ğŸŸ¢',BULL_UNCONFIRMED:'ğŸŸ¢',TRANSITION:'ğŸŸ¡',
                  BOTTOM_FORMING:'ğŸ”µ',BEAR_RALLY:'ğŸŸ¡',BEAR_CONFIRMED:'ğŸ”´',UNKNOWN:'âšª'};
  const colours= {BULL_CONFIRMED:'#3fb950',BULL_UNCONFIRMED:'#3fb950',
                  TRANSITION:'#e3b341',BOTTOM_FORMING:'#58a6ff',
                  BEAR_RALLY:'#e3b341',BEAR_CONFIRMED:'#f85149',UNKNOWN:'#8b949e'};
  const regimeClass = {BULL_CONFIRMED:'regime-bull',BULL_UNCONFIRMED:'regime-bull',
                        TRANSITION:'regime-trans',BOTTOM_FORMING:'regime-bottom',
                        BEAR_RALLY:'regime-trans',BEAR_CONFIRMED:'regime-bear',UNKNOWN:''};

  const regime = d.regime || 'UNKNOWN';
  document.getElementById('regimeBanner').className = `card mb-3 p-3 ${regimeClass[regime]||''}`;
  document.getElementById('regimeEmoji').textContent = emojis[regime]||'âšª';
  document.getElementById('regimeName').style.color = colours[regime]||'#fff';
  document.getElementById('regimeName').textContent  = regime.replace(/_/g,' ');
  document.getElementById('regimeDate').textContent  = `Assessed: ${d.assessed_at||''}`;
  document.getElementById('actionNote').textContent  = d.action_matrix?.note||'';

  // Index cards
  const indices = [
    ['SPY','S&P 500',d.spy_trend],
    ['QQQ','NASDAQ 100',d.qqq_trend],
    ['IWM','Russell 2000',d.iwm_trend],
    ['DIA','Dow Jones',d.dia_trend],
  ];
  const idxHtml = indices.map(([sym,name,t]) => {
    if (!t||t.status==='NO DATA') return '';
    const sc = t.trend_score||0;
    const clr = t.status==='UPTREND' ? '#3fb950' : t.status==='WEAKENING' ? '#e3b341' : '#f85149';
    const smas = Object.entries(t.above_smas||{}).map(([k,v])=>
      `<span class="badge ${v?'bg-success':'bg-danger'} me-1">${k.replace('sma','SMA')}</span>`
    ).join('');
    return `<div class="col-6 col-md-3">
      <div class="card">
        <div class="card-body text-center py-2">
          <div class="text-muted small">${sym} â€” ${name}</div>
          <div class="fw-bold mt-1" style="color:${clr}">${t.status}</div>
          <div class="mt-1 small">Score ${sc}/4 &nbsp;|&nbsp; YTD ${t.ytd_pct>0?'+':''}${Number(t.ytd_pct||0).toFixed(1)}%</div>
          <div class="mt-1">${smas}</div>
          <div class="mt-1 text-muted small">From 52wH: ${Number(t.pct_from_52w_high||0).toFixed(1)}%</div>
        </div>
      </div>
    </div>`;
  }).join('');
  document.getElementById('indexCards').innerHTML = idxHtml;

  // Dist days
  const dd = d.distribution_days ?? 'â€”';
  const ddClr = dd >= 6 ? '#f85149' : dd >= 4 ? '#e3b341' : '#3fb950';
  document.getElementById('distDays').style.color = ddClr;
  document.getElementById('distDays').textContent  = dd;
  document.getElementById('qqqDist').textContent   = d.qqq_dist_days ?? 'â€”';

  // Breadth
  const br = d.breadth_pct;
  const brClr = br>=60?'#3fb950':br>=40?'#e3b341':'#f85149';
  document.getElementById('breadth').style.color = brClr;
  document.getElementById('breadth').textContent  = br!=null ? br+'%' : 'â€”';

  // NH/NL
  const nh = d.nh_nl_ratio;
  const nhClr = nh>=60?'#3fb950':nh>=40?'#e3b341':'#f85149';
  document.getElementById('nhNl').style.color = nhClr;
  document.getElementById('nhNl').textContent  = nh!=null ? nh+'%' : 'â€”';

  // Action matrix
  const am = d.action_matrix || {};
  document.getElementById('actionMatrix').innerHTML = `
    <div class="row g-2 text-center mb-3">
      <div class="col-6"><div class="metric-card p-2"><div class="fw-bold fs-4">${am.max_open_positions??'â€”'}</div><div class="metric-lbl">Max Positions</div></div></div>
      <div class="col-6"><div class="metric-card p-2"><div class="fw-bold fs-4">${am.max_portfolio_pct??'â€”'}%</div><div class="metric-lbl">Max Deployment</div></div></div>
    </div>
    <div><strong>Stop Mode:</strong> <span class="badge bg-secondary">${am.stop_mode||'â€”'}</span></div>
    <div class="mt-2 text-muted small">${am.note||''}</div>`;

  // Sectors
  const leading  = d.leading_sectors||[];
  const lagging  = d.lagging_sectors||[];
  document.getElementById('sectorBox').innerHTML = `
    ${leading.length ? `<div class="mb-2"><strong class="text-success">Leading:</strong><br/>${leading.map(s=>`<span class="badge" style="background:#1b6e2e;color:#3fb950;margin:2px">${s}</span>`).join('')}</div>` : ''}
    ${lagging.length ? `<div><strong class="text-danger">Lagging:</strong><br/>${lagging.map(s=>`<span class="badge" style="background:#3e0a0a;color:#f85149;margin:2px">${s}</span>`).join('')}</div>` : ''}
    ${!leading.length && !lagging.length ? '<span class="text-muted">Sector data unavailable.</span>' : ''}`;

  document.getElementById('result').classList.remove('d-none');
}
</script>
{% endblock %}
