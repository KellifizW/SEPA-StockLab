{% extends "base.html" %}
{% block title %}Analyze{% endblock %}
{% block content %}
<h4 class="mb-3"><i class="bi bi-search me-2" style="color:var(--accent)"></i>Individual Stock Analysis</h4>

<div class="card mb-3">
  <div class="card-body">
    <div class="row g-2 align-items-end">
      <div class="col-auto">
        <label class="form-label text-muted small">Ticker Symbol</label>
        <input class="form-control" id="tickerInput" value="{{ prefill }}"
               placeholder="e.g. NVDA" style="width:120px;text-transform:uppercase"
               oninput="this.value=this.value.toUpperCase()"
               onkeydown="if(event.key==='Enter')analyze()">
      </div>
      <div class="col-auto">
        <label class="form-label text-muted small">Account Size ($)</label>
        <input class="form-control" id="accountInput" type="number" value="100000" style="width:140px">
      </div>
      <div class="col-auto">
        <button class="btn btn-accent" onclick="analyze()"><i class="bi bi-play-fill me-1"></i>Analyze</button>
      </div>
    </div>
  </div>
</div>

<!-- Loading -->
<div id="loading" class="text-center py-5 d-none">
  <div class="spinner-border text-info spinner-glow" style="width:3rem;height:3rem"></div>
  <div class="mt-3 text-muted">Fetching data and running SEPA analysis…</div>
</div>

<!-- Error -->
<div id="errBox" class="alert alert-danger d-none"></div>

<!-- Yahoo Finance auth warning (shown when yfinance returns no info due to 401/crumb) -->
<div id="yf401Warning" class="alert d-none mb-3"
     style="background:#2e1a00;border-left:4px solid #e3b341;color:#e3b341">
  <i class="bi bi-exclamation-triangle-fill me-2"></i>
  <strong>Yahoo Finance 認証失效 (Invalid Crumb)</strong> —
  基本面數據可能不完整，分析結果可能不準確。
  <button class="btn btn-sm ms-3"
          style="background:#4a3800;color:#e3b341;border:1px solid #e3b341"
          onclick="resetYfSession()">
    <i class="bi bi-arrow-clockwise me-1"></i>重置連接 Reset Session
  </button>
</div>

<!-- Result -->
<div id="result" class="d-none">
  <div class="row g-3 mb-3" id="summaryCards"></div>

  <div class="row g-3">
    <!-- TT Checklist -->
    <div class="col-12 col-md-5">
      <div class="card h-100">
        <div class="card-header"><i class="bi bi-check2-all me-2"></i>Trend Template (TT1-TT10)</div>
        <div class="card-body p-0">
          <ul class="list-group list-group-flush" id="ttList"></ul>
        </div>
      </div>
    </div>

    <!-- SEPA Scores -->
    <div class="col-12 col-md-3">
      <div class="card h-100">
        <div class="card-header"><i class="bi bi-pie-chart me-2"></i>SEPA Pillar Scores</div>
        <div class="card-body" id="sepaScores"></div>
      </div>
    </div>

    <!-- VCP -->
    <div class="col-12 col-md-4">
      <div class="card h-100">
        <div class="card-header"><i class="bi bi-activity me-2"></i>VCP Analysis</div>
        <div class="card-body" id="vcpBox"></div>
      </div>
    </div>

    <!-- Fundamentals -->
    <div class="col-12 col-md-6">
      <div class="card">
        <div class="card-header"><i class="bi bi-bank me-2"></i>Fundamentals Checklist</div>
        <div class="card-body p-0">
          <ul class="list-group list-group-flush" id="fundList"></ul>
        </div>
      </div>
    </div>

    <!-- Position Sizing -->
    <div class="col-12 col-md-6">
      <div class="card">
        <div class="card-header"><i class="bi bi-calculator me-2"></i>Position Sizing</div>
        <div class="card-body" id="posBox"></div>
      </div>
    </div>

    <!-- Score History Chart -->
    <div class="col-12">
      <div class="card">
        <div class="card-header"><i class="bi bi-graph-up me-2"></i>Score History (Last 90 days)</div>
        <div class="card-body">
          <div id="historyLoading" class="text-center py-3">
            <div class="spinner-border spinner-border-sm text-info"></div>
            <div class="text-muted small mt-2">Loading chart…</div>
          </div>
          <div id="historyChartWrap" style="position:relative;height:300px;display:none"><canvas id="historyChart"></canvas></div>
          <div id="historyEmpty" style="display:none" class="text-center py-4 text-muted">
            <i class="bi bi-inbox fs-2 d-block mb-2"></i>
            這隻股票還沒有出現在之前的掃描中。
          </div>
        </div>
      </div>
    </div>

    <!-- Price History Chart -->
    <div class="col-12">
      <div class="card">
        <div class="card-header"><i class="bi bi-bar-chart-line me-2"></i>Price History (Last 90 days)</div>
        <div class="card-body">
          <div id="priceLoading" class="text-center py-3">
            <div class="spinner-border spinner-border-sm text-success"></div>
            <div class="text-muted small mt-2">Loading price data…</div>
          </div>
          <div id="priceChartWrap" style="position:relative;height:280px;display:none"><canvas id="priceChart"></canvas></div>
          <div id="priceEmpty" style="display:none" class="text-center py-4 text-muted">
            <i class="bi bi-inbox fs-2 d-block mb-2"></i>
            No price cache found for this ticker.
          </div>
        </div>
      </div>
    </div>

    <!-- Recommendation -->
    <div class="col-12">
      <div class="card" id="recCard">
        <div class="card-header"><i class="bi bi-lightbulb me-2"></i>Recommendation</div>
        <div class="card-body" id="recBox"></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
async function analyze() {
  const ticker = document.getElementById('tickerInput').value.trim().toUpperCase();
  const acct   = parseFloat(document.getElementById('accountInput').value) || 100000;
  if (!ticker) { toast('Enter a ticker symbol', false); return; }

  document.getElementById('result').classList.add('d-none');
  document.getElementById('errBox').classList.add('d-none');
  document.getElementById('loading').classList.remove('d-none');

  const r = await fetch('/api/analyze', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ticker, account_size: acct})
  }).then(x=>x.json());

  pollJob(`/api/analyze/status/${r.job_id}`,
    data => renderResult(data, ticker),
    err  => {
      document.getElementById('loading').classList.add('d-none');
      document.getElementById('errBox').textContent = `Error: ${err}`;
      document.getElementById('errBox').classList.remove('d-none');
    }
  );
}

function renderResult(d, ticker) {
  document.getElementById('loading').classList.add('d-none');
  if (!d) { toast('No result returned', false); return; }

  const score  = d.sepa_score || 0;
  const rec    = d.recommendation || {};
  const tt     = d.trend_template || {};
  const vcp    = d.vcp || {};
  const pos    = d.position || {};
  const funds  = d.fundamentals || {};
  const scored = d.scored_pillars || {};
  const cls    = scoreClass(score);

  // Show/hide 401 auth warning
  const w401 = document.getElementById('yf401Warning');
  if (d.yf_auth_warning) {
    w401.classList.remove('d-none');
    toast('Yahoo Finance 認証失效 — 基本面數據可能不完整', false);
  } else {
    w401.classList.add('d-none');
  }

  // Summary cards
  document.getElementById('summaryCards').innerHTML = `
    <div class="col-6 col-md-3"><div class="metric-card">
      <div class="metric-val ${cls}">${Number(score).toFixed(1)}</div>
      <div class="metric-lbl">SEPA Score</div>
    </div></div>
    <div class="col-6 col-md-3"><div class="metric-card">
      <div class="metric-val">${fmtInt(d.rs_rank)}</div>
      <div class="metric-lbl">RS Rank</div>
    </div></div>
    <div class="col-6 col-md-3"><div class="metric-card">
      <div class="metric-val ${vcp.is_valid_vcp ? 'score-high' : 'score-low'}">${vcp.grade||'—'}</div>
      <div class="metric-lbl">VCP Grade</div>
    </div></div>
    <div class="col-6 col-md-3"><div class="metric-card">
      <div class="metric-val" style="color:${rec.action==='BUY'?'var(--success)':rec.action==='AVOID'?'var(--danger)':'var(--warning)'}">${rec.action||'—'}</div>
      <div class="metric-lbl">Action</div>
    </div></div>`;

  // TT Checklist
  const ttItems = [
    ['TT1', 'Price > SMA150', tt.tt1],
    ['TT2', 'Price > SMA200', tt.tt2],
    ['TT3', 'SMA150 > SMA200', tt.tt3],
    ['TT4', 'SMA200 Trend Rising (22d)', tt.tt4],
    ['TT5', 'SMA50 > SMA150 & SMA200', tt.tt5],
    ['TT6', 'Price > SMA50', tt.tt6],
    ['TT7', 'Price >25% above 52W Low', tt.tt7],
    ['TT8', 'Price within 25% of 52W High', tt.tt8],
    ['TT9', `RS Rank ≥ 70 (actual: ${fmtInt(d.rs_rank)})`, tt.tt9],
    ['TT10','Sector in top 35%', tt.tt10],
  ];
  document.getElementById('ttList').innerHTML = ttItems.map(([id, lbl, pass]) =>
    `<li class="list-group-item d-flex justify-content-between align-items-center py-2" style="background:transparent;border-color:#21262d">
      <span class="text-muted small">${id}: ${lbl}</span>
      ${pass ? '<i class="bi bi-check-circle-fill text-success"></i>' : '<i class="bi bi-x-circle text-danger"></i>'}
    </li>`
  ).join('');

  // SEPA pillar scores — only show the 5 pillars, not all scored_pillars keys
  const pillarDefs = [
    ['trend_score',       '趨勢 Trend'],
    ['fundamental_score', '基本面 Fundamentals'],
    ['catalyst_score',    '催化劑 Catalyst'],
    ['entry_score',       '入場時機 Entry'],
    ['rr_score',          '風險回報 Risk/Reward'],
  ];
  document.getElementById('sepaScores').innerHTML = pillarDefs.map(([k, lbl]) => {
    const pct = Math.round(scored[k] || 0);
    const bar = `<div class="progress mt-1 mb-2" style="height:6px">
      <div class="progress-bar ${pct>=70?'bg-success':pct>=50?'bg-warning':'bg-danger'}"
           style="width:${pct}%"></div></div>`;
    return `<div><div class="d-flex justify-content-between"><span class="small">${lbl}</span><span class="small fw-bold">${pct}</span></div>${bar}</div>`;
  }).join('') + `<div class="mt-2 pt-2" style="border-top:1px solid #21262d"><div class="d-flex justify-content-between"><span class="small fw-bold">總分 Total</span><span class="small fw-bold ${scoreClass(score)}">${Number(score).toFixed(1)}</span></div></div>`;

  // VCP box
  document.getElementById('vcpBox').innerHTML = `
    <div class="mb-2"><strong>Valid VCP:</strong> ${vcp.is_valid_vcp ? '<span class="text-success">YES ✓</span>' : '<span class="text-danger">NO</span>'}</div>
    <div><strong>Score:</strong> ${vcp.vcp_score||0}/100 &nbsp; <strong>Grade:</strong> ${vcp.grade||'—'}</div>
    <div class="mt-2 text-muted small">
      T-count: ${vcp.t_count||0} &nbsp;|&nbsp;
      Base: ${vcp.base_weeks||0}w &nbsp;|&nbsp;
      Depth: ${fmtPct(vcp.base_depth_pct)}
    </div>
    <div class="mt-1 text-muted small">
      ${vcp.pivot_price ? `Pivot: <strong style="color:var(--accent)">$${Number(vcp.pivot_price).toFixed(2)}</strong>` : ''}
    </div>
    <div class="mt-2 small">
      ATR contracting: ${vcp.atr_contracting ? '✓' : '✗'} &nbsp;
      BB contracting: ${vcp.bb_contracting ? '✓' : '✗'} &nbsp;
      Vol dry-up: ${vcp.vol_dry ? '✓' : '✗'}
    </div>
    ${(vcp.notes||[]).length ? `<div class="mt-2 text-muted small">${vcp.notes.map(n=>`• ${n}`).join('<br>')}</div>` : ''}`;

  // Fundamentals
  const fundChecks = funds.checks || [];
  const fundPasses = funds.passes ?? 0;
  const fundTotal  = funds.total ?? 0;
  const fundPct    = funds.pct ?? 0;
  const fundLabels = {
    'F1_EPS_QOQ_25':     'EPS 季增長 ≥ 25%',
    'F2_EPS_ACCEL':      'EPS 加速成長',
    'F3_ANNUAL_EPS_25':  '年度 EPS 成長 ≥ 25%',
    'F5_REVENUE_20':     '營收成長 ≥ 20%',
    'F7_PROFIT_MARGIN':  '淨利率 > 0%',
    'F8_ROE_17':         'ROE ≥ 17%',
    'F10_BEAT_ESTIMATES':'上季 EPS 超越預期',
    'F11_REVISIONS_UP':  '分析師上調預估',
    'F12_INST_INCREASING':'機構持股增加',
  };
  const fundSummary = `<li class="list-group-item d-flex justify-content-between align-items-center py-2" style="background:#0d1520;border-color:#21262d">
    <span class="small fw-bold">Fundamentals Score</span>
    <span class="badge ${fundPct>=70?'bg-success':fundPct>=40?'bg-warning':'bg-danger'}">${fundPasses} / ${fundTotal} (${fundPct}%)</span>
  </li>`;
  document.getElementById('fundList').innerHTML = fundChecks.length ?
    fundSummary + fundChecks.map(c => {
      const label = fundLabels[c.id] || c.id;
      return `<li class="list-group-item d-flex justify-content-between align-items-center py-2" style="background:transparent;border-color:#21262d">
        <div>
          <span class="text-muted small">${c.id?.replace(/_/g,' ')}</span><br/>
          <span class="small">${label}</span>
          <div class="text-muted" style="font-size:0.75rem">${c.note||''}</div>
        </div>
        ${c.pass ? '<i class="bi bi-check-circle-fill text-success"></i>' : '<i class="bi bi-x-circle text-danger"></i>'}
      </li>`;
    }).join('') :
    '<li class="list-group-item text-muted py-3" style="background:transparent">No fundamental data available.</li>';

  // Position sizing
  document.getElementById('posBox').innerHTML = pos ? `
    <div class="row g-2 text-center">
      <div class="col-6"><div class="metric-card p-2">
        <div class="fw-bold" style="font-size:20px">$${Number(pos.entry||0).toFixed(2)}</div>
        <div class="metric-lbl">Entry Price</div>
      </div></div>
      <div class="col-6"><div class="metric-card p-2">
        <div class="fw-bold text-danger" style="font-size:20px">$${Number(pos.stop||0).toFixed(2)}</div>
        <div class="metric-lbl">Stop Loss</div>
      </div></div>
      <div class="col-6"><div class="metric-card p-2">
        <div class="fw-bold text-success" style="font-size:20px">${fmtInt(pos.shares)}</div>
        <div class="metric-lbl">Shares</div>
      </div></div>
      <div class="col-6"><div class="metric-card p-2">
        <div class="fw-bold" style="font-size:20px">$${Number(pos.position_value||0).toLocaleString('en',{maximumFractionDigits:0})}</div>
        <div class="metric-lbl">Position Value</div>
      </div></div>
    </div>
    <div class="mt-3 text-muted small">
      Risk: $${Number(pos.risk_dollar||0).toFixed(0)} (${fmtPct(pos.risk_pct)}) &nbsp;|&nbsp;
      R:R ${Number(pos.rr||0).toFixed(1)}:1 &nbsp;|&nbsp;
      Target $${Number(pos.target||0).toFixed(2)}
    </div>
    <button class="btn btn-sm btn-outline-success mt-3 w-100"
      onclick="prefillPosition('${ticker}',${pos.entry||0},${pos.shares||0},${pos.stop||0},${pos.target||0})">
      <i class="bi bi-plus-circle me-1"></i>Add to Positions
    </button>` : '<p class="text-muted">Position data unavailable.</p>';

  // Recommendation
  const colours = {BUY:'success', WATCH:'info', MONITOR:'warning', AVOID:'danger'};
  const c = colours[rec.action] || 'secondary';
  document.getElementById('recBox').innerHTML = `
    <div class="alert alert-${c} mb-2">${rec.action||'N/A'}: ${rec.description||''}</div>
    ${(rec.reasons||[]).map(r=>`<div class="text-muted small">• ${r}</div>`).join('')}
    <div class="d-flex gap-2 mt-3">
      <button class="btn btn-sm btn-primary" onclick="addToWatchlist('${ticker}')">
        <i class="bi bi-bookmark-plus me-1"></i>Add to Watchlist
      </button>
      ${rec.action === 'BUY' ? `
        <button class="btn btn-sm btn-success" onclick="prefillPosition('${ticker}',${pos?.entry||0},${pos?.shares||0},${pos?.stop||0},${pos?.target||0})">
          <i class="bi bi-plus-circle me-1"></i>Create Position
        </button>
      ` : ''}
    </div>`;

  document.getElementById('result').classList.remove('d-none');

  // Load and render score history chart asynchronously
  loadScoreHistory(ticker);
  loadPriceHistory(ticker);
}

async function loadScoreHistory(ticker) {
  try {
    document.getElementById('historyLoading').style.display = 'block';
    document.getElementById('historyChartWrap').style.display = 'none';
    document.getElementById('historyEmpty').style.display = 'none';

    const scanTrend = await fetch(`/api/db/scan-trend/${ticker}?days=90`).then(x => x.json());
    const rsTrend = await fetch(`/api/db/rs-trend/${ticker}?days=90`).then(x => x.json());

    const scanRows = scanTrend.rows || [];
    const rsRows = rsTrend.rows || [];

    if (!scanRows.length) {
      document.getElementById('historyLoading').style.display = 'none';
      document.getElementById('historyEmpty').style.display = 'block';
      return;
    }

    // Build chart data
    const dates = scanRows.map(r => r.scan_date);
    const scores = scanRows.map(r => r.sepa_score || 0);
    const rsRanks = rsRows.length ? rsRows.map(r => r.rs_rank || 0) : Array(scanRows.length).fill(null);

    // Create dual-axis chart
    const ctx = document.getElementById('historyChart');
    if (ctx.chart) ctx.chart.destroy();

    ctx.chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: dates,
        datasets: [
          {
            label: 'SEPA Score',
            data: scores,
            borderColor: '#00d4ff',
            backgroundColor: 'rgba(0, 212, 255, 0.1)',
            yAxisID: 'y',
            tension: 0.3,
            borderWidth: 2,
            pointRadius: 4,
            pointHoverRadius: 6,
            pointBackgroundColor: '#00d4ff'
          },
          {
            label: 'RS Rank %ile',
            data: rsRanks,
            borderColor: '#58a6ff',
            backgroundColor: 'rgba(88, 166, 255, 0.1)',
            yAxisID: 'y1',
            tension: 0.3,
            borderWidth: 2,
            pointRadius: 4,
            pointHoverRadius: 6,
            pointBackgroundColor: '#58a6ff'
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {mode: 'index', intersect: false},
        plugins: {
          legend: {
            labels: {color: '#c9d1d9', usePointStyle: true}
          }
        },
        scales: {
          x: {
            grid: {color: '#30363d'},
            ticks: {color: '#8b949e', maxTicksLimit: 8}
          },
          y: {
            type: 'linear',
            position: 'left',
            grid: {color: '#30363d'},
            ticks: {color: '#8b949e'},
            min: 0,
            max: 100,
            title: {display: true, text: 'SEPA Score', color: '#00d4ff'}
          },
          y1: {
            type: 'linear',
            position: 'right',
            grid: {drawOnChartArea: false},
            ticks: {color: '#8b949e'},
            min: 0,
            max: 100,
            title: {display: true, text: 'RS Rank %ile', color: '#58a6ff'}
          }
        }
      }
    });

    document.getElementById('historyLoading').style.display = 'none';
    document.getElementById('historyChartWrap').style.display = 'block';
  } catch (e) {
    console.error('Error loading score history:', e);
    document.getElementById('historyLoading').style.display = 'none';
    document.getElementById('historyEmpty').style.display = 'block';
  }
}

function prefillPosition(ticker, entry, shares, stop, target) {
  const params = new URLSearchParams({ticker, entry, shares, stop, target});
  window.location.href = `/positions?prefill=${encodeURIComponent(JSON.stringify({ticker,entry,shares,stop,target}))}`;
}

async function loadPriceHistory(ticker) {
  const loadEl  = document.getElementById('priceLoading');
  const chartEl = document.getElementById('priceChart');
  const emptyEl = document.getElementById('priceEmpty');
  const wrapEl = document.getElementById('priceChartWrap');
  loadEl.style.display = 'block';
  wrapEl.style.display = 'none';
  emptyEl.style.display = 'none';
  try {
    const res = await fetch(`/api/db/price-history/${ticker}?days=90`).then(x => x.json());
    const rows = res.rows || [];
    if (!rows.length) {
      loadEl.style.display = 'none';
      emptyEl.style.display = 'block';
      return;
    }
    const dates  = rows.map(r => r.date.slice(0, 10));  // trim T00:00:00
    const closes = rows.map(r => +r.close);
    const vols   = rows.map(r => +r.volume);
    const maxVol = Math.max(...vols) || 1;
    // Y-axis: 5% padding below low, 5% above high — no zero baseline
    const priceMin = Math.min(...closes);
    const priceMax = Math.max(...closes);
    const pricePad = (priceMax - priceMin) * 0.05 || priceMin * 0.03;
    const yMin = priceMin - pricePad;
    const yMax = priceMax + pricePad;
    if (chartEl._chart) chartEl._chart.destroy();
    chartEl._chart = new Chart(chartEl, {
      type: 'bar',
      data: {
        labels: dates,
        datasets: [
          {
            type: 'line',
            label: 'Close',
            data: closes,
            borderColor: '#3fb950',
            backgroundColor: 'rgba(63,185,80,0.08)',
            yAxisID: 'yPrice',
            tension: 0.2,
            borderWidth: 2,
            pointRadius: 0,
            pointHoverRadius: 5,
          },
          {
            type: 'bar',
            label: 'Volume',
            data: vols.map(v => yMin + (v / maxVol) * (priceMax - priceMin) * 0.25),
            backgroundColor: 'rgba(88,166,255,0.22)',
            yAxisID: 'yVol',
            borderWidth: 0,
          },
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: { labels: { color: '#c9d1d9', usePointStyle: true } },
          tooltip: {
            callbacks: {
              label: ctx => ctx.dataset.label === 'Volume'
                ? `Vol: ${(vols[ctx.dataIndex] / 1e6).toFixed(2)}M`
                : `Close: $${(+ctx.raw).toFixed(2)}`
            }
          }
        },
        scales: {
          x: { grid: { color: '#30363d' }, ticks: { color: '#8b949e', maxTicksLimit: 8 } },
          yPrice: {
            type: 'linear', position: 'left',
            grid: { color: '#30363d' }, ticks: { color: '#8b949e' },
            min: yMin, max: yMax,
            title: { display: true, text: 'Price ($)', color: '#3fb950' }
          },
          yVol: {
            type: 'linear', position: 'right',
            grid: { drawOnChartArea: false },
            ticks: { display: false },
            min: yMin, max: yMax + (priceMax - priceMin) * 0.25
          }
        }
      }
    });
    loadEl.style.display = 'none';
    wrapEl.style.display = 'block';
    
    // 分析完成通知（不自動關閉）
    toastCompletion(`✅ ${ticker} 分析完成`, true);
  } catch(e) {
    console.error('loadPriceHistory error:', e);
    loadEl.style.display = 'none';
    emptyEl.style.display = 'block';
  }
}

async function addToWatchlist(ticker) {
  const r = await fetch('/api/watchlist/add', {
    method: 'POST', headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ticker})
  }).then(x => x.json());
  
  if (r.job_id) {
    pollJob(`/api/watchlist/add/status/${r.job_id}`,
      ()  => toast(`✅ ${ticker} added to watchlist`, true),
      err => toast(`Error: ${err}`, false)
    );
  } else {
    toast(`Error: ${r.error || 'Failed to add to watchlist'}`, false);
  }
}

async function resetYfSession() {
  const btn = event.target.closest('button');
  if (btn) { btn.disabled = true; btn.textContent = '重置中…'; }
  try {
    const r = await fetch('/api/admin/reset-yf-session', {method:'POST'}).then(x=>x.json());
    if (r.ok) {
      toast('✅ Session 已重置，請重新查詢', true);
      document.getElementById('yf401Warning').classList.add('d-none');
    } else {
      toast('⚠️ 重置失敗: ' + (r.error || r.message), false);
    }
  } catch(e) {
    toast('⚠️ 重置失敗: ' + e, false);
  } finally {
    if (btn) { btn.disabled = false; btn.innerHTML = '<i class="bi bi-arrow-clockwise me-1"></i>重置連接 Reset Session'; }
  }
}

// Auto-run if prefill ticker provided
window.addEventListener('DOMContentLoaded', () => {
  const t = document.getElementById('tickerInput').value;
  if (t) analyze();
});
</script>
{% endblock %}
