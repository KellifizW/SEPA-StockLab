{% extends "base.html" %}
{% block title %}Analyze{% endblock %}
{% block content %}
<h4 class="mb-3"><i class="bi bi-search me-2" style="color:var(--accent)"></i>Individual Stock Analysis</h4>

<div class="card mb-3">
  <div class="card-body">
    <div class="row g-2 align-items-end">
      <div class="col-auto">
        <label class="form-label text-muted small">Ticker Symbol</label>
        <input class="form-control" id="tickerInput" value="{{ prefill }}"
               placeholder="e.g. NVDA" style="width:120px;text-transform:uppercase"
               oninput="this.value=this.value.toUpperCase()"
               onkeydown="if(event.key==='Enter')analyze()">
      </div>
      <div class="col-auto">
        <label class="form-label text-muted small">Account Size ($)</label>
        <input class="form-control" id="accountInput" type="number" value="100000" style="width:140px">
      </div>
      <div class="col-auto">
        <button class="btn btn-accent" onclick="analyze()"><i class="bi bi-play-fill me-1"></i>Analyze</button>
      </div>
    </div>
  </div>
</div>

<!-- Loading -->
<div id="loading" class="text-center py-5 d-none">
  <div class="spinner-border text-info spinner-glow" style="width:3rem;height:3rem"></div>
  <div class="mt-3 text-muted">Fetching data and running SEPA analysis…</div>
</div>

<!-- Error -->
<div id="errBox" class="alert alert-danger d-none"></div>

<!-- Yahoo Finance auth warning (shown when yfinance returns no info due to 401/crumb) -->
<div id="yf401Warning" class="alert d-none mb-3"
     style="background:#2e1a00;border-left:4px solid #e3b341;color:#e3b341">
  <i class="bi bi-exclamation-triangle-fill me-2"></i>
  <strong>Yahoo Finance 認証失效 (Invalid Crumb)</strong> —
  基本面數據可能不完整，分析結果可能不準確。
  <button class="btn btn-sm ms-3"
          style="background:#4a3800;color:#e3b341;border:1px solid #e3b341"
          onclick="resetYfSession()">
    <i class="bi bi-arrow-clockwise me-1"></i>重置連接 Reset Session
  </button>
</div>

<!-- Result -->
<div id="result" class="d-none">
  <div class="row g-3 mb-3" id="summaryCards"></div>

  <div class="row g-3">
    <!-- TT Checklist -->
    <div class="col-12 col-md-5">
      <div class="card h-100">
        <div class="card-header"><i class="bi bi-check2-all me-2"></i>Trend Template (TT1-TT10)</div>
        <div class="card-body p-0">
          <ul class="list-group list-group-flush" id="ttList"></ul>
        </div>
      </div>
    </div>

    <!-- SEPA Scores -->
    <div class="col-12 col-md-3">
      <div class="card h-100">
        <div class="card-header"><i class="bi bi-pie-chart me-2"></i>SEPA Pillar Scores</div>
        <div class="card-body" id="sepaScores"></div>
      </div>
    </div>

    <!-- VCP -->
    <div class="col-12 col-md-4">
      <div class="card h-100">
        <div class="card-header"><i class="bi bi-activity me-2"></i>VCP Analysis</div>
        <div class="card-body" id="vcpBox"></div>
      </div>
    </div>

    <!-- Fundamentals -->
    <div class="col-12 col-md-6">
      <div class="card">
        <div class="card-header"><i class="bi bi-bank me-2"></i>Fundamentals Checklist</div>
        <div class="card-body p-0">
          <ul class="list-group list-group-flush" id="fundList"></ul>
        </div>
      </div>
    </div>

    <!-- Position Sizing -->
    <div class="col-12 col-md-6">
      <div class="card">
        <div class="card-header"><i class="bi bi-calculator me-2"></i>Position Sizing</div>
        <div class="card-body" id="posBox"></div>
      </div>
    </div>

    <!-- Score History Chart -->
    <div class="col-12">
      <div class="card">
        <div class="card-header"><i class="bi bi-graph-up me-2"></i>Score History (Last 90 days)</div>
        <div class="card-body">
          <div id="historyLoading" class="text-center py-3">
            <div class="spinner-border spinner-border-sm text-info"></div>
            <div class="text-muted small mt-2">Loading chart…</div>
          </div>
          <div id="historyChartWrap" style="position:relative;height:300px;display:none"><canvas id="historyChart"></canvas></div>
          <div id="historyEmpty" style="display:none" class="text-center py-4 text-muted">
            <i class="bi bi-inbox fs-2 d-block mb-2"></i>
            這隻股票還沒有出現在之前的掃描中。
          </div>
        </div>
      </div>
    </div>

    <!-- K線技術分析圖 Technical Analysis Chart -->
    <div class="col-12">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
          <span><i class="bi bi-bar-chart-line me-2"></i>K 線技術分析圖 Technical Chart</span>
          <div class="d-flex align-items-center gap-3 flex-wrap">
            <!-- Legend -->
            <div class="d-flex gap-2 small flex-wrap" style="color:#8b949e">
              <span class="d-flex align-items-center gap-1">
                <span style="display:inline-block;width:14px;height:2px;background:#58a6ff"></span>SMA50
              </span>
              <span class="d-flex align-items-center gap-1">
                <span style="display:inline-block;width:14px;height:2px;background:#e3b341"></span>SMA150
              </span>
              <span class="d-flex align-items-center gap-1">
                <span style="display:inline-block;width:14px;height:2px;background:#f85149"></span>SMA200
              </span>
              <span class="d-flex align-items-center gap-1">
                <span style="display:inline-block;width:14px;height:1px;background:rgba(136,136,136,0.7);border-top:1px dashed #888"></span>BB
              </span>
              <span class="d-flex align-items-center gap-1" id="legendPivotWrap" style="display:none!important">
                <span style="display:inline-block;width:14px;height:2px;background:#64ffda"></span>
                <span style="color:#64ffda">Pivot</span>
              </span>
              <span class="d-flex align-items-center gap-1" id="legendEntryWrap" style="display:none!important">
                <span style="display:inline-block;width:14px;height:2px;background:#00d4ff"></span>
                <span style="color:#00d4ff">Entry</span>
              </span>
            </div>
            <!-- Time range buttons -->
            <div class="btn-group btn-group-sm" id="chartRangeBtns">
              <button class="btn btn-outline-secondary" data-days="90"  onclick="setChartRange(90,this)">3M</button>
              <button class="btn btn-outline-secondary" data-days="180" onclick="setChartRange(180,this)">6M</button>
              <button class="btn btn-outline-secondary active" data-days="365" onclick="setChartRange(365,this)">1Y</button>
              <button class="btn btn-outline-secondary" data-days="504" onclick="setChartRange(504,this)">2Y</button>
            </div>
          </div>
        </div>
        <div class="card-body p-0" style="width:100%;overflow:hidden">
          <div id="priceLoading" class="text-center py-3">
            <div class="spinner-border spinner-border-sm text-success"></div>
            <div class="text-muted small mt-2">載入 K 線資料… Loading chart data…</div>
          </div>
          <!-- LWC chart container -->
          <div id="priceChartWrap" style="display:none;width:100%;overflow:hidden">
            <!-- Main chart: Candlestick + SMA + BB + Volume -->
            <div id="lwcMainChart" style="height:370px;width:100%;overflow:hidden"></div>
            <!-- RSI sub-header -->
            <div style="background:#0d1117;padding:3px 14px;border-bottom:1px solid #21262d;display:flex;align-items:center;gap:14px">
              <span class="small" style="color:#8b949e">RSI (14)</span>
              <span class="small fw-bold" id="rsiCurrentVal" style="color:#c9d1d9">—</span>
              <span class="small" id="rsiOBOS" style="margin-left:4px"></span>
            </div>
            <!-- RSI sub-chart -->
            <div id="lwcRsiChart" style="height:90px;width:100%"></div>
          </div>
          <div id="priceEmpty" style="display:none" class="text-center py-4 text-muted">
            <i class="bi bi-inbox fs-2 d-block mb-2"></i>
            No price data available for this ticker.
          </div>
        </div>
      </div>
    </div>

    <!-- Recommendation -->
    <div class="col-12">
      <div class="card" id="recCard">
        <div class="card-header"><i class="bi bi-lightbulb me-2"></i>Recommendation</div>
        <div class="card-body" id="recBox"></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
async function analyze() {
  const ticker = document.getElementById('tickerInput').value.trim().toUpperCase();
  const acct   = parseFloat(document.getElementById('accountInput').value) || 100000;
  if (!ticker) { toast('Enter a ticker symbol', false); return; }

  document.getElementById('result').classList.add('d-none');
  document.getElementById('errBox').classList.add('d-none');
  document.getElementById('loading').classList.remove('d-none');

  const r = await fetch('/api/analyze', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ticker, account_size: acct})
  }).then(x=>x.json());

  pollJob(`/api/analyze/status/${r.job_id}`,
    data => renderResult(data, ticker),
    err  => {
      document.getElementById('loading').classList.add('d-none');
      document.getElementById('errBox').textContent = `Error: ${err}`;
      document.getElementById('errBox').classList.remove('d-none');
    }
  );
}

function renderResult(d, ticker) {
  document.getElementById('loading').classList.add('d-none');
  if (!d) { toast('No result returned', false); return; }

  const score  = d.sepa_score || 0;
  const rec    = d.recommendation || {};
  const tt     = d.trend_template || {};
  const vcp    = d.vcp || {};
  const pos    = d.position || {};
  const funds  = d.fundamentals || {};
  const scored = d.scored_pillars || {};
  const cls    = scoreClass(score);

  // Show/hide 401 auth warning
  const w401 = document.getElementById('yf401Warning');
  if (d.yf_auth_warning) {
    w401.classList.remove('d-none');
    toast('Yahoo Finance 認証失效 — 基本面數據可能不完整', false);
  } else {
    w401.classList.add('d-none');
  }

  // Summary cards
  document.getElementById('summaryCards').innerHTML = `
    <div class="col-6 col-md-3"><div class="metric-card">
      <div class="metric-val ${cls}">${Number(score).toFixed(1)}</div>
      <div class="metric-lbl">SEPA Score</div>
    </div></div>
    <div class="col-6 col-md-3"><div class="metric-card">
      <div class="metric-val">${fmtInt(d.rs_rank)}</div>
      <div class="metric-lbl">RS Rank</div>
    </div></div>
    <div class="col-6 col-md-3"><div class="metric-card">
      <div class="metric-val ${vcp.is_valid_vcp ? 'score-high' : 'score-low'}">${vcp.grade||'—'}</div>
      <div class="metric-lbl">VCP Grade</div>
    </div></div>
    <div class="col-6 col-md-3"><div class="metric-card">
      <div class="metric-val" style="color:${rec.action==='BUY'?'var(--success)':rec.action==='AVOID'?'var(--danger)':'var(--warning)'}">${rec.action||'—'}</div>
      <div class="metric-lbl">Action</div>
    </div></div>`;

  // TT Checklist
  const ttItems = [
    ['TT1', 'Price > SMA150', tt.tt1],
    ['TT2', 'Price > SMA200', tt.tt2],
    ['TT3', 'SMA150 > SMA200', tt.tt3],
    ['TT4', 'SMA200 Trend Rising (22d)', tt.tt4],
    ['TT5', 'SMA50 > SMA150 & SMA200', tt.tt5],
    ['TT6', 'Price > SMA50', tt.tt6],
    ['TT7', 'Price >25% above 52W Low', tt.tt7],
    ['TT8', 'Price within 25% of 52W High', tt.tt8],
    ['TT9', `RS Rank ≥ 70 (actual: ${fmtInt(d.rs_rank)})`, tt.tt9],
    ['TT10','Sector in top 35%', tt.tt10],
  ];
  document.getElementById('ttList').innerHTML = ttItems.map(([id, lbl, pass]) =>
    `<li class="list-group-item d-flex justify-content-between align-items-center py-2" style="background:transparent;border-color:#21262d">
      <span class="text-muted small">${id}: ${lbl}</span>
      ${pass ? '<i class="bi bi-check-circle-fill text-success"></i>' : '<i class="bi bi-x-circle text-danger"></i>'}
    </li>`
  ).join('');

  // SEPA pillar scores — only show the 5 pillars, not all scored_pillars keys
  const pillarDefs = [
    ['trend_score',       '趨勢 Trend'],
    ['fundamental_score', '基本面 Fundamentals'],
    ['catalyst_score',    '催化劑 Catalyst'],
    ['entry_score',       '入場時機 Entry'],
    ['rr_score',          '風險回報 Risk/Reward'],
  ];
  document.getElementById('sepaScores').innerHTML = pillarDefs.map(([k, lbl]) => {
    const pct = Math.round(scored[k] || 0);
    const bar = `<div class="progress mt-1 mb-2" style="height:6px">
      <div class="progress-bar ${pct>=70?'bg-success':pct>=50?'bg-warning':'bg-danger'}"
           style="width:${pct}%"></div></div>`;
    return `<div><div class="d-flex justify-content-between"><span class="small">${lbl}</span><span class="small fw-bold">${pct}</span></div>${bar}</div>`;
  }).join('') + `<div class="mt-2 pt-2" style="border-top:1px solid #21262d"><div class="d-flex justify-content-between"><span class="small fw-bold">總分 Total</span><span class="small fw-bold ${scoreClass(score)}">${Number(score).toFixed(1)}</span></div></div>`;

  // VCP box
  document.getElementById('vcpBox').innerHTML = `
    <div class="mb-2"><strong>Valid VCP:</strong> ${vcp.is_valid_vcp ? '<span class="text-success">YES ✓</span>' : '<span class="text-danger">NO</span>'}</div>
    <div><strong>Score:</strong> ${vcp.vcp_score||0}/100 &nbsp; <strong>Grade:</strong> ${vcp.grade||'—'}</div>
    <div class="mt-2 text-muted small">
      T-count: ${vcp.t_count||0} &nbsp;|&nbsp;
      Base: ${vcp.base_weeks||0}w &nbsp;|&nbsp;
      Depth: ${fmtPct(vcp.base_depth_pct)}
    </div>
    <div class="mt-1 text-muted small">
      ${vcp.pivot_price ? `Pivot: <strong style="color:#64ffda">$${Number(vcp.pivot_price).toFixed(2)}</strong>
        <i class="bi bi-question-circle ms-1" style="cursor:help;color:#8b949e"
          data-bs-toggle="tooltip" data-bs-placement="top"
          title="Pivot 突破點：VCP 形態的理想入場價位，即最後一次收縮結束後的阻力位頂部。當股價放量突破此水平時，即為 Minervini 標準進場信號。圖表中以青色虛線標示。"></i>` : ''}
    </div>
    <div class="mt-2 small">
      ATR contracting: ${vcp.atr_contracting ? '✓' : '✗'} &nbsp;
      BB contracting: ${vcp.bb_contracting ? '✓' : '✗'} &nbsp;
      Vol dry-up: ${vcp.vol_dry ? '✓' : '✗'}
    </div>
    ${(vcp.notes||[]).length ? `<div class="mt-2 text-muted small">${vcp.notes.map(n=>`• ${n}`).join('<br>')}</div>` : ''}`;

  // Fundamentals
  const fundChecks = funds.checks || [];
  const fundPasses = funds.passes ?? 0;
  const fundTotal  = funds.total ?? 0;
  const fundPct    = funds.pct ?? 0;
  const fundLabels = {
    'F1_EPS_QOQ_25':     'EPS 季增長 ≥ 25%',
    'F2_EPS_ACCEL':      'EPS 加速成長',
    'F3_ANNUAL_EPS_25':  '年度 EPS 成長 ≥ 25%',
    'F5_REVENUE_20':     '營收成長 ≥ 20%',
    'F7_PROFIT_MARGIN':  '淨利率 > 0%',
    'F8_ROE_17':         'ROE ≥ 17%',
    'F10_BEAT_ESTIMATES':'上季 EPS 超越預期',
    'F11_REVISIONS_UP':  '分析師上調預估',
    'F12_INST_INCREASING':'機構持股增加',
  };
  const fundSummary = `<li class="list-group-item d-flex justify-content-between align-items-center py-2" style="background:#0d1520;border-color:#21262d">
    <span class="small fw-bold">Fundamentals Score</span>
    <span class="badge ${fundPct>=70?'bg-success':fundPct>=40?'bg-warning':'bg-danger'}">${fundPasses} / ${fundTotal} (${fundPct}%)</span>
  </li>`;
  document.getElementById('fundList').innerHTML = fundChecks.length ?
    fundSummary + fundChecks.map(c => {
      const label = fundLabels[c.id] || c.id;
      return `<li class="list-group-item d-flex justify-content-between align-items-center py-2" style="background:transparent;border-color:#21262d">
        <div>
          <span class="text-muted small">${c.id?.replace(/_/g,' ')}</span><br/>
          <span class="small">${label}</span>
          <div class="text-muted" style="font-size:0.75rem">${c.note||''}</div>
        </div>
        ${c.pass ? '<i class="bi bi-check-circle-fill text-success"></i>' : '<i class="bi bi-x-circle text-danger"></i>'}
      </li>`;
    }).join('') :
    '<li class="list-group-item text-muted py-3" style="background:transparent">No fundamental data available.</li>';

  // Position sizing
  document.getElementById('posBox').innerHTML = pos ? `
    <div class="row g-2 text-center">
      <div class="col-6"><div class="metric-card p-2">
        <div class="fw-bold" style="font-size:20px">$${Number(pos.entry||0).toFixed(2)}</div>
        <div class="metric-lbl">Entry Price</div>
      </div></div>
      <div class="col-6"><div class="metric-card p-2">
        <div class="fw-bold text-danger" style="font-size:20px">$${Number(pos.stop||0).toFixed(2)}</div>
        <div class="metric-lbl">Stop Loss</div>
      </div></div>
      <div class="col-6"><div class="metric-card p-2">
        <div class="fw-bold text-success" style="font-size:20px">${fmtInt(pos.shares)}</div>
        <div class="metric-lbl">Shares</div>
      </div></div>
      <div class="col-6"><div class="metric-card p-2">
        <div class="fw-bold" style="font-size:20px">$${Number(pos.position_value||0).toLocaleString('en',{maximumFractionDigits:0})}</div>
        <div class="metric-lbl">Position Value</div>
      </div></div>
    </div>
    <div class="mt-3 text-muted small">
      Risk: $${Number(pos.risk_dollar||0).toFixed(0)} (${fmtPct(pos.risk_pct)}) &nbsp;|&nbsp;
      R:R ${Number(pos.rr||0).toFixed(1)}:1 &nbsp;|&nbsp;
      Target $${Number(pos.target||0).toFixed(2)}
    </div>
    <button class="btn btn-sm btn-outline-success mt-3 w-100"
      onclick="prefillPosition('${ticker}',${pos.entry||0},${pos.shares||0},${pos.stop||0},${pos.target||0})">
      <i class="bi bi-plus-circle me-1"></i>Add to Positions
    </button>` : '<p class="text-muted">Position data unavailable.</p>';

  // Recommendation
  const colours = {BUY:'success', WATCH:'info', MONITOR:'warning', AVOID:'danger'};
  const c = colours[rec.action] || 'secondary';
  document.getElementById('recBox').innerHTML = `
    <div class="alert alert-${c} mb-2">${rec.action||'N/A'}: ${rec.description||''}</div>
    ${(rec.reasons||[]).map(r=>`<div class="text-muted small">• ${r}</div>`).join('')}
    <div class="d-flex gap-2 mt-3">
      <button class="btn btn-sm btn-primary" onclick="addToWatchlist('${ticker}')">
        <i class="bi bi-bookmark-plus me-1"></i>Add to Watchlist
      </button>
      ${rec.action === 'BUY' ? `
        <button class="btn btn-sm btn-success" onclick="prefillPosition('${ticker}',${pos?.entry||0},${pos?.shares||0},${pos?.stop||0},${pos?.target||0})">
          <i class="bi bi-plus-circle me-1"></i>Create Position
        </button>
      ` : ''}
    </div>`;

  document.getElementById('result').classList.remove('d-none');

  // Re-init tooltips for dynamically rendered elements (e.g. Pivot tooltip in vcpBox)
  document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => {
    const existing = bootstrap.Tooltip.getInstance(el);
    if (!existing) new bootstrap.Tooltip(el);
  });

  // Load and render score history chart asynchronously
  loadScoreHistory(ticker);
  // Pass VCP pivot + position lines into chart
  loadPriceHistory(ticker, {
    pivot:  vcp.pivot_price  ? Number(vcp.pivot_price)  : null,
    entry:  pos.entry        ? Number(pos.entry)        : null,
    stop:   pos.stop         ? Number(pos.stop)         : null,
    target: pos.target       ? Number(pos.target)       : null,
  });
}

async function loadScoreHistory(ticker) {
  try {
    document.getElementById('historyLoading').style.display = 'block';
    document.getElementById('historyChartWrap').style.display = 'none';
    document.getElementById('historyEmpty').style.display = 'none';

    const scanTrend = await fetch(`/api/db/scan-trend/${ticker}?days=90`).then(x => x.json());
    const rsTrend = await fetch(`/api/db/rs-trend/${ticker}?days=90`).then(x => x.json());

    const scanRows = scanTrend.rows || [];
    const rsRows = rsTrend.rows || [];

    if (!scanRows.length) {
      document.getElementById('historyLoading').style.display = 'none';
      document.getElementById('historyEmpty').style.display = 'block';
      return;
    }

    // Build chart data
    const dates = scanRows.map(r => r.scan_date);
    const scores = scanRows.map(r => r.sepa_score || 0);
    const rsRanks = rsRows.length ? rsRows.map(r => r.rs_rank || 0) : Array(scanRows.length).fill(null);

    // Create dual-axis chart
    const ctx = document.getElementById('historyChart');
    if (ctx.chart) ctx.chart.destroy();

    ctx.chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: dates,
        datasets: [
          {
            label: 'SEPA Score',
            data: scores,
            borderColor: '#00d4ff',
            backgroundColor: 'rgba(0, 212, 255, 0.1)',
            yAxisID: 'y',
            tension: 0.3,
            borderWidth: 2,
            pointRadius: 4,
            pointHoverRadius: 6,
            pointBackgroundColor: '#00d4ff'
          },
          {
            label: 'RS Rank %ile',
            data: rsRanks,
            borderColor: '#58a6ff',
            backgroundColor: 'rgba(88, 166, 255, 0.1)',
            yAxisID: 'y1',
            tension: 0.3,
            borderWidth: 2,
            pointRadius: 4,
            pointHoverRadius: 6,
            pointBackgroundColor: '#58a6ff'
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {mode: 'index', intersect: false},
        plugins: {
          legend: {
            labels: {color: '#c9d1d9', usePointStyle: true}
          }
        },
        scales: {
          x: {
            grid: {color: '#30363d'},
            ticks: {color: '#8b949e', maxTicksLimit: 8}
          },
          y: {
            type: 'linear',
            position: 'left',
            grid: {color: '#30363d'},
            ticks: {color: '#8b949e'},
            min: 0,
            max: 100,
            title: {display: true, text: 'SEPA Score', color: '#00d4ff'}
          },
          y1: {
            type: 'linear',
            position: 'right',
            grid: {drawOnChartArea: false},
            ticks: {color: '#8b949e'},
            min: 0,
            max: 100,
            title: {display: true, text: 'RS Rank %ile', color: '#58a6ff'}
          }
        }
      }
    });

    document.getElementById('historyLoading').style.display = 'none';
    document.getElementById('historyChartWrap').style.display = 'block';
  } catch (e) {
    console.error('Error loading score history:', e);
    document.getElementById('historyLoading').style.display = 'none';
    document.getElementById('historyEmpty').style.display = 'block';
  }
}

function prefillPosition(ticker, entry, shares, stop, target) {
  const params = new URLSearchParams({ticker, entry, shares, stop, target});
  window.location.href = `/positions?prefill=${encodeURIComponent(JSON.stringify({ticker,entry,shares,stop,target}))}`;
}

// ── LWC Chart state ───────────────────────────────────────────────────────────
let _lwcMain = null;   // main chart instance
let _lwcRsi  = null;   // RSI sub-chart instance
let _lwcData = null;   // cached enriched data

function _lwcDestroy() {
  if (_lwcMain) { try { _lwcMain.remove(); } catch(e) {} _lwcMain = null; }
  if (_lwcRsi)  { try { _lwcRsi.remove();  } catch(e) {} _lwcRsi  = null; }
  _lwcData = null;
}

function setChartRange(days, btn) {
  document.querySelectorAll('#chartRangeBtns button').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  if (!_lwcMain || !_lwcData || !_lwcData.candles.length) return;
  const last = _lwcData.candles[_lwcData.candles.length - 1].time;
  const from = last - days * 86400;
  _lwcMain.timeScale().setVisibleRange({ from, to: last });
  if (_lwcRsi) _lwcRsi.timeScale().setVisibleRange({ from, to: last });
}

async function loadPriceHistory(ticker, priceLines = {}) {
  const loadEl  = document.getElementById('priceLoading');
  const wrapEl  = document.getElementById('priceChartWrap');
  const emptyEl = document.getElementById('priceEmpty');
  loadEl.style.display = 'block';
  wrapEl.style.display = 'none';
  emptyEl.style.display = 'none';
  _lwcDestroy();
  try {
    const res = await fetch(`/api/chart/enriched/${ticker}?days=504`).then(x => x.json());
    if (!res.ok || !res.candles || !res.candles.length) {
      loadEl.style.display = 'none';
      emptyEl.style.display = 'block';
      return;
    }
    _lwcData = res;
    const LWC     = LightweightCharts;
    const mainDiv = document.getElementById('lwcMainChart');
    const rsiDiv  = document.getElementById('lwcRsiChart');
    const wrapDiv = document.getElementById('priceChartWrap');

    const baseOpts = {
      layout:    { background: { color: '#0d1117' }, textColor: '#8b949e' },
      grid:      { vertLines: { color: '#21262d' }, horzLines: { color: '#21262d' } },
      crosshair: { mode: LWC.CrosshairMode.Normal },
      rightPriceScale: { borderColor: '#30363d' },
      timeScale: { borderColor: '#30363d', timeVisible: true, secondsVisible: false },
      handleScroll: true, handleScale: true,
    };

    // ── Main chart ─────────────────────────────────────────────────────────
    // Use wrapper container width to ensure full expansion
    const containerWidth = wrapDiv.parentElement.clientWidth || window.innerWidth - 40;
    _lwcMain = LWC.createChart(mainDiv, { ...baseOpts, height: 370, width: containerWidth });

    // Candlestick series (OHLC K線)
    const candleSeries = _lwcMain.addCandlestickSeries({
      upColor:         '#3fb950', downColor:         '#f85149',
      borderUpColor:   '#3fb950', borderDownColor:   '#f85149',
      wickUpColor:     '#3fb950', wickDownColor:     '#f85149',
    });
    candleSeries.setData(res.candles);

    // Volume histogram — lower 18% of main chart
    const volSeries = _lwcMain.addHistogramSeries({
      priceFormat: { type: 'volume' }, priceScaleId: 'vol',
    });
    _lwcMain.priceScale('vol').applyOptions({
      scaleMargins: { top: 0.82, bottom: 0 },
      drawTicks: false, borderVisible: false,
    });
    volSeries.setData(res.volume);

    // SMA overlays: 50 (blue) / 150 (amber) / 200 (red)
    [
      { key: 'sma50',  color: '#58a6ff', title: 'SMA50'  },
      { key: 'sma150', color: '#e3b341', title: 'SMA150' },
      { key: 'sma200', color: '#f85149', title: 'SMA200' },
    ].forEach(({ key, color, title }) => {
      if (res[key] && res[key].length) {
        _lwcMain.addLineSeries({
          color, lineWidth: 1.5, title,
          priceLineVisible: false, lastValueVisible: false,
        }).setData(res[key]);
      }
    });

    // Bollinger Bands: upper & lower dashed, midline dotted
    if (res.bbu && res.bbu.length) {
      _lwcMain.addLineSeries({ color: 'rgba(136,136,136,0.5)', lineWidth: 1, lineStyle: 2,
        priceLineVisible: false, lastValueVisible: false }).setData(res.bbu);
    }
    if (res.bbl && res.bbl.length) {
      _lwcMain.addLineSeries({ color: 'rgba(136,136,136,0.5)', lineWidth: 1, lineStyle: 2,
        priceLineVisible: false, lastValueVisible: false }).setData(res.bbl);
    }
    if (res.bbm && res.bbm.length) {
      _lwcMain.addLineSeries({ color: 'rgba(136,136,136,0.25)', lineWidth: 1, lineStyle: 1,
        priceLineVisible: false, lastValueVisible: false }).setData(res.bbm);
    }

    // ── RSI sub-chart ──────────────────────────────────────────────────────
    _lwcRsi = LWC.createChart(rsiDiv, {
      ...baseOpts,
      height: 90, width: containerWidth,
      timeScale:  { ...baseOpts.timeScale, visible: false },
      rightPriceScale: { borderColor: '#30363d', scaleMargins: { top: 0.1, bottom: 0.1 } },
    });

    const rsiSeries = _lwcRsi.addLineSeries({
      color: '#c9d1d9', lineWidth: 1.5,
      priceLineVisible: false, lastValueVisible: true,
    });
    if (res.rsi && res.rsi.length) rsiSeries.setData(res.rsi);

    // RSI reference lines: 70 / 50 / 30
    rsiSeries.createPriceLine({ price: 70, color: '#f85149', lineWidth: 1, lineStyle: 2, axisLabelVisible: true,  title: '70' });
    rsiSeries.createPriceLine({ price: 50, color: '#333333', lineWidth: 1, lineStyle: 0, axisLabelVisible: false });
    rsiSeries.createPriceLine({ price: 30, color: '#3fb950', lineWidth: 1, lineStyle: 2, axisLabelVisible: true,  title: '30' });

    // RSI value readout on crosshair
    _lwcMain.subscribeCrosshairMove(param => {
      const el   = document.getElementById('rsiCurrentVal');
      const obEl = document.getElementById('rsiOBOS');
      if (!el || !res.rsi || !res.rsi.length) return;
      let rsiVal = null;
      if (param && param.time) {
        const pt = res.rsi.find(r => r.time === param.time);
        if (pt) rsiVal = pt.value;
      }
      if (rsiVal === null) rsiVal = res.rsi[res.rsi.length - 1].value;
      const color = rsiVal >= 70 ? '#f85149' : rsiVal <= 30 ? '#3fb950' : '#c9d1d9';
      el.textContent  = rsiVal.toFixed(1);
      el.style.color  = color;
      if (obEl) {
        obEl.textContent = rsiVal >= 70 ? '超買 Overbought' : rsiVal <= 30 ? '超賣 Oversold' : '';
        obEl.style.color = color;
      }
    });

    // Sync time range: main ↔ RSI (with re-entrance guard)
    let _syncing = false;
    _lwcMain.timeScale().subscribeVisibleLogicalRangeChange(range => {
      if (_syncing || !_lwcRsi || !range) return;
      _syncing = true; _lwcRsi.timeScale().setVisibleLogicalRange(range); _syncing = false;
    });
    _lwcRsi.timeScale().subscribeVisibleLogicalRangeChange(range => {
      if (_syncing || !_lwcMain || !range) return;
      _syncing = true; _lwcMain.timeScale().setVisibleLogicalRange(range); _syncing = false;
    });

    // Responsive resize observer — observe parent card body for width changes
    new ResizeObserver(() => {
      const newWidth = wrapDiv.parentElement.clientWidth || window.innerWidth - 40;
      if (_lwcMain) _lwcMain.applyOptions({ width: newWidth });
      if (_lwcRsi)  _lwcRsi.applyOptions({ width: newWidth });
    }).observe(wrapDiv.parentElement);

    // ── Price lines: Pivot / Entry / Stop / Target ────────────────────────
    const pl = priceLines;
    if (pl.pivot)  {
      candleSeries.createPriceLine({ price: pl.pivot,  color: '#64ffda', lineWidth: 2, lineStyle: 2, axisLabelVisible: true,  title: `Pivot $${pl.pivot.toFixed(2)}` });
      const w = document.getElementById('legendPivotWrap');
      if (w) w.style.setProperty('display', 'flex', 'important');
    }
    if (pl.entry)  {
      candleSeries.createPriceLine({ price: pl.entry,  color: '#00d4ff', lineWidth: 1, lineStyle: 2, axisLabelVisible: true,  title: `Entry $${pl.entry.toFixed(2)}` });
      const w = document.getElementById('legendEntryWrap');
      if (w) w.style.setProperty('display', 'flex', 'important');
    }
    if (pl.stop)   candleSeries.createPriceLine({ price: pl.stop,   color: '#f85149', lineWidth: 1, lineStyle: 2, axisLabelVisible: true,  title: `Stop $${pl.stop.toFixed(2)}` });
    if (pl.target) candleSeries.createPriceLine({ price: pl.target, color: '#3fb950', lineWidth: 1, lineStyle: 2, axisLabelVisible: true,  title: `Target $${pl.target.toFixed(2)}` });

    // Default view: 1Y
    setChartRange(365, document.querySelector('#chartRangeBtns button[data-days="365"]'));

    loadEl.style.display = 'none';
    wrapEl.style.display = 'block';
    toastCompletion(`✅ ${ticker} 分析完成`, true);
  } catch(e) {
    console.error('loadPriceHistory error:', e);
    loadEl.style.display = 'none';
    emptyEl.style.display = 'block';
  }
}

async function addToWatchlist(ticker) {
  const r = await fetch('/api/watchlist/add', {
    method: 'POST', headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ticker})
  }).then(x => x.json());
  
  if (r.job_id) {
    pollJob(`/api/watchlist/add/status/${r.job_id}`,
      ()  => toast(`✅ ${ticker} added to watchlist`, true),
      err => toast(`Error: ${err}`, false)
    );
  } else {
    toast(`Error: ${r.error || 'Failed to add to watchlist'}`, false);
  }
}

async function resetYfSession() {
  const btn = event.target.closest('button');
  if (btn) { btn.disabled = true; btn.textContent = '重置中…'; }
  try {
    const r = await fetch('/api/admin/reset-yf-session', {method:'POST'}).then(x=>x.json());
    if (r.ok) {
      toast('✅ Session 已重置，請重新查詢', true);
      document.getElementById('yf401Warning').classList.add('d-none');
    } else {
      toast('⚠️ 重置失敗: ' + (r.error || r.message), false);
    }
  } catch(e) {
    toast('⚠️ 重置失敗: ' + e, false);
  } finally {
    if (btn) { btn.disabled = false; btn.innerHTML = '<i class="bi bi-arrow-clockwise me-1"></i>重置連接 Reset Session'; }
  }
}

// Auto-run if prefill ticker provided
window.addEventListener('DOMContentLoaded', () => {
  // Initialize Bootstrap tooltips (for Pivot and other tooltip icons)
  new bootstrap.Tooltip(document.body, {selector: '[data-bs-toggle="tooltip"]'});
  const t = document.getElementById('tickerInput').value;
  if (t) analyze();
});
</script>
{% endblock %}
