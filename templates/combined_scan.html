{% extends "base.html" %}
{% block title %}Combined SEPA + QM Scan{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
<style>
  /* â”€â”€ Star colours â”€â”€ */
  .star-5p  { color: #3fb950; font-weight: 700; }
  .star-5   { color: #3fb950; }
  .star-4   { color: #e3b341; }
  .star-3   { color: #8b949e; }
  .star-low { color: #f85149; }
  /* â”€â”€ Setup badge colours â”€â”€ */
  .badge-htf  { background: #1b6e2e; color: #3fb950; }
  .badge-ep   { background: #4a3800; color: #e3b341; }
  .badge-lad  { background: #1a3060; color: #58a6ff; }
  .badge-surf { background: #003040; color: #00d4ff; }
  .badge-rpl  { background: #3a0060; color: #d49fff; }
  .badge-flag { background: #301020; color: #ff8fa3; }
  .badge-uk   { background: #1c2128; color: #8b949e; }
  .veto-badge { background: #3a0a0a; color: #f85149; font-size: 10px; border-radius: 3px; padding: 1px 5px; }
  /* â”€â”€ SEPA score colours â”€â”€ */
  .score-high { color: #3fb950; font-weight: 700; }
  .score-mid  { color: #e3b341; font-weight: 600; }
  .score-low  { color: #f85149; }
  .row-below-threshold { opacity: 0.5; }
  .row-below-threshold:hover { opacity: 0.75; }
  .tag-vcp { background: #004d40; color: #64ffda; border-radius: 4px; padding: 2px 7px; font-size: 11px; white-space: nowrap; text-decoration: none; display: inline-block; }
  /* â”€â”€ Layout â”€â”€ */
  .combined-tabs .nav-link { color: #8b949e; border-color: transparent; }
  .combined-tabs .nav-link.active { color: var(--accent); border-color: #30363d #30363d #161b22; background: #161b22; }
  .filter-bar { background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 16px; }
  .filter-panel { background: #161b22; border: 1px solid #30363d; border-radius: 6px; padding: 12px; margin-top: 12px; }
  .qm-row:hover { background: #1a2030 !important; cursor: pointer; }
  .sepa-row:hover { background: #1a2030 !important; }
  .timing-pill { background: #1c2128; border: 1px solid #30363d; border-radius: 6px; padding: 6px 14px; display: inline-block; font-size: 12px; }
  .regime-bull  { background: #1b3a2e; color: #3fb950; }
  .regime-trans { background: #3a3000; color: #e3b341; }
  .regime-bear  { background: #3a1010; color: #f85149; }
  .metric-card { background: #0d1117; border: 1px solid #30363d; border-radius: 6px; padding: 12px; text-align: center; }
  .metric-val  { font-weight: 700; color: var(--accent); }
  .metric-lbl  { font-size: 11px; color: #8b949e; margin-top: 4px; }
  .info-panel  { background: #0d1b2a; border: 1px solid #1c2f42; border-radius: 6px; padding: 12px; }
  .cache-info-panel { background: #0d1117; border: 1px solid #30363d; border-radius: 8px; padding: 12px 16px; margin-bottom: 16px; }
  /* â”€â”€ Step indicators â”€â”€ */
  .step-dot { display: inline-flex; align-items: center; justify-content: center; width: 24px; height: 24px; border-radius: 50%; background: #21262d; border: 2px solid #30363d; color: #8b949e; font-size: 11px; font-weight: 700; transition: all .3s; }
  .step-dot.active { background: var(--accent); border-color: var(--accent); color: #000; }
  .step-dot.done   { background: #1b6e2e; border-color: #3fb950; color: #3fb950; }
  .step-label { font-size: 10px; color: #8b949e; text-align: center; white-space: nowrap; }
  .step-connector { flex: 1; height: 2px; background: #30363d; margin: 0 4px; align-self: center; }
  .step-connector.done { background: #3fb950; }
  /* â”€â”€ Live log â”€â”€ */
  #liveLogWrap { background: #0d1117; border: 1px solid #30363d; border-radius: 6px; padding: 8px; max-height: 120px; overflow-y: auto; font-family: monospace; font-size: 11px; }
  #liveLog .log-line      { color: #8b949e; }
  #liveLog .log-line.info { color: #58a6ff; }
  #liveLog .log-line.ok   { color: #3fb950; }
  #liveLog .log-line.warn { color: #e3b341; }
  #liveLog .log-line.err  { color: #f85149; }
  /* â”€â”€ æœªé€šé badge â”€â”€ */
  .not-passed-badge { font-size: 10px; background: #3a1010; color: #f85149; border-radius: 3px; padding: 1px 5px; margin-left: 4px; }
</style>
{% endblock %}

{% block content %}

<!-- â”€â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="d-flex justify-content-between align-items-center mb-3">
  <h4 class="mb-0">
    <i class="bi bi-lightning-fill me-2" style="color:var(--accent)"></i>
    Combined Scan â€” SEPA <span style="color:#8b949e">+</span> QM
    <small class="text-secondary ms-2" style="font-size:13px">å®Œæ•´åŠŸèƒ½æƒæ Full Parity</small>
  </h4>
  <div class="d-flex align-items-center gap-2">
    <span id="tradingDateBadge" class="badge bg-dark border border-secondary small"></span>
    <span id="clockHK"  class="badge bg-dark border border-secondary small"></span>
    <span id="clockUS"  class="badge bg-dark border border-secondary small"></span>
  </div>
</div>

<!-- â”€â”€â”€ Speed & Cache Status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="cache-info-panel" id="cacheInfoPanel">
  <div class="d-flex justify-content-between align-items-start mb-2">
    <span class="fw-bold small">
      <i class="bi bi-speedometer2 me-1" style="color:var(--accent)"></i>
      å¿«å– &amp; é€Ÿåº¦é ä¼° Cache Speed
    </span>
    <button class="btn btn-sm btn-outline-secondary py-0 px-2" onclick="loadCacheInfo()" title="é‡æ–°æ•´ç† Refresh">
      <i class="bi bi-arrow-clockwise"></i>
    </button>
  </div>
  <div class="row g-2 small">
    <div class="col-md-3">
      <span class="text-secondary"
        data-bs-toggle="tooltip" data-bs-html="true"
        title="&lt;b&gt;RS ç›¸å°å¼·åº¦æ’åå¿«å–&lt;/b&gt;&lt;br&gt;IBD é¢¨æ ¼çš„ç›¸å°å¼·åº¦ï¼ˆRSï¼‰ç™¾åˆ†ä½æ’åï¼Œæ¯”è¼ƒå€‹è‚¡3å€‹æœˆ/6å€‹æœˆ/12å€‹æœˆæ¼²å¹…èˆ‡å…¨å¸‚å ´æ‰€æœ‰è‚¡ç¥¨ã€‚&lt;br&gt;âœ“ cached = ä»Šæ—¥æ’åå·²å»ºç«‹ï¼ŒStage 2 å¯ç›´æ¥ä½¿ç”¨&lt;br&gt;âœ— needs rebuild = é¦–æ¬¡ä½¿ç”¨æˆ–è¶…éä¸€å¤©ï¼Œéœ€é‡å»ºï¼ˆç´„ 5 åˆ†é˜ï¼‰&lt;br&gt;æ‹¬è™Ÿå…§æ•¸å­— = åŠ å…¥æ’åçš„è‚¡ç¥¨æ•¸ç›®ã€‚"
      >RS Rankings <i class="bi bi-info-circle" style="font-size:10px"></i>:</span>
      <span id="cacheRS" class="ms-1 badge bg-secondary">checkingâ€¦</span>
    </div>
    <div class="col-md-3">
      <span class="text-secondary"
        data-bs-toggle="tooltip" data-bs-html="true"
        title="&lt;b&gt;è‚¡åƒ¹æ­·å²å¿«å–&lt;/b&gt;&lt;br&gt;å·²å¿«å–ä»Šæ—¥ OHLCVï¼ˆé–‹é«˜ä½æ”¶é‡ï¼‰çš„è‚¡ç¥¨æ•¸é‡ã€‚&lt;br&gt;ç³»çµ±ä½¿ç”¨ yfinance æ‰¹é‡ä¸‹è¼‰ï¼Œä¸¦ä»¥ Parquet æ ¼å¼å„²å­˜æ–¼ data/price_cache/ã€‚&lt;br&gt;åŒæ—¥å†æ¬¡æƒææ™‚ï¼Œç›´æ¥è®€å–å¿«å–ï¼ˆæ¯«ç§’ç´šï¼‰ï¼Œå¤§å¹…ç¸®çŸ­æƒææ™‚é–“ã€‚&lt;br&gt;æ•¸å­—è¶Šé«˜ï¼ŒStage 2 é€Ÿåº¦è¶Šå¿«ã€‚&lt;br&gt;æ¯å€‹å¿«å–æª”æ¡ˆä»¥è‚¡ç¥¨ä»£è™Ÿ+æ™‚é–“æ®µå‘½åï¼Œæœ‰æ•ˆæœŸä¸€å€‹äº¤æ˜“æ—¥ã€‚"
      >Price Cache <i class="bi bi-info-circle" style="font-size:10px"></i>:</span>
      <span id="cachePrice" class="ms-1 badge bg-secondary">checkingâ€¦</span>
    </div>
    <div class="col-md-3">
      <span class="text-secondary"
        data-bs-toggle="tooltip" data-bs-html="true"
        title="&lt;b&gt;åŸºæœ¬é¢è³‡æ–™å¿«å–&lt;/b&gt;&lt;br&gt;å·²å¿«å–ä»Šæ—¥åŸºæœ¬é¢æ•¸æ“šçš„è‚¡ç¥¨æ•¸é‡ï¼ˆEPS å¢é•·ã€ROEã€ç‡Ÿæ”¶ã€æœ¬ç›Šæ¯”ç­‰ï¼‰ã€‚&lt;br&gt;SEPA æƒæéœ€è¦åŸºæœ¬é¢è³‡æ–™ï¼ˆè²¡å ±æ•¸æ“šï¼‰ç”¨æ–¼ç¬¬ä¸‰éšæ®µè©•åˆ†ï¼ŒQM æƒæä¸ä½¿ç”¨åŸºæœ¬é¢ã€‚&lt;br&gt;è³‡æ–™ä¾†æºï¼šyfinanceï¼ˆå…è²»ï¼‰ã€‚&lt;br&gt;å¿«å–å¾ŒåŒæ—¥ä¸å†é‡è¤‡è«‹æ±‚ï¼Œç¯€çœ API é…é¡ã€‚"
      >Fundamentals <i class="bi bi-info-circle" style="font-size:10px"></i>:</span>
      <span id="cacheFundamentals" class="ms-1 badge bg-secondary">checkingâ€¦</span>
    </div>
    <div class="col-md-3">
      <span class="text-secondary"
        data-bs-toggle="tooltip" data-bs-html="true"
        title="&lt;b&gt;é ä¼°æƒææ™‚é–“&lt;/b&gt;&lt;br&gt;æ ¹æ“šç•¶å‰å¿«å–ç‹€æ…‹é ä¼°æœ¬æ¬¡æƒææ‰€éœ€æ™‚é–“ï¼š&lt;br&gt;â€¢ ~2-5 åˆ†é˜ï¼šRS æ’å + è‚¡åƒ¹è³‡æ–™å‡å·²å¿«å–ï¼ˆæœ€ä½³æƒ…æ³ï¼‰&lt;br&gt;â€¢ ~5-12 åˆ†é˜ï¼šRS å·²å¿«å–ä½†è‚¡åƒ¹éœ€é‡æ–°ä¸‹è¼‰&lt;br&gt;â€¢ ~10-20 åˆ†é˜ï¼šé¦–æ¬¡æƒæï¼Œæ‰€æœ‰è³‡æ–™å‡éœ€ä¸‹è¼‰&lt;br&gt;ä½¿ç”¨ NASDAQ FTPï¼ˆæ¨è–¦ï¼‰æ¯” Finviz å¿«ç´„ 3-5 å€ã€‚"
      >Est. Time <i class="bi bi-info-circle" style="font-size:10px"></i>:</span>
      <span id="cacheEstimate" class="ms-1 badge bg-secondary">checkingâ€¦</span>
    </div>
  </div>
  <div id="cacheHints" class="mt-2 small text-muted"></div>
</div>

<!-- â”€â”€â”€ API Rate Limits (collapsible) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="mb-3">
  <button class="btn btn-sm btn-link text-secondary p-0 text-decoration-none"
    onclick="toggleRateLimitInfo()" style="font-size:12px">
    <i class="bi bi-chevron-right me-1" id="rateLimitToggle"></i>
    API Rate Limits &amp; Best Practices
  </button>
  <div id="rateLimitInfo" class="d-none mt-2 info-panel small">
    <div class="row g-2">
      <div class="col-md-4">
        <strong class="text-warning">yfinance (Yahoo Finance)</strong>
        <ul class="list-unstyled mt-1 mb-0 text-secondary">
          <li>â€¢ ç„¡å®˜æ–¹é™åˆ¶ï¼Œéå®˜æ–¹ ~2000 calls/hour</li>
          <li>â€¢ æ‰¹é‡ä¸‹è¼‰ (multi-ticker) æ•ˆç‡æœ€é«˜</li>
          <li>â€¢ å»ºè­°æ¯ 50 æª”å»¶é² 0.5s</li>
        </ul>
      </div>
      <div class="col-md-4">
        <strong class="text-warning">Stage 1 ä¾†æºé¸æ“‡</strong>
        <ul class="list-unstyled mt-1 mb-0 text-secondary">
          <li>â€¢ <span class="text-success fw-bold">NASDAQ FTP</span>ï¼ˆæ¨è–¦ï¼‰ï¼šå…è²»ã€ç©©å®šã€å¿«é€Ÿ</li>
          <li>â€¢ <span class="text-warning">Finviz</span>ï¼šå‚™ç”¨æ–¹æ¡ˆï¼Œæœ‰çˆ¬èŸ²é™åˆ¶ ~100æ¬¡/å¤©</li>
          <li>â€¢ å…©ç¨®ä¾†æºå¯åœ¨æ§åˆ¶åˆ—ä¸­åˆ‡æ›</li>
          <li>â€¢ FTP æ¨¡å¼è‡ªå‹•éæ¿¾ OTC/ç²‰å–®è‚¡</li>
        </ul>
      </div>
      <div class="col-md-4">
        <strong class="text-success">æœ€ä½³å¯¦è¸ Best Practices</strong>
        <ul class="list-unstyled mt-1 mb-0 text-secondary">
          <li>â€¢ æ¯æ—¥é¦–æ¬¡æƒæè¼ƒæ…¢ï¼ˆå»ºç«‹å¿«å–ï¼‰</li>
          <li>â€¢ åŒæ—¥ç¬¬äºŒæ¬¡æƒæ 2-5 åˆ†é˜</li>
          <li>â€¢ ä½¿ç”¨ NASDAQ FTPï¼ˆæœ€å¿«ã€æœ€ç©©ï¼‰</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ Controls bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="filter-bar">
  <div class="row g-3 align-items-end">
    <!-- Stage 1 Source -->
    <div class="col-auto">
      <label class="form-label text-secondary mb-1" style="font-size:12px">Stage 1 ä¾†æº</label>
      <select class="form-select form-select-sm" id="combinedSource"
        style="width:185px;background:#0d1117;color:#c9d1d9;border-color:#30363d"
        onchange="onSourceChange(this.value)">
        <option value="nasdaq_ftp" selected>NASDAQ FTP (æ¨è–¦)</option>
        <option value="finviz">Finviz (æ…¢)</option>
      </select>
    </div>

    <!-- QM Filters (shown on QM tab only) -->
    <div class="col-auto d-none" id="qmFilterContainer">
      <label class="form-label text-secondary mb-1" style="font-size:12px">æœ€ä½æ˜Ÿç´š Min Stars</label>
      <select class="form-select form-select-sm" id="minStar"
        style="width:130px;background:#0d1117;color:#c9d1d9;border-color:#30363d"
        onchange="filterQmTable()">
        <option value="3">â˜…â˜…â˜… 3+</option>
        <option value="3.5">â˜…â˜…â˜…Â½ 3.5+</option>
        <option value="4" selected>â˜…â˜…â˜…â˜… 4+</option>
        <option value="4.5">â˜…â˜…â˜…â˜…Â½ 4.5+</option>
        <option value="5">â˜…â˜…â˜…â˜…â˜… 5+</option>
      </select>
    </div>
    <div class="col-auto d-none" id="qmFilterContainer2">
      <label class="form-label text-secondary mb-1" style="font-size:12px">Top N</label>
      <select class="form-select form-select-sm" id="topN"
        style="width:90px;background:#0d1117;color:#c9d1d9;border-color:#30363d"
        onchange="filterQmTable()">
        <option value="25">25</option>
        <option value="50" selected>50</option>
        <option value="100">100</option>
        <option value="9999">å…¨éƒ¨</option>
      </select>
    </div>

    <!-- Refresh RS checkbox -->
    <div class="col-auto">
      <div class="form-check mt-3">
        <input class="form-check-input" type="checkbox" id="chkRefreshRS">
        <label class="form-check-label text-muted small" for="chkRefreshRS">Refresh RS</label>
      </div>
    </div>

    <!-- Buttons -->
    <div class="col-auto">
      <button class="btn btn-accent px-4" id="btnRun" onclick="startScan()">
        <i class="bi bi-play-fill me-1"></i>Scan
      </button>
      <button class="btn btn-outline-danger btn-sm ms-2 d-none" id="btnStop" onclick="stopScan()">
        <i class="bi bi-stop-fill me-1"></i>å–æ¶ˆ
      </button>
      <button class="btn btn-outline-secondary btn-sm ms-2 d-none" id="btnLoadLast" onclick="loadLastResults()">
        <i class="bi bi-clock-history me-1"></i>ä¸Šæ¬¡çµæœ
      </button>
    </div>

    <div class="col ms-auto text-end">
      <span id="combinedStatus" class="text-muted small">Ready</span>
    </div>
  </div>

  <!-- Source notes -->
  <div id="srcNote_nasdaq_ftp" class="mt-2 small text-muted">
    <i class="bi bi-check-circle me-1" style="color:#3fb950"></i>
    NASDAQ/NYSE/AMEX ä¸Šå¸‚è‚¡ç¥¨ï¼Œç´„ 2-4 åˆ†é˜
  </div>
  <div id="srcNote_finviz" class="d-none mt-2 small text-muted">
    <i class="bi bi-exclamation-triangle me-1" style="color:#e3b341"></i>
    è¼ƒæ…¢ï¼ˆç´„ 10-15 åˆ†é˜ï¼‰ï¼ŒOTC è‡ªå‹•éæ¿¾
  </div>
</div>

<!-- â”€â”€â”€ Progress panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="progressArea" class="d-none mt-3">
  <!-- Step indicators -->
  <div class="d-flex align-items-start mb-3">
    <div class="d-flex flex-column align-items-center">
      <div class="step-dot" id="step1">1</div>
      <div class="step-label mt-1">Stage 1</div>
    </div>
    <div class="step-connector" id="conn1"></div>
    <div class="d-flex flex-column align-items-center">
      <div class="step-dot" id="step2">2</div>
      <div class="step-label mt-1">ä¸‹è¼‰</div>
    </div>
    <div class="step-connector" id="conn2"></div>
    <div class="d-flex flex-column align-items-center">
      <div class="step-dot" id="step3">3</div>
      <div class="step-label mt-1">TTé©—è­‰</div>
    </div>
    <div class="step-connector" id="conn3"></div>
    <div class="d-flex flex-column align-items-center">
      <div class="step-dot" id="step4">4</div>
      <div class="step-label mt-1">è©•åˆ†</div>
    </div>
    <div class="step-connector" id="conn4"></div>
    <div class="d-flex flex-column align-items-center">
      <div class="step-dot" id="step5">5</div>
      <div class="step-label mt-1">å®Œæˆ</div>
    </div>
  </div>

  <!-- Progress bar + messages -->
  <div class="progress mb-2" style="height:5px;background:#21262d">
    <div id="progressBar" class="progress-bar"
      style="background:var(--accent);width:0%;transition:width .4s"></div>
  </div>
  <div class="d-flex justify-content-between align-items-center mb-1">
    <span id="progressMsg" class="text-muted small">Startingâ€¦</span>
    <span id="progressTicker" class="text-muted small font-monospace"></span>
  </div>

  <!-- Live log -->
  <div id="liveLogWrap" class="d-none">
    <div id="liveLog"></div>
  </div>
  <button class="btn btn-link btn-sm text-secondary p-0 mt-1" id="btnToggleLog"
    onclick="toggleLiveLog()" style="font-size:11px">
    <i class="bi bi-terminal me-1"></i>Show Live Log
  </button>
</div>

<!-- â”€â”€â”€ Timing row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="timingRow" class="d-none my-3 d-flex flex-wrap gap-2">
  <span class="timing-pill"><i class="bi bi-cloud-download me-1 text-secondary"></i>S1: <strong id="tS1">â€”</strong>s</span>
  <span class="timing-pill"><i class="bi bi-hdd me-1 text-secondary"></i>DL: <strong id="tDL">â€”</strong>s</span>
  <span class="timing-pill"><i class="bi bi-cpu me-1 text-secondary"></i>Par: <strong id="tPar">â€”</strong>s</span>
  <span class="timing-pill" style="border-color:var(--accent);color:var(--accent)">
    <i class="bi bi-clock-fill me-1"></i>Total: <strong id="tTot">â€”</strong>s
  </span>
</div>

<!-- â”€â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<ul class="nav nav-tabs combined-tabs mb-0" id="combinedTabs" role="tablist"
  style="border-color:#30363d">
  <li class="nav-item">
    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#paneSepa"
      type="button" onclick="onTabChange('sepa')">
      <i class="bi bi-funnel me-1"></i>SEPA
      <span class="badge bg-secondary ms-1" id="sepaBadge">â€”</span>
    </button>
  </li>
  <li class="nav-item">
    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#paneQm"
      type="button" onclick="onTabChange('qm')">
      <i class="bi bi-lightning-charge me-1" style="color:#e3b341"></i>QM
      <span class="badge bg-secondary ms-1" id="qmBadge">â€”</span>
    </button>
  </li>
  <li class="nav-item">
    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#paneMkt"
      type="button" onclick="onTabChange('market')">
      <i class="bi bi-bar-chart-line me-1"></i>Market
    </button>
  </li>
</ul>

<div class="tab-content" style="border:1px solid #30363d;border-top:none;border-radius:0 0 8px 8px">

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SEPA TAB â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="tab-pane fade show active p-3" id="paneSepa" role="tabpanel">

    <!-- Summary stat cards -->
    <div class="row g-3 mb-3" id="sepaSummaryRow" style="display:none">
      <div class="col-6 col-md-3">
        <div class="metric-card">
          <div class="metric-val" id="sepaPassCount">â€”</div>
          <div class="metric-lbl">é€šé Passed</div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="metric-card">
          <div class="metric-val" id="sepaAllCount" style="color:#8b949e">â€”</div>
          <div class="metric-lbl">å…¨éƒ¨è©•åˆ† All Scored</div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="metric-card">
          <div class="metric-val" id="sepaAvgScore" style="color:#e3b341">â€”</div>
          <div class="metric-lbl">å¹³å‡åˆ† Avg Score</div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="metric-card">
          <div class="metric-val" id="sepaScanTime" style="color:#8b949e">â€”</div>
          <div class="metric-lbl">æƒææ™‚é–“ Scan Time</div>
        </div>
      </div>
    </div>

    <!-- Charts row -->
    <div class="row g-3 mb-3" id="scanSummaryCharts" style="display:none">
      <div class="col-md-5">
        <div class="metric-card p-2">
          <div class="small text-secondary mb-2 text-center">æ¿å¡Šåˆ†ä½ˆ Sector Distribution</div>
          <div style="position:relative;height:180px">
            <canvas id="sectorDonutChart"></canvas>
          </div>
        </div>
      </div>
      <div class="col-md-7">
        <div class="metric-card p-2">
          <div class="small text-secondary mb-2 text-center">SEPA åˆ†æ•¸åˆ†ä½ˆ Score Distribution</div>
          <div style="position:relative;height:180px">
            <canvas id="scoreHistChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Log bar -->
    <div id="scanLogBar" class="d-none mb-2 small text-muted">
      <i class="bi bi-file-text me-1"></i>Log: <span id="scanLogPath">â€”</span>
    </div>

    <!-- Results toolbar -->
    <div class="d-flex align-items-center gap-2 mb-2 flex-wrap" id="sepaToolbar">
      <!-- Text search -->
      <input type="text" class="form-control form-control-sm" id="filterInput"
        placeholder="Search ticker / sectorâ€¦"
        style="width:200px;background:#0d1117;color:#c9d1d9;border-color:#30363d"
        oninput="filterSepaTable()">

      <!-- Show All toggle -->
      <button class="btn btn-sm btn-outline-secondary d-none" id="btnShowAll" onclick="toggleShowAll()">
        <i class="bi bi-eye me-1"></i>Show All Scored
        (<span id="allScoredCount">0</span>)
      </button>

      <!-- Filters button -->
      <button class="btn btn-sm btn-outline-secondary" onclick="toggleSepaFilters()">
        <i class="bi bi-funnel me-1"></i>ç¯©é¸ Filters
        <span class="badge bg-warning text-dark ms-1 d-none" id="filterBadge"></span>
      </button>

      <span class="text-muted small ms-auto" id="resultCount"></span>

      <!-- CSV -->
      <button class="btn btn-sm btn-outline-secondary" onclick="exportSepaCSV()">
        <i class="bi bi-download me-1"></i>CSV
      </button>
    </div>

    <!-- Advanced filter panel -->
    <div id="sepaFilterPanel" class="filter-panel d-none">
      <div class="row g-3 small mb-2">
        <div class="col-6 col-md-4 col-lg-2">
          <label class="form-label small mb-1 text-secondary">SEPA Score</label>
          <div class="d-flex align-items-center gap-1">
            <input type="number" class="form-control form-control-sm" id="sepaMin"
              placeholder="Min" min="0" max="100" oninput="filterSepaTable()" style="width:55px">
            <span class="text-muted">â€“</span>
            <input type="number" class="form-control form-control-sm" id="sepaMax"
              placeholder="Max" min="0" max="100" oninput="filterSepaTable()" style="width:55px">
          </div>
        </div>
        <div class="col-6 col-md-4 col-lg-2">
          <label class="form-label small mb-1 text-secondary">Trend (0-100)</label>
          <div class="d-flex align-items-center gap-1">
            <input type="number" class="form-control form-control-sm" id="trendMin"
              placeholder="Min" min="0" max="100" oninput="filterSepaTable()" style="width:55px">
            <span class="text-muted">â€“</span>
            <input type="number" class="form-control form-control-sm" id="trendMax"
              placeholder="Max" min="0" max="100" oninput="filterSepaTable()" style="width:55px">
          </div>
        </div>
        <div class="col-6 col-md-4 col-lg-2">
          <label class="form-label small mb-1 text-secondary">Fundamentals (0-100)</label>
          <div class="d-flex align-items-center gap-1">
            <input type="number" class="form-control form-control-sm" id="fundMin"
              placeholder="Min" min="0" max="100" oninput="filterSepaTable()" style="width:55px">
            <span class="text-muted">â€“</span>
            <input type="number" class="form-control form-control-sm" id="fundMax"
              placeholder="Max" min="0" max="100" oninput="filterSepaTable()" style="width:55px">
          </div>
        </div>
        <div class="col-6 col-md-4 col-lg-2">
          <label class="form-label small mb-1 text-secondary">RS Rank (0-99)</label>
          <div class="d-flex align-items-center gap-1">
            <input type="number" class="form-control form-control-sm" id="rsMin"
              placeholder="Min" min="0" max="99" oninput="filterSepaTable()" style="width:55px">
            <span class="text-muted">â€“</span>
            <input type="number" class="form-control form-control-sm" id="rsMax"
              placeholder="Max" min="0" max="99" oninput="filterSepaTable()" style="width:55px">
          </div>
        </div>
        <div class="col-6 col-md-4 col-lg-2">
          <label class="form-label small mb-1 text-secondary">Price $</label>
          <div class="d-flex align-items-center gap-1">
            <input type="number" class="form-control form-control-sm" id="priceMin"
              placeholder="Min" min="0" oninput="filterSepaTable()" style="width:55px">
            <span class="text-muted">â€“</span>
            <input type="number" class="form-control form-control-sm" id="priceMax"
              placeholder="Max" min="0" oninput="filterSepaTable()" style="width:55px">
          </div>
        </div>
        <div class="col-6 col-md-4 col-lg-2">
          <label class="form-label small mb-1 text-secondary">Pivot $</label>
          <div class="d-flex align-items-center gap-1">
            <input type="number" class="form-control form-control-sm" id="pivotMin"
              placeholder="Min" min="0" oninput="filterSepaTable()" style="width:55px">
            <span class="text-muted">â€“</span>
            <input type="number" class="form-control form-control-sm" id="pivotMax"
              placeholder="Max" min="0" oninput="filterSepaTable()" style="width:55px">
          </div>
        </div>
      </div>
      <div class="row g-3 small align-items-end">
        <!-- VCP Grade -->
        <div class="col-md-3">
          <label class="form-label small mb-1 text-secondary">VCP Grade</label>
          <div class="d-flex gap-2 flex-wrap">
            <div class="form-check form-check-inline mb-0">
              <input class="form-check-input" type="checkbox" id="vcpA" onchange="filterSepaTable()">
              <label class="form-check-label" for="vcpA">A</label>
            </div>
            <div class="form-check form-check-inline mb-0">
              <input class="form-check-input" type="checkbox" id="vcpB" onchange="filterSepaTable()">
              <label class="form-check-label" for="vcpB">B</label>
            </div>
            <div class="form-check form-check-inline mb-0">
              <input class="form-check-input" type="checkbox" id="vcpC" onchange="filterSepaTable()">
              <label class="form-check-label" for="vcpC">C</label>
            </div>
            <div class="form-check form-check-inline mb-0">
              <input class="form-check-input" type="checkbox" id="vcpNone" onchange="filterSepaTable()">
              <label class="form-check-label text-secondary" for="vcpNone">None</label>
            </div>
          </div>
        </div>
        <!-- TT Status -->
        <div class="col-md-2">
          <label class="form-label small mb-1 text-secondary">Trend Template</label>
          <div class="d-flex gap-2">
            <div class="form-check form-check-inline mb-0">
              <input class="form-check-input" type="checkbox" id="ttPass" checked onchange="filterSepaTable()">
              <label class="form-check-label text-success" for="ttPass">Pass</label>
            </div>
            <div class="form-check form-check-inline mb-0">
              <input class="form-check-input" type="checkbox" id="ttFail" onchange="filterSepaTable()">
              <label class="form-check-label text-danger" for="ttFail">Fail</label>
            </div>
          </div>
        </div>
        <!-- Sector multiselect -->
        <div class="col-md-5">
          <label class="form-label small mb-1 text-secondary">Sector (Ctrl+click multi-select)</label>
          <select class="form-select form-select-sm" id="sectorFilter" multiple size="3"
            onchange="filterSepaTable()"
            style="background:#0d1117;color:#c9d1d9;border-color:#30363d"></select>
        </div>
        <!-- Reset -->
        <div class="col-md-2">
          <button class="btn btn-sm btn-outline-secondary w-100" onclick="resetSepaFilters()">
            <i class="bi bi-x-circle me-1"></i>Reset
          </button>
        </div>
      </div>
    </div><!-- /sepaFilterPanel -->

    <!-- SEPA table -->
    <div class="table-responsive mt-2">
      <table class="table table-hover mb-0 align-middle" id="sepaTable" style="font-size:13px">
        <thead>
          <tr>
            <th style="width:36px">#</th>
            <th data-bs-toggle="tooltip"
              title="é»æ“Šè‚¡ç¥¨ä»£è™Ÿå¯é€²å…¥ SEPA å€‹è‚¡æ·±åº¦åˆ†æé é¢ï¼ˆBUY/WATCH/AVOID å»ºè­°ï¼‰">
              Ticker
              <i class="bi bi-info-circle text-secondary" style="font-size:10px"></i>
            </th>
            <th data-bs-toggle="tooltip"
              title="SEPA 5 æŸ±ç¸½åˆ†ï¼ˆ0-100ï¼‰ã€‚è¨ˆç®—ç‚ºï¼šè¶¨å‹¢(35%) + åŸºæœ¬é¢(30%) + å…¥å ´æ™‚æ©Ÿ(20%) + å‚¬åŒ–åŠ‘(10%) + é¢¨éšªå›å ±(5%)ã€‚â‰¥75 ç‚ºå„ªè³ªè¨­ç½®ï¼ˆç¶ è‰²ï¼‰ï¼Œâ‰¥55 ç‚ºå€¼å¾—è§€å¯Ÿï¼ˆé»ƒè‰²ï¼‰ï¼Œ&lt;55 ç‚ºå¼±å‹¢ï¼ˆç´…è‰²ï¼‰ã€‚">
              SEPA Score
              <i class="bi bi-info-circle text-secondary" style="font-size:10px"></i>
            </th>
            <th data-bs-toggle="tooltip"
              title="è¶¨å‹¢åˆ†æ•¸ï¼ˆ0-100ï¼‰ã€‚è¡¡é‡è‚¡ç¥¨æ˜¯å¦è™•æ–¼ Stage 2 ä¸Šå‡è¶¨å‹¢ï¼ŒåŸºæ–¼è¶¨å‹¢æ¨¡æ¿ï¼ˆTT1-TT10ï¼‰é€šéæ•¸é‡ã€å‡ç·šæ’åˆ—èˆ‡ 52 å‘¨ä½ç½®è¨ˆç®—ã€‚åˆ†æ•¸è¶Šé«˜è¡¨ç¤ºè¶¨å‹¢è¶Šå¼ºã€‚">
              Trend
              <i class="bi bi-info-circle text-secondary" style="font-size:10px"></i>
            </th>
            <th data-bs-toggle="tooltip"
              title="åŸºæœ¬é¢åˆ†æ•¸ï¼ˆ0-100ï¼‰ã€‚è©•ä¼° EPS å­£å¢é•·ï¼ˆâ‰¥25%ï¼‰ã€ç‡Ÿæ”¶å¢é•·ï¼ˆâ‰¥20%ï¼‰ã€ROEï¼ˆâ‰¥17%ï¼‰ã€æ©Ÿæ§‹æŒè‚¡è®ŠåŒ–ã€ç›ˆåˆ©åŠ é€Ÿç­‰ 9 é …è²¡å ±æŒ‡æ¨™ã€‚Minervini è¦æ±‚ä¸Šå¸‚å…¬å¸æœ‰å¼ºå‹åŸºæœ¬é¢æ”¯æ’ã€‚">
              Fund
              <i class="bi bi-info-circle text-secondary" style="font-size:10px"></i>
            </th>
            <th data-bs-toggle="tooltip"
              title="IBD é¢¨æ ¼ç›¸å°å¼·åº¦æ’åï¼ˆ0-99 ç™¾åˆ†ä½ï¼‰ã€‚æ¯”è¼ƒéå» 3/6/12 å€‹æœˆæ¼²å¹…èˆ‡å…¨å¸‚å ´è‚¡ç¥¨ã€‚RS â‰¥ 70 ç‚º TT9 é€šéæ¢ä»¶ï¼ŒRS â‰¥ 90 ç‚ºæœ€é ‚å°–å¼·å‹¢è‚¡ã€‚RS è¶Šé«˜è¡¨ç¤ºè©²è‚¡æ¯”å¸‚å ´ä¸Šå¤§å¤šæ•¸è‚¡ç¥¨å¼·ã€‚">
              RS
              <i class="bi bi-info-circle text-secondary" style="font-size:10px"></i>
            </th>
            <th data-bs-toggle="tooltip"
              title="VCPï¼ˆæ³¢å‹•æ”¶ç¸®å½¢æ…‹ Volatility Contraction Patternï¼‰ç­‰ç´šï¼šA=é«˜è³ªé‡ VCPï¼ˆ3+æ¬¡æ”¶ç¸®ã€æˆäº¤é‡ä¹¾æ¶¸ï¼‰ã€B=æ¨™æº– VCPã€C=å¼± VCPã€D/æ©«ç·š=æœªç™¼ç¾ VCPã€‚é»æ“Š VCP æ¨™ç±¤é€²å…¥ VCP è©³ç´°åˆ†æé é¢ã€‚">
              VCP
              <i class="bi bi-info-circle text-secondary" style="font-size:10px"></i>
            </th>
            <th data-bs-toggle="tooltip"
              title="æ¨ç´é»åƒ¹æ ¼ï¼ˆPivot Pointï¼‰ï¼šVCP çªç ´çš„ç†æƒ³å…¥å ´åƒ¹ä½ã€‚é€šå¸¸ç‚ºæ•´å›ºåº•éƒ¨æœ€é«˜é»ä¸Šæ–¹ 0-5%ã€‚åƒ¹æ ¼çªç ´æ¨ç´é»ä¸”æˆäº¤é‡æ”¾å¤§ â‰¥1.5x å¹³å‡é‡ç‚º Minervini æ¨™æº–å…¥å ´è¨Šè™Ÿã€‚">
              Pivot
              <i class="bi bi-info-circle text-secondary" style="font-size:10px"></i>
            </th>
            <th data-bs-toggle="tooltip"
              title="ç•¶å‰è‚¡åƒ¹ï¼ˆæœ€æ–°æ”¶ç›¤åƒ¹ï¼‰ã€‚å°æ¯”æ¨ç´é»å¯åˆ¤æ–·æ˜¯å¦ä»åœ¨åˆç†è¿½è²·ç¯„åœå…§ï¼ˆMinervini è¦æ±‚è¿½è²·ç©ºé–“ â‰¤ 5%ï¼‰ã€‚">
              Price
              <i class="bi bi-info-circle text-secondary" style="font-size:10px"></i>
            </th>
            <th data-bs-toggle="tooltip"
              title="è¶¨å‹¢æ¨¡æ¿ï¼ˆTrend Templateï¼‰TT1-TT10 é€šéæƒ…æ³ã€‚âœ“ X/10 = X å€‹æ¢ä»¶é€šéï¼Œâ‰¥8/10 ç‚ºé€šéã€‚TT9 = RSæ’åé”æ¨™ï¼ŒTT10 = æ¿å¡Šå‹•åŠ›é”æ¨™ã€‚Minervini è¦æ±‚è‡³å°‘ 8/10 é€šéæ‰é€²å…¥è©•åˆ†ã€‚">
              TT
              <i class="bi bi-info-circle text-secondary" style="font-size:10px"></i>
            </th>
            <th data-bs-toggle="tooltip"
              title="æ‰€å±¬æ¿å¡Šï¼ˆSectorï¼‰ã€‚ç›¸åŒæ¿å¡Šå€‹è‚¡å¾€å¾€åŒæ¼²åŒè·Œã€‚Minervini å»ºè­°åŒæ¿å¡ŠæŒè‚¡ä¸è¶…é 3 éš»ï¼Œä»¥é¿å…æ¿å¡Šé›†ä¸­é¢¨éšªã€‚">
              Sector
              <i class="bi bi-info-circle text-secondary" style="font-size:10px"></i>
            </th>
            <th></th>
          </tr>
        </thead>
        <tbody id="sepaBody">
          <tr><td colspan="12" class="text-center text-muted py-5">
            æƒæå¾Œé¡¯ç¤ºçµæœ Run scan to see results
          </td></tr>
        </tbody>
      </table>
    </div>
  </div><!-- /paneSepa -->

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• QM TAB â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="tab-pane fade p-3" id="paneQm" role="tabpanel">

    <!-- QM Summary cards -->
    <div class="row g-3 mb-3" id="qmSummaryRow" style="display:none">
      <div class="col-6 col-md-3">
        <div class="metric-card">
          <div class="metric-val" id="metPassCount">â€”</div>
          <div class="metric-lbl">é€šé Passed</div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="metric-card">
          <div class="metric-val" id="met5Star" style="color:#3fb950">â€”</div>
          <div class="metric-lbl">5â˜…+ é ‚å°–</div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="metric-card">
          <div class="metric-val" id="metAvgStar" style="color:#e3b341">â€”</div>
          <div class="metric-lbl">å¹³å‡æ˜Ÿç´š Avg Stars</div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="metric-card">
          <div class="metric-val" id="metScanTime" style="color:#8b949e">â€”</div>
          <div class="metric-lbl">æƒææ™‚é–“ Time</div>
        </div>
      </div>
    </div>

    <!-- QM Diagnostics (collapsible) -->
    <div class="mb-2">
      <button class="btn btn-sm btn-link text-secondary p-0 text-decoration-none"
        onclick="toggleQmDiag()" style="font-size:12px">
        <i class="bi bi-chevron-right me-1" id="qmDiagToggle"></i>QM è¨ºæ–· Diagnostics
      </button>
      <div id="qmDiagPanel" class="d-none mt-2 info-panel small">
        <div id="qmDiagContent" class="text-muted">æƒæå®Œæˆå¾Œé¡¯ç¤ºè¨ºæ–·è³‡è¨Š</div>
      </div>
    </div>

    <!-- QM table -->
    <div class="table-responsive">
      <table class="table table-hover mb-0" id="qmTable" style="font-size:12.5px">
        <thead>
          <tr>
            <th style="width:36px">#</th>
            <th data-bs-toggle="tooltip"
              title="é»æ“Šè‚¡ç¥¨ä»£è™Ÿå¯é€²å…¥QMå€‹è‚¡åˆ†æé é¢ï¼ŒæŸ¥çœ‹è©³ç´°æŠ€è¡“åˆ†æèˆ‡äº¤æ˜“å»ºè­°">
              è‚¡ç¥¨ Ticker
              <i class="bi bi-info-circle text-secondary" style="font-size:10px"></i>
            </th>
            <th data-bs-toggle="tooltip"
              title="6ç¶­è©•åˆ†ç³»çµ±ï¼šADRæ³¢å‹•(20%)+æˆäº¤é¡(20%)+å‹•èƒ½(30%)+å½¢æ…‹(10%)+å‡ç·š(10%)+åŸºæœ¬é¢(10%) | 5â˜…+=é ‚å°–æ©Ÿæœƒ 4â˜…=å€¼å¾—é—œæ³¨ 3â˜…=è§€å¯Ÿæ¸…å–®">
              â­ æ˜Ÿç´š Stars
              <i class="bi bi-info-circle text-secondary" style="font-size:10px"></i>
            </th>
            <th data-bs-toggle="tooltip"
              title="å¹³å‡æ—¥æ³¢å‹•å¹…åº¦ï¼ˆATR/PriceÃ—100%ï¼‰| ç†æƒ³ç¯„åœï¼š5-15%ï¼Œä½æ–¼5%æµå‹•æ€§ä¸è¶³ï¼Œé«˜æ–¼15%æ³¢å‹•éå¤§">
              ADR%
              <i class="bi bi-info-circle text-secondary" style="font-size:10px"></i>
            </th>
            <th data-bs-toggle="tooltip"
              title="20æ—¥å¹³å‡æ—¥æˆäº¤é‡‘é¡ï¼ˆç™¾è¬ç¾å…ƒï¼‰| å»ºè­°æœ€ä½$10Mï¼Œ$50M+æµå‹•æ€§ä½³ï¼Œç¢ºä¿è¶³å¤ äº¤æ˜“é‡é€²å‡º">
              æ—¥å‡æˆäº¤é¡ $Vol
              <i class="bi bi-info-circle text-secondary" style="font-size:10px"></i>
            </th>
            <th data-bs-toggle="tooltip"
              title="éå»1å€‹æœˆåƒ¹æ ¼è®Šå‹•ç‡ | Qullamaggieç­–ç•¥åå¥½å¼·å‹¢è‚¡ï¼Œ1M>20%ç‚ºä½³ï¼Œä»£è¡¨çŸ­æœŸå‹•èƒ½å¼·å‹">
              1M%
              <i class="bi bi-info-circle text-secondary" style="font-size:10px"></i>
            </th>
            <th data-bs-toggle="tooltip"
              title="éå»3å€‹æœˆåƒ¹æ ¼è®Šå‹•ç‡ | ä¸­æœŸå‹•èƒ½æŒ‡æ¨™ï¼Œ3M>50%ä»£è¡¨è‚¡ç¥¨è™•æ–¼å¼·å‹¢ä¸Šå‡è¶¨å‹¢">
              3M%
              <i class="bi bi-info-circle text-secondary" style="font-size:10px"></i>
            </th>
            <th data-bs-toggle="tooltip"
              title="éå»6å€‹æœˆå‹•èƒ½ï¼Œæœ€é‡è¦çš„ä¸­é•·æœŸå‹•èƒ½æŒ‡æ¨™ | 6M>100%ä»£è¡¨æ¥µå¼·å‹•èƒ½ï¼ŒQullamaggieç­–ç•¥æ ¸å¿ƒæŒ‡æ¨™">
              6M%
              <i class="bi bi-info-circle text-secondary" style="font-size:10px"></i>
            </th>
            <th data-bs-toggle="tooltip"
              title="HTF=é«˜ç·Šæ——å½¢ EP=çªç ´é» LADDER=éšæ¢¯ä¸Šå‡ SURF=å‡ç·šè¡æµª RPL=å›èª¿è‡³æ”¯æ’ FLAG=æ——å½¢æ•´ç†">
              å½¢æ…‹é¡å‹ Setup
              <i class="bi bi-info-circle text-secondary" style="font-size:10px"></i>
            </th>
            <th data-bs-toggle="tooltip"
              title="æ­£åœ¨è¡æµªçš„å‡ç·šï¼ˆ10/20/50MAï¼‰ï¼Œè¡¨ç¤ºè‚¡åƒ¹åœ¨è©²å‡ç·šé™„è¿‘å‘ˆç¾å¤šæ¬¡å½ˆå‡å½¢æ…‹ï¼Œå‡ç·šå……ç•¶å‹•æ…‹æ”¯æ’">
              å‡ç·š MA Surf
              <i class="bi bi-info-circle text-secondary" style="font-size:10px"></i>
            </th>
            <th data-bs-toggle="tooltip"
              title="Higher Lowsï¼ˆè¼ƒé«˜ä½é»ï¼‰ï¼šæ¯æ¬¡å›èª¿ä½é»é«˜æ–¼å‰æ¬¡ï¼Œä»£è¡¨è²·ç›¤æŒçºŒæ”¯æ’ï¼Œè¶¨å‹¢å¥åº·">
              è¼ƒé«˜ä½é» HL
              <i class="bi bi-info-circle text-secondary" style="font-size:10px"></i>
            </th>
            <th data-bs-toggle="tooltip"
              title="Price Tightnessï¼šè¿‘æœŸ5æ—¥æœ€é«˜æœ€ä½åƒ¹å·®å°æ–¼3%ï¼Œä»£è¡¨è‚¡åƒ¹æ³¢å‹•æ”¶ç·Šï¼Œå¸¸ç‚ºçªç ´å‰çš„è“„åŠ›æ•´ç†">
              æ³¢å‹•æ”¶ç·Š Tight
              <i class="bi bi-info-circle text-secondary" style="font-size:10px"></i>
            </th>
          </tr>
        </thead>
        <tbody id="qmBody">
          <tr><td colspan="12" class="text-center text-secondary py-5">
            æƒæå¾Œé¡¯ç¤ºçµæœ Run scan to see results
          </td></tr>
        </tbody>
      </table>
    </div>

    <!-- Qullamaggie info footer -->
    <div class="mt-4 p-3 info-panel small text-secondary">
      <i class="bi bi-info-circle me-2" style="color:var(--accent)"></i>
      <strong>Kristjan Qullamaggie ç­–ç•¥èªªæ˜ï¼š</strong>
      æœ¬æƒæå™¨å¯¦ç¾ Qullamaggie çš„å‹•èƒ½çªç ´ç­–ç•¥ï¼Œå°ˆæ³¨æ–¼é«˜ ADRã€å¼·å‹•èƒ½ã€å½¢æˆç‰¹å®šæŠ€è¡“å½¢æ…‹çš„è‚¡ç¥¨ã€‚
      æ ¸å¿ƒç†å¿µï¼šæ‰¾å‡ºå…·å‚™ HTFã€EP æˆ– SURF å½¢æ…‹çš„å¼·å‹¢è‚¡ï¼Œåœ¨ä½é¢¨éšªä½ç½®é€²å ´ï¼Œç›®æ¨™ 3-10 å€å›å ±ã€‚
      å»ºè­°ä½¿ç”¨ 4â˜… ä»¥ä¸Šä½œç‚ºè§€å¯Ÿæ¸…å–®ï¼Œ5â˜… ä»¥ä¸Šç‚ºå„ªå…ˆè€ƒæ…®æ¨™çš„ã€‚
    </div>
  </div><!-- /paneQm -->

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MARKET TAB â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="tab-pane fade p-3" id="paneMkt" role="tabpanel">
    <div id="mktContent">
      <div class="text-muted py-5 text-center">
        <i class="bi bi-bar-chart-line" style="font-size:2.5rem;opacity:.3"></i>
        <div class="mt-3">æƒæå®Œæˆå¾Œé¡¯ç¤ºå¸‚å ´ç’°å¢ƒ Market data shown after scan completes</div>
      </div>
    </div>
  </div>

</div><!-- /tab-content -->
{% endblock %}

{% block extra_js %}
<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Combined Scan â€” Full Parity JavaScript
   SEPA parity: scan.html  |  QM parity: qm_scan.html
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const CACHE_KEY = 'combined_scan_v3';
const CACHE_VER = '3';

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _jid          = null;
let _sepaData     = [];   // SEPA passed rows
let _sepaAllData  = [];   // SEPA all scored rows
let _qmAllData    = [];   // QM all rows from backend (before min_star filter)
let _sepaShowAll  = false;
let _currentTab   = 'sepa';
let _liveLogVis   = false;

/* â”€â”€â”€ Clocks & Trading Date â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function updateClocks() {
  const now  = new Date();
  const fmt  = tz => new Intl.DateTimeFormat('en', {
    hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false, timeZone: tz
  }).format(now);

  // Last US trading day
  const usEast = new Date(now.toLocaleString('en-US', {timeZone: 'America/New_York'}));
  let d = new Date(usEast);
  if (d.getHours() < 9 || (d.getHours() === 9 && d.getMinutes() < 30)) d.setDate(d.getDate() - 1);
  while (d.getDay() === 0 || d.getDay() === 6) d.setDate(d.getDate() - 1);
  const yy  = d.getFullYear();
  const mm  = String(d.getMonth() + 1).padStart(2, '0');
  const dd  = String(d.getDate()).padStart(2, '0');
  const dn  = d.toLocaleDateString('en-US', {weekday: 'short', timeZone: 'America/New_York'});
  document.getElementById('tradingDateBadge').innerHTML =
    '<i class="bi bi-calendar3 me-1"></i>' + yy + '-' + mm + '-' + dd + ' (' + dn + ')';

  // Market open dot
  const h    = usEast.getHours(), m = usEast.getMinutes(), day = usEast.getDay();
  let dot = 'ğŸ”´';
  if (day >= 1 && day <= 5) {
    const mins = h * 60 + m;
    if (mins >= 570 && mins < 960) dot = 'ğŸŸ¢';
    else if ((mins >= 240 && mins < 570) || (mins >= 960 && mins < 1200)) dot = 'ğŸŸ¡';
  }
  document.getElementById('clockHK').innerHTML =
    '<i class="bi bi-clock me-1"></i>HK ' + fmt('Asia/Hong_Kong');
  document.getElementById('clockUS').innerHTML =
    '<i class="bi bi-clock me-1"></i>ET ' + fmt('America/New_York') + ' ' + dot;
}
updateClocks();
setInterval(updateClocks, 1000);

/* â”€â”€â”€ Source note â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function onSourceChange(val) {
  ['nasdaq_ftp', 'finviz'].forEach(function(s) {
    var el = document.getElementById('srcNote_' + s);
    if (el) el.classList.toggle('d-none', s !== val);
  });
}

/* â”€â”€â”€ Tab change â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function onTabChange(tab) {
  _currentTab = tab;
  var qmF1 = document.getElementById('qmFilterContainer');
  var qmF2 = document.getElementById('qmFilterContainer2');
  if (tab === 'qm') {
    qmF1.classList.remove('d-none');
    qmF2.classList.remove('d-none');
  } else {
    qmF1.classList.add('d-none');
    qmF2.classList.add('d-none');
  }
}

/* â”€â”€â”€ DOMContentLoaded â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
document.addEventListener('DOMContentLoaded', function() {
  // Bootstrap tooltips
  document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(function(el) {
    new bootstrap.Tooltip(el, {trigger: 'hover', html: true});
  });

  // Restore from localStorage
  try {
    var raw = localStorage.getItem(CACHE_KEY);
    if (raw) {
      var cached = JSON.parse(raw);
      if (cached._ver === CACHE_VER) {
        var sepa = cached.sepa || [], sepaAll = cached.sepaAll || sepa;
        var qm   = cached.qm  || [];
        if (sepa.length) {
          _sepaData = sepa; _sepaAllData = sepaAll;
          renderSepaTable(_sepaShowAll ? _sepaAllData : _sepaData);
          populateSectorFilter();
          renderScanCharts(_sepaShowAll ? _sepaAllData : _sepaData);
          updateSepaSummary(_sepaData, _sepaAllData);
          if (_sepaAllData.length > _sepaData.length) {
            document.getElementById('allScoredCount').textContent = _sepaAllData.length;
            document.getElementById('btnShowAll').classList.remove('d-none');
          }
          document.getElementById('sepaBadge').textContent = _sepaData.length;
        }
        if (qm.length) {
          _qmAllData = qm;
          filterQmTable();   // handles rendering + summary cards
        }
        if (cached.market) renderMarket(cached.market);
        if (cached.timing)  renderTiming(cached.timing);
        var ts = cached._ts ? ' (' + new Date(cached._ts).toLocaleTimeString('zh-HK') + ')' : '';
        setStatus('Restored: SEPA ' + sepa.length + ' + QM ' + qm.length + ts);
        document.getElementById('btnLoadLast').classList.remove('d-none');
      }
    }
  } catch(e) { /* ignore */ }

  // Load cache info after short delay
  setTimeout(loadCacheInfo, 600);
});

/* â•â•â• SCAN CONTROL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function startScan() {
  var refreshRs = document.getElementById('chkRefreshRS').checked;
  var stage1Src = document.getElementById('combinedSource').value;

  document.getElementById('btnRun').disabled = true;
  document.getElementById('btnStop').classList.remove('d-none');
  document.getElementById('progressArea').classList.remove('d-none');
  document.getElementById('progressBar').style.width = '0%';
  document.getElementById('progressMsg').textContent = 'Startingâ€¦';
  document.getElementById('progressTicker').textContent = '';
  document.getElementById('timingRow').classList.add('d-none');
  _sepaShowAll = false;

  // Reset step indicators
  for (var i = 1; i <= 5; i++) document.getElementById('step' + i).className = 'step-dot';
  for (var j = 1; j <= 4; j++) {
    var c = document.getElementById('conn' + j);
    if (c) c.className = 'step-connector';
  }
  setStatus('Scanningâ€¦');

  try {
    var resp = await fetch('/api/combined/scan/run', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({refresh_rs: refreshRs, stage1_source: stage1Src})
    });
    var r = await resp.json();
    _jid = r.job_id;
    pollScan();
  } catch(e) { onError(e.message); }
}

function stopScan() {
  if (_jid) fetch('/api/combined/scan/cancel/' + _jid, {method: 'POST'}).catch(function(){});
  resetUI();
  setStatus('Cancelled');
}

function pollScan() {
  if (!_jid) return;
  fetch('/api/combined/scan/status/' + _jid)
    .then(function(r) { return r.json(); })
    .then(function(job) {
      if (job.status === 'done')       onDone(job.result || {});
      else if (job.status === 'error') onError(job.error || 'Unknown error');
      else { renderProgress(job.progress || {}); setTimeout(pollScan, 2000); }
    })
    .catch(function() { setTimeout(pollScan, 3000); });
}

function renderProgress(p) {
  var pct = Math.min(100, p.pct || 0);
  document.getElementById('progressBar').style.width = Math.max(pct, 2) + '%';
  var stageText = p.stage || '', msg = p.msg || '';
  document.getElementById('progressMsg').textContent =
    [stageText, msg].filter(Boolean).join(' â€” ') || 'â€¦';
  if (p.ticker) document.getElementById('progressTicker').textContent = p.ticker;

  // Step indicator update
  var stageMap = {stage1: 1, download: 2, validate: 3, score: 4, complete: 5};
  var stepNum = stageMap[stageText] || (pct >= 90 ? 4 : pct >= 60 ? 3 : pct >= 30 ? 2 : 1);
  for (var i = 1; i <= 5; i++) {
    var s = document.getElementById('step' + i);
    s.className = i < stepNum ? 'step-dot done' : i === stepNum ? 'step-dot active' : 'step-dot';
  }
  for (var j = 1; j <= 4; j++) {
    var conn = document.getElementById('conn' + j);
    if (conn) conn.className = j < stepNum ? 'step-connector done' : 'step-connector';
  }

  if (p.log_line) appendLog(p.log_line, p.log_level || 'info');
  setStatus(pct + '%');
}

function appendLog(line, level) {
  var logEl = document.getElementById('liveLog');
  var div = document.createElement('div');
  div.className = 'log-line ' + (level || '');
  div.textContent = line;
  logEl.appendChild(div);
  logEl.parentElement.scrollTop = logEl.parentElement.scrollHeight;
}

function toggleLiveLog() {
  _liveLogVis = !_liveLogVis;
  document.getElementById('liveLogWrap').classList.toggle('d-none', !_liveLogVis);
  document.getElementById('btnToggleLog').innerHTML = _liveLogVis
    ? '<i class="bi bi-terminal me-1"></i>Hide Live Log'
    : '<i class="bi bi-terminal me-1"></i>Show Live Log';
}

function onDone(result) {
  resetUI();
  document.getElementById('progressBar').style.width = '100%';
  for (var i = 1; i <= 5; i++) document.getElementById('step' + i).className = 'step-dot done';
  for (var j = 1; j <= 4; j++) {
    var c = document.getElementById('conn' + j);
    if (c) c.className = 'step-connector done';
  }

  var sepa   = result.sepa   || {};
  var qm     = result.qm     || {};
  var market = result.market || {};
  var timing = result.timing || {};

  var sepaRows = sepa.passed || sepa.rows || [];
  var sepaAll  = sepa.all_scored || sepaRows;
  _sepaData    = sepaRows;
  _sepaAllData = sepaAll;

  // Store ALL QM rows; filterQmTable() applies minStar + topN
  _qmAllData = qm.passed || qm.rows || [];

  renderSepaTable(_sepaShowAll ? _sepaAllData : _sepaData);
  populateSectorFilter();
  renderScanCharts(_sepaShowAll ? _sepaAllData : _sepaData);
  filterQmTable();   // â† applies min_star filter + updates summary cards
  renderMarket(market);
  renderTiming(timing);
  updateSepaSummary(sepaRows, sepaAll);

  document.getElementById('sepaBadge').textContent = sepaRows.length;
  // QM badge = filtered count
  var filteredQmLen = _qmAllData.filter(function(r) {
    return (r.qm_star || r.stars || 0) >= parseFloat(document.getElementById('minStar').value || 4);
  }).length;
  document.getElementById('qmBadge').textContent = filteredQmLen;

  if (sepaAll.length > sepaRows.length) {
    document.getElementById('allScoredCount').textContent = sepaAll.length;
    document.getElementById('btnShowAll').classList.remove('d-none');
  }

  if (qm.diagnostics) document.getElementById('qmDiagContent').innerHTML = fmtDiag(qm.diagnostics);

  if (result.log_path) {
    document.getElementById('scanLogBar').classList.remove('d-none');
    document.getElementById('scanLogPath').textContent = result.log_path;
  }

  setStatus('Done â€” SEPA: ' + sepaRows.length + '/' + sepaAll.length + ' | QM: ' + _qmAllData.length);
  document.getElementById('btnLoadLast').classList.remove('d-none');

  // â”€â”€ Completion popup notification â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var csvHint = '';
  if (result.sepa_csv) csvHint += '<br><small class="text-muted">SEPA CSV: ' + result.sepa_csv + '</small>';
  if (result.qm_csv)   csvHint += '<br><small class="text-muted">QM CSV: '   + result.qm_csv   + '</small>';
  var logHint = result.log_path ? '<br><small class="text-muted">æ—¥èªŒ: ' + result.log_path + '</small>' : '';
  toastCompletion(
    'âœ… Combined æƒæå®Œæˆï¼<br>SEPA: <strong>' + sepaRows.length + '</strong> å€‹è‚¡ç¥¨ | QM: <strong>' + _qmAllData.length + '</strong> å€‹è¨­ç½®' + csvHint + logHint,
    true
  );

  try {
    localStorage.setItem(CACHE_KEY, JSON.stringify({
      _ver: CACHE_VER, sepa: sepaRows, sepaAll: sepaAll,
      qm: _qmAllData, market: market, timing: timing,
      _ts: new Date().toISOString()
    }));
  } catch(e) { /* ignore quota */ }
}

function onError(msg) {
  resetUI();
  setStatus('Error: ' + msg, true);
}

function resetUI() {
  _jid = null;
  document.getElementById('btnRun').disabled = false;
  document.getElementById('btnStop').classList.add('d-none');
}

function setStatus(msg, isErr) {
  var el = document.getElementById('combinedStatus');
  el.textContent = msg;
  el.className = 'small ' + (isErr ? 'text-danger' : 'text-muted');
}

async function loadLastResults() {
  try {
    var r = await fetch('/api/scan/last?include_all=1').then(function(x) { return x.json(); });
    if (r.rows && r.rows.length) {
      _sepaData    = r.rows.filter(function(x) { return x._passed !== false; });
      _sepaAllData = r.rows;
      renderSepaTable(_sepaShowAll ? _sepaAllData : _sepaData);
      populateSectorFilter();
      renderScanCharts(_sepaShowAll ? _sepaAllData : _sepaData);
      updateSepaSummary(_sepaData, _sepaAllData);
      document.getElementById('sepaBadge').textContent = _sepaData.length;
      if (_sepaAllData.length > _sepaData.length) {
        document.getElementById('allScoredCount').textContent = _sepaAllData.length;
        document.getElementById('btnShowAll').classList.remove('d-none');
      }
      setStatus('Loaded last SEPA scan (' + (r.saved_at || '') + ')');
    }
  } catch(e) { setStatus('Failed to load: ' + e.message, true); }
}

/* â•â•â• SEPA RENDERING â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderSepaTable(data) {
  var body = document.getElementById('sepaBody');
  body.innerHTML = '';
  var rcEl = document.getElementById('resultCount');
  rcEl.textContent = data.length ? data.length + ' result' + (data.length !== 1 ? 's' : '') : '';

  if (!data.length) {
    body.innerHTML = '<tr><td colspan="12" class="text-center text-muted py-5">No results</td></tr>';
    return;
  }

  var frag = document.createDocumentFragment();
  data.forEach(function(r, i) {
    var passed = r._passed !== false;
    var total  = r.total_score != null ? Number(r.total_score).toFixed(1) : 'â€”';
    var tCls   = r.total_score >= 75 ? 'score-high' : r.total_score >= 55 ? 'score-mid' : 'score-low';
    var trend  = r.trend_score != null ? Number(r.trend_score).toFixed(0) : 'â€”';
    var fund   = r.fundamental_score != null ? Number(r.fundamental_score).toFixed(0) : 'â€”';
    var rs     = r.rs_rank != null ? Number(r.rs_rank).toFixed(0) : 'â€”';

    // VCP with link to /vcp
    var vcpGrade = r.vcp_grade && r.vcp_grade !== 'D' ? r.vcp_grade : null;
    var vcpHtml  = vcpGrade
      ? '<a href="/vcp?ticker=' + r.ticker + '" class="tag-vcp">VCP ' + vcpGrade + '</a>'
      : 'â€”';

    var pivot  = r.pivot != null ? '$' + Number(r.pivot).toFixed(2)
               : r.pivot_price != null ? '$' + Number(r.pivot_price).toFixed(2) : 'â€”';
    var price  = r.close != null ? '$' + Number(r.close).toFixed(2)
               : r.price != null ? '$' + Number(r.price).toFixed(2) : 'â€”';

    // TT with TT9/TT10 extras
    var ttOk   = (r.tt_score != null && r.tt_score >= 8) || r.tt_pass === true;
    var ttIcon = ttOk
      ? '<i class="bi bi-check-circle-fill text-success"></i>'
      : '<i class="bi bi-x-circle text-danger"></i>';
    var ttLabel = r.tt_score != null ? Number(r.tt_score).toFixed(0) + '/10' : (ttOk ? 'Pass' : 'Fail');
    var tt9  = r.tt_checks && r.tt_checks.TT9  ? ' <small class="text-info">RS&#10003;</small>'  : '';
    var tt10 = r.tt_checks && r.tt_checks.TT10 ? ' <small class="text-info">Sec&#10003;</small>' : '';

    var notPassedBadge = passed ? '' : '<span class="not-passed-badge">æœªé€šé</span>';

    var row = document.createElement('tr');
    row.className = 'sepa-row' + (passed ? '' : ' row-below-threshold');
    row.innerHTML =
      '<td class="text-muted small">' + (i + 1) + '</td>' +
      '<td><a href="/analyze?ticker=' + r.ticker + '" class="fw-bold" style="color:var(--accent)">' +
        r.ticker + '</a>' + notPassedBadge +
        '<div class="text-muted" style="font-size:11px">' + (r.company || '') + '</div></td>' +
      '<td class="' + (passed ? tCls : 'text-muted') + ' fw-bold">' + total + '</td>' +
      '<td class="text-muted small">' + trend + '</td>' +
      '<td class="text-muted small">' + fund + '</td>' +
      '<td class="text-muted small">' + rs + '</td>' +
      '<td>' + vcpHtml + '</td>' +
      '<td class="small">' + pivot + '</td>' +
      '<td class="small">' + price + '</td>' +
      '<td class="text-center small">' + ttIcon + ' ' + ttLabel + tt9 + tt10 + '</td>' +
      '<td class="text-muted small">' + (r.sector || 'â€”') + '</td>' +
      '<td><button class="btn btn-sm btn-outline-info py-0 px-1" ' +
        'onclick="addToWatchlist(\'' + r.ticker + '\')" title="Add to Watchlist">' +
        '<i class="bi bi-bookmark-plus"></i></button></td>';
    frag.appendChild(row);
  });
  body.appendChild(frag);
}

/* â”€â”€â”€ SEPA Charts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
var _PALETTE = ['#58a6ff','#3fb950','#e3b341','#f78166','#d49fff',
                '#79c0ff','#56d364','#ffa657','#ff7b72','#bc8cff','#89d4f5'];

function renderScanCharts(data) {
  if (!data || !data.length) {
    document.getElementById('scanSummaryCharts').style.display = 'none';
    return;
  }
  document.getElementById('scanSummaryCharts').style.display = '';

  // Sector donut
  var sMap = {};
  data.forEach(function(r) {
    var s = r.sector || 'Unknown';
    sMap[s] = (sMap[s] || 0) + 1;
  });
  var sLabels = Object.keys(sMap).sort(function(a, b) { return sMap[b] - sMap[a]; });
  var sVals   = sLabels.map(function(s) { return sMap[s]; });

  var donutEl = document.getElementById('sectorDonutChart');
  if (donutEl._chart) donutEl._chart.destroy();
  donutEl._chart = new Chart(donutEl, {
    type: 'doughnut',
    data: {
      labels: sLabels,
      datasets: [{data: sVals, backgroundColor: _PALETTE, borderColor: '#161b22', borderWidth: 2}]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: {
          display: true, position: 'right',
          labels: {color: '#8b949e', font: {size: 9}, boxWidth: 10, padding: 4}
        }
      }
    }
  });

  // Score histogram
  var bins   = ['0-20','20-40','40-60','60-70','70-80','80-90','90-100'];
  var counts = [0, 0, 0, 0, 0, 0, 0];
  data.forEach(function(r) {
    var s = r.total_score || 0;
    if      (s < 20) counts[0]++;
    else if (s < 40) counts[1]++;
    else if (s < 60) counts[2]++;
    else if (s < 70) counts[3]++;
    else if (s < 80) counts[4]++;
    else if (s < 90) counts[5]++;
    else             counts[6]++;
  });

  var histEl = document.getElementById('scoreHistChart');
  if (histEl._chart) histEl._chart.destroy();
  histEl._chart = new Chart(histEl, {
    type: 'bar',
    data: {
      labels: bins,
      datasets: [{
        label: 'Stocks',
        data: counts,
        backgroundColor: bins.map(function(_, idx) {
          return idx >= 4 ? '#3fb950' : idx >= 2 ? '#e3b341' : '#f85149';
        }),
        borderRadius: 4
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {legend: {display: false}},
      scales: {
        x: {ticks: {color: '#8b949e', font: {size: 9}}, grid: {color: '#21262d'}},
        y: {ticks: {color: '#8b949e', font: {size: 9}}, grid: {color: '#21262d'}}
      }
    }
  });
}

/* â”€â”€â”€ Sector filter population â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function populateSectorFilter() {
  var src = _sepaShowAll ? _sepaAllData : _sepaData;
  var sectors = [];
  var seen = {};
  src.forEach(function(r) {
    if (r.sector && !seen[r.sector]) { seen[r.sector] = 1; sectors.push(r.sector); }
  });
  sectors.sort();
  var sel = document.getElementById('sectorFilter');
  var current = new Set(Array.from(sel.selectedOptions).map(function(o) { return o.value; }));
  sel.innerHTML = sectors.map(function(s) {
    return '<option value="' + s + '"' + (current.has(s) ? ' selected' : '') + '>' + s + '</option>';
  }).join('');
}

/* â”€â”€â”€ SEPA Filter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function filterSepaTable() {
  var sepaMin  = parseFloat(document.getElementById('sepaMin').value  || 0);
  var sepaMax  = parseFloat(document.getElementById('sepaMax').value  || 100);
  var trendMin = parseFloat(document.getElementById('trendMin').value || 0);
  var trendMax = parseFloat(document.getElementById('trendMax').value || 100);
  var fundMin  = parseFloat(document.getElementById('fundMin').value  || 0);
  var fundMax  = parseFloat(document.getElementById('fundMax').value  || 100);
  var rsMin    = parseFloat(document.getElementById('rsMin').value    || 0);
  var rsMax    = parseFloat(document.getElementById('rsMax').value    || 99);
  var priceMin = parseFloat(document.getElementById('priceMin').value || 0);
  var priceMax = parseFloat(document.getElementById('priceMax').value || 1e9);
  var pivotMin = parseFloat(document.getElementById('pivotMin').value || 0);
  var pivotMax = parseFloat(document.getElementById('pivotMax').value || 1e9);
  var searchTxt = (document.getElementById('filterInput').value || '').toLowerCase();

  var vcpGrades = new Set();
  if (document.getElementById('vcpA').checked)    vcpGrades.add('A');
  if (document.getElementById('vcpB').checked)    vcpGrades.add('B');
  if (document.getElementById('vcpC').checked)    vcpGrades.add('C');
  if (document.getElementById('vcpNone').checked) vcpGrades.add('None');

  var ttFilters = new Set();
  if (document.getElementById('ttPass').checked) ttFilters.add('pass');
  if (document.getElementById('ttFail').checked) ttFilters.add('fail');

  var selectedSectors = new Set(
    Array.from(document.getElementById('sectorFilter').selectedOptions).map(function(o) { return o.value; })
  );

  var data = _sepaShowAll ? _sepaAllData : _sepaData;
  var filtered = data.filter(function(r) {
    var score      = r.total_score  || 0;
    var trend      = r.trend_score  || 0;
    var fund       = r.fundamental_score || 0;
    var rs         = r.rs_rank      || 0;
    var priceVal   = r.close || r.price || 0;
    var pivotVal   = r.pivot != null ? parseFloat(r.pivot)
                   : r.pivot_price != null ? parseFloat(r.pivot_price) : 0;

    if (score    < sepaMin  || score    > sepaMax)  return false;
    if (trend    < trendMin || trend    > trendMax) return false;
    if (fund     < fundMin  || fund     > fundMax)  return false;
    if (rs       < rsMin    || rs       > rsMax)    return false;
    if (priceVal < priceMin || priceVal > priceMax) return false;
    if (pivotVal < pivotMin || pivotVal > pivotMax) return false;

    if (searchTxt) {
      var hay = ((r.ticker || '') + ' ' + (r.sector || '') + ' ' + (r.company || '')).toLowerCase();
      if (hay.indexOf(searchTxt) === -1) return false;
    }

    if (vcpGrades.size > 0) {
      var grade = r.vcp_grade && r.vcp_grade !== 'D' ? r.vcp_grade : 'None';
      if (!vcpGrades.has(grade)) return false;
    }

    if (ttFilters.size > 0) {
      var ttOk = (r.tt_score != null && r.tt_score >= 8) || r.tt_pass === true;
      var ttSt = ttOk ? 'pass' : 'fail';
      if (!ttFilters.has(ttSt)) return false;
    }

    if (selectedSectors.size > 0 && !selectedSectors.has(r.sector)) return false;

    return true;
  });

  renderSepaTable(filtered);
  renderScanCharts(filtered);
  updateFilterBadge();
}

function toggleSepaFilters() {
  document.getElementById('sepaFilterPanel').classList.toggle('d-none');
}

function resetSepaFilters() {
  ['sepaMin','sepaMax','trendMin','trendMax','fundMin','fundMax',
   'rsMin','rsMax','priceMin','priceMax','pivotMin','pivotMax','filterInput'].forEach(function(id) {
    document.getElementById(id).value = '';
  });
  ['vcpA','vcpB','vcpC','vcpNone','ttFail'].forEach(function(id) {
    document.getElementById(id).checked = false;
  });
  document.getElementById('ttPass').checked = true;
  document.getElementById('sectorFilter').selectedIndex = -1;
  filterSepaTable();
}

function updateFilterBadge() {
  var badge = document.getElementById('filterBadge');
  var count = 0;
  ['sepaMin','sepaMax','trendMin','trendMax','fundMin','fundMax',
   'rsMin','rsMax','priceMin','priceMax','pivotMin','pivotMax','filterInput'].forEach(function(id) {
    if (document.getElementById(id).value) count++;
  });
  var vcpCount = ['vcpA','vcpB','vcpC','vcpNone'].filter(function(id) {
    return document.getElementById(id).checked;
  }).length;
  if (vcpCount > 0 && vcpCount < 4) count++;
  var ttPass = document.getElementById('ttPass').checked;
  var ttFail = document.getElementById('ttFail').checked;
  if ((ttPass && !ttFail) || (!ttPass && ttFail)) count++;
  if (document.getElementById('sectorFilter').selectedOptions.length > 0) count++;

  if (count > 0) {
    badge.textContent = count;
    badge.classList.remove('d-none');
  } else {
    badge.classList.add('d-none');
  }
}

function toggleShowAll() {
  _sepaShowAll = !_sepaShowAll;
  var btn = document.getElementById('btnShowAll');
  if (_sepaShowAll) {
    btn.innerHTML = '<i class="bi bi-eye-slash me-1"></i>Show Passed Only (' + _sepaData.length + ')';
  } else {
    btn.innerHTML = '<i class="bi bi-eye me-1"></i>Show All Scored (' + _sepaAllData.length + ')';
  }
  populateSectorFilter();
  filterSepaTable();
}

function updateSepaSummary(passed, all) {
  var row = document.getElementById('sepaSummaryRow');
  row.style.display = '';
  document.getElementById('sepaPassCount').textContent = passed.length;
  document.getElementById('sepaAllCount').textContent  = all.length;
  var avg = passed.length
    ? (passed.reduce(function(s, r) { return s + (r.total_score || 0); }, 0) / passed.length).toFixed(1)
    : 'â€”';
  document.getElementById('sepaAvgScore').textContent = avg;
  document.getElementById('sepaScanTime').textContent = new Date().toLocaleTimeString('zh-HK');
}

/* â•â•â• QM RENDERING â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function filterQmTable() {
  var minStar = parseFloat(document.getElementById('minStar').value || 4);
  var topN    = parseInt(document.getElementById('topN').value || 50);
  var filtered = _qmAllData
    .filter(function(r) { return (r.qm_star || r.stars || 0) >= minStar; })
    .slice(0, topN);
  renderQmTable(filtered);
  document.getElementById('qmBadge').textContent = filtered.length;
  // Keep summary cards in sync with what the table actually shows
  if (_qmAllData.length > 0) updateQmSummary(filtered);
}

function renderQmTable(rows) {
  var tbody = document.getElementById('qmBody');
  if (!rows || !rows.length) {
    tbody.innerHTML = '<tr><td colspan="12" class="text-center text-secondary py-5">No results</td></tr>';
    return;
  }

  tbody.innerHTML = rows.map(function(r, i) {
    var star      = parseFloat(r.qm_star != null ? r.qm_star : (r.stars != null ? r.stars : 0));
    var starClass = star >= 5 ? 'star-5p' : star >= 4.5 ? 'star-5' : star >= 4 ? 'star-4' : star >= 3 ? 'star-3' : 'star-low';
    var starHtml  = renderStars(star);

    var adrVal = r.adr != null ? parseFloat(r.adr) : null;
    var adrTxt = adrVal != null ? adrVal.toFixed(1) + '%' : 'â€”';
    var adrCls = adrVal != null && adrVal < 5 ? 'text-danger' : '';

    var dvol = r.dollar_volume_m != null ? '$' + parseFloat(r.dollar_volume_m).toFixed(1) + 'M' : 'â€”';
    var m1   = r.mom_1m != null ? fmtMom(r.mom_1m) : 'â€”';
    var m3   = r.mom_3m != null ? fmtMom(r.mom_3m) : 'â€”';
    var m6   = r.mom_6m != null ? fmtMom(r.mom_6m) : 'â€”';

    var setup      = (r.setup_type || '').toUpperCase();
    var setupBadge = setupBadgeHtml(setup);

    // Surf â€” coloured badge, not plain text
    var surfHtml = r.surfing_ma
      ? '<span class="badge" style="background:#003040;color:#00d4ff">' + r.surfing_ma + 'MA</span>'
      : '<span class="text-secondary">â€”</span>';

    // HL and Tight â€” check icons or dash
    var hlHtml    = r.has_higher_lows
      ? '<i class="bi bi-check-circle-fill text-success"></i>'
      : '<span class="text-secondary">â€”</span>';
    var tightHtml = r.is_tight
      ? '<i class="bi bi-arrows-collapse text-info"></i>'
      : '<span class="text-secondary">â€”</span>';

    // VETO below ticker
    var vetoHtml = r.veto
      ? '<br><span class="veto-badge">VETO:' + r.veto + '</span>'
      : '';

    return '<tr class="qm-row" onclick="window.location=\'/qm/analyze?ticker=' + r.ticker + '\'">' +
      '<td class="text-secondary">' + (i + 1) + '</td>' +
      '<td><a href="/qm/analyze?ticker=' + r.ticker + '" class="fw-bold" ' +
        'style="color:var(--accent2,#e3b341)" onclick="event.stopPropagation()">' +
        r.ticker + '</a>' + vetoHtml + '</td>' +
      '<td class="' + starClass + '">' + starHtml + '</td>' +
      '<td class="' + adrCls + '">' + adrTxt + '</td>' +
      '<td>' + dvol + '</td>' +
      '<td>' + m1 + '</td>' +
      '<td>' + m3 + '</td>' +
      '<td class="fw-bold">' + m6 + '</td>' +
      '<td>' + setupBadge + '</td>' +
      '<td>' + surfHtml + '</td>' +
      '<td>' + hlHtml + '</td>' +
      '<td>' + tightHtml + '</td>' +
      '</tr>';
  }).join('');

  // Re-init tooltips for dynamically created setup badges
  tbody.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(function(el) {
    new bootstrap.Tooltip(el, {trigger: 'hover'});
  });
}

function updateQmSummary(rows) {
  document.getElementById('qmSummaryRow').style.display = '';
  document.getElementById('metPassCount').textContent = rows.length;
  var n5 = rows.filter(function(r) { return (r.qm_star || r.stars || 0) >= 5; }).length;
  document.getElementById('met5Star').textContent = n5;
  var avg = rows.length
    ? (rows.reduce(function(s, r) { return s + (r.qm_star || r.stars || 0); }, 0) / rows.length).toFixed(1)
    : 'â€”';
  document.getElementById('metAvgStar').textContent = avg + 'â˜…';
  document.getElementById('metScanTime').textContent = new Date().toLocaleTimeString('zh-HK');
}

/* â”€â”€â”€ Star renderer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderStars(val) {
  var full = Math.floor(val), half = (val - full) >= 0.5;
  var s = '';
  for (var i = 0; i < full; i++) s += 'â˜…';
  if (half) s += 'Â½';
  return s + ' <small>(' + val.toFixed(1) + ')</small>';
}

/* â”€â”€â”€ Setup badge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function setupBadgeHtml(code) {
  var map = {
    'HTF':     {cls: 'badge-htf',  label: 'HTF',       title: 'High Tight Flag é«˜ç·Šæ——å½¢ï¼šæ¥µå¼·å‹•èƒ½å½¢æ…‹ï¼Œ30å¤©+50%æ¼²å¹…å¾Œå½¢æˆç·Šæ——ï¼Œçªç ´æˆåŠŸç‡é«˜'},
    'EP':      {cls: 'badge-ep',   label: 'EP',         title: 'Episodic Pivot çˆ†ç™¼é»ï¼šåŸºæœ¬é¢å‚¬åŒ–åŠ‘ï¼ˆè²¡å ±/æ–°å“/æ”¶è³¼ï¼‰å¼•ç™¼çš„è·³ç©ºçªç ´ï¼ŒæŒå€‰åˆ°è¶¨å‹¢çµæŸ'},
    'LADDER':  {cls: 'badge-lad',  label: 'LADDER',     title: 'Ladder Up éšæ¢¯ä¸Šå‡ï¼šæ¯æ¬¡å›èª¿åˆ°å‡ç·šæ”¯æ’å¾Œç¹¼çºŒå‰µé«˜ï¼Œå½¢æˆéšæ¢¯å¼ä¸Šå‡'},
    'SURF_50': {cls: 'badge-surf', label: 'SURF 50MA',  title: 'MA Surfing å‡ç·šè¡æµª(50MA)ï¼šè‚¡åƒ¹å¤šæ¬¡åœ¨50æ—¥å‡ç·šé™„è¿‘å½ˆå‡ï¼Œå‡ç·šå……ç•¶æ”¯æ’'},
    'SURF_20': {cls: 'badge-surf', label: 'SURF 20MA',  title: 'MA Surfing å‡ç·šè¡æµª(20MA)ï¼šè‚¡åƒ¹å¤šæ¬¡åœ¨20æ—¥å‡ç·šé™„è¿‘å½ˆå‡'},
    'SURF_10': {cls: 'badge-surf', label: 'SURF 10MA',  title: 'MA Surfing å‡ç·šè¡æµª(10MA)ï¼šè‚¡åƒ¹å¤šæ¬¡åœ¨10æ—¥å‡ç·šé™„è¿‘å½ˆå‡'},
    'RPL':     {cls: 'badge-rpl',  label: 'RPL',        title: 'Pullback to Support å›èª¿è‡³æ”¯æ’ï¼šä¸Šå‡é€”ä¸­å›èª¿è‡³å‡ç·šæˆ–å‰é«˜æ”¯æ’ä½ï¼Œä½é¢¨éšªè²·å…¥æ©Ÿæœƒ'},
    'FLAG':    {cls: 'badge-flag', label: 'FLAG',       title: 'Flag/Pennant æ——å½¢ï¼šä¸Šæ¼²å¾Œå°å¹…æ•´ç†å½¢æˆæ——å½¢ï¼Œçªç ´æ——å½¢é˜»åŠ›ç¹¼çºŒä¸Šæ¼²'}
  };
  var info = map[code] || {cls: 'badge-uk', label: code || '?', title: 'æœªçŸ¥å½¢æ…‹é¡å‹'};
  return '<span class="badge ' + info.cls + '" data-bs-toggle="tooltip" title="' +
    info.title.replace(/"/g, '&quot;') + '">' + info.label + '</span>';
}

/* â”€â”€â”€ Momentum formatter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function fmtMom(v) {
  var n = parseFloat(v);
  var cls = n >= 50 ? 'text-success fw-bold' : n >= 0 ? 'text-success' : 'text-danger';
  return '<span class="' + cls + '">' + (n >= 0 ? '+' : '') + n.toFixed(1) + '%</span>';
}

/* â”€â”€â”€ QM Diagnostics â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function toggleQmDiag() {
  var panel = document.getElementById('qmDiagPanel');
  var icon  = document.getElementById('qmDiagToggle');
  panel.classList.toggle('d-none');
  icon.style.transform  = panel.classList.contains('d-none') ? 'rotate(0deg)' : 'rotate(90deg)';
  icon.style.transition = 'transform 0.2s';
}

function fmtDiag(diag) {
  if (!diag || typeof diag !== 'object') return String(diag);
  return Object.entries(diag).map(function(entry) {
    return '<div><span class="text-secondary">' + entry[0] + ':</span> ' +
           '<span class="text-info">' + entry[1] + '</span></div>';
  }).join('');
}

/* â•â•â• MARKET â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderMarket(m) {
  if (!m || !m.regime) return;
  var rc = m.regime === 'CONFIRMED_UPTREND' ? 'regime-bull'
         : m.regime === 'UPTREND_UNDER_PRESSURE' ? 'regime-trans' : 'regime-bear';
  document.getElementById('mktContent').innerHTML =
    '<div class="row g-3">' +
    '<div class="col-12"><div class="p-3 rounded ' + rc + '">' +
      '<h5 class="mb-1" style="font-size:15px">' + m.regime + '</h5>' +
      '<small>' + (m.summary || '') + '</small>' +
    '</div></div>' +
    '<div class="col-6 col-md-3"><div class="metric-card">' +
      '<div class="metric-val">' + (m.breadth_pct != null ? m.breadth_pct.toFixed(1) + '%' : 'â€”') + '</div>' +
      '<div class="metric-lbl">Breadth å¸‚å ´å»£åº¦</div></div></div>' +
    '<div class="col-6 col-md-3"><div class="metric-card">' +
      '<div class="metric-val">' + (m.dist_days || 'â€”') + '</div>' +
      '<div class="metric-lbl">Distribution Days</div></div></div>' +
    '<div class="col-6 col-md-3"><div class="metric-card">' +
      '<div class="metric-val">' + (m.spy_pct != null ? m.spy_pct.toFixed(2) + '%' : 'â€”') + '</div>' +
      '<div class="metric-lbl">SPY</div></div></div>' +
    '<div class="col-6 col-md-3"><div class="metric-card">' +
      '<div class="metric-val">' + (m.qqq_pct != null ? m.qqq_pct.toFixed(2) + '%' : 'â€”') + '</div>' +
      '<div class="metric-lbl">QQQ</div></div></div>' +
    '</div>';
}

/* â•â•â• TIMING â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderTiming(t) {
  if (!t || !t.total) return;
  document.getElementById('tS1').textContent  = (t.stage1         || 0).toFixed(1);
  document.getElementById('tDL').textContent  = (t.batch_download || 0).toFixed(1);
  document.getElementById('tPar').textContent = (t.parallel       || 0).toFixed(1);
  document.getElementById('tTot').textContent = (t.total          || 0).toFixed(1);
  document.getElementById('timingRow').classList.remove('d-none');
}

/* â•â•â• ACTIONS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function addToWatchlist(ticker) {
  try {
    await fetch('/api/watchlist/add', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ticker: ticker})
    });
    if (typeof toast === 'function') toast(ticker + ' added to watchlist');
  } catch(e) { /* silent */ }
}

function exportSepaCSV() {
  var src = _sepaShowAll ? _sepaAllData : _sepaData;
  if (!src.length) return;
  var keys = ['ticker','company','total_score','trend_score','fundamental_score',
              'rs_rank','vcp_grade','pivot','pivot_price','close','sector'];
  var csv = [keys.join(',')].concat(src.map(function(r) {
    return keys.map(function(k) { return '"' + (r[k] != null ? r[k] : '') + '"'; }).join(',');
  })).join('\n');
  _dlCsv(csv, 'sepa_scan');
}

function exportQmCSV() {
  if (!_qmAllData.length) return;
  var keys = ['ticker','qm_star','setup_type','adr','dollar_volume_m',
              'mom_1m','mom_3m','mom_6m','surfing_ma','has_higher_lows','is_tight','veto'];
  var csv = [keys.join(',')].concat(_qmAllData.map(function(r) {
    return keys.map(function(k) { return '"' + (r[k] != null ? r[k] : '') + '"'; }).join(',');
  })).join('\n');
  _dlCsv(csv, 'qm_scan');
}

function _dlCsv(csv, prefix) {
  var a = document.createElement('a');
  a.href     = URL.createObjectURL(new Blob([csv], {type: 'text/csv'}));
  a.download = prefix + '_' + new Date().toISOString().slice(0, 10) + '.csv';
  a.click();
}

/* â•â•â• CACHE INFO â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function loadCacheInfo() {
  fetch('/api/scan/cache-info')
    .then(function(r) { return r.json(); })
    .then(function(d) {
      if (!d.ok) {
        document.getElementById('cacheHints').innerHTML =
          '<div class="text-warning">Cache check failed: ' + (d.error || 'unknown') + '</div>';
        ['cacheRS','cachePrice','cacheFundamentals','cacheEstimate'].forEach(function(id) {
          var el = document.getElementById(id);
          el.textContent = 'N/A';
          el.className = 'ms-1 badge bg-secondary';
        });
        return;
      }
      var info = d.cache;

      var rsEl = document.getElementById('cacheRS');
      if (info.rs_cached) {
        rsEl.textContent = 'âœ“ cached (' + info.rs_count + ' tickers)';
        rsEl.className = 'ms-1 badge bg-success';
      } else {
        rsEl.textContent = 'âœ— needs rebuild (~5 min)';
        rsEl.className = 'ms-1 badge bg-warning text-dark';
      }

      var priceEl = document.getElementById('cachePrice');
      priceEl.textContent = info.price_cached_today + ' today';
      priceEl.className = info.price_cached_today > 50 ? 'ms-1 badge bg-success' : 'ms-1 badge bg-info';

      var fundEl = document.getElementById('cacheFundamentals');
      fundEl.textContent = info.fund_cached_today + ' today';
      fundEl.className = info.fund_cached_today > 10 ? 'ms-1 badge bg-success' : 'ms-1 badge bg-info';

      var estEl = document.getElementById('cacheEstimate');
      if (info.rs_cached && info.price_cached_today > 100) {
        estEl.textContent = '~2-5 min (cached)';
        estEl.className = 'ms-1 badge bg-success';
      } else if (info.rs_cached) {
        estEl.textContent = '~5-12 min';
        estEl.className = 'ms-1 badge bg-info';
      } else {
        estEl.textContent = '~10-20 min (first run)';
        estEl.className = 'ms-1 badge bg-warning text-dark';
      }

      var hints = [];
      if (!info.rs_cached)
        hints.push('ğŸ’¡ é¦–æ¬¡æƒæéœ€å»ºç«‹ RS æ’åå¿«å–ï¼ˆç´„ 500-600 å€‹è‚¡ç¥¨ï¼‰ï¼Œç´„ 5 åˆ†é˜ã€‚å»ºç«‹å¾ŒåŒæ—¥æƒæç„¡éœ€é‡å»ºã€‚');
      else
        hints.push('âœ… RS æ’åå¿«å–æœ‰æ•ˆï¼ˆ' + info.rs_count + ' å€‹è‚¡ç¥¨ï¼‰ï¼ŒStage 2 RS è©•åˆ†å°‡ç›´æ¥è®€å–æœ¬åœ°å¿«å–ã€‚');
      if (info.price_cached_today > 100)
        hints.push('âš¡ å·²å¿«å– ' + info.price_cached_today + ' æª”ä»Šæ—¥è‚¡åƒ¹ï¼ŒStage 2 æ‰¹é‡ä¸‹è¼‰å°‡ä¸»è¦è®€å–æœ¬åœ°å¿«å–ï¼ˆé€Ÿåº¦å¿« 10xï¼‰ã€‚');
      else if (info.price_cached_today > 0)
        hints.push('ğŸ”„ éƒ¨åˆ†è‚¡åƒ¹å·²å¿«å–ï¼ˆ' + info.price_cached_today + ' æª”ï¼‰ï¼Œå…¶é¤˜å°‡å¾ yfinance ä¸‹è¼‰ï¼ˆæ‰¹é‡æ¨¡å¼ï¼Œæ¯æ‰¹ 40 æª”ï¼‰ã€‚');
      else
        hints.push('ğŸ“¥ è‚¡åƒ¹å¿«å–ç‚ºç©ºï¼ŒStage 2 å°‡é€é yfinance æ‰¹é‡ä¸‹è¼‰æ‰€æœ‰å€™é¸è‚¡ç¥¨çš„ 2 å¹´ OHLCV è³‡æ–™ã€‚');
      if (info.fund_cached_today > 0)
        hints.push('ğŸ“Š å·²å¿«å– ' + info.fund_cached_today + ' æª”åŸºæœ¬é¢è³‡æ–™ï¼ˆEPS/ROE/ç‡Ÿæ”¶ï¼‰ï¼ŒSEPA Stage 3 è©•åˆ†å°‡ç›´æ¥ä½¿ç”¨ã€‚');
      else
        hints.push('ğŸ“ˆ åŸºæœ¬é¢å¿«å–ç‚ºç©ºï¼›SEPA è©•åˆ†æ™‚å°‡å¾ yfinance ç²å–è²¡å ±æ•¸æ“šï¼ˆæ¯æ¬¡æƒæåªèª¿ç”¨ä¸€æ¬¡ï¼‰ã€‚');
      if (info.finviz_cached)
        hints.push('ğŸŒ Finviz ç¯©é¸çµæœå·²å¿«å–ï¼ˆ' + info.finviz_ttl_hours + ' å°æ™‚ TTLï¼‰ã€‚è‹¥é¸æ“‡ Finviz æ¨¡å¼ï¼Œæœ¬æ¬¡æƒæå°‡ç›´æ¥ä½¿ç”¨å¿«å–çµæœã€‚');
      hints.push('â„¹ï¸ Stage 1 ä¾†æºï¼š<b>NASDAQ FTP</b>ï¼ˆæ¨è–¦ï¼Œå…è²»ã€å¿«é€Ÿã€ç´„è¦†è“‹ 5,000+ ä¸Šå¸‚è‚¡ç¥¨ï¼‰æˆ– <b>Finviz</b>ï¼ˆå‚™ç”¨ï¼Œè¼ƒæ…¢ï¼Œæœ‰æ—¥è«‹æ±‚é™åˆ¶ï¼‰ã€‚å¯åœ¨ä¸Šæ–¹ä¸‹æ‹‰é¸å–®åˆ‡æ›ã€‚');
      hints.push('â±ï¸ è©³ç´° API é™åˆ¶åŠæœ€ä½³å¯¦è¸ï¼Œè«‹å±•é–‹ä¸Šæ–¹ã€ŒAPI Rate Limitsã€é¢æ¿ã€‚');
      document.getElementById('cacheHints').innerHTML =
        hints.map(function(h) { return '<div style="margin-bottom:2px">' + h + '</div>'; }).join('');
    })
    .catch(function() {
      document.getElementById('cacheHints').innerHTML =
        '<div class="text-muted">Unable to load cache info</div>';
    });
}

/* â•â•â• RATE LIMIT TOGGLE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function toggleRateLimitInfo() {
  var info   = document.getElementById('rateLimitInfo');
  var toggle = document.getElementById('rateLimitToggle');
  info.classList.toggle('d-none');
  toggle.style.transform  = info.classList.contains('d-none') ? 'rotate(0deg)' : 'rotate(90deg)';
  toggle.style.transition = 'transform 0.2s';
}
</script>
{% endblock %}
